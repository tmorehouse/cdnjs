/**
 * postal - Pub/Sub library providing wildcard subscriptions, complex message handling, etc.  Works server and client-side.
 * Author: Jim Cowart (http://ifandelse.com)
 * Version: v0.12.0
 * Url: http://github.com/postaljs/postal.js
 * License(s): MIT
 */
(function(t,e){"function"==typeof define&&define.amd?define(["lodash"],function(n){return e(n,t)}):"object"==typeof module&&module.exports?module.exports=e(require("lodash"),this):t.postal=e(t._,t)})(this,function(t,e,n){function i(t,e){return function(){if(console.warn||console.log){var n="Warning, the "+t+" method has been deprecated. Please use "+e+" instead.";console.warn?console.warn(n):console.log(n)}return b.prototype[e].apply(this,arguments)}}function r(){for(;x.length;)l.unsubscribe(x.shift())}function c(t,e,n){return function(i,r,c){i===t&&c.splice(r,1),0===c.length&&delete n[e]}}function s(t,e,n,i){return function(r){p.resolver.compare(r.topic,t)&&(e.push(r),r.cacheKeys.push(n),i&&i(r))}}function o(t,e){return{channel:p.SYSTEM_CHANNEL,topic:"subscription."+t,data:{event:"subscription."+t,channel:e.channel,topic:e.topic}}}function a(e,n){return"function"==typeof e?e:e?function(i){var r=0,c=0;return t.each(e,function(t,s){r+=1,("topic"===s&&n.compare(i.topic,e.topic,{preventCache:!0})||"context"===s&&e.context===i._context||i[s]===e[s])&&(c+=1)}),r===c}:function(){return!0}}var u=e.postal,h={DEFAULT_CHANNEL:"/",SYSTEM_CHANNEL:"postal",enableSystemMessages:!0,cacheKeyDelimiter:"|",autoCompactResolver:!1},l={configuration:t.extend({},h)},p=l.configuration,f=function(t,e){this.bus=e,this.channel=t||p.DEFAULT_CHANNEL};f.prototype.subscribe=function(){return this.bus.subscribe({channel:this.channel,topic:1===arguments.length?arguments[0].topic:arguments[0],callback:1===arguments.length?arguments[0].callback:arguments[1]})},f.prototype.publish=function(){var t=1===arguments.length?"[object String]"===Object.prototype.toString.call(arguments[0])?{topic:arguments[0]}:arguments[0]:{topic:arguments[0],data:arguments[1]};t.channel=this.channel,this.bus.publish(t)};var b=function(t,e,i){if(3!==arguments.length)throw new Error("You must provide a channel, topic and callback when creating a SubscriptionDefinition instance.");if(0===e.length)throw new Error("Topics cannot be empty");this.channel=t,this.topic=e,this.callback=i,this.pipeline=[],this.cacheKeys=[],this._context=n},d=function(){var e;return function(n){var i=!1;return t.isString(n)?(i=n===e,e=n):(i=t.isEqual(n,e),e=t.clone(n)),!i}},g=function(){var e=[];return function(n){var i=!t.any(e,function(e){return t.isObject(n)||t.isArray(n)?t.isEqual(n,e):n===e});return i&&e.push(n),i}};b.prototype={"catch":function(t){var e=this.callback,n=function(){try{e.apply(this,arguments)}catch(n){t(n,arguments[0])}};return this.callback=n,this},defer:function(){return this.delay(0)},disposeAfter:function(e){if(!t.isNumber(e)||0>=e)throw new Error("The value provided to disposeAfter (maxCalls) must be a number greater than zero.");var n=this,i=t.after(e,t.bind(function(){n.unsubscribe()}));return n.pipeline.push(function(t,e,n){n(t,e),i()}),n},distinct:function(){return this.constraint(new g)},distinctUntilChanged:function(){return this.constraint(new d)},invokeSubscriber:function(t,e){if(!this.inactive){var n=this,i=n.pipeline,r=i.length,c=n._context,s=-1;if(r){i=i.concat([n.callback]);var o=function a(t,e){s+=1,r>s?i[s].call(c,t,e,a):n.callback.call(c,t,e)};o(t,e,0)}else n.callback.call(c,t,e)}},logError:function(){if(console){var t;t=console.warn?console.warn:console.log,this["catch"](t)}return this},once:function(){return this.disposeAfter(1)},subscribe:function(t){return this.callback=t,this},unsubscribe:function(){this.inactive||l.unsubscribe(this)},constraint:function(e){if(!t.isFunction(e))throw new Error("Predicate constraint must be a function");return this.pipeline.push(function(t,n,i){e.call(this,t,n)&&i(t,n)}),this},constraints:function(e){var n=this;return t.isArray(e)&&t.each(e,function(t){n.constraint(t)}),n},context:function(t){return this._context=t,this},debounce:function(e,n){if(!t.isNumber(e))throw new Error("Milliseconds must be a number");return this.pipeline.push(t.debounce(function(t,e,n){n(t,e)},e,!!n)),this},delay:function(e){if(!t.isNumber(e))throw new Error("Milliseconds must be a number");var n=this;return n.pipeline.push(function(t,n,i){setTimeout(function(){i(t,n)},e)}),this},throttle:function(e){if(!t.isNumber(e))throw new Error("Milliseconds must be a number");var n=function(t,e,n){n(t,e)};return this.pipeline.push(t.throttle(n,e)),this}};for(var m=["withConstraint","withConstraints","withContext","withDebounce","withDelay","withThrottle"],v=["constraint","constraints","context","debounce","delay","throttle"],y=0;6>y;y++){var w=m[y];b.prototype[w]=i(w,v[y])}var _=p.cacheKeyDelimiter,E=(p.resolver={cache:{},regex:{},compare:function(e,n,i){var r,c,s,o=n+_+e,a=this.cache[o],u=i||{};return a===!0?a:-1===e.indexOf("#")&&-1===e.indexOf("*")?(u.preventCache||(a=this.cache[o]=n===e),a):((c=this.regex[e])||(r="^"+t.map(e.split("."),function(t){var e="";return s&&(e="#"!==s?"\\.\\b":"\\b"),e+="#"===t?"[\\s\\S]*":"*"===t?"[^.]+":t,s=t,e}).join("")+"$",c=this.regex[e]=new RegExp(r)),u.preventCache||(a=this.cache[o]=c.test(n)),a)},reset:function(){this.cache={},this.regex={}},purge:function(e){var n=this,i=function(t,i){var r=i.split(_),c=r[0],s=r[1];"undefined"!=typeof e.topic&&e.topic!==c||"undefined"!=typeof e.binding&&e.binding!==s||delete n.cache[i]},r=function(t,e){var i=e.split(_);0===l.getSubscribersFor({topic:i[0]}).length&&delete n.cache[e]};if("undefined"==typeof e)this.reset();else{var c=e.compact===!0?r:i;t.each(this.cache,c)}}},0),x=[],C=0,S=t.bind(o,this,"created"),A=t.bind(o,this,"removed");if(t.extend(l,{cache:{},subscriptions:{},wireTaps:[],ChannelDefinition:f,SubscriptionDefinition:b,channel:function(t){return new f(t,this)},addWireTap:function(t){var e=this;return e.wireTaps.push(t),function(){var n=e.wireTaps.indexOf(t);-1!==n&&e.wireTaps.splice(n,1)}},noConflict:function(){if("undefined"==typeof window||"undefined"!=typeof window&&"function"==typeof define&&define.amd)throw new Error("noConflict can only be used in browser clients which aren't using AMD modules");return e.postal=u,this},getSubscribersFor:function(e){var n=[],i=this;return t.each(i.subscriptions,function(i){t.each(i,function(i){n=n.concat(t.filter(i,a(e,p.resolver)))})}),n},publish:function(e){++E;var n=e.channel=e.channel||p.DEFAULT_CHANNEL,i=e.topic;e.timeStamp=new Date,this.wireTaps.length&&t.each(this.wireTaps,function(t){t(e.data,e,E)});var c=n+p.cacheKeyDelimiter+i,o=this.cache[c];if(o)t.each(o,function(t){t.invokeSubscriber(e.data,e)});else{o=this.cache[c]=[];var a=s(i,o,c,function(t){t.invokeSubscriber(e.data,e)});t.each(this.subscriptions[n],function(e){t.each(e,a)})}0===--E&&r()},reset:function(){this.unsubscribeFor(),p.resolver.reset(),this.subscriptions={}},subscribe:function(e){var n,i=this.subscriptions,r=new b(e.channel||p.DEFAULT_CHANNEL,e.topic,e.callback),c=i[r.channel],o=r.channel.length;return c||(c=i[r.channel]={}),n=i[r.channel][r.topic],n||(n=i[r.channel][r.topic]=[]),n.push(r),t.each(this.cache,function(t,e){e.substr(0,o)===r.channel&&s(e.split(p.cacheKeyDelimiter)[1],t,e)(r)}),p.enableSystemMessages&&this.publish(S(r)),r},unsubscribe:function(){for(var e,n,i,r,s=arguments.length,o=0;s>o;o++){if(e=arguments[o],e.inactive=!0,E)return x.push(e),void 0;if(n=this.subscriptions[e.channel],i=n&&n[e.topic]){var a=i.length;for(r=0;a>r;){if(i[r]===e){i.splice(r,1);break}r+=1}if(0===i.length&&(delete n[e.topic],t.isEmpty(n)&&delete this.subscriptions[e.channel]),e.cacheKeys&&e.cacheKeys.length)for(var u;u=e.cacheKeys.pop();)t.each(this.cache[u],c(e,u,this.cache));if("function"==typeof p.resolver.purge){var h=p.autoCompactResolver===!0?0:"number"==typeof p.autoCompactResolver?p.autoCompactResolver-1:!1;h>=0&&C===h?(p.resolver.purge({compact:!0}),C=0):h>=0&&h>C&&(C+=1)}}p.enableSystemMessages&&this.publish(A(e))}},unsubscribeFor:function(t){var e=[];this.subscriptions&&(e=this.getSubscribersFor(t),this.unsubscribe.apply(this,e))}}),e&&Object.prototype.hasOwnProperty.call(e,"__postalReady__")&&t.isArray(e.__postalReady__))for(;e.__postalReady__.length;)e.__postalReady__.shift().onReady(l);return l});