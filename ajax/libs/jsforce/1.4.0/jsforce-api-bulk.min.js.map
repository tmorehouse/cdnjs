{"version":3,"file":"jsforce-api-bulk.min.js","sources":["jsforce-api-bulk.js"],"names":["e","exports","module","define","amd","o","window","global","self","f","jsforce","modules","api","Bulk","t","n","r","s","u","a","require","i","Error","code","l","call","length",1,"process","inherits","stream","Stream","events","_","RecordStream","Promise","HttpApi","Job","bulk","type","operation","options","jobId","this","_bulk","id","state","_batches","EventEmitter","prototype","info","callback","_jobInfo","check","thenCall","open","_logger","body","toLowerCase","extIdField","join","_request","method","path","headers","Content-Type","responseType","then","res","emit","jobInfo","err","createBatch","batch","Batch","on","batchId","logger","_waitAssign","debug","object","list","batchInfoList","batchInfo","isArray","close","_changeState","abort","job","super_","apply","sendable","_csvStream","CSVStream","nullValue","pipe","_deferred","defer","run","exec","execute","input","_result","rdeferred","promise","resolve","reject","once","data","forEach","record","send","end","isString","write","onResolved","onReject","onProgress","isFunction","nextTick","clone","Id","attributes","poll","interval","timeout","startTime","Date","getTime","now","name","parseInt","numberRecordsProcessed","retrieve","stateMessage","setTimeout","results","_conn","result","map","ret","success","Success","errors","resultId","_stream","BatchStream","writable","_getRequestStream","_reqStream","BulkApi","arguments","beforeSend","request","accessToken","isSessionExpired","response","statusCode","test","hasErrorInResponseBody","error","parseError","errorCode","exceptionCode","message","exceptionMessage","conn","pollInterval","pollTimeout","baseUrl","instanceUrl","version","url","load","createJob","cleanup","cleanupOnError","query","soql","m","replace","match","rstream","_process",2,"drainQueue","draining","currentQueue","len","queue","noop","fun","push","title","browser","env","argv","addListener","off","removeListener","removeAllListeners","binding","cwd","chdir","umask"],"mappings":"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","sourcesContent":["!function(e){if(\"object\"==typeof exports&&\"undefined\"!=typeof module)module.exports=e();else if(\"function\"==typeof define&&define.amd)define([],e);else{var o;\"undefined\"!=typeof window?o=window:\"undefined\"!=typeof global?o=global:\"undefined\"!=typeof self&&(o=self);var f=o;f=f.jsforce||(f.jsforce={}),f=f.modules||(f.modules={}),f=f.api||(f.api={}),f.Bulk=e()}}(function(){var define,module,exports;return (function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require==\"function\"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error(\"Cannot find module '\"+o+\"'\");throw f.code=\"MODULE_NOT_FOUND\",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,function(e){var n=t[o][1][e];return s(n?n:e)},l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require==\"function\"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s})({1:[function(require,module,exports){\n(function (process){\n/*global process*/\n/**\n * @file Manages Salesforce Bulk API related operations\n * @author Shinichi Tomita <shinichi.tomita@gmail.com>\n */\n\nvar inherits     = jsforce.require('inherits'),\n    stream       = jsforce.require('stream'),\n    Stream       = stream.Stream,\n    events       = jsforce.require('events'),\n    _            = jsforce.require('underscore'),\n    RecordStream = jsforce.require('./record-stream'),\n    CSV          = jsforce.require('./csv'),\n    Promise      = jsforce.require('./promise'),\n    HttpApi      = jsforce.require('./http-api');\n\n/*--------------------------------------------*/\n\n/**\n * Class for Bulk API Job\n *\n * @protected\n * @class Bulk~Job\n * @extends events.EventEmitter\n * \n * @param {Bulk} bulk - Bulk API object\n * @param {String} [type] - SObject type\n * @param {String} [operation] - Bulk load operation ('insert', 'update', 'upsert', 'delete', or 'hardDelete')\n * @param {Object} [options] - Options for bulk loading operation\n * @param {String} [options.extIdField] - External ID field name (used when upsert operation).\n * @param {String} [jobId] - Job ID (if already available)\n */\nvar Job = function(bulk, type, operation, options, jobId) {\n  this._bulk = bulk;\n  this.type = type;\n  this.operation = operation;\n  this.options = options || {};\n  this.id = jobId;\n  this.state = this.id ? 'Open' : 'Unknown';\n  this._batches = {};\n};\n\ninherits(Job, events.EventEmitter);\n\n/**\n * @typedef {Object} Bulk~JobInfo\n * @prop {String} id - Job ID\n * @prop {String} object - Object type name\n * @prop {String} operation - Operation type of the job\n * @prop {String} state - Job status\n */\n\n/**\n * Return latest jobInfo from cache\n *\n * @method Bulk~Job#open\n * @param {Callback.<Bulk~JobInfo>} [callback] - Callback function\n * @returns {Promise.<Bulk~JobInfo>}\n */\nJob.prototype.info = function(callback) {\n  var self = this;\n  // if cache is not available, check the latest\n  if (!this._jobInfo) {\n    this._jobInfo = this.check();\n  }\n  return this._jobInfo.thenCall(callback);\n};\n\n/**\n * Open new job and get jobinfo\n *\n * @method Bulk~Job#open\n * @param {Callback.<Bulk~JobInfo>} [callback] - Callback function\n * @returns {Promise.<Bulk~JobInfo>}\n */\nJob.prototype.open = function(callback) {\n  var self = this;\n  var bulk = this._bulk;\n  var logger = bulk._logger;\n\n  // if not requested opening job\n  if (!this._jobInfo) {\n    var body = [\n      '<?xml version=\"1.0\" encoding=\"UTF-8\"?>',\n      '<jobInfo  xmlns=\"http://www.force.com/2009/06/asyncapi/dataload\">',\n        '<operation>' + this.operation.toLowerCase() + '</operation>',\n        '<object>' + this.type + '</object>',\n        (this.options.extIdField ?\n         '<externalIdFieldName>'+this.options.extIdField+'</externalIdFieldName>' :\n         ''),\n        '<contentType>CSV</contentType>',\n      '</jobInfo>'\n    ].join('');\n\n    this._jobInfo = bulk._request({\n      method : 'POST',\n      path : \"/job\",\n      body : body,\n      headers : {\n        \"Content-Type\" : \"application/xml; charset=utf-8\"\n      },\n      responseType: \"application/xml\"\n    }).then(function(res) {\n      self.emit(\"open\", res.jobInfo);\n      self.id = res.jobInfo.id;\n      self.state = res.jobInfo.state;\n      return res.jobInfo;\n    }, function(err) {\n      self.emit(\"error\", err);\n      throw err;\n    });\n  }\n  return this._jobInfo.thenCall(callback);\n};\n\n/**\n * Create a new batch instance in the job\n *\n * @method Bulk~Job#createBatch\n * @returns {Bulk~Batch}\n */\nJob.prototype.createBatch = function() {\n  var batch = new Batch(this);\n  var self = this;\n  batch.on('queue', function() {\n    self._batches[batch.id] = batch;\n  });\n  return batch;\n};\n\n/**\n * Get a batch instance specified by given batch ID\n *\n * @method Bulk~Job#batch\n * @param {String} batchId - Batch ID\n * @returns {Bulk~Batch}\n */\nJob.prototype.batch = function(batchId) {\n  var batch = this._batches[batchId];\n  if (!batch) {\n    batch = new Batch(this, batchId);\n    this._batches[batchId] = batch;\n  }\n  return batch;\n};\n\n/**\n * Check the latest job status from server\n *\n * @method Bulk~Job#check\n * @param {Callback.<Bulk~JobInfo>} [callback] - Callback function\n * @returns {Promise.<Bulk~JobInfo>}\n */\nJob.prototype.check = function(callback) {\n  var self = this;\n  var bulk = this._bulk;\n  var logger = bulk._logger;\n\n  this._jobInfo = this._waitAssign().then(function() {\n    return bulk._request({\n      method : 'GET',\n      path : \"/job/\" + self.id,\n      responseType: \"application/xml\"\n    });\n  }).then(function(res) {\n    logger.debug(res.jobInfo);\n    self.id = res.jobInfo.id;\n    self.type = res.jobInfo.object;\n    self.operation = res.jobInfo.operation;\n    self.state = res.jobInfo.state;\n    return res.jobInfo;\n  });\n  return this._jobInfo.thenCall(callback);\n};\n\n/**\n * Wait till the job is assigned to server\n *\n * @method Bulk~Job#info\n * @param {Callback.<Bulk~JobInfo>} [callback] - Callback function\n * @returns {Promise.<Bulk~JobInfo>}\n */\nJob.prototype._waitAssign = function(callback) {\n  return (this.id ? new Promise({ id: this.id }) : this.open()).thenCall(callback);\n};\n\n\n/**\n * List all registered batch info in job\n *\n * @method Bulk~Job#list\n * @param {Callback.<Array.<Bulk~BatchInfo>>} [callback] - Callback function\n * @returns {Promise.<Array.<Bulk~BatchInfo>>}\n */\nJob.prototype.list = function(callback) {\n  var self = this;\n  var bulk = this._bulk;\n  var logger = bulk._logger;\n\n  return this._waitAssign().then(function() {\n    return bulk._request({\n      method : 'GET',\n      path : \"/job/\" + self.id + \"/batch\",\n      responseType: \"application/xml\"\n    });\n  }).then(function(res) {\n    logger.debug(res.batchInfoList.batchInfo);\n    var batchInfoList = res.batchInfoList;\n    batchInfoList = _.isArray(batchInfoList.batchInfo) ? batchInfoList.batchInfo : [ batchInfoList.batchInfo ];\n    return batchInfoList;\n  }).thenCall(callback);\n\n};\n\n/**\n * Close opened job\n *\n * @method Bulk~Job#close\n * @param {Callback.<Bulk~JobInfo>} [callback] - Callback function\n * @returns {Promise.<Bulk~JobInfo>}\n */\nJob.prototype.close = function() {\n  var self = this;\n  return this._changeState(\"Closed\").then(function(jobInfo) {\n    self.id = null;\n    self.emit(\"close\", jobInfo);\n    return jobInfo;\n  }, function(err) {\n    self.emit(\"error\", err);\n    throw err;\n  });\n};\n\n/**\n * Set the status to abort\n *\n * @method Bulk~Job#abort\n * @param {Callback.<Bulk~JobInfo>} [callback] - Callback function\n * @returns {Promise.<Bulk~JobInfo>}\n */\nJob.prototype.abort = function() {\n  var self = this;\n  return this._changeState(\"Aborted\").then(function(jobInfo) {\n    self.id = null;\n    self.emit(\"abort\", jobInfo);\n    return jobInfo;\n  }, function(err) {\n    self.emit(\"error\", err);\n    throw err;\n  });\n};\n\n/**\n * @private\n */\nJob.prototype._changeState = function(state, callback) {\n  var self = this;\n  var bulk = this._bulk;\n  var logger = bulk._logger;\n\n  this._jobInfo = this._waitAssign().then(function() {\n    var body = [\n      '<?xml version=\"1.0\" encoding=\"UTF-8\"?>',\n      '<jobInfo xmlns=\"http://www.force.com/2009/06/asyncapi/dataload\">',\n        '<state>' + state + '</state>',\n      '</jobInfo>'\n    ].join('');\n    return bulk._request({\n      method : 'POST',\n      path : \"/job/\" + self.id,\n      body : body,\n      headers : {\n        \"Content-Type\" : \"application/xml; charset=utf-8\"\n      },\n      responseType: \"application/xml\"\n    });\n  }).then(function(res) {\n    logger.debug(res.jobInfo);\n    self.state = res.jobInfo.state;\n    return res.jobInfo;\n  });\n  return this._jobInfo.thenCall(callback);\n\n};\n\n\n/*--------------------------------------------*/\n\n/**\n * Batch (extends RecordStream implements Sendable)\n *\n * @protected\n * @class Bulk~Batch\n * @extends {RecordStream}\n * @implements {Promise.<Array.<RecordResult>>}\n * @param {Bulk~Job} job - Bulk job object\n * @param {String} [batchId] - Batch ID (if already available)\n */\nvar Batch = function(job, batchId) {\n  Batch.super_.apply(this);\n  this.sendable = true;\n  this.job = job;\n  this.id = batchId;\n  this._bulk = job._bulk;\n  this._csvStream = new RecordStream.CSVStream({ nullValue: '#N/A' });\n  this._csvStream.stream().pipe(this.stream());\n  this._deferred = Promise.defer();\n};\n\ninherits(Batch, RecordStream);\n\n/**\n * Execute batch operation\n *\n * @method Bulk~Batch#execute\n * @param {Array.<Record>|stream.Stream|String} [input] - Input source for batch operation. Accepts array of records, CSV string, and CSV data input stream in insert/update/upsert/delete/hardDelete operation, SOQL string in query operation.\n * @param {Callback.<Array.<RecordResult>|Array.<BatchResultInfo>>} [callback] - Callback function\n * @returns {Bulk~Batch}\n */\nBatch.prototype.run =\nBatch.prototype.exec =\nBatch.prototype.execute = function(input, callback) {\n  var self = this;\n\n  if (typeof input === 'function') { // if input argument is omitted\n    callback = input;\n    input = null;\n  }\n\n  // if batch is already executed\n  if (this._result) {\n    throw new Error(\"Batch already executed.\");\n  }\n\n  var rdeferred = Promise.defer();\n  this._result = rdeferred.promise;\n  this._result.then(function(res) {\n    self._deferred.resolve(res);\n  }, function(err) {\n    self._deferred.reject(err);\n  });\n  this.once('response', function(res) {\n    rdeferred.resolve(res);\n  });\n  this.once('error', function(err) {\n    rdeferred.reject(err);\n  });\n\n  if (input instanceof Stream) {\n    input.pipe(this.stream());\n  } else {\n    var data;\n    if (_.isArray(input)) {\n      _.forEach(input, function(record) { self.send(record); });\n      self.end();\n    } else if (_.isString(input)){\n      data = input;\n      var stream = this.stream();\n      stream.write(data);\n      stream.end();\n    }\n  }\n\n  // return Batch instance for chaining\n  return this.thenCall(callback);\n};\n\n/**\n * Promise/A+ interface\n * http://promises-aplus.github.io/promises-spec/\n *\n * Delegate to deferred promise, return promise instance for batch result\n *\n * @method Bulk~Batch#then\n */\nBatch.prototype.then = function(onResolved, onReject, onProgress) {\n  return this._deferred.promise.then(onResolved, onReject, onProgress);\n};\n\n/**\n * Promise/A+ extension\n * Call \"then\" using given node-style callback function\n *\n * @method Bulk~Batch#thenCall\n */\nBatch.prototype.thenCall = function(callback) {\n  if (_.isFunction(callback)) {\n    this.then(function(res) {\n      process.nextTick(function() {\n        callback(null, res);\n      });\n    }, function(err) {\n      process.nextTick(function() {\n        callback(err);\n      });\n    });\n  }\n  return this;\n};\n\n/**\n * @override\n */\nBatch.prototype.send = function(record) {\n  record = _.clone(record);\n  if (this.job.operation === \"insert\") {\n    delete record.Id;\n  } else if (this.job.operation === \"delete\") {\n    record = { Id: record.Id };\n  }\n  delete record.type;\n  delete record.attributes;\n  return this._csvStream.send(record);\n};\n\n/**\n * @override\n */\nBatch.prototype.end = function(record) {\n  if (record) {\n    this.send(record);\n  }\n  this.sendable = false;\n  this._csvStream.end();\n};\n\n/**\n * @typedef {Object} Bulk~BatchInfo\n * @prop {String} id - Batch ID\n * @prop {String} jobId - Job ID\n * @prop {String} state - Batch state\n * @prop {String} stateMessage - Batch state message\n */\n\n/**\n * Check the latest batch status in server\n *\n * @method Bulk~Batch#check\n * @param {Callback.<Bulk~BatchInfo>} [callback] - Callback function\n * @returns {Promise.<Bulk~BatchInfo>}\n */\nBatch.prototype.check = function(callback) {\n  var self = this;\n  var bulk = this._bulk;\n  var logger = bulk._logger;\n  var jobId = this.job.id;\n  var batchId = this.id;\n\n  if (!jobId || !batchId) {\n    throw new Error(\"Batch not started.\");\n  }\n  return bulk._request({\n    method : 'GET',\n    path : \"/job/\" + jobId + \"/batch/\" + batchId,\n    responseType: \"application/xml\"\n  }).then(function(res) {\n    logger.debug(res.batchInfo);\n    return res.batchInfo;\n  }).thenCall(callback);\n};\n\n\n/**\n * Polling the batch result and retrieve\n *\n * @method Bulk~Batch#poll\n * @param {Number} interval - Polling interval in milliseconds\n * @param {Number} timeout - Polling timeout in milliseconds\n */\nBatch.prototype.poll = function(interval, timeout) {\n  var self = this;\n  var jobId = this.job.id;\n  var batchId = this.id;\n\n  if (!jobId || !batchId) {\n    throw new Error(\"Batch not started.\");\n  }\n  var startTime = new Date().getTime();\n  var poll = function() {\n    var now = new Date().getTime();\n    if (startTime + timeout < now) {\n      var err = new Error(\"Polling time out. Job Id = \" + jobId + \" , batch Id = \" + batchId);\n      err.name = 'PollingTimeout';\n      self.emit('error', err);\n      return;\n    }\n    self.check(function(err, res) {\n      if (err) {\n        self.emit('error', err);\n      } else {\n        if (res.state === \"Failed\") {\n          if (parseInt(res.numberRecordsProcessed, 10) > 0) {\n            self.retrieve();\n          } else {\n            self.emit('error', new Error(res.stateMessage));\n          }\n        } else if (res.state === \"Completed\") {\n          self.retrieve();\n        } else {\n          self.emit('progress', res);\n          setTimeout(poll, interval);\n        }\n      }\n    });\n  };\n  setTimeout(poll, interval);\n};\n\n/**\n * @typedef {Object} Bulk~BatchResultInfo\n * @prop {String} id - Batch result ID\n * @prop {String} batchId - Batch ID which includes this batch result.\n * @prop {String} jobId - Job ID which includes this batch result.\n */\n\n/**\n * Retrieve batch result\n *\n * @method Bulk~Batch#retrieve\n * @param {Callback.<Array.<RecordResult>|Array.<Bulk~BatchResultInfo>>} [callback] - Callback function\n * @returns {Promise.<Array.<RecordResult>|Array.<Bulk~BatchResultInfo>>}\n */\nBatch.prototype.retrieve = function(callback) {\n  var self = this;\n  var bulk = this._bulk;\n  var jobId = this.job.id;\n  var job = this.job;\n  var batchId = this.id;\n\n  if (!jobId || !batchId) {\n    throw new Error(\"Batch not started.\");\n  }\n\n  return job.info().then(function(jobInfo) {\n    return bulk._request({\n      method : 'GET',\n      path : \"/job/\" + jobId + \"/batch/\" + batchId + \"/result\"\n    });\n  }).then(function(res) {\n    var results;\n    if (job.operation === 'query') {\n      var conn = bulk._conn;\n      var resultIds = res['result-list'].result;\n      results = res['result-list'].result;\n      results = _.map(_.isArray(results) ? results : [ results ], function(id) {\n        return {\n          id: id,\n          batchId: batchId,\n          jobId: jobId\n        };\n      });\n    } else {\n      results = _.map(res, function(ret) {\n        return {\n          id: ret.Id || null,\n          success: ret.Success === \"true\",\n          errors: ret.Error ? [ ret.Error ] : []\n        };\n      });\n    }\n    self.emit('response', results);\n    return results;\n  }, function(err) {\n    self.emit('error', err);\n    throw err;\n  }).thenCall(callback);\n};\n\n/**\n * Fetch query result as a record stream\n * @param {String} resultId - Result id\n * @returns {RecordStream.CSVStream} - Record stream, convertible to CSV data stream\n */\nBatch.prototype.result = function(resultId) {\n  var jobId = this.job.id;\n  var batchId = this.id;\n\n  if (!jobId || !batchId) {\n    throw new Error(\"Batch not started.\");\n  }\n  return new RecordStream.CSVStream(null,\n    this._bulk._request({\n      method : 'GET',\n      path : \"/job/\" + jobId + \"/batch/\" + batchId + \"/result/\" + resultId\n    }).stream()\n  );\n};\n\n/**\n * @override\n */\nBatch.prototype.stream = function() {\n  if (!this._stream) {\n    this._stream = new BatchStream(this);\n  }\n  return this._stream;\n};\n\n/*--------------------------------------------*/\n\n/**\n * Batch uploading stream (extends WritableStream)\n *\n * @private\n * @class Bulk~BatchStream\n * @extends stream.Stream\n */\nvar BatchStream = function(batch) {\n  BatchStream.super_.call(this);\n  this.batch = batch;\n  this.writable = true;\n};\n\ninherits(BatchStream, Stream);\n\n/**\n * @private\n */\nBatchStream.prototype._getRequestStream = function() {\n  var batch = this.batch;\n  var bulk = batch._bulk;\n  var logger = bulk._logger;\n\n  if (!this._reqStream) {\n    this._reqStream = bulk._request({\n      method : 'POST',\n      path : \"/job/\" + batch.job.id + \"/batch\",\n      headers: {\n        \"Content-Type\": \"text/csv\"\n      },\n      responseType: \"application/xml\"\n    }, function(err, res) {\n      if (err) {\n        batch.emit('error', err);\n      } else {\n        logger.debug(res.batchInfo);\n        batch.id = res.batchInfo.id;\n        batch.emit('queue', res.batchInfo);\n      }\n    }).stream();\n  }\n  return this._reqStream;\n};\n\n/**\n * @override\n */\nBatchStream.prototype.write = function(data) {\n  var self = this;\n  this.batch.job.open().then(function() {\n    self._getRequestStream().write(data);\n  }, function(err) {\n    self.emit('error', err);\n  });\n};\n\n/**\n * @override\n */\nBatchStream.prototype.end = function(data) {\n  var self = this;\n  this.writable = false;\n  this.batch.job.open().then(function() {\n    self._getRequestStream().end(data);\n  }, function(err) {\n    self.emit('error', err);\n  });\n};\n\n/*--------------------------------------------*/\n/**\n * @private\n */\nvar BulkApi = function() {\n  BulkApi.super_.apply(this, arguments);\n};\n\ninherits(BulkApi, HttpApi);\n\nBulkApi.prototype.beforeSend = function(request) {\n  request.headers = request.headers || {};\n  request.headers[\"X-SFDC-SESSION\"] = this._conn.accessToken;\n};\n\nBulkApi.prototype.isSessionExpired = function(response) {\n  return response.statusCode === 400 &&\n    /<exceptionCode>InvalidSessionId<\\/exceptionCode>/.test(response.body);\n};\n\nBulkApi.prototype.hasErrorInResponseBody = function(body) {\n  return !!body.error;\n};\n\nBulkApi.prototype.parseError = function(body) {\n  return {\n    errorCode: body.error.exceptionCode,\n    message: body.error.exceptionMessage\n  };\n};\n\n/*--------------------------------------------*/\n\n/**\n * Class for Bulk API\n *\n * @class\n * @param {Connection} conn - Connection object\n */\nvar Bulk = function(conn) {\n  this._conn = conn;\n  this._logger = conn._logger;\n};\n\n/** \n * Polling interval in milliseconds \n * @type {Number}\n */\nBulk.prototype.pollInterval = 1000;\n\n/**\n * Polling timeout in milliseconds\n * @type {Number}\n */\nBulk.prototype.pollTimeout = 10000;\n\n/** @private **/\nBulk.prototype._request = function(request, callback) {\n  var conn = this._conn;\n  request = _.clone(request);\n  var baseUrl = [ conn.instanceUrl, \"services/async\", conn.version ].join('/');\n  request.url = baseUrl + request.path;\n  var options = { responseType: request.responseType };\n  delete request.path;\n  delete request.responseType;\n  return new BulkApi(this._conn, options).request(request).thenCall(callback);\n};\n\n/**\n * Create and start bulkload job and batch\n *\n * @param {String} type - SObject type\n * @param {String} operation - Bulk load operation ('insert', 'update', 'upsert', 'delete', or 'hardDelete')\n * @param {Object} [options] - Options for bulk loading operation\n * @param {String} [options.extIdField] - External ID field name (used when upsert operation).\n * @param {Array.<Record>|stream.Stream|String} [input] - Input source for bulkload. Accepts array of records, CSV string, and CSV data input stream in insert/update/upsert/delete/hardDelete operation, SOQL string in query operation.\n * @param {Callback.<Array.<RecordResult>|Array.<Bulk~BatchResultInfo>>} [callback] - Callback function\n * @returns {Bulk~Batch}\n */\nBulk.prototype.load = function(type, operation, options, input, callback) {\n  var self = this;\n  if (!type || !operation) {\n    throw new Error(\"Insufficient arguments. At least, 'type' and 'operation' are required.\");\n  }\n  if (operation.toLowerCase() !== 'upsert') { // options is only for upsert operation\n    callback = input;\n    input = options;\n    options = null;\n  }\n  var job = this.createJob(type, operation, options);\n  job.once('error', function (error) {\n    if (batch) {\n      batch.emit('error', error); // pass job error to batch\n    }\n  });\n  var batch = job.createBatch();\n  var cleanup = function() {\n    batch = null;\n    job.close();\n  };\n  var cleanupOnError = function(err) {\n    if (err.name !== 'PollingTimeout') {\n      cleanup();\n    }\n  };\n  batch.on('response', cleanup);\n  batch.on('error', cleanupOnError);\n  batch.on('queue', function() { batch.poll(self.pollInterval, self.pollTimeout); });\n  return batch.execute(input, callback);\n};\n\n/**\n * Execute bulk query and get record stream\n *\n * @param {String} soql - SOQL to execute in bulk job\n * @returns {RecordStream.CSVStream} - Record stream, convertible to CSV data stream\n */\nBulk.prototype.query = function(soql) {\n  var m = soql.replace(/\\([\\s\\S]+\\)/g, '').match(/FROM\\s+(\\w+)/i);\n  if (!m) {\n    throw new Error(\"No sobject type found in query, maybe caused by invalid SOQL.\");\n  }\n  var type = m[1];\n  var self = this;\n  var rstream = new RecordStream.CSVStream();\n  this.load(type, \"query\", soql).then(function(results) {\n    // Ideally, it should merge result files into one stream.\n    // Currently only first batch result is the target (mostly enough).\n    var r = results[0];\n    var result = self.job(r.jobId).batch(r.batchId).result(r.id);\n    result.stream().pipe(rstream.stream());\n  });\n  return rstream;\n};\n\n\n/**\n * Create a new job instance\n *\n * @param {String} type - SObject type\n * @param {String} operation - Bulk load operation ('insert', 'update', 'upsert', 'delete', 'hardDelete', or 'query')\n * @param {Object} [options] - Options for bulk loading operation\n * @returns {Bulk~Job}\n */\nBulk.prototype.createJob = function(type, operation, options) {\n  return new Job(this, type, operation, options);\n};\n\n/**\n * Get a job instance specified by given job ID\n *\n * @param {String} jobId - Job ID\n * @returns {Bulk~Job}\n */\nBulk.prototype.job = function(jobId) {\n  return new Job(this, null, null, null, jobId);\n};\n\n\n/*--------------------------------------------*/\n\nmodule.exports = Bulk;\n\n}).call(this,require('_process'))\n},{\"_process\":2}],2:[function(require,module,exports){\n// shim for using process in browser\n\nvar process = module.exports = {};\nvar queue = [];\nvar draining = false;\n\nfunction drainQueue() {\n    if (draining) {\n        return;\n    }\n    draining = true;\n    var currentQueue;\n    var len = queue.length;\n    while(len) {\n        currentQueue = queue;\n        queue = [];\n        var i = -1;\n        while (++i < len) {\n            currentQueue[i]();\n        }\n        len = queue.length;\n    }\n    draining = false;\n}\nprocess.nextTick = function (fun) {\n    queue.push(fun);\n    if (!draining) {\n        setTimeout(drainQueue, 0);\n    }\n};\n\nprocess.title = 'browser';\nprocess.browser = true;\nprocess.env = {};\nprocess.argv = [];\nprocess.version = ''; // empty string to avoid regexp issues\n\nfunction noop() {}\n\nprocess.on = noop;\nprocess.addListener = noop;\nprocess.once = noop;\nprocess.off = noop;\nprocess.removeListener = noop;\nprocess.removeAllListeners = noop;\nprocess.emit = noop;\n\nprocess.binding = function (name) {\n    throw new Error('process.binding is not supported');\n};\n\n// TODO(shtylman)\nprocess.cwd = function () { return '/' };\nprocess.chdir = function (dir) {\n    throw new Error('process.chdir is not supported');\n};\nprocess.umask = function() { return 0; };\n\n},{}]},{},[1])(1)\n});"]}