/*
 machina
 Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 License: Dual licensed MIT (http://www.opensource.org/licenses/mit-license) & GPL (http://www.opensource.org/licenses/gpl-license)
 Version 0.3.2
 */
(function(t,e){"object"==typeof module&&module.exports?module.exports=function(t){return e(t)}:"function"==typeof define&&define.amd?define(["underscore"],function(i){return e(i,t)}):t.machina=e(t._,t)})(this,function(t,e,i){var n=[].slice,s="transition",r="handler",a="handling",o="handled",u="nohandler",c="transition",h="invalidstate",l="deferred",p="newfsm",f={makeFsmNamespace:function(){var t=0;return function(){return"fsm."+t++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},eventQueue:[],namespace:f.makeFsmNamespace(),targetReplayState:"",state:i,priorState:i,_priorAction:"",_currentAction:""}}};if(!t.deepExtend){var v={"*":function(t,e,i){t[e]=i},object:function(t,e,i){t[e]=y({},t[e]||{},i)},array:function(e,i,n){e[i]=[],t.each(n,function(t,n){v[g(t)](e[i],n,t)},this)}},d=function(e){return t.isArray(e)?"array":t.isDate(e)?"date":t.isRegExp(e)?"regex":typeof e},g=function(t){var e=d(t);return v[e]?e:"*"},y=function(e){return t.each(n.call(arguments,1),function(i){t.each(i,function(t,i){v[g(t)](e,i,t)})}),e};t.mixin({deepExtend:y})}var m=function(e){t.extend(this,e),t.defaults(this,f.getDefaultOptions()),this.initialize.apply(this,arguments),L.emit(p,this),this.initialState&&this.transition(this.initialState)};t.extend(m.prototype,{initialize:function(){},emit:function(e){var s=arguments;this.eventListeners["*"]&&t.each(this.eventListeners["*"],function(t){try{t.apply(this,n.call(s,0))}catch(e){console&&console.log!==i&&console.log(""+e)}}),this.eventListeners[e]&&t.each(this.eventListeners[e],function(t){try{t.apply(this,n.call(s,1))}catch(e){console&&console.log!==i&&console.log(""+e)}})},handle:function(t){if(!this.inExitHandler){var e,s,c,h=this.states,l=this.state,p=n.call(arguments,0);this.currentActionArgs=p,h[l][t]||h[l]["*"]||this["*"]?(e=h[l][t]?t:"*",c="*"===e,h[l][e]?(s=h[l][e],this._currentAction=l+"."+e):(s=this["*"],this._currentAction="*"),this.emit.call(this,a,{inputType:t,args:p.slice(1)}),"[object String]"===Object.prototype.toString.call(s)?this.transition(s):s.apply(this,c?p:p.slice(1)),this.emit.call(this,o,{inputType:t,args:p.slice(1)}),this._priorAction=this._currentAction,this._currentAction="",this.processQueue(r)):this.emit.call(this,u,{inputType:t,args:p.slice(1)}),this.currentActionArgs=i}},transition:function(t){if(!this.inExitHandler){var e;if(this.states[t])return this.targetReplayState=t,this.priorState=this.state,this.state=t,e=this.priorState,this.states[e]&&this.states[e]._onExit&&(this.inExitHandler=!0,this.states[e]._onExit.call(this),this.inExitHandler=!1),this.emit.call(this,c,{fromState:e,toState:t}),this.states[t]._onEnter&&this.states[t]._onEnter.call(this),this.targetReplayState===t&&this.processQueue(s),i;this.emit.call(this,h,{state:this.state,attemptedState:t})}},processQueue:function(e){var i=e===s?function(t){return t.type===s&&(!t.untilState||t.untilState===this.state)}:function(t){return t.type===r},n=t.filter(this.eventQueue,i,this);this.eventQueue=t.difference(this.eventQueue,n),t.each(n,function(t){this.handle.apply(this,t.args)},this)},clearQueue:function(e,i){if(e){var n;e===s?n=function(t){return t.type===s&&(i?t.untilState===i:!0)}:e===r&&(n=function(t){return t.type===r}),this.eventQueue=t.filter(this.eventQueue,n)}else this.eventQueue=[]},deferUntilTransition:function(t){if(this.currentActionArgs){var e={type:s,untilState:t,args:this.currentActionArgs};this.eventQueue.push(e),this.emit.call(this,l,{state:this.state,queuedArgs:e})}},deferUntilNextHandler:function(){if(this.currentActionArgs){var t={type:s,args:this.currentActionArgs};this.eventQueue.push(t),this.emit.call(this,l,{state:this.state,queuedArgs:t})}},on:function(t,e){var i=this;return i.eventListeners[t]||(i.eventListeners[t]=[]),i.eventListeners[t].push(e),{eventName:t,callback:e,off:function(){i.off(t,e)}}},off:function(e,i){e?this.eventListeners[e]&&(this.eventListeners[e]=i?t.without(this.eventListeners[e],i):[]):this.eventListeners={}}}),m.prototype.trigger=m.prototype.emit;var x=function(){},A=function(e,i,n){var s;return s=i&&i.hasOwnProperty("constructor")?i.constructor:function(){e.apply(this,arguments)},t.deepExtend(s,e),x.prototype=e.prototype,s.prototype=new x,i&&t.deepExtend(s.prototype,i),n&&t.deepExtend(s,n),s.prototype.constructor=s,s.__super__=e.prototype,s};m.extend=function(t,e){var i=A(this,t,e);return i.extend=this.extend,i};var L={Fsm:m,utils:f,on:function(t,e){return this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(e),e},off:function(e,i){this.eventListeners[e]&&(this.eventListeners[e]=t.without(this.eventListeners[e],i))},trigger:function(e){var i=arguments,s=this.eventListeners[e]||[];s&&s.length&&t.each(s,function(t){t.apply(null,n.call(i,1))})},eventListeners:{newFsm:[]}};return L.emit=L.trigger,L});