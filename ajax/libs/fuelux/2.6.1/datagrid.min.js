define(["require","jquery"],function(c){var e=c("jquery");var a=e.fn.datagrid;var b=22;var d=function(h,g){this.$element=e(h);this.$thead=this.$element.find("thead");this.$tfoot=this.$element.find("tfoot");this.$footer=this.$element.find("tfoot th");this.$footerchildren=this.$footer.children().show().css("visibility","hidden");this.$topheader=this.$element.find("thead th");this.$searchcontrol=this.$element.find(".datagrid-search");this.$filtercontrol=this.$element.find(".filter");this.$pagesize=this.$element.find(".grid-pagesize");this.$pageinput=this.$element.find(".grid-pager input");this.$pagedropdown=this.$element.find(".grid-pager .dropdown-menu");this.$prevpagebtn=this.$element.find(".grid-prevpage");this.$nextpagebtn=this.$element.find(".grid-nextpage");this.$pageslabel=this.$element.find(".grid-pages");this.$countlabel=this.$element.find(".grid-count");this.$startlabel=this.$element.find(".grid-start");this.$endlabel=this.$element.find(".grid-end");this.$tbody=e("<tbody>").insertAfter(this.$thead);this.$colheader=e("<tr>").appendTo(this.$thead);this.options=e.extend(true,{},e.fn.datagrid.defaults,g);this.selectedItems={};if(this.$pagesize.hasClass("select")){this.$pagesize.select("selectByValue",this.options.dataOptions.pageSize);this.options.dataOptions.pageSize=parseInt(this.$pagesize.select("selectedItem").value,10)}else{var f=this.options.dataOptions.pageSize;this.$pagesize.find("option").filter(function(){return e(this).text()===f.toString()}).attr("selected",true);this.options.dataOptions.pageSize=parseInt(this.$pagesize.val(),10)}if(this.$searchcontrol.length<=0){this.$searchcontrol=this.$element.find(".search")}this.columns=this.options.dataSource.columns();this.$nextpagebtn.on("click",e.proxy(this.next,this));this.$prevpagebtn.on("click",e.proxy(this.previous,this));this.$searchcontrol.on("searched cleared",e.proxy(this.searchChanged,this));this.$filtercontrol.on("changed",e.proxy(this.filterChanged,this));this.$colheader.on("click","th",e.proxy(this.headerClicked,this));if(this.$pagesize.hasClass("select")){this.$pagesize.on("changed",e.proxy(this.pagesizeChanged,this))}else{this.$pagesize.on("change",e.proxy(this.pagesizeChanged,this))}this.$pageinput.on("change",e.proxy(this.pageChanged,this));this.renderColumns();if(this.options.stretchHeight){this.initStretchHeight()}this.renderData()};d.prototype={constructor:d,renderColumns:function(){var f;this.$footer.attr("colspan",this.columns.length);this.$topheader.attr("colspan",this.columns.length);var g="";e.each(this.columns,function(h,i){g+='<th data-property="'+i.property+'"';if(i.sortable){g+=' class="sortable"'}g+=">"+i.label+"</th>"});this.$colheader.append(g);if(this.options.dataOptions.sortProperty){f=this.$colheader.children('th[data-property="'+this.options.dataOptions.sortProperty+'"]');this.updateColumns(f,this.options.dataOptions.sortDirection)}},updateColumns:function(f,g){this._updateColumns(this.$colheader,f,g);if(this.$sizingHeader){this._updateColumns(this.$sizingHeader,this.$sizingHeader.find("th").eq(f.index()),g)}},_updateColumns:function(g,f,i){var h=(i==="asc")?"icon-chevron-up":"icon-chevron-down";g.find("i.datagrid-sort").remove();g.find("th").removeClass("sorted");e("<i>").addClass(h+" datagrid-sort").appendTo(f);f.addClass("sorted")},getSelectedItems:function(){return this.selectedItems},setSelectedItems:function(f){var g=[];e.extend(true,g,f);if((this.options.multiSelect===false)&&(g.length>1)){this.clearSelectedItems();g.splice(1)}e.each(g,e.proxy(function(h,i){e.each(this.options.dataSource._data,e.proxy(function(j,k){if(k[this.options.primaryKey].toString()===i.toString()){this.selectedItems[k[this.options.primaryKey]]=k}},this))},this));e.each(this.$tbody.find("tr"),e.proxy(function(h,i){if(this.selectedItems.hasOwnProperty(e(i).attr("data-id"))){e(i).addClass("selected")}},this))},clearSelectedItems:function(){e.each(this.$tbody.find("tr"),function(f,g){e(g).removeClass("selected")});this.selectedItems={}},updatePageDropdown:function(g){var h="";for(var f=1;f<=g.pages;f++){h+="<li><a>"+f+"</a></li>"}this.$pagedropdown.html(h)},updatePageButtons:function(f){if(f.page===1){this.$prevpagebtn.attr("disabled","disabled")}else{this.$prevpagebtn.removeAttr("disabled")}if(f.page===f.pages){this.$nextpagebtn.attr("disabled","disabled")}else{this.$nextpagebtn.removeAttr("disabled")}},renderData:function(){var g=this;function f(l,i){var k=i.property;var j=l[k];var h;if(typeof i.render==="function"){h=i.render.call(g,j,l)}else{h=j}return h}this.$tbody.html(this.placeholderRowHTML(this.options.loadingHTML));this.options.dataSource.data(this.options.dataOptions,function(k){if(typeof k==="string"){g.$footerchildren.css("visibility","hidden");g.$tbody.html(g.errorRowHTML(k));g.stretchHeight();g.$element.trigger("loaded");return}var j=(k.count===1)?g.options.itemText:g.options.itemsText;g.$footerchildren.css("visibility",function(){return(k.count>0)?"visible":"hidden"});g.$pageinput.val(k.page);g.$pageslabel.text(k.pages);g.$countlabel.text(k.count+" "+j);g.$startlabel.text(k.start);g.$endlabel.text(k.end);g.updatePageDropdown(k);g.updatePageButtons(k);var l=!!g.options.multiSelect;var i=!!g.options.enableSelect;var h=[];if(k.data.length===0){g.$tbody.html(g.placeholderRowHTML(g.options.noDataFoundHTML))}else{h=e.map(g.selectedItems,function(n,m){return m.toString()});e.each(k.data,function(m,o){var n=e("<tr/>");e.each(g.columns,function(p,q){var s=e("<td/>");if(q.cssClass){s.addClass(q.cssClass)}if(i&&(p===0)){var r=e("<div/>");r.addClass("selectWrap");r.append(f(o,q));s.html(r)}else{s.html(f(o,q))}n.append(s)});if(i){n.addClass("selectable");n.attr("data-id",o[g.options.primaryKey]);if(e.inArray(o[g.options.primaryKey].toString(),h)>-1){n.addClass("selected")}}if(m===0){g.$tbody.empty()}g.$tbody.append(n)});if(i){g.$tbody.find("tr").bind("click",function(o){var p=e(o.currentTarget).data("id");var n;e.each(k.data,function(q,r){if(p===r[g.options.primaryKey]){n=r}});var m=g.selectedItems.hasOwnProperty(p);if(!l){g.clearSelectedItems()}if(m&&!l){g.$element.trigger("itemDeselected",n)}else{if(m&&l){delete g.selectedItems[p];e(o.currentTarget).removeClass("selected")}else{g.selectedItems[p]=n;e(o.currentTarget).addClass("selected");g.$element.trigger("itemSelected",n)}}})}}if(e.trim(g.$tbody.html())===""){g.$tbody.html(g.placeholderRowHTML(g.options.noDataFoundHTML))}g.stretchHeight();g.$element.trigger("loaded")})},errorRowHTML:function(f){return'<tr><td style="text-align:center;padding:20px 20px 0 20px;border-bottom:none;" colspan="'+this.columns.length+'"><div class="alert alert-error">'+f+"</div></td></tr>"},placeholderRowHTML:function(f){return'<tr><td style="text-align:center;padding:20px;border-bottom:none;" colspan="'+this.columns.length+'">'+f+"</td></tr>"},headerClicked:function(j){var f=e(j.target);if(!f.hasClass("sortable")){return}var i=this.options.dataOptions.sortDirection;var g=this.options.dataOptions.sortProperty;var h=f.data("property");if(g===h){this.options.dataOptions.sortDirection=(i==="asc")?"desc":"asc"}else{this.options.dataOptions.sortDirection="asc";this.options.dataOptions.sortProperty=h}this.options.dataOptions.pageIndex=0;this.updateColumns(f,this.options.dataOptions.sortDirection);this.renderData()},pagesizeChanged:function(g,f){if(f){this.options.dataOptions.pageSize=parseInt(f.value,10)}else{this.options.dataOptions.pageSize=parseInt(e(g.target).val(),10)}this.options.dataOptions.pageIndex=0;this.renderData()},pageChanged:function(h){var g=parseInt(e(h.target).val(),10);g=(isNaN(g))?1:g;var f=this.$pageslabel.text();this.options.dataOptions.pageIndex=(g>f)?f-1:g-1;this.renderData()},searchChanged:function(g,f){this.options.dataOptions.search=f;this.options.dataOptions.pageIndex=0;this.renderData()},filterChanged:function(g,f){this.options.dataOptions.filter=f;this.options.dataOptions.pageIndex=0;this.renderData()},previous:function(){this.$nextpagebtn.attr("disabled","disabled");this.$prevpagebtn.attr("disabled","disabled");this.options.dataOptions.pageIndex--;this.renderData()},next:function(){this.$nextpagebtn.attr("disabled","disabled");this.$prevpagebtn.attr("disabled","disabled");this.options.dataOptions.pageIndex++;this.renderData()},reload:function(){this.options.dataOptions.pageIndex=0;this.renderData()},initStretchHeight:function(){this.$gridContainer=this.$element.parent();this.$element.wrap('<div class="datagrid-stretch-wrapper">');this.$stretchWrapper=this.$element.parent();this.$headerTable=e("<table>").attr("class",this.$element.attr("class"));this.$footerTable=this.$headerTable.clone();this.$headerTable.prependTo(this.$gridContainer).addClass("datagrid-stretch-header");this.$thead.detach().appendTo(this.$headerTable);this.$sizingHeader=this.$thead.clone();this.$sizingHeader.find("tr:first").remove();this.$footerTable.appendTo(this.$gridContainer).addClass("datagrid-stretch-footer");this.$tfoot.detach().appendTo(this.$footerTable)},stretchHeight:function(){if(!this.$gridContainer){return}this.setColumnWidths();var f=this.$gridContainer.height();var h=this.$headerTable.outerHeight();var i=this.$footerTable.outerHeight();var g=h+i;this.$stretchWrapper.height(f-g)},setColumnWidths:function(){if(!this.$sizingHeader){return}this.$element.prepend(this.$sizingHeader);var g=this.$sizingHeader.find("th");var f=g.length;function h(k,m){if(k===f-1){return}var j=e(m);var n=g.eq(k);var l=n.width();if(n.hasClass("sorted")&&j.prop("tagName")==="TD"){l=l+b}j.width(l)}this.$colheader.find("th").each(h);this.$tbody.find("tr:first > td").each(h);this.$sizingHeader.detach()}};e.fn.datagrid=function(h){var g=Array.prototype.slice.call(arguments,1);var i;var f=this.each(function(){var l=e(this);var k=l.data("datagrid");var j=typeof h==="object"&&h;if(!k){l.data("datagrid",(k=new d(this,j)))}if(typeof h==="string"){i=k[h].apply(k,g)}});return(i===undefined)?f:i};e.fn.datagrid.defaults={dataOptions:{pageIndex:0,pageSize:10},loadingHTML:'<div class="progress progress-striped active" style="width:50%;margin:auto;"><div class="bar" style="width:100%;"></div></div>',itemsText:"items",itemText:"item",noDataFoundHTML:"0 items"};e.fn.datagrid.Constructor=d;e.fn.datagrid.noConflict=function(){e.fn.datagrid=a;return this}});