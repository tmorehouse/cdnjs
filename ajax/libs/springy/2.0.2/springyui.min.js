(function(){jQuery.fn.springy=function(v){var b=this.graph=v.graph||new Springy.Graph();var s=v.stiffness||400;var g=v.repulsion||400;var e=v.damping||0.5;var r=v.nodeSelected||null;var f=this[0];var n=f.getContext("2d");var t=this.layout=new Springy.Layout.ForceDirected(b,s,g,e);var c=t.getBoundingBox();var j={bottomleft:new Springy.Vector(-2,-2),topright:new Springy.Vector(2,2)};Springy.requestAnimationFrame(function o(){j=t.getBoundingBox();c={bottomleft:c.bottomleft.add(j.bottomleft.subtract(c.bottomleft).divide(10)),topright:c.topright.add(j.topright.subtract(c.topright).divide(10))};Springy.requestAnimationFrame(o)});var q=function(y){var x=c.topright.subtract(c.bottomleft);var A=y.subtract(c.bottomleft).divide(x.x).x*f.width;var z=y.subtract(c.bottomleft).divide(x.y).y*f.height;return new Springy.Vector(A,z)};var a=function(A){var z=c.topright.subtract(c.bottomleft);var y=(A.x/f.width)*z.x+c.bottomleft.x;var x=(A.y/f.height)*z.y+c.bottomleft.y;return new Springy.Vector(y,x)};var l=null;var d=null;var i=null;jQuery(f).mousedown(function(y){var z=jQuery(this).offset();var x=a({x:y.pageX-z.left,y:y.pageY-z.top});l=d=i=t.nearest(x);if(l.node!==null){i.point.m=10000;if(r){r(l.node)}}m.start()});jQuery(f).dblclick(function(y){var z=jQuery(this).offset();var x=a({x:y.pageX-z.left,y:y.pageY-z.top});l=t.nearest(x);node=l.node;if(node&&node.data&&node.data.ondoubleclick){node.data.ondoubleclick()}});jQuery(f).mousemove(function(y){var z=jQuery(this).offset();var x=a({x:y.pageX-z.left,y:y.pageY-z.top});d=t.nearest(x);if(i!==null&&i.node!==null){i.point.p.x=x.x;i.point.p.y=x.y}m.start()});jQuery(window).bind("mouseup",function(x){i=null});Springy.Node.prototype.getWidth=function(){var y=(this.data.label!==undefined)?this.data.label:this.id;if(this._width&&this._width[y]){return this._width[y]}n.save();n.font="16px Verdana, sans-serif";var x=n.measureText(y).width+10;n.restore();this._width||(this._width={});this._width[y]=x;return x};Springy.Node.prototype.getHeight=function(){return 20};var m=this.renderer=new Springy.Renderer(t,function k(){n.clearRect(0,0,f.width,f.height)},function h(G,z,x){var U=q(z).x;var D=q(z).y;var S=q(x).x;var C=q(x).y;var V=new Springy.Vector(S-U,C-D);var W=V.normal().normalise();var O=b.getEdges(G.source,G.target);var B=b.getEdges(G.target,G.source);var X=O.length+B.length;var N=0;for(var R=0;R<O.length;R++){if(O[R].id===G.id){N=R}}var E=6;var F=W.multiply(-((X-1)*E)/2+(N*E));var A=q(z).add(F);var y=q(x).add(F);var K=G.target.getWidth();var H=G.target.getHeight();var J=u(A,y,{x:S-K/2,y:C-H/2},K,H);if(!J){J=y}var I=(G.data.color!==undefined)?G.data.color:"#000000";var T;var M;var L=(G.data.weight!==undefined)?G.data.weight:1;n.lineWidth=Math.max(L*2,0.1);T=1+n.lineWidth;M=8;var P=(G.data.directional!==undefined)?G.data.directional:true;var Q;if(P){Q=J.subtract(V.normalise().multiply(M*0.5))}else{Q=y}n.strokeStyle=I;n.beginPath();n.moveTo(A.x,A.y);n.lineTo(Q.x,Q.y);n.stroke();if(P){n.save();n.fillStyle=I;n.translate(J.x,J.y);n.rotate(Math.atan2(C-D,S-U));n.beginPath();n.moveTo(-M,T);n.lineTo(0,0);n.lineTo(-M,-T);n.lineTo(-M*0.8,-0);n.closePath();n.fill();n.restore()}if(G.data.label!==undefined){text=G.data.label;n.save();n.textAlign="center";n.textBaseline="top";n.font="10px Helvetica, sans-serif";n.fillStyle="#5BA6EC";n.fillText(text,(U+S)/2,(D+C)/2);n.restore()}},function p(z,A){var x=q(A);n.save();var y=z.getWidth();var C=z.getHeight();n.clearRect(x.x-y/2,x.y-10,y,20);if(l!==null&&d.node!==null&&l.node.id===z.id){n.fillStyle="#FFFFE0"}else{if(d!==null&&d.node!==null&&d.node.id===z.id){n.fillStyle="#EEEEEE"}else{n.fillStyle="#FFFFFF"}}n.fillRect(x.x-y/2,x.y-10,y,20);n.textAlign="left";n.textBaseline="top";n.font="16px Verdana, sans-serif";n.fillStyle="#000000";n.font="16px Verdana, sans-serif";var B=(z.data.label!==undefined)?z.data.label:z.id;n.fillText(B,x.x-y/2+5,x.y-8);n.restore()});m.start();function w(D,C,B,A){var x=((A.y-B.y)*(C.x-D.x)-(A.x-B.x)*(C.y-D.y));if(x===0){return false}var z=((A.x-B.x)*(D.y-B.y)-(A.y-B.y)*(D.x-B.x))/x;var y=((C.x-D.x)*(D.y-B.y)-(C.y-D.y)*(D.x-B.x))/x;if(z<0||z>1||y<0||y>1){return false}return new Springy.Vector(D.x+z*(C.x-D.x),D.y+z*(C.y-D.y))}function u(D,C,A,B,y){var F={x:A.x,y:A.y};var z={x:A.x+B,y:A.y};var x={x:A.x,y:A.y+y};var E={x:A.x+B,y:A.y+y};var G;if(G=w(D,C,F,z)){return G}if(G=w(D,C,z,E)){return G}if(G=w(D,C,E,x)){return G}if(G=w(D,C,x,F)){return G}return false}return this}})();