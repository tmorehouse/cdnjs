(function(){jQuery.fn.springy=function(D){var c=this.graph=D.graph||new Springy.Graph();var p="16px Verdana, sans-serif";var w="8px Verdana, sans-serif";var A=D.stiffness||400;var i=D.repulsion||400;var f=D.damping||0.5;var z=D.nodeSelected||null;var h={};var m=true;var g=this[0];var u=g.getContext("2d");var B=this.layout=new Springy.Layout.ForceDirected(c,A,i,f);var d=B.getBoundingBox();var o={bottomleft:new Springy.Vector(-2,-2),topright:new Springy.Vector(2,2)};Springy.requestAnimationFrame(function v(){o=B.getBoundingBox();d={bottomleft:d.bottomleft.add(o.bottomleft.subtract(d.bottomleft).divide(10)),topright:d.topright.add(o.topright.subtract(d.topright).divide(10))};Springy.requestAnimationFrame(v)});var y=function(G){var F=d.topright.subtract(d.bottomleft);var I=G.subtract(d.bottomleft).divide(F.x).x*g.width;var H=G.subtract(d.bottomleft).divide(F.y).y*g.height;return new Springy.Vector(I,H)};var a=function(I){var H=d.topright.subtract(d.bottomleft);var G=(I.x/g.width)*H.x+d.bottomleft.x;var F=(I.y/g.height)*H.y+d.bottomleft.y;return new Springy.Vector(G,F)};var r=null;var e=null;var n=null;jQuery(g).mousedown(function(G){var H=jQuery(this).offset();var F=a({x:G.pageX-H.left,y:G.pageY-H.top});r=e=n=B.nearest(F);if(r.node!==null){n.point.m=10000;if(z){z(r.node)}}s.start()});jQuery(g).dblclick(function(G){var H=jQuery(this).offset();var F=a({x:G.pageX-H.left,y:G.pageY-H.top});r=B.nearest(F);node=r.node;if(node&&node.data&&node.data.ondoubleclick){node.data.ondoubleclick()}});jQuery(g).mousemove(function(G){var H=jQuery(this).offset();var F=a({x:G.pageX-H.left,y:G.pageY-H.top});e=B.nearest(F);if(n!==null&&n.node!==null){n.point.p.x=F.x;n.point.p.y=F.y}s.start()});jQuery(window).bind("mouseup",function(F){n=null});var l=function(G){var H=(G.data.label!==undefined)?G.data.label:G.id;if(G._width&&G._width[H]){return G._width[H]}u.save();u.font=(G.data.font!==undefined)?G.data.font:p;var F=u.measureText(H).width;u.restore();G._width||(G._width={});G._width[H]=F;return F};var j=function(F){return 16};var t=function(G){var F=(G.data.image.width!==undefined)?G.data.image.width:h[G.data.image.src].object.width;return F};var b=function(G){var F=(G.data.image.height!==undefined)?G.data.image.height:h[G.data.image.src].object.height;return F};Springy.Node.prototype.getHeight=function(){var F;if(this.data.image==undefined){F=j(this)}else{if(this.data.image.src in h&&h[this.data.image.src].loaded){F=b(this)}else{F=10}}return F};Springy.Node.prototype.getWidth=function(){var F;if(this.data.image==undefined){F=l(this)}else{if(this.data.image.src in h&&h[this.data.image.src].loaded){F=t(this)}else{F=10}}return F};var s=this.renderer=new Springy.Renderer(B,function q(){u.clearRect(0,0,g.width,g.height)},function k(O,H,F){var af=y(H).x;var L=y(H).y;var ad=y(F).x;var K=y(F).y;var ah=new Springy.Vector(ad-af,K-L);var aj=ah.normal().normalise();var W=c.getEdges(O.source,O.target);var J=c.getEdges(O.target,O.source);var ak=W.length+J.length;var V=0;for(var ab=0;ab<W.length;ab++){if(W[ab].id===O.id){V=ab}}var M=12;var N=aj.multiply(-((ak-1)*M)/2+(V*M));var ac=6;var Y=6;var I=y(H).add(N);var G=y(F).add(N);var S=O.target.getWidth()+ac;var P=O.target.getHeight()+Y;var R=C(I,G,{x:ad-S/2,y:K-P/2},S,P);if(!R){R=G}var Q=(O.data.color!==undefined)?O.data.color:"#000000";var ae;var U;var T=(O.data.weight!==undefined)?O.data.weight:1;u.lineWidth=Math.max(T*2,0.1);ae=1+u.lineWidth;U=8;var X=(O.data.directional!==undefined)?O.data.directional:true;var aa;if(X){aa=R.subtract(ah.normalise().multiply(U*0.5))}else{aa=G}u.strokeStyle=Q;u.beginPath();u.moveTo(I.x,I.y);u.lineTo(aa.x,aa.y);u.stroke();if(X){u.save();u.fillStyle=Q;u.translate(R.x,R.y);u.rotate(Math.atan2(K-L,ad-af));u.beginPath();u.moveTo(-U,ae);u.lineTo(0,0);u.lineTo(-U,-ae);u.lineTo(-U*0.8,-0);u.closePath();u.fill();u.restore()}if(O.data.label!==undefined){text=O.data.label;u.save();u.textAlign="center";u.textBaseline="top";u.font=(O.data.font!==undefined)?O.data.font:w;u.fillStyle=Q;var ag=Math.atan2(G.y-I.y,G.x-I.x);var ai=-8;if(m&&(ag>Math.PI/2||ag<-Math.PI/2)){ai=8;ag+=Math.PI}var Z=I.add(G).divide(2).add(aj.multiply(ai));u.translate(Z.x,Z.y);u.rotate(ag);u.fillText(text,0,-2);u.restore()}},function x(I,H){var Q=y(H);u.save();var K=6;var J=6;var G=I.getWidth();var O=I.getHeight();var M=G+K;var N=O+J;u.clearRect(Q.x-M/2,Q.y-N/2,M,N);if(r!==null&&r.node!==null&&r.node.id===I.id){u.fillStyle="#FFFFE0"}else{if(e!==null&&e.node!==null&&e.node.id===I.id){u.fillStyle="#EEEEEE"}else{u.fillStyle="#FFFFFF"}}u.fillRect(Q.x-M/2,Q.y-N/2,M,N);if(I.data.image==undefined){u.textAlign="left";u.textBaseline="top";u.font=(I.data.font!==undefined)?I.data.font:p;u.fillStyle="#000000";var P=(I.data.label!==undefined)?I.data.label:I.id;u.fillText(P,Q.x-G/2,Q.y-O/2)}else{var F=I.data.image.src;if(F in h){if(h[F].loaded){u.drawImage(h[F].object,Q.x-G/2,Q.y-O/2,G,O)}}else{h[F]={};var L=new Image();h[F].object=L;L.addEventListener("load",function(){h[F].loaded=true});L.src=F}}u.restore()});s.start();function E(L,K,J,I){var F=((I.y-J.y)*(K.x-L.x)-(I.x-J.x)*(K.y-L.y));if(F===0){return false}var H=((I.x-J.x)*(L.y-J.y)-(I.y-J.y)*(L.x-J.x))/F;var G=((K.x-L.x)*(L.y-J.y)-(K.y-L.y)*(L.x-J.x))/F;if(H<0||H>1||G<0||G>1){return false}return new Springy.Vector(L.x+H*(K.x-L.x),L.y+H*(K.y-L.y))}function C(L,K,I,J,G){var N={x:I.x,y:I.y};var H={x:I.x+J,y:I.y};var F={x:I.x,y:I.y+G};var M={x:I.x+J,y:I.y+G};var O;if(O=E(L,K,N,H)){return O}if(O=E(L,K,H,M)){return O}if(O=E(L,K,M,F)){return O}if(O=E(L,K,F,N)){return O}return false}return this}})();