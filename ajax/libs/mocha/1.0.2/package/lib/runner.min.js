function Runner(t){var e=this;this._globals=[],this.suite=t,this.total=t.total(),this.failures=0,this.on("test end",function(t){e.checkGlobals(t)}),this.on("hook end",function(t){e.checkGlobals(t)}),this.grep(/.*/),this.globals(utils.keys(global).concat(["errno"]))}var EventEmitter=require("events").EventEmitter,debug=require("debug")("runner"),Test=require("./test"),utils=require("./utils"),noop=function(){};module.exports=Runner,Runner.prototype.__proto__=EventEmitter.prototype,Runner.prototype.grep=function(t){return debug("grep %s",t),this._grep=t,this.total=this.grepTotal(this.suite),this},Runner.prototype.grepTotal=function(t){var e=this,n=0;return t.eachTest(function(t){e._grep.test(t.fullTitle())&&n++}),n},Runner.prototype.globals=function(t){return 0==arguments.length?this._globals:(debug("globals %j",t),utils.forEach(t,function(t){this._globals.push(t)},this),this)},Runner.prototype.checkGlobals=function(t){if(!this.ignoreLeaks){var e=utils.filter(utils.keys(global),function(t){return!(~utils.indexOf(this._globals,t)||global.navigator&&"onerror"===t)},this);this._globals=this._globals.concat(e),e.length>1?this.fail(t,new Error("global leaks detected: "+e.join(", "))):e.length&&this.fail(t,new Error("global leak detected: "+e[0]))}},Runner.prototype.fail=function(t,e){++this.failures,t.state="failed",this.emit("fail",t,e)},Runner.prototype.failHook=function(t,e){this.fail(t,e),this.emit("end")},Runner.prototype.hook=function(t,e){function n(t){var i=o[t];return i?(r.currentRunnable=i,r.emit("hook",i),i.on("error",function(t){r.failHook(i,t)}),void i.run(function(e){return i.removeAllListeners("error"),e?r.failHook(i,e):(r.emit("hook end",i),void n(++t))})):e()}var i=this.suite,o=i["_"+t],r=(i._timeout,this);process.nextTick(function(){n(0)})},Runner.prototype.hooks=function(t,e,n){function i(s){return o.suite=s,s?void o.hook(t,function(t){return t?(o.suite=r,n(t)):void i(e.pop())}):(o.suite=r,n())}var o=this,r=this.suite;i(e.pop())},Runner.prototype.hookUp=function(t,e){var n=[this.suite].concat(this.parents()).reverse();this.hooks(t,n,e)},Runner.prototype.hookDown=function(t,e){var n=[this.suite].concat(this.parents());this.hooks(t,n,e)},Runner.prototype.parents=function(){for(var t=this.suite,e=[];t=t.parent;)e.push(t);return e},Runner.prototype.runTest=function(t){var e=this.test,n=this;try{e.on("error",function(t){n.fail(e,t)}),e.run(t)}catch(i){t(i)}},Runner.prototype.runTests=function(t,e){function n(){return o.failures&&t._bail?e():(i=r.shift())?o._grep.test(i.fullTitle())?i.pending?(o.emit("pending",i),o.emit("test end",i),n()):(o.emit("test",o.test=i),void o.hookDown("beforeEach",function(){o.currentRunnable=o.test,o.runTest(function(t){return i=o.test,t?(o.fail(i,t),o.emit("test end",i),o.hookUp("afterEach",n)):(i.state="passed",o.emit("pass",i),o.emit("test end",i),void o.hookUp("afterEach",n))})})):n():e()}var i,o=this,r=t.tests;this.next=n,n()},Runner.prototype.runSuite=function(t,e){function n(){var e=t.suites[s++];return e?void r.runSuite(e,n):i()}function i(){r.suite=t,r.hook("afterAll",function(){r.emit("suite end",t),e()})}var o=this.grepTotal(t),r=this,s=0;return debug("run suite %s",t.fullTitle()),o?(this.emit("suite",this.suite=t),void this.hook("beforeAll",function(){r.runTests(t,n)})):e()},Runner.prototype.uncaught=function(t){debug("uncaught exception");var e=this.currentRunnable;if("failed"!=e.state)return e.clearTimeout(),t.uncaught=!0,this.fail(e,t),"test"==e.type?(this.emit("test end",e),void this.hookUp("afterEach",this.next)):void this.emit("end")},Runner.prototype.run=function(t){var e=this,t=t||function(){};return debug("start"),this.on("end",function(){debug("end"),process.removeListener("uncaughtException",this.uncaught),t(e.failures)}),this.emit("start"),this.runSuite(this.suite,function(){debug("finished running"),e.emit("end")}),process.on("uncaughtException",function(t){e.uncaught(t)}),this};