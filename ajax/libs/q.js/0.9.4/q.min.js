/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
(function(a){if(typeof bootstrap==="function"){bootstrap("promise",a)}else{if(typeof exports==="object"){module.exports=a()}else{if(typeof define==="function"&&define.amd){define(a)}else{if(typeof ses!=="undefined"){if(!ses.ok()){return}else{ses.makeQ=a}}else{Q=a()}}}}})(function(){var f=false;try{throw new Error()}catch(M){f=!!M.stack}var aa=j();var N;var am=function(){};var K;if(typeof setImmediate==="function"){if(typeof window!=="undefined"){K=setImmediate.bind(window)}else{K=setImmediate}}else{if(typeof process!=="undefined"&&process.nextTick){K=process.nextTick}else{(function(){var aH={task:void 0,next:null};var aG=aH;var aJ=2;var aD=0;var aI=0;var aK=0;var aE=void 0;function e(){--aD;if(++aK>=aJ){aK=0;aJ*=4;var aL=aI&&Math.min(aI-1,aJ);while(aD<aL){++aD;aE()}}while(aI){--aI;aH=aH.next;var aM=aH.task;aH.task=void 0;aM()}aK=0}K=function(aL){aG=aG.next={task:aL,next:null};if(aD<++aI&&aD<aJ){++aD;aE()}};if(typeof MessageChannel!=="undefined"){var aF=new MessageChannel();aF.port1.onmessage=e;aE=function(){aF.port2.postMessage(0)}}else{aE=function(){setTimeout(e,0)}}})()}}function u(aD){var e=Function.call;return function(){return e.apply(aD,arguments)}}var al=u(Array.prototype.slice);var V=u(Array.prototype.reduce||function(aF,aE){var e=0,aD=this.length;if(arguments.length===1){do{if(e in this){aE=this[e++];break}if(++e>=aD){throw new TypeError()}}while(1)}for(;e<aD;e++){if(e in this){aE=aF(aE,this[e],e)}}return aE});var ao=u(Array.prototype.indexOf||function(aD){for(var e=0;e<this.length;e++){if(this[e]===aD){return e}}return -1});var A=u(Array.prototype.map||function(aF,aD){var e=this;var aE=[];V(e,function(aI,aH,aG){aE.push(aF.call(aD,aH,aG,e))},void 0);return aE});var C=Object.create||function(aD){function e(){}e.prototype=aD;return new e()};var aw=u(Object.prototype.hasOwnProperty);var z=Object.keys||function(e){var aE=[];for(var aD in e){if(aw(e,aD)){aE.push(aD)}}return aE};var az=u(Object.prototype.toString);function w(e){return e===Object(e)}function x(e){return(az(e)==="[object StopIteration]"||e instanceof I)}var I;if(typeof ReturnValue!=="undefined"){I=ReturnValue}else{I=function(e){this.value=e}}var ak;try{new Function("(function* (){ yield 1; })");ak=true}catch(M){ak=false}Z.longStackJumpLimit=1;var ac="From previous event:";function p(e,aD){if(f&&aD.stack&&typeof e==="object"&&e!==null&&e.stack&&e.stack.indexOf(ac)===-1){e.stack=B(e.stack)+"\n"+ac+"\n"+B(aD.stack)}}function B(aF){var aD=aF.split("\n");var aG=[];for(var aE=0;aE<aD.length;++aE){var e=aD[aE];if(!aq(e)&&!h(e)&&e){aG.push(e)}}return aG.join("\n")}function h(e){return e.indexOf("(module.js:")!==-1||e.indexOf("(node.js:")!==-1}function aj(e){var aF=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(e);if(aF){return[aF[1],Number(aF[2])]}var aE=/at ([^ ]+):(\d+):(?:\d+)$/.exec(e);if(aE){return[aE[1],Number(aE[2])]}var aD=/.*@(.+):(\d+)$/.exec(e);if(aD){return[aD[1],Number(aD[2])]}}function aq(aD){var aE=aj(aD);if(!aE){return false}var aF=aE[0];var e=aE[1];return aF===N&&e>=aa&&e<=ad}function j(){if(!f){return}try{throw new Error()}catch(aG){var aD=aG.stack.split("\n");var aE=aD[0].indexOf("@")>0?aD[1]:aD[2];var aF=aj(aE);if(!aF){return}N=aF[0];return aF[1]}}function Z(e){return Y(e)}Z.nextTick=K;Z.defer=ab;function ab(){var aF=[],aH=[],aG;var aD=C(ab.prototype);var aJ=C(W.prototype);aJ.promiseDispatch=function(aL,aM,aK){var e=al(arguments);if(aF){aF.push(e);if(aM==="when"&&aK[1]){aH.push(aK[1])}}else{K(function(){aG.promiseDispatch.apply(aG,e)})}};aJ.valueOf=function(){if(aF){return aJ}var e=q(aG);if(ap(e)){aG=e}return e};if(Z.longStackJumpLimit>0&&f){try{throw new Error()}catch(aI){aJ.stack=aI.stack.substring(aI.stack.indexOf("\n")+1)}}function aE(e){aG=e;V(aF,function(aL,aK){K(function(){e.promiseDispatch.apply(e,aK)})},void 0);aF=void 0;aH=void 0}aD.promise=aJ;aD.resolve=function(e){if(aG){return}aE(Y(e))};aD.fulfill=function(e){if(aG){return}aE(aA(e))};aD.reject=function(e){if(aG){return}aE(ag(e))};aD.notify=function(e){if(aG){return}V(aH,function(aL,aK){K(function(){aK(e)})},void 0)};return aD}ab.prototype.makeNodeResolver=function(){var e=this;return function(aD,aE){if(aD){e.reject(aD)}else{if(arguments.length>2){e.resolve(al(arguments,1))}else{e.resolve(aE)}}}};Z.promise=t;function t(aD){if(typeof aD!=="function"){throw new TypeError("resolver must be a function.")}var e=ab();s(aD,e.resolve,e.reject,e.notify).fail(e.reject);return e.promise}Z.makePromise=W;function W(aF,aH,e,aD,aE){if(aH===void 0){aH=function(aI){return ag(new Error("Promise does not support operation: "+aI))}}var aG=C(W.prototype);aG.promiseDispatch=function(aL,aM,aJ){var aI;try{if(aF[aM]){aI=aF[aM].apply(aG,aJ)}else{aI=aH.call(aG,aM,aJ)}}catch(aK){aI=ag(aK)}if(aL){aL(aI)}};if(e){aG.valueOf=e}if(aE){aG.exception=aD}return aG}W.prototype.then=function(e,aD,aE){return av(this,e,aD,aE)};W.prototype.thenResolve=function(e){return av(this,function(){return e})};W.prototype.thenReject=function(e){return av(this,function(){throw e})};V(["isFulfilled","isRejected","isPending","dispatch","when","spread","get","set","del","delete","post","send","invoke","keys","fapply","fcall","fbind","all","allResolved","timeout","delay","catch","finally","fail","fin","progress","done","nfcall","nfapply","nfbind","denodeify","nbind","npost","nsend","ninvoke","nodeify"],function(aD,e){W.prototype[e]=function(){return Z[e].apply(Z,[this].concat(al(arguments)))}},void 0);W.prototype.toSource=function(){return this.toString()};W.prototype.toString=function(){return"[object Promise]"};Z.nearer=q;function q(e){if(ap(e)){return e.valueOf()}return e}Z.isPromise=ap;function ap(e){return w(e)&&typeof e.promiseDispatch==="function"}Z.isPromiseAlike=O;function O(e){return w(e)&&typeof e.then==="function"}Z.isPending=S;function S(e){return !d(e)&&!o(e)}Z.isFulfilled=d;function d(e){return !O(q(e))}Z.isRejected=o;function o(e){e=q(e);return ap(e)&&"exception" in e}var r=[];var P=[];var aB=false;var y=true;function U(){if(!aB&&typeof window!=="undefined"&&!window.Touch&&window.console){console.warn("[Q] Unhandled rejection reasons (should be empty):",r)}aB=true}function X(){for(var e=0;e<r.length;e++){var aD=r[e];if(aD&&typeof aD.stack!=="undefined"){console.warn("Unhandled rejection reason:",aD.stack)}else{console.warn("Unhandled rejection reason (no stack):",aD)}}}function ar(){r.length=0;P.length=0;aB=false;if(!y){y=true;if(typeof process!=="undefined"&&process.on){process.on("exit",X)}}}function F(aD,e){if(!y){return}P.push(aD);r.push(e);U()}function k(aE,aD){if(!y){return}var e=ao(P,aE);if(e!==-1){P.splice(e,1);r.splice(e,1)}}Z.resetUnhandledRejections=ar;Z.getUnhandledReasons=function(){return r.slice()};Z.stopUnhandledRejectionTracking=function(){ar();if(typeof process!=="undefined"&&process.on){process.removeListener("exit",X)}y=false};ar();Z.reject=ag;function ag(aE){var aD=W({when:function(aG){if(aG){k(this)}return aG?aG(aE):this}},function aF(){return this},function e(){return this},aE,true);F(aD,aE);return aD}Z.fulfill=aA;function aA(aD){return W({when:function(){return aD},get:function(aE){return aD[aE]},set:function(aE,aF){aD[aE]=aF},"delete":function(aE){delete aD[aE]},post:function(aF,aE){if(aF===null||aF===void 0){return aD.apply(void 0,aE)}else{return aD[aF].apply(aD,aE)}},apply:function(aF,aE){return aD.apply(aF,aE)},keys:function(){return z(aD)}},void 0,function e(){return aD})}Z.resolve=Y;function Y(e){if(ap(e)){return e}e=q(e);if(O(e)){return ay(e)}else{return aA(e)}}function ay(aD){var e=ab();K(function(){try{aD.then(e.resolve,e.reject,e.notify)}catch(aE){e.reject(aE)}});return e.promise}Z.master=g;function g(e){return W({isDef:function(){}},function aD(aF,aE){return aC(e,aF,aE)},function(){return q(e)})}Z.when=av;function av(aI,aH,aJ,aE){var aK=ab();var aF=false;function aG(aN){try{return typeof aH==="function"?aH(aN):aN}catch(aM){return ag(aM)}}function aL(aM){if(typeof aJ==="function"){p(aM,e);try{return aJ(aM)}catch(aN){return ag(aN)}}return ag(aM)}function aD(aM){return typeof aE==="function"?aE(aM):aM}var e=Y(aI);K(function(){e.promiseDispatch(function(aM){if(aF){return}aF=true;aK.resolve(aG(aM))},"when",[function(aM){if(aF){return}aF=true;aK.resolve(aL(aM))}])});e.promiseDispatch(void 0,"when",[void 0,function(aM){var aO;var aP=false;try{aO=aD(aM)}catch(aN){aP=true;if(Z.onerror){Z.onerror(aN)}else{throw aN}}if(!aP){aK.notify(aO)}}]);return aK.promise}Z.spread=G;function G(aE,e,aD){return av(aE,function(aF){return at(aF).then(function(aG){return e.apply(void 0,aG)},aD)},aD)}Z.async=T;function T(e){return function(){function aE(aK,aI){var aH;if(ak){try{aH=aF[aK](aI)}catch(aJ){return ag(aJ)}if(aH.done){return aH.value}else{return av(aH.value,aG,aD)}}else{try{aH=aF[aK](aI)}catch(aJ){if(x(aJ)){return aJ.value}else{return ag(aJ)}}return av(aH,aG,aD)}}var aF=e.apply(this,arguments);var aG=aE.bind(aE,"send");var aD=aE.bind(aE,"throw");return aG()}}Z["return"]=i;function i(e){throw new I(e)}Z.promised=ax;function ax(e){return function(){return G([this,at(arguments)],function(aD,aE){return e.apply(aD,aE)})}}Z.dispatch=aC;function aC(aE,aF,aD){var e=ab();K(function(){Y(aE).promiseDispatch(e.resolve,aF,aD)});return e.promise}Z.dispatcher=E;function E(e){return function(aE){var aD=al(arguments,1);return aC(aE,e,aD)}}Z.get=E("get");Z.set=E("set");Z["delete"]=Z.del=E("delete");var m=Z.post=E("post");Z.send=L;Z.invoke=L;function L(aE,aD){var e=al(arguments,2);return m(aE,aD,e)}Z.fapply=au;function au(aD,e){return aC(aD,"apply",[void 0,e])}Z["try"]=s;Z.fcall=s;function s(aD){var e=al(arguments,1);return au(aD,e)}Z.fbind=ae;function ae(aE){var e=al(arguments,1);return function aD(){var aF=e.concat(al(arguments));return aC(aE,"apply",[this,aF])}}Z.keys=E("keys");Z.all=at;function at(e){return av(e,function(aF){var aE=0;var aD=ab();V(aF,function(aI,aH,aG){if(d(aH)){aF[aG]=q(aH)}else{++aE;av(aH,function(aJ){aF[aG]=aJ;if(--aE===0){aD.resolve(aF)}},aD.reject)}},void 0);if(aE===0){aD.resolve(aF)}return aD.promise})}Z.allResolved=R;function R(e){return av(e,function(aD){aD=A(aD,Y);return av(at(A(aD,function(aE){return av(aE,am,am)})),function(){return aD})})}Z["catch"]=Z.fail=a;function a(aD,e){return av(aD,void 0,e)}Z.progress=D;function D(e,aD){return av(e,void 0,void 0,aD)}Z["finally"]=Z.fin=n;function n(e,aD){return av(e,function(aE){return av(aD(),function(){return aE})},function(aE){return av(aD(),function(){return ag(aE)})})}Z.done=ai;function ai(aH,e,aG,aF){var aD=function(aI){K(function(){p(aI,aH);if(Z.onerror){Z.onerror(aI)}else{throw aI}})};var aE=e||aG||aF?av(aH,e,aG,aF):aH;if(typeof process==="object"&&process&&process.domain){aD=process.domain.bind(aD)}a(aE,aD)}Z.timeout=af;function af(aG,aD,aF){var e=ab();var aE=setTimeout(function(){e.reject(new Error(aF||"Timed out after "+aD+" ms"))},aD);av(aG,function(aH){clearTimeout(aE);e.resolve(aH)},function(aH){clearTimeout(aE);e.reject(aH)},e.notify);return e.promise}Z.delay=b;function b(aE,aD){if(aD===void 0){aD=aE;aE=void 0}var e=ab();av(aE,undefined,undefined,e.notify);setTimeout(function(){e.resolve(aE)},aD);return e.promise}Z.nfapply=v;function v(aF,aD){var aE=al(aD);var e=ab();aE.push(e.makeNodeResolver());au(aF,aE).fail(e.reject);return e.promise}Z.nfcall=H;function H(aE){var aD=al(arguments,1);var e=ab();aD.push(e.makeNodeResolver());au(aE,aD).fail(e.reject);return e.promise}Z.nfbind=an;Z.denodeify=Z.nfbind;function an(aD){var e=al(arguments,1);return function(){var aF=e.concat(al(arguments));var aE=ab();aF.push(aE.makeNodeResolver());au(aD,aF).fail(aE.reject);return aE.promise}}Z.nbind=l;function l(aE,e){var aD=al(arguments,2);return function(){var aH=aD.concat(al(arguments));var aF=ab();aH.push(aF.makeNodeResolver());function aG(){return aE.apply(e,arguments)}au(aG,aH).fail(aF.reject);return aF.promise}}Z.npost=J;function J(aF,aE,aD){var aG=al(aD||[]);var e=ab();aG.push(e.makeNodeResolver());m(aF,aE,aG).fail(e.reject);return e.promise}Z.nsend=ah;Z.ninvoke=Z.nsend;function ah(aE,aD){var aF=al(arguments,2);var e=ab();aF.push(e.makeNodeResolver());m(aE,aD,aF).fail(e.reject);return e.promise}Z.nodeify=c;function c(aD,e){if(e){aD.then(function(aE){K(function(){e(null,aE)})},function(aE){K(function(){e(aE)})})}else{return aD}}var ad=j();return Z});