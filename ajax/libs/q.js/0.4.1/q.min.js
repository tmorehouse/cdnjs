(function(x,h){var s;try{s=require("event-queue").enqueue}catch(w){s=function(e){setTimeout(e,0)}}function y(e){return e}var b=Object.freeze||y;var o=Object.create||function o(z){var e=function(){};e.prototype=z;return new e()};var f=typeof console==="undefined"?y:function(e){console.log(e)};x.enqueue=s;x.defer=c;function c(){var B=[],z;var A=o(d.prototype);A.promiseSend=function(){var C=Array.prototype.slice.call(arguments);if(B){B.push(C)}else{n.apply(h,[z].concat(C))}};A.valueOf=function(){if(B){return A}return l(z)};var e=function(C){var E,F,D;if(!B){return}z=i(C);for(E=0,F=B.length;E<F;++E){n.apply(h,[z].concat(B[E]))}B=h;return z};return{promise:b(A),resolve:e,reject:function(C){return e(g(C))}}}x.makePromise=d;function d(z,B,e){if(B===h){B=function(C){return g("Promise does not support operation: "+C)}}var A=o(d.prototype);A.promiseSend=function(F,D){var E=Array.prototype.slice.call(arguments,2);var C;if(z[F]){C=z[F].apply(z,E)}else{C=B.apply(z,[F].concat(E))}D=D||y;return D(C)};if(e){A.valueOf=e}return b(A)}d.prototype.then=function(e,z){return j(this,e,z)};d.prototype.end=function(){return j(this,h,t)};d.prototype.toSource=function(){return this.toString()};d.prototype.toString=function(){return"[object Promise]"};b(d.prototype);x.isPromise=q;function q(e){return e&&typeof e.promiseSend==="function"}x.isResolved=m;function m(e){return !q(l(e.valueOf()))}x.isFulfilled=u;function u(e){return !q(l(e))&&!r(e)}x.isRejected=r;function r(e){e=l(e);if(e===h||e===null){return false}return !!e.promiseRejected}x.reject=g;function g(z){return d({when:function(B){return B?B(z):g(z)}},function A(B){return g(z)},function e(){var B=o(g.prototype);B.promiseRejected=true;B.reason=z;return B})}g.prototype=o(d.prototype,{constructor:{value:g}});x.ref=i;function i(z){if(q(z)){return z}if(z&&typeof z.then==="function"){return d({},function A(D,C){if(D!=="when"){return Q.when(z,function(E){return Q.ref(E).promiseSend.apply(null,arguments)})}else{var B=c();z.then(B.resolve,B.reject);return B.promise}})}return d({when:function(B){return z},get:function(B){if(z===h||z===null){return g("Cannot access property "+B+" of "+z)}return z[B]},put:function(B,C){if(z===h||z===null){return g("Cannot set property "+B+" of "+z+" to "+C)}return z[B]=C},del:function(B){if(z===h||z===null){return g("Cannot delete property "+B+" of "+z)}return delete z[B]},post:function(B,C){if(z===h||z===null){return g(""+z+" has no methods")}var D=z[B];if(!D){return g("No such method "+B+" on object "+z)}if(!D.apply){return g("Property "+B+" on object "+z+" is not a method")}return z[B].apply(z,C)},keys:function(){return Object.keys(z)}},h,function e(){return z})}x.def=p;function p(z){return d({isDef:function(){}},function A(C){var B=Array.prototype.slice.call(arguments);return k.apply(h,[z].concat(B))},function e(){return z.valueOf()})}x.when=j;function j(D,A,C){var B=c();var z=false;function e(G){try{return A?A(G):G}catch(F){if(typeof process!=="undefined"){process.emit("uncaughtException",F)}else{f(F&&F.stack||F)}return g(F)}}function E(G){try{return C?C(G):g(G)}catch(F){f(F&&F.stack||F);return g(F)}}n(i(D),"when",function(F){if(z){return}z=true;B.resolve(i(F).promiseSend("when",e,E))},function(F){if(z){return}z=true;B.resolve(E(F))});return B.promise}x.asap=function(A,e,z){e=e||y;if(u(A)){return l(e(l(A)))}else{if(r(A)){var B=A.valueOf().reason;if(z){return z(B)}else{throw B}}else{return j(A,e,z)}}};var l=function(e){if(e===h||e===null){return e}else{return e.valueOf()}};x.Method=a;function a(e){return function(A){var z=Array.prototype.slice.call(arguments,1);return k.apply(h,[A,e].concat(z))}}x.send=k;function k(A,B){var e=c();var z=Array.prototype.slice.call(arguments,2);n.apply(h,[i(A),B,e.resolve].concat(z));return e.promise}x.get=a("get");x.put=a("put");x.del=a("del");var v=x.post=a("post");x.invoke=function(A,z){var e=Array.prototype.slice.call(arguments,2);return v(A,z,e)};x.keys=a("keys");x.error=t;function t(e){throw e}function n(z){var e=Array.prototype.slice.call(arguments,1);s(function(){z.promiseSend.apply(z,e)})}})(typeof exports!=="undefined"?exports:Q={});