/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 */
(function(a,b){if(typeof define==="function"){define(function(d,c,e){a(d,c,e)})}else{if(typeof exports==="object"){a(require,exports,module)}else{Q=a(b,{},{})}}})(function(h,J,a,g){var M;try{M=h("event-queue").enqueue}catch(L){if(typeof MessageChannel!=="undefined"){var A=new MessageChannel();var k={},O=k;A.port1.onmessage=function(){var P=k.next;var e=P.task;k=P;e()};M=function(e){O=O.next={task:e};A.port2.postMessage()}}else{M=function(e){setTimeout(e,0)}}}function H(e){return e}var E=function(P,e,R){if(!P[e]){P[e]=R}return P[e]};var o=E(Object,"freeze",H);var d=E(Object,"create",function(P){var e=function(){};e.prototype=P;return new e()});var w=E(Object,"keys",function(e){var R=[];for(var P in e){R.push(P)}return R});var m=Array.prototype.reduce||function(S,R){var e=0,P=this.length;if(arguments.length==1){do{if(e in this){R=this[e++];break}if(++e>=P){throw new TypeError()}}while(1)}for(;e<P;e++){if(e in this){R=S(R,this[e],e)}}return R};var l=function(e){return Object.prototype.toString.call(e)==="[object StopIteration]"};var n=Array.prototype.slice;var K=null;var j=function(e){if(e===g||e===K){return e}else{return e.valueOf()}};J.enqueue=J.nextTick=M;J.defer=c;function c(){var S=[],P;var R=d(y.prototype);R.promiseSend=function(){var T=n.call(arguments);if(S){S.push(T)}else{M(function(){P.promiseSend.apply(P,T)})}};R.valueOf=function(){if(S){return R}return P.valueOf()};var e=function(T){var V,W,U;if(!S){return}P=G(T);m.call(S,function(Y,X){M(function(){P.promiseSend.apply(P,X)})},g);S=g;return P};return{promise:o(R),resolve:e,reject:function(T){return e(v(T))}}}J.makePromise=y;function y(P,S,e){if(S===g){S=function(T){return v("Promise does not support operation: "+T)}}var R=d(y.prototype);R.promiseSend=function(X,U){var V=n.call(arguments,2);var T;try{if(P[X]){T=P[X].apply(P,V)}else{T=S.apply(P,[X].concat(V))}}catch(W){T=v(W)}return(U||H)(T)};if(e){R.valueOf=e}return o(R)}y.prototype.then=function(e,P){return z(this,e,P)};m.call(["when","send","get","put","del","post","invoke","keys","apply","call","all","wait","join","fail","fin","spy","view","viewInfo","end"],function(P,e){y.prototype[e]=function(){return J[e].apply(J,[this].concat(n.call(arguments)))}},g);y.prototype.toSource=function(){return this.toString()};y.prototype.toString=function(){return"[object Promise]"};o(y.prototype);J.isPromise=s;function s(e){return e&&typeof e.promiseSend==="function"}J.isResolved=b;function b(e){return !s(j(e))}J.isFulfilled=B;function B(e){return !s(j(e))&&!D(e)}J.isRejected=D;function D(e){e=j(e);if(e===g||e===K){return false}return !!e.promiseRejected}J.reject=v;function v(P){return y({when:function(S){return S?S(P):v(P)}},function R(S){return v(P)},function e(){var S=d(v.prototype);S.promiseRejected=true;S.reason=P;return S})}v.prototype=d(y.prototype,{constructor:{value:v}});J.ref=G;function G(P){if(s(P)){return P}if(P&&typeof P.then==="function"){return y({},function R(U,T){if(U!=="when"){return z(P,function(V){return G(V).promiseSend.apply(g,arguments)})}else{var S=c();P.then(S.resolve,S.reject);return S.promise}})}return y({when:function(S){return P},get:function(S){return P[S]},put:function(S,T){return P[S]=T},del:function(S){return delete P[S]},post:function(S,T){return P[S].apply(P,T)},apply:function(S,T){return P.apply(S,T)},viewInfo:function(){var S=P;var T={};while(S){Object.getOwnPropertyNames(S).forEach(function(U){if(!T[U]){T[U]=typeof S[U]}});S=Object.getPrototypeOf(S)}return{type:typeof P,properties:T}},keys:function(){return w(P)}},g,function e(){return P})}J.master=J.def=t;function t(e){return y({isDef:function(){}},function P(S){var R=n.call(arguments);return x.apply(g,[e].concat(R))},function(){return j(e)})}J.viewInfo=I;function I(e,P){e=G(e);if(P){return y({viewInfo:function(){return P}},function R(T){var S=n.call(arguments);return x.apply(g,[e].concat(S))},function(){return j(e)})}else{return x(e,"viewInfo")}}J.view=function(e){return I(e).when(function(S){var P;if(S.type==="function"){P=function(){return N(e,g,arguments)}}else{P={}}var R=S.properties||{};Object.keys(R).forEach(function(T){if(R[T]==="function"){P[T]=function(){return q(e,T,arguments)}}});return G(P)})};J.when=z;function z(U,R,T){var S=c();var P=false;function e(X){try{return R?R(X):X}catch(W){return v(W)}}function V(X){try{return T?T(X):v(X)}catch(W){return v(W)}}M(function(){G(U).promiseSend("when",function(W){if(P){return}P=true;S.resolve(G(W).promiseSend("when",e,V))},function(W){if(P){return}P=true;S.resolve(V(W))})});return S.promise}J.async=C;function C(e){return function(){var R=function(X,V){var U;try{U=S[X](V)}catch(W){if(l(W)){return W.value}else{return v(W)}}return z(U,T,P)};var S=e.apply(this,arguments);var T=R.bind(R,"send");var P=R.bind(R,"throw");return T()}}J.Method=u;function u(e){return function(R){var P=n.call(arguments,1);return x.apply(g,[R,e].concat(P))}}J.send=x;function x(R,S){var e=c();var P=n.call(arguments,2);R=G(R);M(function(){R.promiseSend.apply(R,[S,e.resolve].concat(P))});return e.promise}J.get=u("get");J.put=u("put");J.del=u("del");var q=J.post=u("post");J.invoke=function(R,P){var e=n.call(arguments,2);return q(R,P,e)};var N=J.apply=u("apply");J.call=function(R,P){var e=n.call(arguments,2);return N(R,P,e)};J.keys=u("keys");J.all=r;function r(e){return z(e,function(T){var S=T.length;var R=[];if(S===0){return G(R)}var P=c();m.call(T,function(W,V,U){z(V,function(X){R[U]=X;if(--S===0){P.resolve(R)}},P.reject)},g);return P.promise})}J.wait=function(e){return r(arguments).get(0)};J.join=function(){var e=n.call(arguments);var P=e.pop();return r(e).then(function(R){return P.apply(g,R)})};J.fail=f;function f(P,e){return z(P,g,e)}J.spy=J.fin=F;function F(e,P){return z(e,function(R){return z(P(),function(){return R})},function(R){return z(P(),function(){return v(R)})})}J.end=p;function p(e){z(e,g,function(P){M(function(){throw P})})}for(var i in J){G[i]=J[i]}a.exports=G;return G});