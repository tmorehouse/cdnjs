/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 */
(function(a,b){if(typeof define==="function"){define(function(d,c){a(d,c)})}else{if(typeof exports==="object"){a(require,exports)}else{a(b,Q={})}}})(function(D,F,k){var x;try{x=D("event-queue").enqueue}catch(E){if(typeof MessageChannel!=="undefined"){var H=new MessageChannel();x=function(e){H.port1.onmessage=e;H.port2.postMessage()}}else{x=function(e){setTimeout(e,0)}}}function G(e){return e}var b=Object.freeze||G;var r=Object.create||function r(I){var e=function(){};e.prototype=I;return new e()};var u=Object.keys||function(e){var J=[];for(var I in e){J.push(I)}return J};var s=Array.prototype.reduce||function(K,J){for(var e=0,I=this.length;e<I;e++){J=K(J,this[e],e)}return J};var f=typeof console==="undefined"?G:function(e){console.log(e)};F.enqueue=x;F.defer=c;function c(){var K=[],I;var J=r(d.prototype);J.promiseSend=function(){var L=Array.prototype.slice.call(arguments);if(K){K.push(L)}else{q.apply(k,[I].concat(L))}};J.valueOf=function(){if(K){return J}return o(I)};var e=function(L){var N,O,M;if(!K){return}I=j(L);for(N=0,O=K.length;N<O;++N){q.apply(k,[I].concat(K[N]))}K=k;return I};return{promise:b(J),resolve:e,reject:function(L){return e(i(L))}}}F.makePromise=d;function d(I,K,e){if(K===k){K=function(L){return i("Promise does not support operation: "+L)}}var J=r(d.prototype);J.promiseSend=function(O,M){var N=Array.prototype.slice.call(arguments,2);var L;if(I[O]){L=I[O].apply(I,N)}else{L=K.apply(I,[O].concat(N))}M=M||G;return M(L)};if(e){J.valueOf=e}return b(J)}d.prototype.then=function(e,I){return m(this,e,I)};s.call(["get","put","del","post","invoke","keys","apply","call","wait","join","fail","fin","spy","report","end"],function(I,e){d.prototype[e]=function(){return F[e].apply(F,[this].concat(Array.prototype.slice.call(arguments)))}},k);d.prototype.toSource=function(){return this.toString()};d.prototype.toString=function(){return"[object Promise]"};b(d.prototype);F.isPromise=v;function v(e){return e&&typeof e.promiseSend==="function"}F.isResolved=p;function p(e){return !v(o(e.valueOf()))}F.isFulfilled=z;function z(e){return !v(o(e))&&!w(e)}F.isRejected=w;function w(e){e=o(e);if(e===k||e===null){return false}return !!e.promiseRejected}F.reject=i;function i(I){return d({when:function(K){return K?K(I):i(I)}},function J(K){return i(I)},function e(){var K=r(i.prototype);K.promiseRejected=true;K.reason=I;return K})}i.prototype=r(d.prototype,{constructor:{value:i}});F.ref=j;function j(I){if(v(I)){return I}if(I&&typeof I.then==="function"){return d({},function J(M,L){if(M!=="when"){return m(I,function(N){return j(N).promiseSend.apply(null,arguments)})}else{var K=c();I.then(K.resolve,K.reject);return K.promise}})}return d({when:function(K){return I},get:function(K){if(I===k||I===null){return i("Cannot access property "+K+" of "+I)}return I[K]},put:function(K,L){if(I===k||I===null){return i("Cannot set property "+K+" of "+I+" to "+L)}return I[K]=L},del:function(K){if(I===k||I===null){return i("Cannot delete property "+K+" of "+I)}return delete I[K]},post:function(K,L){if(I===k||I===null){return i(""+I+" has no methods")}var M=I[K];if(!M){return i("No such method "+K+" on object "+I)}if(!M.apply){return i("Property "+K+" on object "+I+" is not a method")}return I[K].apply(I,L)},apply:function(K,L){if(!I||typeof I.apply!=="function"){return i(""+I+" is not a function")}return I.apply(K,L)},keys:function(){return u(I)}},k,function e(){return I})}F.master=F.def=t;function t(I){return d({isDef:function(){}},function J(L){var K=Array.prototype.slice.call(arguments);return n.apply(k,[I].concat(K))},function e(){return I.valueOf()})}F.when=m;function m(M,J,L){var K=c();var I=false;function e(P){try{return J?J(P):P}catch(O){return i(O)}}function N(P){try{return L?L(P):i(P)}catch(O){return i(O)}}q(j(M),"when",function(O){if(I){return}I=true;K.resolve(j(O).promiseSend("when",e,N))},function(O){if(I){return}I=true;K.resolve(N(O))});return K.promise}F.asap=function(J,e,I){e=e||G;if(z(J)){return o(e(o(J)))}else{if(w(J)){var K=J.valueOf().reason;if(I){return I(K)}else{throw K}}else{return m(J,e,I)}}};var o=function(e){if(e===k||e===null){return e}else{return e.valueOf()}};F.Method=a;function a(e){return function(J){var I=Array.prototype.slice.call(arguments,1);return n.apply(k,[J,e].concat(I))}}F.send=n;function n(J,K){var e=c();var I=Array.prototype.slice.call(arguments,2);q.apply(k,[j(J),K,e.resolve].concat(I));return e.promise}F.get=a("get");F.put=a("put");F.del=a("del");var B=F.post=a("post");F.invoke=function(J,I){var e=Array.prototype.slice.call(arguments,2);return B(J,I,e)};var y=F.apply=a("apply");F.call=function(J,I){var e=Array.prototype.slice.call(arguments,2);return y(J,I,e)};F.keys=a("keys");F.wait=function(I){var e=Array.prototype.slice.call(arguments,1);return s.call(e,function(K,J){return m(J,function(){return K})},I)};F.join=function(){var e=Array.prototype.slice.call(arguments);var I=e.pop();return s.call(e,function(J,L,K){return m(L,function(M){return m(J,function(){e[K]=M})})},k).then(function(){return I.apply(k,e)})};F.fail=l;function l(I,e){return m(I,k,e)}F.fin=C;function C(e,I){return m(e,function(J){return I(J,k)},function(J){return I(k,J)})}F.spy=g;function g(e,I){return m(e,function(J){I(J,k);return J},function(J){I(k,J);return i(J)})}F.report=A;function A(J,I){var e=new Error(I||"REPORT");return g(J,function(K,L){f(e&&e.stack||e);if(L){f(L&&L.stack||L)}else{f(K)}})}F.end=h;function h(e){m(e,k,function(I){x(function(){throw I})})}function q(I){var e=Array.prototype.slice.call(arguments,1);x(function(){I.promiseSend.apply(I,e)})}});