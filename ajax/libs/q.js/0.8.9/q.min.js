/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * With formatStackTrace and formatSourcePosition functions
 * Copyright 2006-2008 the V8 project authors. All rights reserved.
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *     * Neither the name of Google Inc. nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
(function(a){if(typeof bootstrap==="function"){bootstrap("promise",a)}else{if(typeof exports==="object"){a(void 0,exports)}else{if(typeof define==="function"){define(a)}else{if(typeof ses!=="undefined"){if(!ses.ok()){return}else{ses.makeQ=function(){var b={};return a(void 0,b)}}}else{a(void 0,Q={})}}}}})(function(al,H){var T=g();var K;var ai=function(){};var Z=Object.freeze||ai;if(typeof cajaVM!=="undefined"){Z=cajaVM.def}var G;if(typeof process!=="undefined"){G=process.nextTick}else{if(typeof msSetImmediate==="function"){G=msSetImmediate.bind(window)}else{if(typeof setImmediate==="function"){G=setImmediate}else{if(typeof MessageChannel!=="undefined"){var ae=new MessageChannel();var r={},y=r;ae.port1.onmessage=function(){r=r.next;var az=r.task;delete r.task;az()};G=function(az){y=y.next={task:az};ae.port2.postMessage(0)}}else{G=function(az){setTimeout(az,0)}}}}}var q;if(Function.prototype.bind){var B=Function.prototype.bind;q=B.bind(B.call)}else{q=function(az){return function(){return az.call.apply(az,arguments)}}}var ag=q(Array.prototype.slice);var N=q(Array.prototype.reduce||function(aC,aB){var az=0,aA=this.length;if(arguments.length===1){do{if(az in this){aB=this[az++];break}if(++az>=aA){throw new TypeError()}}while(1)}for(;az<aA;az++){if(az in this){aB=aC(aB,this[az],az)}}return aB});var aj=q(Array.prototype.indexOf||function(aA){for(var az=0;az<this.length;az++){if(this[az]===aA){return az}}return -1});var v=q(Array.prototype.map||function(aC,aA){var az=this;var aB=[];N(az,function(aF,aE,aD){aB.push(aC.call(aA,aE,aD,az))},void 0);return aB});var w=Object.create||function(aA){function az(){}az.prototype=aA;return new az()};var u=Object.keys||function(az){var aB=[];for(var aA in az){aB.push(aA)}return aB};var aw=Object.prototype.toString;function t(az){return(aw(az)==="[object StopIteration]"||az instanceof C)}var C;if(typeof ReturnValue!=="undefined"){C=ReturnValue}else{C=function(az){this.value=az}}function ac(aC,aG){var aB=[];try{aB.push(aC.toString())}catch(aE){try{aB.push("<error: "+aE+">")}catch(aA){aB.push("<error>")}}for(var aD=0;aD<aG.length;aD++){var aF=aG[aD];var az;if(typeof aF==="string"){aB.push(aF)}else{try{az=P(aF)}catch(aE){try{az="<error: "+aE+">"}catch(aA){az="<error>"}}aB.push("    at "+az)}}return aB.join("\n")}function P(aA){var aE="";if(aA.isNative()){aE="native"}else{if(aA.isEval()){aE="eval at "+aA.getEvalOrigin()}else{var aC=aA.getFileName();if(aC){aE+=aC;var aB=aA.getLineNumber();if(aB!==null){aE+=":"+aB;var az=aA.getColumnNumber();if(az){aE+=":"+az}}}}}if(!aE){aE="unknown source"}var aJ="";var aF=aA.getFunction().name;var aI=true;var aH=aA.isConstructor();var aD=!(aA.isToplevel()||aH);if(aD){var aG=aA.getMethodName();aJ+=aA.getTypeName()+".";if(aF){aJ+=aF;if(aG&&(aG!==aF)){aJ+=" [as "+aG+"]"}}else{aJ+=aG||"<anonymous>"}}else{if(aH){aJ+="new "+(aF||"<anonymous>")}else{if(aF){aJ+=aF}else{aJ+=aE;aI=false}}}if(aI){aJ+=" ("+aE+")"}return aJ}function am(aB,aA){if(aB!==K){return false}var az=aA.getLineNumber();return az>=T&&az<=W}function S(aB){var aA=Error.prepareStackTrace;Error.prepareStackTrace=function(aC,aD){return aD.filter(function(aE){var aF=aE.getFileName();return(aF!=="module.js"&&aF!=="node.js"&&!am(aF,aE))})};var az=aB.stack;Error.prepareStackTrace=aA;return az}function g(){if(Error.captureStackTrace){var aB,az;var aA=Error.prepareStackTrace;Error.prepareStackTrace=function(aC,aD){aB=aD[1].getFileName();az=aD[1].getLineNumber()};new Error().stack;Error.prepareStackTrace=aA;K=aB;return az}}function av(aB,az,aA){return function(){if(typeof console!=="undefined"&&typeof console.warn==="function"){console.warn(az+" is deprecated, use "+aA+" instead.",new Error("").stack)}return aB.apply(aB,arguments)}}H.nextTick=G;H.defer=U;function U(){var aE=[],aC=[],aB;var az=w(U.prototype);var aD=w(O.prototype);aD.promiseSend=function(aJ,aH,aI,aG){var aF=ag(arguments);if(aE){aE.push(aF);if(aJ==="when"&&aG){aC.push(aG)}}else{G(function(){aB.promiseSend.apply(aB,aF)})}};aD.valueOf=function(){if(aE){return aD}return aB.valueOf()};if(Error.captureStackTrace){Error.captureStackTrace(aD,U)}function aA(aF){if(!aE){return}aB=R(aF);N(aE,function(aH,aG){G(function(){aB.promiseSend.apply(aB,aG)})},void 0);aE=void 0;aC=void 0;return aB}Z(aD);az.promise=aD;az.resolve=aA;az.reject=function(aF){return aA(ab(aF))};az.notify=function(){if(aE){var aF=arguments;N(aC,function(aH,aG){G(function(){aG.apply(void 0,aF)})},void 0)}};return az}U.prototype.makeNodeResolver=function(){var az=this;return function(aA,aB){if(aA){az.reject(aA)}else{if(arguments.length>2){az.resolve(ag(arguments,1))}else{az.resolve(aB)}}}};U.prototype.node=av(U.prototype.makeNodeResolver,"node","makeNodeResolver");H.promise=p;function p(aA){var az=U();o(aA,az.resolve,az.reject,az.notify).fail(az.reject);return az.promise}H.makePromise=O;function O(aB,aD,az,aA){if(aD===void 0){aD=function(aE){return ab(new Error("Promise does not support operation: "+aE))}}var aC=w(O.prototype);aC.promiseSend=function(aI,aF){var aG=ag(arguments,2);var aE;try{if(aB[aI]){aE=aB[aI].apply(aC,aG)}else{aE=aD.apply(aC,[aI].concat(aG))}}catch(aH){aE=ab(aH)}if(aF){aF(aE)}};if(az){aC.valueOf=az}if(aA){aC.exception=aA}Z(aC);return aC}O.prototype.then=function(az,aA,aB){return ap(this,az,aA,aB)};N(["isResolved","isFulfilled","isRejected","when","spread","send","get","put","del","post","invoke","keys","apply","call","bind","fapply","fcall","fbind","all","allResolved","view","viewInfo","timeout","delay","catch","finally","fail","fin","progress","end","ncall","napply","nbind","npost","ninvoke","nend"],function(aA,az){O.prototype[az]=function(){return H[az].apply(H,[this].concat(ag(arguments)))}},void 0);O.prototype.toSource=function(){return this.toString()};O.prototype.toString=function(){return"[object Promise]"};Z(O.prototype);H.nearer=n;function n(az){if(Object(az)!==az){return az}else{return az.valueOf()}}H.isPromise=ak;function ak(az){return az&&typeof az.promiseSend==="function"}H.isResolved=ar;function ar(az){return c(az)||l(az)}H.isFulfilled=c;function c(az){return !ak(n(az))}H.isRejected=l;function l(az){az=n(az);return ak(az)&&"exception" in az}var J=[];var V=[];var m;function h(){if(!m&&typeof window!=="undefined"&&!window.Touch&&window.console){console.log("Should be empty:",V)}m=true}H.reject=ab;function ab(aB){aB=aB||new Error();var aA=O({when:function(aE){if(aE){var aD=aj(J,this);if(aD!==-1){V.splice(aD,1);J.splice(aD,1)}}return aE?aE(aB):ab(aB)}},function aC(){return ab(aB)},function az(){return this},aB);h();J.push(aA);V.push(aB);return aA}H.begin=R;H.resolve=R;H.ref=av(R,"ref","resolve");function R(aB){if(ak(aB)){return aB}aB=az(aB);if(aB&&typeof aB.then==="function"){var aA=U();aB.then(aA.resolve,aA.reject,aA.notify);return aA.promise}return O({when:function(){return aB},get:function(aC){return aB[aC]},put:function(aC,aD){aB[aC]=aD;return aB},del:function(aC){delete aB[aC];return aB},post:function(aC,aD){return aB[aC].apply(aB,aD)},apply:function(aC,aD){return aB.apply(aC,aD)},fapply:function(aC){return aB.apply(void 0,aC)},viewInfo:function(){var aC=aB;var aD={};function aE(aF){if(!aD[aF]){aD[aF]=typeof aC[aF]}}while(aC){Object.getOwnPropertyNames(aC).forEach(aE);aC=Object.getPrototypeOf(aC)}return{type:typeof aB,properties:aD}},keys:function(){return u(aB)}},void 0,function az(){return aB})}H.master=d;function d(az){return O({isDef:function(){}},function aA(){var aB=ag(arguments);return I.apply(void 0,[az].concat(aB))},function(){return n(az)})}H.viewInfo=ax;function ax(az,aA){az=R(az);if(aA){return O({viewInfo:function(){return aA}},function aB(){var aC=ag(arguments);return I.apply(void 0,[az].concat(aC))},function(){return n(az)})}else{return I(az,"viewInfo")}}H.view=ah;function ah(az){return ax(az).when(function(aC){var aA;if(aC.type==="function"){aA=function(){return au(az,void 0,arguments)}}else{aA={}}var aB=aC.properties||{};u(aB).forEach(function(aD){if(aB[aD]==="function"){aA[aD]=function(){return j(az,aD,arguments)}}});return R(aA)})}H.when=ap;function ap(aE,aD,aF,aA){var aG=U();var aB=false;function aC(aJ){try{return aD?aD(aJ):aJ}catch(aI){return ab(aI)}}function aH(aI){try{return aF?aF(aI):ab(aI)}catch(aJ){return ab(aJ)}}var az=R(aE);G(function(){az.promiseSend("when",function(aI){if(aB){return}aB=true;aG.resolve(aC(aI))},function(aI){if(aB){return}aB=true;aG.resolve(aH(aI))})});if(aA){az.promiseSend("when",void 0,void 0,aA)}return aG.promise}H.spread=A;function A(aB,az,aA){return ap(aB,function(aC){return an(aC).then(function(aD){return az.apply(void 0,aD)})},aA)}H.async=M;function M(az){return function(){function aB(aH,aF){var aE;try{aE=aC[aH](aF)}catch(aG){if(t(aG)){return aG.value}else{return ab(aG)}}return ap(aE,aD,aA)}var aC=az.apply(this,arguments);var aD=aB.bind(aB,"send");var aA=aB.bind(aB,"throw");return aD()}}H["return"]=e;function e(az){throw new C(az)}H.promised=at;function at(az){return function(){return an([this,an(arguments)]).spread(function(aA,aB){return az.apply(aA,aB)})}}H.sender=av(X,"sender","dispatcher");H.Method=av(X,"Method","dispatcher");function X(az){return function(aB){var aA=ag(arguments,1);return I.apply(void 0,[aB,az].concat(aA))}}H.send=av(I,"send","dispatch");function I(aB,aC){var az=U();var aA=ag(arguments,2);aB=R(aB);G(function(){aB.promiseSend.apply(aB,[aC,az.resolve].concat(aA))});return az.promise}H.dispatch=ay;function ay(aB,aC,aA){var az=U();aB=R(aB);G(function(){aB.promiseSend.apply(aB,[aC,az.resolve].concat(aA))});return az.promise}H.dispatcher=z;function z(az){return function(aB){var aA=ag(arguments,1);return ay(aB,az,aA)}}H.get=z("get");H.put=z("put");H["delete"]=H.del=z("del");var j=H.post=z("post");H.invoke=function(aB,aA){var az=ag(arguments,2);return j(aB,aA,az)};var au=H.apply=av(z("apply"),"apply","fapply");var ao=H.fapply=z("fapply");H.call=av(F,"call","fcall");function F(aB,aA){var az=ag(arguments,2);return au(aB,aA,az)}H["try"]=o;H.fcall=o;function o(aA){var az=ag(arguments,1);return ao(aA,az)}H.bind=av(aq,"bind","fbind");function aq(aC,aA){var az=ag(arguments,2);return function aB(){var aD=az.concat(ag(arguments));return au(aC,aA,aD)}}H.fbind=Y;function Y(aB){var az=ag(arguments,1);return function aA(){var aC=az.concat(ag(arguments));return ao(aB,aC)}}H.keys=z("keys");H.all=an;function an(az){return ap(az,function(aC){var aB=aC.length;if(aB===0){return R(aC)}var aA=U();N(aC,function(aF,aE,aD){if(c(aE)){aC[aD]=n(aE);if(--aB===0){aA.resolve(aC)}}else{ap(aE,function(aG){aC[aD]=aG;if(--aB===0){aA.resolve(aC)}}).fail(aA.reject)}},void 0);return aA.promise})}H.allResolved=L;function L(az){return ap(az,function(aA){return ap(an(v(aA,function(aB){return ap(aB,ai,ai)})),function(){return v(aA,R)})})}H["catch"]=H.fail=a;function a(aA,az){return ap(aA,void 0,az)}H.progress=x;function x(az,aA){ap(az,void 0,void 0,aA);return az}H["finally"]=H.fin=k;function k(az,aA){return ap(az,function(aB){return ap(aA(),function(){return aB})},function(aB){return ap(aA(),function(){return ab(aB)})})}H.end=E;function E(az){ap(az,void 0,function(aA){G(function(){var aB;if(Error.captureStackTrace&&typeof aA==="object"&&(aB=S(aA))){var aC=S(az);var aD=aB.concat("From previous event:",aC);aA.stack=ac(aA,aD)}throw aA})})}H.timeout=aa;function aa(aC,aA){var az=U();var aB=setTimeout(function(){az.reject(new Error("Timed out after "+aA+" ms"))},aA);ap(aC,function(aD){clearTimeout(aB);az.resolve(aD)},az.reject);return az.promise}H.delay=b;function b(aB,aA){if(aA===void 0){aA=aB;aB=void 0}var az=U();setTimeout(function(){az.resolve(aB)},aA);return az.promise}H.napply=f;function f(aB,aA,az){return i(aB,aA).apply(void 0,az)}H.ncall=ad;function ad(aB,aA){var az=ag(arguments,2);return f(aB,aA,az)}H.nbind=i;function i(aC){if(arguments.length>1){var aA=arguments[1];var az=ag(arguments,2);var aB=aC;aC=function(){var aD=az.concat(ag(arguments));return aB.apply(aA,aD)}}return function(){var aD=U();var aE=ag(arguments);aE.push(aD.makeNodeResolver());ao(aC,aE).fail(aD.reject);return aD.promise}}H.npost=D;function D(aB,aA,az){return f(aB[aA],aB,az)}H.ninvoke=af;function af(aB,aA){var az=ag(arguments,2);return f(aB[aA],aB,az)}H.nend=s;function s(aB,az){if(az){var aA=U();aB.then(function(aC){G(function(){aA.resolve();az(null,aC)})},function(aC){G(function(){aA.resolve();az(aC)})});return aA.promise}else{return aB}}Z(H);var W=g()});