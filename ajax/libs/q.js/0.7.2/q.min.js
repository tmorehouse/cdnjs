/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 */
(function(a,b){if(typeof define==="function"){define(function(d,c,e){a(d,c,e)})}else{if(typeof exports==="object"){a(require,exports,module)}else{Q=a(b,{},{})}}})(function(h,K,a,g){var O;try{O=h("event-queue").enqueue}catch(N){if(typeof MessageChannel!=="undefined"){var B=new MessageChannel();var k={},R=k;B.port1.onmessage=function(){var S=k.next;var e=S.task;k=S;e()};O=function(e){R=R.next={task:e};B.port2.postMessage()}}else{O=function(e){setTimeout(e,0)}}}function I(e){return e}var F=function(S,e,T){if(!S[e]){S[e]=T}return S[e]};var o=F(Object,"freeze",I);var d=F(Object,"create",function(S){var e=function(){};e.prototype=S;return new e()});var w=F(Object,"keys",function(e){var T=[];for(var S in e){T.push(S)}return T});var m=Array.prototype.reduce||function(U,T){var e=0,S=this.length;if(arguments.length==1){do{if(e in this){T=this[e++];break}if(++e>=S){throw new TypeError()}}while(1)}for(;e<S;e++){if(e in this){T=U(T,this[e],e)}}return T};var l=function(e){return Object.prototype.toString.call(e)==="[object StopIteration]"};var n=Array.prototype.slice;var M=null;var j=function(e){if(e===g||e===M){return e}else{return e.valueOf()}};K.enqueue=K.nextTick=O;K.defer=c;function c(){var U=[],S;var T=d(y.prototype);T.promiseSend=function(){var V=n.call(arguments);if(U){U.push(V)}else{O(function(){S.promiseSend.apply(S,V)})}};T.valueOf=function(){if(U){return T}return S.valueOf()};var e=function(V){var X,Y,W;if(!U){return}S=H(V);m.call(U,function(aa,Z){O(function(){S.promiseSend.apply(S,Z)})},g);U=g;return S};return{promise:o(T),resolve:e,reject:function(V){return e(v(V))}}}K.makePromise=y;function y(S,U,e){if(U===g){U=function(V){return v("Promise does not support operation: "+V)}}var T=d(y.prototype);T.promiseSend=function(Z,W){var X=n.call(arguments,2);var V;try{if(S[Z]){V=S[Z].apply(S,X)}else{V=U.apply(S,[Z].concat(X))}}catch(Y){V=v(Y)}return(W||I)(V)};if(e){T.valueOf=e}return o(T)}y.prototype.then=function(e,S){return A(this,e,S)};m.call(["when","send","get","put","del","post","invoke","keys","apply","call","all","wait","join","fail","fin","spy","view","viewInfo","timeout","delay","end"],function(S,e){y.prototype[e]=function(){return K[e].apply(K,[this].concat(n.call(arguments)))}},g);y.prototype.toSource=function(){return this.toString()};y.prototype.toString=function(){return"[object Promise]"};o(y.prototype);K.isPromise=s;function s(e){return e&&typeof e.promiseSend==="function"}K.isResolved=b;function b(e){return !s(j(e))}K.isFulfilled=C;function C(e){return !s(j(e))&&!E(e)}K.isRejected=E;function E(e){e=j(e);if(e===g||e===M){return false}return !!e.promiseRejected}K.reject=v;function v(S){return y({when:function(U){return U?U(S):v(S)}},function T(U){return v(S)},function e(){var U=d(v.prototype);U.promiseRejected=true;U.reason=S;return U})}v.prototype=d(y.prototype,{constructor:{value:v}});K.ref=H;function H(T){if(s(T)){return T}if(T&&typeof T.then==="function"){var S=c();T.then(S.resolve,S.reject);return S.promise}return y({when:function(U){return T},get:function(U){return T[U]},put:function(U,V){return T[U]=V},del:function(U){return delete T[U]},post:function(U,V){return T[U].apply(T,V)},apply:function(U,V){return T.apply(U,V)},viewInfo:function(){var U=T;var V={};while(U){Object.getOwnPropertyNames(U).forEach(function(W){if(!V[W]){V[W]=typeof U[W]}});U=Object.getPrototypeOf(U)}return{type:typeof T,properties:V}},keys:function(){return w(T)}},g,function e(){return T})}K.master=K.def=t;function t(e){return y({isDef:function(){}},function S(U){var T=n.call(arguments);return x.apply(g,[e].concat(T))},function(){return j(e)})}K.viewInfo=J;function J(e,S){e=H(e);if(S){return y({viewInfo:function(){return S}},function T(V){var U=n.call(arguments);return x.apply(g,[e].concat(U))},function(){return j(e)})}else{return x(e,"viewInfo")}}K.view=function(e){return J(e).when(function(U){var S;if(U.type==="function"){S=function(){return P(e,g,arguments)}}else{S={}}var T=U.properties||{};Object.keys(T).forEach(function(V){if(T[V]==="function"){S[V]=function(){return q(e,V,arguments)}}});return H(S)})};K.when=A;function A(W,T,V){var U=c();var S=false;function e(Z){try{return T?T(Z):Z}catch(Y){return v(Y)}}function X(Z){try{return V?V(Z):v(Z)}catch(Y){return v(Y)}}O(function(){H(W).promiseSend("when",function(Y){if(S){return}S=true;U.resolve(H(Y).promiseSend("when",e,X))},function(Y){if(S){return}S=true;U.resolve(X(Y))})});return U.promise}K.async=D;function D(e){return function(){var T=function(Z,X){var W;try{W=U[Z](X)}catch(Y){if(l(Y)){return Y.value}else{return v(Y)}}return A(W,V,S)};var U=e.apply(this,arguments);var V=T.bind(T,"send");var S=T.bind(T,"throw");return V()}}K.Method=u;function u(e){return function(T){var S=n.call(arguments,1);return x.apply(g,[T,e].concat(S))}}K.send=x;function x(T,U){var e=c();var S=n.call(arguments,2);T=H(T);O(function(){T.promiseSend.apply(T,[U,e.resolve].concat(S))});return e.promise}K.get=u("get");K.put=u("put");K.del=u("del");var q=K.post=u("post");K.invoke=function(T,S){var e=n.call(arguments,2);return q(T,S,e)};var P=K.apply=u("apply");K.call=function(T,S){var e=n.call(arguments,2);return P(T,S,e)};K.keys=u("keys");K.all=r;function r(e){return A(e,function(V){var U=V.length;var T=[];if(U===0){return H(T)}var S=c();m.call(V,function(Y,X,W){A(X,function(Z){T[W]=Z;if(--U===0){S.resolve(T)}},S.reject)},g);return S.promise})}K.wait=function(e){return r(arguments).get(0)};K.join=function(){var e=n.call(arguments);var S=e.pop();return r(e).then(function(T){return S.apply(g,T)})};K.fail=f;function f(S,e){return A(S,g,e)}K.spy=K.fin=G;function G(e,S){return A(e,function(T){return A(S(),function(){return T})},function(T){return A(S(),function(){return v(T)})})}K.end=p;function p(e){A(e,g,function(S){O(function(){throw S})})}K.timeout=L;function L(T,S){var e=c();A(T,e.resolve,e.reject);setTimeout(function(){e.reject("Timed out")},S);return e.promise}K.delay=z;function z(T,S){var e=c();setTimeout(function(){e.resolve(T)},S);return e.promise}for(var i in K){H[i]=K[i]}a.exports=H;return H});