(function(h,f){var c;if(typeof setTimeout==="function"){c=function(m){setTimeout(m,0)}}else{c=require("event-loop").enqueue}var b;if(typeof require!=="undefined"){try{b=require("system").print}catch(e){b=require("sys").puts}}else{if(typeof console!=="undefined"){b=function(m){console.log(m)}}else{b=function(){}}}h.enqueue=c;h.defer=a;function a(){var p=[],n;var o=Object.create(k.prototype);o.emit=function(){var q=Array.prototype.slice.call(arguments);if(p){p.push(q)}else{i.apply(f,[n].concat(q))}};var m=function(q){var s,t,r;if(!p){return}n=d(q);for(s=0,t=p.length;s<t;++s){i.apply(f,[n].concat(p[s]))}p=f};return{promise:o,resolve:m,reject:function(q){m(l(q))}}}h.Promise=k;function k(m,o){if(o===f){o=function(p){return l("Promise does not support operation: "+p)}}var n=Object.create(k.prototype);n.emit=function(s,q){var r=Array.prototype.slice.call(arguments,2);var p;if(m[s]){p=m[s].apply(m,r)}else{p=o.apply(m,arguments)}if(q){return q(p)}return p};return n}k.prototype.toSource=function(){return this.toString()};k.prototype.toString=function(){return"[object Promise]"};k.prototype.valueOf=function(){return this.emit("valueOf")};h.isPromise=j;function j(m){return m instanceof k}h.reject=l;function l(m){return k({when:function(o){return o?o(m):l(m)}},function n(q,p){var o=l(m);return p?p(o):o})}h.ref=d;function d(m){if(j(m)){return m}return k({when:function(n){return m},get:function(n){return m[n]},put:function(n,o){m[n]=o},"delete":function(n){delete m[n]},post:function(o,n){return m[o].apply(m,n)},valueOf:function(){return m}})}h.Method=g;function g(m){return function(p){var n=a();var o=Array.prototype.slice.call(arguments,1);i.apply(f,[d(p),m,n.resolve].concat(o));return n.promise}}h.when=function(q,n,p){var o=a();var m=false;i(d(q),"when",function(r){if(m){return}m=true;o.resolve(d(r).emit("when",n,p))},function(r){if(m){return}m=true;o.resolve(p?p(r):l(r))});return o.promise};h.asap=function(o,m,n){if(h.isPromise(o)){return h.when(o,m,n)}else{return m(o)}};h.get=g("get");h.put=g("put");h.del=g("del");h.post=g("post");h.defined=function(m){return h.when(m,function(n){if(n===f||n===null){return l("Resolved undefined value: "+n)}return n})};h.error=function(m){if(!(m instanceof Error)){m=new Error(m)}throw m};function i(n){var m=Array.prototype.slice.call(arguments,1);c(function(){try{n.emit.apply(n,m)}catch(o){b(o.stack||o)}})}})(typeof exports!=="undefined"?exports:this["/q"]={});