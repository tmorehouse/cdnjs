/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
(function(a){if(typeof bootstrap==="function"){bootstrap("promise",a)}else{if(typeof exports==="object"){module.exports=a()}else{if(typeof define==="function"&&define.amd){define(a)}else{if(typeof ses!=="undefined"){if(!ses.ok()){return}else{ses.makeQ=a}}else{Q=a()}}}}})(function(){var v=Z();var j;var al=function(){};var an;if(typeof setImmediate==="function"){if(typeof window!=="undefined"){an=setImmediate.bind(window)}else{an=setImmediate}}else{if(typeof process!=="undefined"&&process.nextTick){an=process.nextTick}else{(function(){var ax={task:void 0,next:null};var aw=ax;var az=2;var at=0;var ay=0;var aA=0;var au=void 0;function ar(){--at;if(++aA>=az){aA=0;az*=4;var aB=ay&&Math.min(ay-1,az);while(at<aB){++at;au()}}while(ay){--ay;ax=ax.next;var aC=ax.task;ax.task=void 0;aC()}aA=0}an=function(aB){aw=aw.next={task:aB,next:null};if(at<++ay&&at<az){++at;au()}};if(typeof MessageChannel!=="undefined"){var av=new MessageChannel();av.port1.onmessage=ar;au=function(){av.port2.postMessage(0)}}else{au=function(){setTimeout(ar,0)}}})()}}function q(at){var ar=Function.call;return function(){return ar.apply(at,arguments)}}var ah=q(Array.prototype.slice);var c=q(Array.prototype.reduce||function(av,au){var ar=0,at=this.length;if(arguments.length===1){do{if(ar in this){au=this[ar++];break}if(++ar>=at){throw new TypeError()}}while(1)}for(;ar<at;ar++){if(ar in this){au=av(au,this[ar],ar)}}return au});var U=q(Array.prototype.indexOf||function(at){for(var ar=0;ar<this.length;ar++){if(this[ar]===at){return ar}}return -1});var b=q(Array.prototype.map||function(av,at){var ar=this;var au=[];c(ar,function(ay,ax,aw){au.push(av.call(at,ax,aw,ar))},void 0);return au});var K=Object.create||function(at){function ar(){}ar.prototype=at;return new ar()};var C=q(Object.prototype.hasOwnProperty);var I=Object.keys||function(ar){var au=[];for(var at in ar){if(C(ar,at)){au.push(at)}}return au};var aq=q(Object.prototype.toString);function x(ar){return(aq(ar)==="[object StopIteration]"||ar instanceof L)}var L;if(typeof ReturnValue!=="undefined"){L=ReturnValue}else{L=function(ar){this.value=ar}}k.longStackJumpLimit=1;var ac="From previous event:";function l(ar,at){if(at.stack&&typeof ar==="object"&&ar!==null&&ar.stack&&ar.stack.indexOf(ac)===-1){ar.stack=N(ar.stack)+"\n"+ac+"\n"+N(at.stack)}}function N(av){var at=av.split("\n");var aw=[];for(var au=0;au<at.length;++au){var ar=at[au];if(!f(ar)&&!ad(ar)){aw.push(ar)}}return aw.join("\n")}function ad(ar){return ar.indexOf("(module.js:")!==-1||ar.indexOf("(node.js:")!==-1}function f(at){var au=/at .+ \((.*):(\d+):\d+\)/.exec(at);if(!au){return false}var av=au[1];var ar=au[2];return av===j&&ar>=v&&ar<=t}function Z(){if(Error.captureStackTrace){var au,ar;var at=Error.prepareStackTrace;Error.prepareStackTrace=function(av,aw){au=aw[1].getFileName();ar=aw[1].getLineNumber()};new Error().stack;Error.prepareStackTrace=at;j=au;return ar}}function k(ar){return D(ar)}k.nextTick=an;k.defer=h;function h(){var ax=[],av=[],au;var ar=K(h.prototype);var aw=K(ak.prototype);aw.promiseDispatch=function(aA,aB,az){var ay=ah(arguments);if(ax){ax.push(ay);if(aB==="when"&&az[1]){av.push(az[1])}}else{an(function(){au.promiseDispatch.apply(au,ay)})}};aw.valueOf=function(){if(ax){return aw}var ay=u(au);if(A(ay)){au=ay}return ay};if(Error.captureStackTrace&&k.longStackJumpLimit>0){Error.captureStackTrace(aw,h);aw.stack=aw.stack.substring(aw.stack.indexOf("\n")+1)}function at(ay){au=ay;c(ax,function(aA,az){an(function(){ay.promiseDispatch.apply(ay,az)})},void 0);ax=void 0;av=void 0}ar.promise=aw;ar.resolve=function(ay){if(au){return}at(D(ay))};ar.fulfill=function(ay){if(au){return}at(B(ay))};ar.reject=function(ay){if(au){return}at(F(ay))};ar.notify=function(ay){if(au){return}c(av,function(aA,az){an(function(){az(ay)})},void 0)};return ar}h.prototype.makeNodeResolver=function(){var ar=this;return function(at,au){if(at){ar.reject(at)}else{if(arguments.length>2){ar.resolve(ah(arguments,1))}else{ar.resolve(au)}}}};k.promise=X;function X(at){if(typeof at!=="function"){throw new TypeError("resolver must be a function.")}var ar=h();g(at,ar.resolve,ar.reject,ar.notify).fail(ar.reject);return ar.promise}k.makePromise=ak;function ak(av,ax,ar,at,au){if(ax===void 0){ax=function(ay){return F(new Error("Promise does not support operation: "+ay))}}var aw=K(ak.prototype);aw.promiseDispatch=function(aB,aC,az){var ay;try{if(av[aC]){ay=av[aC].apply(aw,az)}else{ay=ax.call(aw,aC,az)}}catch(aA){ay=F(aA)}if(aB){aB(ay)}};if(ar){aw.valueOf=ar}if(au){aw.exception=at}return aw}ak.prototype.then=function(ar,at,au){return T(this,ar,at,au)};ak.prototype.thenResolve=function(ar){return T(this,function(){return ar})};ak.prototype.thenReject=function(ar){return T(this,function(){throw ar})};c(["isFulfilled","isRejected","isPending","dispatch","when","spread","get","set","del","delete","post","send","invoke","keys","fapply","fcall","fbind","all","allResolved","timeout","delay","catch","finally","fail","fin","progress","done","nfcall","nfapply","nfbind","denodeify","nbind","npost","nsend","ninvoke","nodeify"],function(at,ar){ak.prototype[ar]=function(){return k[ar].apply(k,[this].concat(ah(arguments)))}},void 0);ak.prototype.toSource=function(){return this.toString()};ak.prototype.toString=function(){return"[object Promise]"};k.nearer=u;function u(ar){if(A(ar)){return ar.valueOf()}return ar}k.isPromise=A;function A(ar){return ar&&typeof ar.promiseDispatch==="function"}k.isPromiseAlike=P;function P(ar){return ar&&typeof ar.then==="function"}k.isPending=ai;function ai(ar){return !V(ar)&&!Y(ar)}k.isFulfilled=V;function V(ar){return !P(u(ar))}k.isRejected=Y;function Y(ar){ar=u(ar);return A(ar)&&"exception" in ar}var ae=k.unhandledReasons=[];var ap=[];var m=false;function S(){if(!m&&typeof window!=="undefined"&&!window.Touch&&window.console){console.warn("[Q] Unhandled rejection reasons (should be empty):",ae)}m=true}if(typeof process!=="undefined"&&process.on){process.on("exit",function(){for(var ar=0;ar<ae.length;ar++){var at=ae[ar];if(at&&typeof at.stack!=="undefined"){console.warn("Unhandled rejection reason:",at.stack)}else{console.warn("Unhandled rejection reason (no stack):",at)}}})}k.reject=F;function F(au){var at=ak({when:function(ax){if(ax){var aw=U(ap,this);if(aw!==-1){ap.splice(aw,1);ae.splice(aw,1)}}return ax?ax(au):this}},function av(){return F(au)},function ar(){return this},au,true);S();ap.push(at);ae.push(au);return at}k.fulfill=B;function B(at){return ak({when:function(){return at},get:function(au){return at[au]},set:function(au,av){at[au]=av},"delete":function(au){delete at[au]},post:function(av,au){if(av===null||av===void 0){return at.apply(void 0,au)}else{return at[av].apply(at,au)}},apply:function(av,au){return at.apply(av,au)},keys:function(){return I(at)}},void 0,function ar(){return at})}k.resolve=D;function D(ar){if(A(ar)){return ar}ar=u(ar);if(P(ar)){return O(ar)}else{return B(ar)}}function O(at){var ar=h();an(function(){try{at.then(ar.resolve,ar.reject,ar.notify)}catch(au){ar.reject(au)}});return ar.promise}k.master=w;function w(ar){return ak({isDef:function(){}},function at(av,au){return ab(ar,av,au)},function(){return u(ar)})}k.when=T;function T(ay,ax,az,au){var aA=h();var av=false;function aw(aD){try{return typeof ax==="function"?ax(aD):aD}catch(aC){return F(aC)}}function aB(aC){if(typeof az==="function"){l(aC,ar);try{return az(aC)}catch(aD){return F(aD)}}return F(aC)}function at(aC){return typeof au==="function"?au(aC):aC}var ar=D(ay);an(function(){ar.promiseDispatch(function(aC){if(av){return}av=true;aA.resolve(aw(aC))},"when",[function(aC){if(av){return}av=true;aA.resolve(aB(aC))}])});ar.promiseDispatch(void 0,"when",[void 0,function(aC){var aE;var aF=false;try{aE=at(aC)}catch(aD){aF=true;if(k.onerror){k.onerror(aD)}else{throw aD}}if(!aF){aA.notify(aE)}}]);return aA.promise}k.spread=e;function e(au,ar,at){return T(au,function(av){return z(av).then(function(aw){return ar.apply(void 0,aw)},at)},at)}k.async=W;function W(ar){return function(){function au(aA,ay){var ax;try{ax=av[aA](ay)}catch(az){if(x(az)){return az.value}else{return F(az)}}return T(ax,aw,at)}var av=ar.apply(this,arguments);var aw=au.bind(au,"send");var at=au.bind(au,"throw");return aw()}}k["return"]=i;function i(ar){throw new L(ar)}k.promised=s;function s(ar){return function(){return e([this,z(arguments)],function(at,au){return ar.apply(at,au)})}}k.dispatch=ab;function ab(au,av,at){var ar=h();an(function(){D(au).promiseDispatch(ar.resolve,av,at)});return ar.promise}k.dispatcher=H;function H(ar){return function(au){var at=ah(arguments,1);return ab(au,ar,at)}}k.get=H("get");k.set=H("set");k["delete"]=k.del=H("delete");var y=k.post=H("post");k.send=J;k.invoke=J;function J(au,at){var ar=ah(arguments,2);return y(au,at,ar)}k.fapply=M;function M(at,ar){return ab(at,"apply",[void 0,ar])}k["try"]=g;k.fcall=g;function g(at){var ar=ah(arguments,1);return M(at,ar)}k.fbind=n;function n(au){var ar=ah(arguments,1);return function at(){var av=ar.concat(ah(arguments));return ab(au,"apply",[this,av])}}k.keys=H("keys");k.all=z;function z(ar){return T(ar,function(av){var au=0;var at=h();c(av,function(ay,ax,aw){if(V(ax)){av[aw]=u(ax)}else{++au;T(ax,function(az){av[aw]=az;if(--au===0){at.resolve(av)}},at.reject)}},void 0);if(au===0){at.resolve(av)}return at.promise})}k.allResolved=d;function d(ar){return T(ar,function(at){at=b(at,D);return T(z(b(at,function(au){return T(au,al,al)})),function(){return at})})}k["catch"]=k.fail=p;function p(at,ar){return T(at,void 0,ar)}k.progress=G;function G(ar,at){return T(ar,void 0,void 0,at)}k["finally"]=k.fin=aa;function aa(ar,at){return T(ar,function(au){return T(at(),function(){return au})},function(au){return T(at(),function(){return F(au)})})}k.done=o;function o(ax,ar,aw,av){var at=function(ay){an(function(){l(ay,ax);if(k.onerror){k.onerror(ay)}else{throw ay}})};var au=ar||aw||av?T(ax,ar,aw,av):ax;if(typeof process==="object"&&process&&process.domain){at=process.domain.bind(at)}p(au,at)}k.timeout=ag;function ag(aw,at,av){var ar=h();var au=setTimeout(function(){ar.reject(new Error(av||"Timed out after "+at+" ms"))},at);T(aw,function(ax){clearTimeout(au);ar.resolve(ax)},function(ax){clearTimeout(au);ar.reject(ax)},ar.notify);return ar.promise}k.delay=R;function R(au,at){if(at===void 0){at=au;au=void 0}var ar=h();T(au,undefined,undefined,ar.notify);setTimeout(function(){ar.resolve(au)},at);return ar.promise}k.nfapply=af;function af(av,at){var au=ah(at);var ar=h();au.push(ar.makeNodeResolver());M(av,au).fail(ar.reject);return ar.promise}k.nfcall=aj;function aj(au){var at=ah(arguments,1);var ar=h();at.push(ar.makeNodeResolver());M(au,at).fail(ar.reject);return ar.promise}k.nfbind=ao;k.denodeify=k.nfbind;function ao(at){var ar=ah(arguments,1);return function(){var av=ar.concat(ah(arguments));var au=h();av.push(au.makeNodeResolver());M(at,av).fail(au.reject);return au.promise}}k.nbind=a;function a(au,ar){var at=ah(arguments,2);return function(){var ax=at.concat(ah(arguments));var av=h();ax.push(av.makeNodeResolver());function aw(){return au.apply(ar,arguments)}M(aw,ax).fail(av.reject);return av.promise}}k.npost=r;function r(av,au,at){var aw=ah(at||[]);var ar=h();aw.push(ar.makeNodeResolver());y(av,au,aw).fail(ar.reject);return ar.promise}k.nsend=E;k.ninvoke=k.nsend;function E(au,at){var av=ah(arguments,2);var ar=h();av.push(ar.makeNodeResolver());y(au,at,av).fail(ar.reject);return ar.promise}k.nodeify=am;function am(at,ar){if(ar){at.then(function(au){an(function(){ar(null,au)})},function(au){an(function(){ar(au)})})}else{return at}}var t=Z();return k});