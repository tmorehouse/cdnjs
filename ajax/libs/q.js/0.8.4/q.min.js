/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 */
(function(a){if(typeof define==="function"){define(["exports"],a)}else{if(typeof exports==="object"){a(exports)}else{a(Q={})}}})(function(O){var T;if(typeof process!=="undefined"){T=process.nextTick}else{if(typeof msSetImmediate==="function"){T=msSetImmediate}else{if(typeof setImmediate==="function"){T=setImmediate}else{if(typeof MessageChannel!=="undefined"){var D=new MessageChannel();var m={},V=m;D.port1.onmessage=function(){m=m.next;var W=m.task;m.task=null;W()};T=function(W){V=V.next={task:W};D.port2.postMessage(0)}}else{T=function(W){setTimeout(W,0)}}}}}function M(W){return W}function K(Y,X,W){if(!Y[X]){Y[X]=W}return Y[X]}var r=K(Object,"freeze",M);var j=K(Object,"create",function(X){function W(){}W.prototype=X;return new W()});var z=K(Object,"keys",function(W){var Y=[];for(var X in W){Y.push(X)}return Y});var o=Array.prototype.reduce||function(Z,Y){var W=0,X=this.length;if(arguments.length===1){do{if(W in this){Y=this[W++];break}if(++W>=X){throw new TypeError()}}while(1)}for(;W<X;W++){if(W in this){Y=Z(Y,this[W],W)}}return Y};function n(W){return Object.prototype.toString.call(W)==="[object StopIteration]"}var q=Array.prototype.slice;function l(W){if(Object(W)!==W){return W}else{return W.valueOf()}}O.nextTick=T;O.defer=h;function h(){var aa=[],Y;var W=j(h.prototype);var Z=j(R.prototype);Z.promiseSend=function(){var ab=q.call(arguments);if(aa){aa.push(ab)}else{T(function(){Y.promiseSend.apply(Y,ab)})}};Z.valueOf=function(){if(aa){return Z}return Y.valueOf()};function X(ab){if(!aa){return}Y=w(ab);o.call(aa,function(ad,ac){T(function(){Y.promiseSend.apply(Y,ac)})},void 0);aa=void 0;return Y}W.promise=r(Z);W.resolve=X;W.reject=function(ab){return X(y(ab))};return W}h.prototype.node=h.prototype.makeNodeResolver=function(){var W=this;return function(X,Y){if(X){W.reject(X)}else{if(arguments.length>2){W.resolve(Array.prototype.slice.call(arguments,1))}else{W.resolve(Y)}}}};O.promise=H;function H(X){var W=h();b(X,void 0,W.resolve,W.reject,W.progress).fail(W.reject);return W.promise}O.makePromise=R;function R(Y,aa,W,X){if(aa===void 0){aa=function(ab){return y("Promise does not support operation: "+ab)}}var Z=j(R.prototype);Z.promiseSend=function(af,ac){var ad=q.call(arguments,2);var ab;try{if(Y[af]){ab=Y[af].apply(Z,ad)}else{ab=aa.apply(Z,[af].concat(ad))}}catch(ae){ab=y(ae)}return(ac||M)(ab)};if(W){Z.valueOf=W}if(X){Z.promiseRejected=true}return r(Z)}R.prototype.then=function(W,X){return C(this,W,X)};o.call(["isResolved","isFulfilled","isRejected","when","spread","send","get","put","del","post","invoke","keys","apply","call","bind","all","allResolved","view","viewInfo","timeout","delay","catch","finally","fail","fin","end"],function(X,W){R.prototype[W]=function(){return O[W].apply(O,[this].concat(q.call(arguments)))}},void 0);R.prototype.toSource=function(){return this.toString()};R.prototype.toString=function(){return"[object Promise]"};r(R.prototype);O.isPromise=v;function v(W){return W&&typeof W.promiseSend==="function"}O.isResolved=f;function f(W){return E(W)||J(W)}O.isFulfilled=E;function E(W){return !v(l(W))}O.isRejected=J;function J(W){W=l(W);return W&&!!W.promiseRejected}var I=[];var x=[];if(typeof window!=="undefined"){console.log("Should be empty:",x)}O.reject=y;function y(Y){var X=R({when:function(ab){if(ab){var aa=I.indexOf(this);if(aa!==-1){x.splice(aa,1);I.splice(aa,1)}}return ab?ab(Y):y(Y)}},function Z(aa){return y(Y)},function W(){return y(Y)},true);I.push(X);x.push(Y);return X}O.begin=w;O.resolve=w;O.ref=w;function w(Y){if(v(Y)){return Y}if(Y&&typeof Y.then==="function"){var X=h();Y.then(X.resolve,X.reject);return X.promise}return R({when:function(Z){return Y},get:function(Z){return Y[Z]},put:function(Z,aa){return Y[Z]=aa},del:function(Z){return delete Y[Z]},post:function(Z,aa){return Y[Z].apply(Y,aa)},apply:function(Z,aa){return Y.apply(Z,aa)},viewInfo:function(){var Z=Y;var aa={};function ab(ac){if(!aa[ac]){aa[ac]=typeof Z[ac]}}while(Z){Object.getOwnPropertyNames(Z).forEach(ab);Z=Object.getPrototypeOf(Z)}return{type:typeof Y,properties:aa}},keys:function(){return z(Y)}},void 0,function W(){return Y})}O.master=p;function p(W){return R({isDef:function(){}},function X(Z){var Y=q.call(arguments);return A.apply(void 0,[W].concat(Y))},function(){return l(W)})}O.viewInfo=N;function N(W,X){W=w(W);if(X){return R({viewInfo:function(){return X}},function Y(aa){var Z=q.call(arguments);return A.apply(void 0,[W].concat(Z))},function(){return l(W)})}else{return A(W,"viewInfo")}}O.view=c;function c(W){return N(W).when(function(Z){var X;if(Z.type==="function"){X=function(){return U(W,void 0,arguments)}}else{X={}}var Y=Z.properties||{};Object.keys(Y).forEach(function(aa){if(Y[aa]==="function"){X[aa]=function(){return t(W,aa,arguments)}}});return w(X)})}O.when=C;function C(ab,Y,aa){var Z=h();var X=false;function W(ae){try{return Y?Y(ae):ae}catch(ad){return y(ad)}}function ac(ad){try{return aa?aa(ad):y(ad)}catch(ad){return y(ad)}}T(function(){w(ab).promiseSend("when",function(ad){if(X){return}X=true;Z.resolve(w(ad).promiseSend("when",W,ac))},function(ad){if(X){return}X=true;Z.resolve(ac(ad))})});return Z.promise}O.spread=e;function e(Y,W,X){return C(Y,function(Z){return W.apply(void 0,Z)},X)}O.async=G;function G(W){return function(){function Y(ae,ac){var ab;try{ab=Z[ae](ac)}catch(ad){if(n(ad)){return ad.value}else{return y(ad)}}return C(ab,aa,X)}var Z=W.apply(this,arguments);var aa=Y.bind(Y,"send");var X=Y.bind(Y,"throw");return aa()}}O.sender=i;O.Method=i;function i(W){return function(Y){var X=q.call(arguments,1);return A.apply(void 0,[Y,W].concat(X))}}O.send=A;function A(Y,Z){var W=h();var X=q.call(arguments,2);Y=w(Y);T(function(){Y.promiseSend.apply(Y,[Z,W.resolve].concat(X))});return W.promise}O.get=i("get");O.put=i("put");O.del=O["delete"]=i("del");var t=O.post=i("post");O.invoke=function(Y,X){var W=q.call(arguments,2);return t(Y,X,W)};var U=O.apply=i("apply");O.call=O["try"]=b;function b(Y,X){var W=q.call(arguments,2);return U(Y,X,W)}O.bind=g;function g(Z,X){var W=q.call(arguments,2);return function Y(){var ac=W.concat(q.call(arguments));if(this instanceof Y){var ad=function(){};ad.prototype=Z.prototype;var ab=new ad();var aa=U(Z,ab,ac);return aa.then(function(ae){if(Object(ae)===ae){return ae}return ab})}else{return U(Z,X,ac)}}}O.keys=i("keys");O.all=u;function u(W){return C(W,function(Z){var Y=Z.length;if(Y===0){return w(Z)}var X=h();o.call(Z,function(ac,ab,aa){C(ab,function(ad){Z[aa]=ad;if(--Y===0){X.resolve(Z)}}).fail(X.reject)},void 0);return X.promise})}O.allResolved=d;function d(W){return C(W,function(X){return C(u(X.map(function(Y){return C(Y,M,M)})),function(){return X.map(w)})})}O["catch"]=O.fail=k;function k(X,W){return C(X,void 0,W)}O["finally"]=O.fin=L;function L(W,X){return C(W,function(Y){return C(X(),function(){return Y})},function(Y){return C(X(),function(){return y(Y)})})}O.end=s;function s(W){C(W,void 0,function(X){T(function(){throw X})})}O.timeout=P;function P(Y,X){var W=h();C(Y,W.resolve,W.reject);setTimeout(function(){W.reject(new Error("Timed out after "+X+"ms"))},X);return W.promise}O.delay=B;function B(Y,X){if(X===void 0){X=Y;Y=void 0}var W=h();setTimeout(function(){W.resolve(Y)},X);return W.promise}O.nbind=a;O.node=a;function a(X){if(arguments.length>1){var W=Array.prototype.slice.call(arguments,1);X=X.bind.apply(X,W)}return function(){var Y=h();var Z=q.call(arguments);Z.push(Y.node());U(X,this,Z).fail(Y.reject);return Y.promise}}O.napply=F;function F(Y,X,W){return a(Y).apply(X,W)}O.ncall=S;function S(Y,X){var W=q.call(arguments,2);return F(Y,X,W)}});