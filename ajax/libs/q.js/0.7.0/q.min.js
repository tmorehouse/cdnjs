/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 */
(function(a,b){if(typeof define==="function"){define(function(d,c,e){a(d,c,e)})}else{if(typeof exports==="object"){a(require,exports,module)}else{Q=a(b,{},{})}}})(function(h,I,a,g){var L;try{L=h("event-queue").enqueue}catch(K){if(typeof MessageChannel!=="undefined"){var A=new MessageChannel();var k={},N=k;A.port1.onmessage=function(){var O=k.next;var e=O.task;k=O;e()};L=function(e){N=N.next={task:e};A.port2.postMessage()}}else{L=function(e){setTimeout(e,0)}}}function G(e){return e}var o=Object.freeze=Object.freeze||G;var d=Object.create=Object.create||function(O){var e=function(){};e.prototype=O;return new e()};var w=Object.keys=Object.keys||function(e){var P=[];for(var O in e){P.push(O)}return P};var m=Array.prototype.reduce=Array.prototype.reduce||function(R,P){for(var e=0,O=this.length;e<O;e++){P=R(P,this[e],e)}return P};var l=function(e){return Object.prototype.toString.call(e)==="[object StopIteration]"};var n=Array.prototype.slice;var J=null;var j=function(e){if(e===g||e===J){return e}else{return e.valueOf()}};I.enqueue=I.nextTick=L;I.defer=c;function c(){var R=[],O;var P=d(y.prototype);P.promiseSend=function(){var S=n.call(arguments);if(R){R.push(S)}else{L(function(){O.promiseSend.apply(O,S)})}};P.valueOf=function(){if(R){return P}return O.valueOf()};var e=function(S){var U,V,T;if(!R){return}O=F(S);m.call(R,function(X,W){L(function(){O.promiseSend.apply(O,W)})},g);R=g;return O};return{promise:o(P),resolve:e,reject:function(S){return e(v(S))}}}I.makePromise=y;function y(O,R,e){if(R===g){R=function(S){return v("Promise does not support operation: "+S)}}var P=d(y.prototype);P.promiseSend=function(W,T){var U=n.call(arguments,2);var S;try{if(O[W]){S=O[W].apply(O,U)}else{S=R.apply(O,[W].concat(U))}}catch(V){S=v(V)}return(T||G)(S)};if(e){P.valueOf=e}return o(P)}y.prototype.then=function(e,O){return z(this,e,O)};m.call(["when","send","get","put","del","post","invoke","keys","apply","call","all","wait","join","fail","fin","spy","view","viewInfo","end"],function(O,e){y.prototype[e]=function(){return I[e].apply(I,[this].concat(n.call(arguments)))}},g);y.prototype.toSource=function(){return this.toString()};y.prototype.toString=function(){return"[object Promise]"};o(y.prototype);I.isPromise=r;function r(e){return e&&typeof e.promiseSend==="function"}I.isResolved=b;function b(e){return !r(j(e))}I.isFulfilled=B;function B(e){return !r(j(e))&&!D(e)}I.isRejected=D;function D(e){e=j(e);if(e===g||e===J){return false}return !!e.promiseRejected}I.reject=v;function v(O){return y({when:function(R){return R?R(O):v(O)}},function P(R){return v(O)},function e(){var R=d(v.prototype);R.promiseRejected=true;R.reason=O;return R})}v.prototype=d(y.prototype,{constructor:{value:v}});I.ref=F;function F(O){if(r(O)){return O}if(O&&typeof O.then==="function"){return y({},function P(T,S){if(T!=="when"){return z(O,function(U){return F(U).promiseSend.apply(g,arguments)})}else{var R=c();O.then(R.resolve,R.reject);return R.promise}})}return y({when:function(R){return O},get:function(R){return O[R]},put:function(R,S){return O[R]=S},del:function(R){return delete O[R]},post:function(R,S){return O[R].apply(O,S)},apply:function(R,S){return O.apply(R,S)},viewInfo:function(){var R=O;var S={};while(R){Object.getOwnPropertyNames(R).forEach(function(T){if(!S[T]){S[T]=typeof R[T]}});R=Object.getPrototypeOf(R)}return{type:typeof O,properties:S}},keys:function(){return w(O)}},g,function e(){return O})}I.master=I.def=s;function s(e){return y({isDef:function(){}},function O(R){var P=n.call(arguments);return x.apply(g,[e].concat(P))},function(){return j(e)})}I.viewInfo=H;function H(e,O){e=F(e);if(O){return y({viewInfo:function(){return O}},function P(S){var R=n.call(arguments);return x.apply(g,[e].concat(R))},function(){return j(e)})}else{return x(e,"viewInfo")}}I.view=function(e){return H(e).when(function(R){var O;if(R.type==="function"){O=function(){return M(e,g,arguments)}}else{O={}}var P=R.properties||{};Object.keys(P).forEach(function(S){if(P[S]==="function"){O[S]=function(){return q(e,S,arguments)}}});return F(O)})};I.when=z;function z(T,P,S){var R=c();var O=false;function e(W){try{return P?P(W):W}catch(V){return v(V)}}function U(W){try{return S?S(W):v(W)}catch(V){return v(V)}}L(function(){F(T).promiseSend("when",function(V){if(O){return}O=true;R.resolve(F(V).promiseSend("when",e,U))},function(V){if(O){return}O=true;R.resolve(U(V))})});return R.promise}I.async=C;function C(e){return function(){var P=function(W,U){var T;try{T=R[W](U)}catch(V){if(l(V)){return V.value}else{return v(V)}}return z(T,S,O)};var R=e.apply(this,arguments);var S=P.bind(P,"send");var O=P.bind(P,"throw");return S()}}I.Method=u;function u(e){return function(P){var O=n.call(arguments,1);return x.apply(g,[P,e].concat(O))}}I.send=x;function x(P,R){var e=c();var O=n.call(arguments,2);P=F(P);L(function(){P.promiseSend.apply(P,[R,e.resolve].concat(O))});return e.promise}I.get=u("get");I.put=u("put");I.del=u("del");var q=I.post=u("post");I.invoke=function(P,O){var e=n.call(arguments,2);return q(P,O,e)};var M=I.apply=u("apply");I.call=function(P,O){var e=n.call(arguments,2);return M(P,O,e)};I.keys=u("keys");I.all=t;function t(e){return z(e,function(S){var R=S.length;var P=[];if(R===0){return F(P)}var O=c();m.call(S,function(V,U,T){z(U,function(W){P[T]=W;if(--R===0){O.resolve(P)}},O.reject)},g);return O.promise})}I.wait=function(e){return t(arguments).get(0)};I.join=function(){var e=n.call(arguments);var O=e.pop();return t(e).then(function(P){return O.apply(g,P)})};I.fail=f;function f(O,e){return z(O,g,e)}I.spy=I.fin=E;function E(e,O){return z(e,function(P){return z(O(),function(){return P})},function(P){return z(O(),function(){return v(P)})})}I.end=p;function p(e){z(e,g,function(O){L(function(){throw O})})}for(var i in I){F[i]=I[i]}a.exports=F;return F});