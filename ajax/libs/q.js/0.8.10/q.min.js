/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * With formatStackTrace and formatSourcePosition functions
 * Copyright 2006-2008 the V8 project authors. All rights reserved.
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *     * Neither the name of Google Inc. nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
(function(a){if(typeof bootstrap==="function"){bootstrap("promise",a)}else{if(typeof exports==="object"){a(void 0,exports)}else{if(typeof define==="function"){define(a)}else{if(typeof ses!=="undefined"){if(!ses.ok()){return}else{ses.makeQ=function(){var b={};return a(void 0,b)}}}else{a(void 0,Q={})}}}}})(function(al,G){var S=h();var J;var ai=function(){};var Y=Object.freeze||ai;if(typeof cajaVM!=="undefined"){Y=cajaVM.def}var F;if(typeof process!=="undefined"){F=process.nextTick}else{if(typeof setImmediate==="function"){F=setImmediate}else{if(typeof MessageChannel!=="undefined"){var ad=new MessageChannel();var s={},y=s;ad.port1.onmessage=function(){s=s.next;var az=s.task;delete s.task;az()};F=function(az){y=y.next={task:az};ad.port2.postMessage(0)}}else{F=function(az){setTimeout(az,0)}}}}var r;if(Function.prototype.bind){var B=Function.prototype.bind;r=B.bind(B.call)}else{r=function(az){return function(){return az.call.apply(az,arguments)}}}var ag=r(Array.prototype.slice);var M=r(Array.prototype.reduce||function(aC,aB){var az=0,aA=this.length;if(arguments.length===1){do{if(az in this){aB=this[az++];break}if(++az>=aA){throw new TypeError()}}while(1)}for(;az<aA;az++){if(az in this){aB=aC(aB,this[az],az)}}return aB});var aj=r(Array.prototype.indexOf||function(aA){for(var az=0;az<this.length;az++){if(this[az]===aA){return az}}return -1});var v=r(Array.prototype.map||function(aC,aA){var az=this;var aB=[];M(az,function(aF,aE,aD){aB.push(aC.call(aA,aE,aD,az))},void 0);return aB});var w=Object.create||function(aA){function az(){}az.prototype=aA;return new az()};var u=Object.keys||function(az){var aB=[];for(var aA in az){aB.push(aA)}return aB};var aw=Object.prototype.toString;function t(az){return(aw(az)==="[object StopIteration]"||az instanceof C)}var C;if(typeof ReturnValue!=="undefined"){C=ReturnValue}else{C=function(az){this.value=az}}function ab(aC,aG){var aB=[];try{aB.push(aC.toString())}catch(aE){try{aB.push("<error: "+aE+">")}catch(aA){aB.push("<error>")}}for(var aD=0;aD<aG.length;aD++){var aF=aG[aD];var az;if(typeof aF==="string"){aB.push(aF)}else{try{az=O(aF)}catch(aE){try{az="<error: "+aE+">"}catch(aA){az="<error>"}}aB.push("    at "+az)}}return aB.join("\n")}function O(aA){var aE="";if(aA.isNative()){aE="native"}else{if(aA.isEval()){aE="eval at "+aA.getEvalOrigin()}else{var aC=aA.getFileName();if(aC){aE+=aC;var aB=aA.getLineNumber();if(aB!==null){aE+=":"+aB;var az=aA.getColumnNumber();if(az){aE+=":"+az}}}}}if(!aE){aE="unknown source"}var aJ="";var aF=aA.getFunction().name;var aI=true;var aH=aA.isConstructor();var aD=!(aA.isToplevel()||aH);if(aD){var aG=aA.getMethodName();aJ+=aA.getTypeName()+".";if(aF){aJ+=aF;if(aG&&(aG!==aF)){aJ+=" [as "+aG+"]"}}else{aJ+=aG||"<anonymous>"}}else{if(aH){aJ+="new "+(aF||"<anonymous>")}else{if(aF){aJ+=aF}else{aJ+=aE;aI=false}}}if(aI){aJ+=" ("+aE+")"}return aJ}function am(aB,aA){if(aB!==J){return false}var az=aA.getLineNumber();return az>=S&&az<=V}function R(aB){var aA=Error.prepareStackTrace;Error.prepareStackTrace=function(aC,aD){return aD.filter(function(aE){var aF=aE.getFileName();return(aF!=="module.js"&&aF!=="node.js"&&!am(aF,aE))})};var az=aB.stack;Error.prepareStackTrace=aA;return az}function h(){if(Error.captureStackTrace){var aB,az;var aA=Error.prepareStackTrace;Error.prepareStackTrace=function(aC,aD){aB=aD[1].getFileName();az=aD[1].getLineNumber()};new Error().stack;Error.prepareStackTrace=aA;J=aB;return az}}function av(aB,az,aA){return function(){if(typeof console!=="undefined"&&typeof console.warn==="function"){console.warn(az+" is deprecated, use "+aA+" instead.",new Error("").stack)}return aB.apply(aB,arguments)}}G.nextTick=F;G.defer=T;function T(){var aE=[],aC=[],aB;var az=w(T.prototype);var aD=w(N.prototype);aD.promiseSend=function(aJ,aH,aI,aG){var aF=ag(arguments);if(aE){aE.push(aF);if(aJ==="when"&&aG){aC.push(aG)}}else{F(function(){aB.promiseSend.apply(aB,aF)})}};aD.valueOf=function(){if(aE){return aD}return aB.valueOf()};if(Error.captureStackTrace){Error.captureStackTrace(aD,T)}function aA(aF){if(!aE){return}aB=P(aF);M(aE,function(aH,aG){F(function(){aB.promiseSend.apply(aB,aG)})},void 0);aE=void 0;aC=void 0}Y(aD);az.promise=aD;az.resolve=aA;az.reject=function(aF){aA(aa(aF))};az.notify=function(aF){if(aE){M(aC,function(aH,aG){F(function(){aG(aF)})},void 0)}};return az}T.prototype.makeNodeResolver=function(){var az=this;return function(aA,aB){if(aA){az.reject(aA)}else{if(arguments.length>2){az.resolve(ag(arguments,1))}else{az.resolve(aB)}}}};T.prototype.node=av(T.prototype.makeNodeResolver,"node","makeNodeResolver");G.promise=q;function q(aA){var az=T();p(aA,az.resolve,az.reject,az.notify).fail(az.reject);return az.promise}G.makePromise=N;function N(aB,aD,az,aA){if(aD===void 0){aD=function(aE){return aa(new Error("Promise does not support operation: "+aE))}}var aC=w(N.prototype);aC.promiseSend=function(aI,aF){var aG=ag(arguments,2);var aE;try{if(aB[aI]){aE=aB[aI].apply(aC,aG)}else{aE=aD.apply(aC,[aI].concat(aG))}}catch(aH){aE=aa(aH)}if(aF){aF(aE)}};if(az){aC.valueOf=az}if(aA){aC.exception=aA}Y(aC);return aC}N.prototype.then=function(az,aA,aB){return ap(this,az,aA,aB)};N.prototype.thenResolve=function(az){return ap(this,function(){return az})};M(["isResolved","isFulfilled","isRejected","when","spread","send","get","put","del","post","invoke","keys","apply","call","bind","fapply","fcall","fbind","all","allResolved","view","viewInfo","timeout","delay","catch","finally","fail","fin","progress","end","done","ncall","napply","nbind","npost","ninvoke","nend","nodeify"],function(aA,az){N.prototype[az]=function(){return G[az].apply(G,[this].concat(ag(arguments)))}},void 0);N.prototype.toSource=function(){return this.toString()};N.prototype.toString=function(){return"[object Promise]"};Y(N.prototype);G.nearer=o;function o(az){if(Object(az)!==az){return az}else{if(ak(az)){return az.valueOf()}}return az}G.isPromise=ak;function ak(az){return az&&typeof az.promiseSend==="function"}G.isResolved=ar;function ar(az){return d(az)||m(az)}G.isFulfilled=d;function d(az){return !ak(o(az))}G.isRejected=m;function m(az){az=o(az);return ak(az)&&"exception" in az}var I=[];var U=[];var n;function i(){if(!n&&typeof window!=="undefined"&&!window.Touch&&window.console){console.log("Should be empty:",U)}n=true}G.reject=aa;function aa(aB){aB=aB||new Error();var aA=N({when:function(aE){if(aE){var aD=aj(I,this);if(aD!==-1){U.splice(aD,1);I.splice(aD,1)}}return aE?aE(aB):aa(aB)}},function aC(){return aa(aB)},function az(){return this},aB);i();I.push(aA);U.push(aB);return aA}G.begin=P;G.resolve=P;G.ref=av(P,"ref","resolve");function P(aB){if(ak(aB)){return aB}aB=az(aB);if(aB&&typeof aB.then==="function"){var aA=T();aB.then(aA.resolve,aA.reject,aA.notify);return aA.promise}return N({when:function(){return aB},get:function(aC){return aB[aC]},put:function(aC,aD){aB[aC]=aD;return aB},del:function(aC){delete aB[aC];return aB},post:function(aC,aD){return aB[aC].apply(aB,aD)},apply:function(aC,aD){return aB.apply(aC,aD)},fapply:function(aC){return aB.apply(void 0,aC)},viewInfo:function(){var aC=aB;var aD={};function aE(aF){if(!aD[aF]){aD[aF]=typeof aC[aF]}}while(aC){Object.getOwnPropertyNames(aC).forEach(aE);aC=Object.getPrototypeOf(aC)}return{type:typeof aB,properties:aD}},keys:function(){return u(aB)}},void 0,function az(){return aB})}G.master=e;function e(az){return N({isDef:function(){}},function aA(){var aB=ag(arguments);return H.apply(void 0,[az].concat(aB))},function(){return o(az)})}G.viewInfo=ax;function ax(az,aA){az=P(az);if(aA){return N({viewInfo:function(){return aA}},function aB(){var aC=ag(arguments);return H.apply(void 0,[az].concat(aC))},function(){return o(az)})}else{return H(az,"viewInfo")}}G.view=ah;function ah(az){return ax(az).when(function(aC){var aA;if(aC.type==="function"){aA=function(){return au(az,void 0,arguments)}}else{aA={}}var aB=aC.properties||{};u(aB).forEach(function(aD){if(aB[aD]==="function"){aA[aD]=function(){return k(az,aD,arguments)}}});return P(aA)})}G.when=ap;function ap(aF,aE,aG,aB){var aH=T();var aC=false;function aD(aK){try{return aE?aE(aK):aK}catch(aJ){return aa(aJ)}}function aI(aJ){try{return aG?aG(aJ):aa(aJ)}catch(aK){return aa(aK)}}function aA(aJ){return aB?aB(aJ):aJ}var az=P(aF);F(function(){az.promiseSend("when",function(aJ){if(aC){return}aC=true;aH.resolve(aD(aJ))},function(aJ){if(aC){return}aC=true;aH.resolve(aI(aJ))})});az.promiseSend("when",void 0,void 0,function(aJ){aH.notify(aA(aJ))});return aH.promise}G.spread=A;function A(aB,az,aA){return ap(aB,function(aC){return an(aC).then(function(aD){return az.apply(void 0,aD)},aA)},aA)}G.async=L;function L(az){return function(){function aB(aH,aF){var aE;try{aE=aC[aH](aF)}catch(aG){if(t(aG)){return aG.value}else{return aa(aG)}}return ap(aE,aD,aA)}var aC=az.apply(this,arguments);var aD=aB.bind(aB,"send");var aA=aB.bind(aB,"throw");return aD()}}G["return"]=f;function f(az){throw new C(az)}G.promised=at;function at(az){return function(){return an([this,an(arguments)]).spread(function(aA,aB){return az.apply(aA,aB)})}}G.sender=av(W,"sender","dispatcher");G.Method=av(W,"Method","dispatcher");function W(az){return function(aB){var aA=ag(arguments,1);return H.apply(void 0,[aB,az].concat(aA))}}G.send=av(H,"send","dispatch");function H(aB,aC){var az=T();var aA=ag(arguments,2);aB=P(aB);F(function(){aB.promiseSend.apply(aB,[aC,az.resolve].concat(aA))});return az.promise}G.dispatch=ay;function ay(aB,aC,aA){var az=T();aB=P(aB);F(function(){aB.promiseSend.apply(aB,[aC,az.resolve].concat(aA))});return az.promise}G.dispatcher=z;function z(az){return function(aB){var aA=ag(arguments,1);return ay(aB,az,aA)}}G.get=z("get");G.put=z("put");G["delete"]=G.del=z("del");var k=G.post=z("post");G.invoke=function(aB,aA){var az=ag(arguments,2);return k(aB,aA,az)};var au=G.apply=av(z("apply"),"apply","fapply");var ao=G.fapply=z("fapply");G.call=av(E,"call","fcall");function E(aB,aA){var az=ag(arguments,2);return au(aB,aA,az)}G["try"]=p;G.fcall=p;function p(aA){var az=ag(arguments,1);return ao(aA,az)}G.bind=av(aq,"bind","fbind");function aq(aC,aA){var az=ag(arguments,2);return function aB(){var aD=az.concat(ag(arguments));return au(aC,aA,aD)}}G.fbind=X;function X(aB){var az=ag(arguments,1);return function aA(){var aC=az.concat(ag(arguments));return ao(aB,aC)}}G.keys=z("keys");G.all=an;function an(az){return ap(az,function(aC){var aB=aC.length;if(aB===0){return P(aC)}var aA=T();M(aC,function(aF,aE,aD){if(d(aE)){aC[aD]=o(aE);if(--aB===0){aA.resolve(aC)}}else{ap(aE,function(aG){aC[aD]=aG;if(--aB===0){aA.resolve(aC)}}).fail(aA.reject)}},void 0);return aA.promise})}G.allResolved=K;function K(az){return ap(az,function(aA){return ap(an(v(aA,function(aB){return ap(aB,ai,ai)})),function(){return v(aA,P)})})}G["catch"]=G.fail=a;function a(aA,az){return ap(aA,void 0,az)}G.progress=x;function x(az,aA){return ap(az,void 0,void 0,aA)}G["finally"]=G.fin=l;function l(az,aA){return ap(az,function(aB){return ap(aA(),function(){return aB})},function(aB){return ap(aA(),function(){return aa(aB)})})}G.end=av(ae,"end","done");G.done=ae;function ae(aE,az,aD,aC){function aA(aF){F(function(){var aG;if(Error.captureStackTrace&&typeof aF==="object"&&(aG=R(aF))){var aH=R(aE);if(typeof aG!=="string"){var aI=aG.concat("From previous event:",aH);aF.stack=ab(aF,aI)}}if(G.onerror){G.onerror(aF)}else{throw aF}})}var aB=az||aD||aC?ap(aE,az,aD,aC):aE;a(aB,aA)}G.timeout=Z;function Z(aC,aA){var az=T();var aB=setTimeout(function(){az.reject(new Error("Timed out after "+aA+" ms"))},aA);ap(aC,function(aD){clearTimeout(aB);az.resolve(aD)},az.reject);return az.promise}G.delay=b;function b(aB,aA){if(aA===void 0){aA=aB;aB=void 0}var az=T();setTimeout(function(){az.resolve(aB)},aA);return az.promise}G.napply=g;function g(aB,aA,az){return j(aB,aA).apply(void 0,az)}G.ncall=ac;function ac(aB,aA){var az=ag(arguments,2);return g(aB,aA,az)}G.nbind=j;function j(aC){if(arguments.length>1){var aA=arguments[1];var az=ag(arguments,2);var aB=aC;aC=function(){var aD=az.concat(ag(arguments));return aB.apply(aA,aD)}}return function(){var aD=T();var aE=ag(arguments);aE.push(aD.makeNodeResolver());ao(aC,aE).fail(aD.reject);return aD.promise}}G.npost=D;function D(aC,aB,aA){var aD=ag(aA);var az=T();aD.push(az.makeNodeResolver());k(aC,aB,aD).fail(az.reject);return az.promise}G.ninvoke=af;function af(aB,aA){var aC=ag(arguments,2);var az=T();aC.push(az.makeNodeResolver());k(aB,aA,aC).fail(az.reject);return az.promise}G.nend=av(c,"nend","nodeify");G.nodeify=c;function c(aA,az){if(az){aA.then(function(aB){F(function(){az(null,aB)})},function(aB){F(function(){az(aB)})})}else{return aA}}var V=h()});