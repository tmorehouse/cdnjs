/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
(function(a){if(typeof bootstrap==="function"){bootstrap("promise",a)}else{if(typeof exports==="object"){a(void 0,exports)}else{if(typeof define==="function"){define(a)}else{if(typeof ses!=="undefined"){if(!ses.ok()){return}else{ses.makeQ=function(){var b={};return a(void 0,b)}}}else{a(void 0,Q={})}}}}})(function(ap,L){var V=i();var O;var al=function(){};var ac=Object.freeze||al;if(typeof cajaVM!=="undefined"){ac=cajaVM.def}var K;if(typeof process!=="undefined"){K=process.nextTick}else{if(typeof setImmediate==="function"){K=setImmediate}else{if(typeof MessageChannel!=="undefined"){var ag=new MessageChannel();var u={},C=u;ag.port1.onmessage=function(){u=u.next;var aD=u.task;delete u.task;aD()};K=function(aD){C=C.next={task:aD};ag.port2.postMessage(0)}}else{K=function(aD){setTimeout(aD,0)}}}}var t;if(Function.prototype.bind){var G=Function.prototype.bind;t=G.bind(G.call)}else{t=function(aD){return function(){return aD.call.apply(aD,arguments)}}}var aj=t(Array.prototype.slice);var S=t(Array.prototype.reduce||function(aG,aF){var aD=0,aE=this.length;if(arguments.length===1){do{if(aD in this){aF=this[aD++];break}if(++aD>=aE){throw new TypeError()}}while(1)}for(;aD<aE;aD++){if(aD in this){aF=aG(aF,this[aD],aD)}}return aF});var an=t(Array.prototype.indexOf||function(aE){for(var aD=0;aD<this.length;aD++){if(this[aD]===aE){return aD}}return -1});var y=t(Array.prototype.map||function(aG,aE){var aD=this;var aF=[];S(aD,function(aJ,aI,aH){aF.push(aG.call(aE,aI,aH,aD))},void 0);return aF});var A=Object.create||function(aE){function aD(){}aD.prototype=aE;return new aD()};var x=Object.keys||function(aD){var aF=[];for(var aE in aD){aF.push(aE)}return aF};var aA=Object.prototype.toString;function w(aD){return(aA(aD)==="[object StopIteration]"||aD instanceof H)}var H;if(typeof ReturnValue!=="undefined"){H=ReturnValue}else{H=function(aD){this.value=aD}}var X="From previous event:";function o(aD,aE){if(aE.stack&&typeof aD==="object"&&aD!==null&&aD.stack&&aD.stack.indexOf(X)===-1){aD.stack=z(aD.stack)+"\n"+X+"\n"+z(aE.stack)}}function z(aG){var aE=aG.split("\n");var aH=[];for(var aF=0;aF<aE.length;++aF){var aD=aE[aF];if(!aq(aD)&&!f(aD)){aH.push(aD)}}return aH.join("\n")}function f(aD){return aD.indexOf("(module.js:")!==-1||aD.indexOf("(node.js:")!==-1}function aq(aE){var aF=/at .+ \((.*):(\d+):\d+\)/.exec(aE);if(!aF){return false}var aG=aF[1];var aD=aF[2];return aG===O&&aD>=V&&aD<=Z}function i(){if(Error.captureStackTrace){var aF,aD;var aE=Error.prepareStackTrace;Error.prepareStackTrace=function(aG,aH){aF=aH[1].getFileName();aD=aH[1].getLineNumber()};new Error().stack;Error.prepareStackTrace=aE;O=aF;return aD}}function az(aF,aD,aE){return function(){if(typeof console!=="undefined"&&typeof console.warn==="function"){console.warn(aD+" is deprecated, use "+aE+" instead.",new Error("").stack)}return aF.apply(aF,arguments)}}L.nextTick=K;L.defer=W;function W(){var aI=[],aG=[],aF;var aD=A(W.prototype);var aH=A(T.prototype);aH.promiseSend=function(aN,aL,aM,aK){var aJ=aj(arguments);if(aI){aI.push(aJ);if(aN==="when"&&aK){aG.push(aK)}}else{K(function(){aF.promiseSend.apply(aF,aJ)})}};aH.valueOf=function(){if(aI){return aH}return aF.valueOf()};if(Error.captureStackTrace){Error.captureStackTrace(aH,W);aH.stack=aH.stack.substring(aH.stack.indexOf("\n")+1)}function aE(aJ){if(!aI){return}aF=U(aJ);S(aI,function(aL,aK){K(function(){aF.promiseSend.apply(aF,aK)})},void 0);aI=void 0;aG=void 0}ac(aH);aD.promise=aH;aD.resolve=aE;aD.reject=function(aJ){aE(ae(aJ))};aD.notify=function(aJ){if(aI){S(aG,function(aL,aK){K(function(){aK(aJ)})},void 0)}};return aD}W.prototype.makeNodeResolver=function(){var aD=this;return function(aE,aF){if(aE){aD.reject(aE)}else{if(arguments.length>2){aD.resolve(aj(arguments,1))}else{aD.resolve(aF)}}}};W.prototype.node=az(W.prototype.makeNodeResolver,"node","makeNodeResolver");L.promise=s;function s(aE){var aD=W();r(aE,aD.resolve,aD.reject,aD.notify).fail(aD.reject);return aD.promise}L.makePromise=T;function T(aF,aH,aD,aE){if(aH===void 0){aH=function(aI){return ae(new Error("Promise does not support operation: "+aI))}}var aG=A(T.prototype);aG.promiseSend=function(aM,aJ){var aK=aj(arguments,2);var aI;try{if(aF[aM]){aI=aF[aM].apply(aG,aK)}else{aI=aH.apply(aG,[aM].concat(aK))}}catch(aL){aI=ae(aL)}if(aJ){aJ(aI)}};if(aD){aG.valueOf=aD}if(aE){aG.exception=aE}ac(aG);return aG}T.prototype.then=function(aD,aE,aF){return au(this,aD,aE,aF)};T.prototype.thenResolve=function(aD){return au(this,function(){return aD})};S(["isResolved","isFulfilled","isRejected","when","spread","send","get","put","del","post","invoke","keys","apply","call","bind","fapply","fcall","fbind","all","allResolved","view","viewInfo","timeout","delay","catch","finally","fail","fin","progress","end","done","nfcall","nfapply","nfbind","ncall","napply","nbind","npost","ninvoke","nend","nodeify"],function(aE,aD){T.prototype[aD]=function(){return L[aD].apply(L,[this].concat(aj(arguments)))}},void 0);T.prototype.toSource=function(){return this.toString()};T.prototype.toString=function(){return"[object Promise]"};ac(T.prototype);L.nearer=q;function q(aD){if(ao(aD)){return aD.valueOf()}return aD}L.isPromise=ao;function ao(aD){return aD&&typeof aD.promiseSend==="function"}L.isResolved=aw;function aw(aD){return d(aD)||n(aD)}L.isFulfilled=d;function d(aD){return !ao(q(aD))}L.isRejected=n;function n(aD){aD=q(aD);return ao(aD)&&"exception" in aD}var N=[];var Y=[];var p;function j(){if(!p&&typeof window!=="undefined"&&!window.Touch&&window.console){console.log("Should be empty:",Y)}p=true}L.reject=ae;function ae(aF){aF=aF||new Error();var aE=T({when:function(aI){if(aI){var aH=an(N,this);if(aH!==-1){Y.splice(aH,1);N.splice(aH,1)}}return aI?aI(aF):ae(aF)}},function aG(){return ae(aF)},function aD(){return this},aF);j();N.push(aE);Y.push(aF);return aE}L.begin=U;L.resolve=U;L.ref=az(U,"ref","resolve");function U(aF){if(ao(aF)){return aF}aF=aD(aF);if(aF&&typeof aF.then==="function"){var aE=W();aF.then(aE.resolve,aE.reject,aE.notify);return aE.promise}return T({when:function(){return aF},get:function(aG){return aF[aG]},put:function(aG,aH){aF[aG]=aH;return aF},del:function(aG){delete aF[aG];return aF},post:function(aG,aH){return aF[aG].apply(aF,aH)},apply:function(aG,aH){return aF.apply(aG,aH)},fapply:function(aG){return aF.apply(void 0,aG)},viewInfo:function(){var aG=aF;var aH={};function aI(aJ){if(!aH[aJ]){aH[aJ]=typeof aG[aJ]}}while(aG){Object.getOwnPropertyNames(aG).forEach(aI);aG=Object.getPrototypeOf(aG)}return{type:typeof aF,properties:aH}},keys:function(){return x(aF)}},void 0,function aD(){return aF})}L.master=e;function e(aD){return T({isDef:function(){}},function aE(){var aF=aj(arguments);return M.apply(void 0,[aD].concat(aF))},function(){return q(aD)})}L.viewInfo=aB;function aB(aD,aE){aD=U(aD);if(aE){return T({viewInfo:function(){return aE}},function aF(){var aG=aj(arguments);return M.apply(void 0,[aD].concat(aG))},function(){return q(aD)})}else{return M(aD,"viewInfo")}}L.view=ak;function ak(aD){return aB(aD).when(function(aG){var aE;if(aG.type==="function"){aE=function(){return ay(aD,void 0,arguments)}}else{aE={}}var aF=aG.properties||{};x(aF).forEach(function(aH){if(aF[aH]==="function"){aE[aH]=function(){return l(aD,aH,arguments)}}});return U(aE)})}L.when=au;function au(aJ,aI,aK,aF){var aL=W();var aG=false;function aH(aO){try{return aI?aI(aO):aO}catch(aN){return ae(aN)}}function aM(aN){if(aK){o(aN,aD);try{return aK(aN)}catch(aO){return ae(aO)}}return ae(aN)}function aE(aN){return aF?aF(aN):aN}var aD=U(aJ);K(function(){aD.promiseSend("when",function(aN){if(aG){return}aG=true;aL.resolve(aH(aN))},function(aN){if(aG){return}aG=true;aL.resolve(aM(aN))})});aD.promiseSend("when",void 0,void 0,function(aN){aL.notify(aE(aN))});return aL.promise}L.spread=E;function E(aF,aD,aE){return au(aF,function(aG){return ar(aG).then(function(aH){return aD.apply(void 0,aH)},aE)},aE)}L.async=R;function R(aD){return function(){function aF(aL,aJ){var aI;try{aI=aG[aL](aJ)}catch(aK){if(w(aK)){return aK.value}else{return ae(aK)}}return au(aI,aH,aE)}var aG=aD.apply(this,arguments);var aH=aF.bind(aF,"send");var aE=aF.bind(aF,"throw");return aH()}}L["return"]=g;function g(aD){throw new H(aD)}L.promised=ax;function ax(aD){return function(){return ar([this,ar(arguments)]).spread(function(aE,aF){return aD.apply(aE,aF)})}}L.sender=az(aa,"sender","dispatcher");L.Method=az(aa,"Method","dispatcher");function aa(aD){return function(aF){var aE=aj(arguments,1);return M.apply(void 0,[aF,aD].concat(aE))}}L.send=az(M,"send","dispatch");function M(aF,aG){var aD=W();var aE=aj(arguments,2);aF=U(aF);K(function(){aF.promiseSend.apply(aF,[aG,aD.resolve].concat(aE))});return aD.promise}L.dispatch=aC;function aC(aF,aG,aE){var aD=W();aF=U(aF);K(function(){aF.promiseSend.apply(aF,[aG,aD.resolve].concat(aE))});return aD.promise}L.dispatcher=D;function D(aD){return function(aF){var aE=aj(arguments,1);return aC(aF,aD,aE)}}L.get=D("get");L.put=D("put");L["delete"]=L.del=D("del");var l=L.post=D("post");L.invoke=function(aF,aE){var aD=aj(arguments,2);return l(aF,aE,aD)};var ay=L.apply=az(D("apply"),"apply","fapply");var at=L.fapply=D("fapply");L.call=az(J,"call","fcall");function J(aF,aE){var aD=aj(arguments,2);return ay(aF,aE,aD)}L["try"]=r;L.fcall=r;function r(aE){var aD=aj(arguments,1);return at(aE,aD)}L.bind=az(av,"bind","fbind");function av(aG,aE){var aD=aj(arguments,2);return function aF(){var aH=aD.concat(aj(arguments));return ay(aG,aE,aH)}}L.fbind=ab;function ab(aF){var aD=aj(arguments,1);return function aE(){var aG=aD.concat(aj(arguments));return at(aF,aG)}}L.keys=D("keys");L.all=ar;function ar(aD){return au(aD,function(aG){var aF=aG.length;if(aF===0){return U(aG)}var aE=W();S(aG,function(aJ,aI,aH){if(d(aI)){aG[aH]=q(aI);if(--aF===0){aE.resolve(aG)}}else{au(aI,function(aK){aG[aH]=aK;if(--aF===0){aE.resolve(aG)}}).fail(aE.reject)}},void 0);return aE.promise})}L.allResolved=P;function P(aD){return au(aD,function(aE){return au(ar(y(aE,function(aF){return au(aF,al,al)})),function(){return y(aE,U)})})}L["catch"]=L.fail=a;function a(aE,aD){return au(aE,void 0,aD)}L.progress=B;function B(aD,aE){return au(aD,void 0,void 0,aE)}L["finally"]=L.fin=m;function m(aD,aE){return au(aD,function(aF){return au(aE(),function(){return aF})},function(aF){return au(aE(),function(){return ae(aF)})})}L.end=az(ah,"end","done");L.done=ah;function ah(aI,aD,aH,aG){function aE(aJ){K(function(){o(aJ,aI);if(L.onerror){L.onerror(aJ)}else{throw aJ}})}var aF=aD||aH||aG?au(aI,aD,aH,aG):aI;a(aF,aE)}L.timeout=ad;function ad(aG,aE){var aD=W();var aF=setTimeout(function(){aD.reject(new Error("Timed out after "+aE+" ms"))},aE);au(aG,function(aH){clearTimeout(aF);aD.resolve(aH)},function(aH){clearTimeout(aF);aD.reject(aH)});return aD.promise}L.delay=b;function b(aF,aE){if(aE===void 0){aE=aF;aF=void 0}var aD=W();setTimeout(function(){aD.resolve(aF)},aE);return aD.promise}L.nfapply=v;function v(aG,aE){var aF=aj(aE);var aD=W();aF.push(aD.makeNodeResolver());at(aG,aF).fail(aD.reject);return aD.promise}L.nfcall=F;function F(aF){var aE=aj(arguments,1);var aD=W();aE.push(aD.makeNodeResolver());at(aF,aE).fail(aD.reject);return aD.promise}L.nfbind=am;function am(aE){var aD=aj(arguments,1);return function(){var aG=aD.concat(aj(arguments));var aF=W();aG.push(aF.makeNodeResolver());at(aE,aG).fail(aF.reject);return aF.promise}}L.napply=az(h,"napply","npost");function h(aF,aE,aD){return k(aF,aE).apply(void 0,aD)}L.ncall=az(af,"ncall","ninvoke");function af(aF,aE){var aD=aj(arguments,2);return h(aF,aE,aD)}L.nbind=az(k,"nbind","nfbind");function k(aG){if(arguments.length>1){var aE=arguments[1];var aD=aj(arguments,2);var aF=aG;aG=function(){var aH=aD.concat(aj(arguments));return aF.apply(aE,aH)}}return function(){var aH=W();var aI=aj(arguments);aI.push(aH.makeNodeResolver());at(aG,aI).fail(aH.reject);return aH.promise}}L.npost=I;function I(aG,aF,aE){var aH=aj(aE);var aD=W();aH.push(aD.makeNodeResolver());l(aG,aF,aH).fail(aD.reject);return aD.promise}L.ninvoke=ai;function ai(aF,aE){var aG=aj(arguments,2);var aD=W();aG.push(aD.makeNodeResolver());l(aF,aE,aG).fail(aD.reject);return aD.promise}L.nend=az(c,"nend","nodeify");L.nodeify=c;function c(aE,aD){if(aD){aE.then(function(aF){K(function(){aD(null,aF)})},function(aF){K(function(){aD(aF)})})}else{return aE}}var Z=i()});