/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * With formatStackTrace and formatSourcePosition functions
 * Copyright 2006-2008 the V8 project authors. All rights reserved.
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *     * Neither the name of Google Inc. nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
(function(a){if(typeof define==="function"){define(a)}else{if(typeof exports==="object"){a(void 0,exports)}else{if(typeof ses!=="undefined"){if(!ses.ok()){return}else{ses.makeQ=function(){var b={};return a(void 0,b)}}}else{a(void 0,Q={})}}}})(function(i,ad){var ah=function(){};var q=Object.freeze||ah;if(typeof cajaVM!=="undefined"){q=cajaVM.def}var aj;if(typeof process!=="undefined"){aj=process.nextTick}else{if(typeof msSetImmediate==="function"){aj=msSetImmediate.bind(window)}else{if(typeof setImmediate==="function"){aj=setImmediate}else{if(typeof MessageChannel!=="undefined"){var R=new MessageChannel();var w={},am=w;R.port1.onmessage=function(){w=w.next;var ao=w.task;delete w.task;ao()};aj=function(ao){am=am.next={task:ao};R.port2.postMessage(0)}}else{aj=function(ao){setTimeout(ao,0)}}}}}var t;if(Function.prototype.bind){var H=Function.prototype.bind;t=H.bind(H.call)}else{t=function(ao){return function(ap){return ao.call.apply(ao,arguments)}}}var af=t(Array.prototype.slice);var f=t(Array.prototype.reduce||function(ar,aq){var ao=0,ap=this.length;if(arguments.length===1){do{if(ao in this){aq=this[ao++];break}if(++ao>=ap){throw new TypeError()}}while(1)}for(;ao<ap;ao++){if(ao in this){aq=ar(aq,this[ao],ao)}}return aq});var S=t(Array.prototype.indexOf||function(ap){for(var ao=0;ao<this.length;ao++){if(this[ao]===ap){return ao}}return -1});var c=t(Array.prototype.map||function(ar,ap){var ao=this;var aq=[];f(ao,function(av,au,at){aq.push(ar.call(ap,au,at,ao))},void 0);return aq});var L=Object.create||function(ap){function ao(){}ao.prototype=ap;return new ao()};var J=Object.keys||function(ao){var aq=[];for(var ap in ao){aq.push(ap)}return aq};var an=Object.prototype.toString;function z(ao){return(an(ao)==="[object StopIteration]"||ao instanceof M)}var M;if(typeof ReturnValue!=="undefined"){M=ReturnValue}else{M=function(ao){this.value=ao}}function x(ar,aw){var aq=[];try{aq.push(ar.toString())}catch(au){try{aq.push("<error: "+au+">")}catch(ap){aq.push("<error>")}}for(var at=0;at<aw.length;at++){var av=aw[at];var ao;if(typeof av==="string"){aq.push(av)}else{try{ao=W(av)}catch(au){try{ao="<error: "+au+">"}catch(ap){ao="<error>"}}aq.push("    at "+ao)}}return aq.join("\n")}function W(ap){var au="";if(ap.isNative()){au="native"}else{if(ap.isEval()){au="eval at "+ap.getEvalOrigin()}else{var ar=ap.getFileName();if(ar){au+=ar;var aq=ap.getLineNumber();if(aq!==null){au+=":"+aq;var ao=ap.getColumnNumber();if(ao){au+=":"+ao}}}}}if(!au){au="unknown source"}var az="";var av=ap.getFunction().name;var ay=true;var ax=ap.isConstructor();var at=!(ap.isToplevel()||ax);if(at){var aw=ap.getMethodName();az+=ap.getTypeName()+".";if(av){az+=av;if(aw&&(aw!==av)){az+=" [as "+aw+"]"}}else{az+=aw||"<anonymous>"}}else{if(ax){az+="new "+(av||"<anonymous>")}else{if(av){az+=av}else{az+=au;ay=false}}}if(ay){az+=" ("+au+")"}return az}function d(aq){var ap=Error.prepareStackTrace;Error.prepareStackTrace=function(ar,at){return at.filter(function(au){var av=au.getFileName();return(av!=="module.js"&&av!=="node.js"&&av!==p)})};var ao=aq.stack;Error.prepareStackTrace=ap;return ao}var p;if(Error.captureStackTrace){p=(function(){var ap;var ao=Error.prepareStackTrace;Error.prepareStackTrace=function(aq,ar){ap=ar[0].getFileName()};new Error().stack;Error.prepareStackTrace=ao;return ap})()}ad.nextTick=aj;ad.defer=n;function n(){var at=[],aq;var ao=L(n.prototype);var ar=L(ag.prototype);ar.promiseSend=function(){var au=af(arguments);if(at){at.push(au)}else{aj(function(){aq.promiseSend.apply(aq,au)})}};ar.valueOf=function(){if(at){return ar}return aq.valueOf()};if(Error.captureStackTrace){Error.captureStackTrace(ar,n)}function ap(au){if(!at){return}aq=E(au);f(at,function(aw,av){aj(function(){aq.promiseSend.apply(aq,av)})},void 0);at=void 0;return aq}q(ar);ao.promise=ar;ao.resolve=ap;ao.reject=function(au){return ap(G(au))};return ao}n.prototype.node=n.prototype.makeNodeResolver=function(){var ao=this;return function(ap,aq){if(ap){ao.reject(ap)}else{if(arguments.length>2){ao.resolve(af(arguments,1))}else{ao.resolve(aq)}}}};ad.promise=X;function X(ap){var ao=n();b(ap,void 0,ao.resolve,ao.reject).fail(ao.reject);return ao.promise}ad.makePromise=ag;function ag(aq,at,ao,ap){if(at===void 0){at=function(au){return G(new Error("Promise does not support operation: "+au))}}var ar=L(ag.prototype);ar.promiseSend=function(ay,av){var aw=af(arguments,2);var au;try{if(aq[ay]){au=aq[ay].apply(ar,aw)}else{au=at.apply(ar,[ay].concat(aw))}}catch(ax){au=G(ax)}av(au)};if(ao){ar.valueOf=ao}if(ap){ar.exception=ap}q(ar);return ar}ag.prototype.then=function(ao,ap){return P(this,ao,ap)};f(["isResolved","isFulfilled","isRejected","when","spread","send","get","put","del","post","invoke","keys","apply","call","bind","fapply","fcall","fbind","all","allResolved","view","viewInfo","timeout","delay","catch","finally","fail","fin","end"],function(ap,ao){ag.prototype[ao]=function(){return ad[ao].apply(ad,[this].concat(af(arguments)))}},void 0);ag.prototype.toSource=function(){return this.toString()};ag.prototype.toString=function(){return"[object Promise]"};q(ag.prototype);ad.nearer=v;function v(ao){if(Object(ao)!==ao){return ao}else{return ao.valueOf()}}ad.isPromise=D;function D(ao){return ao&&typeof ao.promiseSend==="function"}ad.isResolved=j;function j(ao){return T(ao)||Z(ao)}ad.isFulfilled=T;function T(ao){return !D(v(ao))}ad.isRejected=Z;function Z(ao){ao=v(ao);return D(ao)&&"exception" in ao}var Y=[];var F=[];if(typeof window!=="undefined"&&window.console){console.log("Should be empty:",F)}ad.reject=G;function G(aq){aq=aq||new Error();var ap=ag({when:function(av){if(av){var au=S(Y,this);if(au!==-1){F.splice(au,1);Y.splice(au,1)}}return av?av(aq):G(aq)}},function ar(at){return G(aq)},function ao(){return this},aq);Y.push(ap);F.push(aq);return ap}ad.begin=E;ad.resolve=E;ad.ref=E;function E(aq){if(D(aq)){return aq}if(aq&&typeof aq.then==="function"){var ap=n();aq.then(ap.resolve,ap.reject);return ap.promise}return ag({when:function(ar){return aq},get:function(ar){return aq[ar]},put:function(ar,at){return aq[ar]=at},del:function(ar){return delete aq[ar]},post:function(ar,at){return aq[ar].apply(aq,at)},apply:function(ar,at){return aq.apply(ar,at)},fapply:function(ar){return aq.apply(void 0,ar)},viewInfo:function(){var ar=aq;var at={};function au(av){if(!at[av]){at[av]=typeof ar[av]}}while(ar){Object.getOwnPropertyNames(ar).forEach(au);ar=Object.getPrototypeOf(ar)}return{type:typeof aq,properties:at}},keys:function(){return J(aq)}},void 0,function ao(){return aq})}ad.master=y;function y(ao){return ag({isDef:function(){}},function ap(ar){var aq=af(arguments);return K.apply(void 0,[ao].concat(aq))},function(){return v(ao)})}ad.viewInfo=ac;function ac(ao,ap){ao=E(ao);if(ap){return ag({viewInfo:function(){return ap}},function aq(at){var ar=af(arguments);return K.apply(void 0,[ao].concat(ar))},function(){return v(ao)})}else{return K(ao,"viewInfo")}}ad.view=e;function e(ao){return ac(ao).when(function(ar){var ap;if(ar.type==="function"){ap=function(){return ak(ao,void 0,arguments)}}else{ap={}}var aq=ar.properties||{};J(aq).forEach(function(at){if(aq[at]==="function"){ap[at]=function(){return B(ao,at,arguments)}}});return E(ap)})}ad.when=P;function P(au,aq,at){var ar=n();var ap=false;function ao(ax){try{return aq?aq(ax):ax}catch(aw){return G(aw)}}function av(aw){try{return at?at(aw):G(aw)}catch(ax){return G(ax)}}aj(function(){E(au).promiseSend("when",function(aw){if(ap){return}ap=true;E(aw).promiseSend("when",function(ax){ar.resolve(ao(ax))},function(ax){ar.resolve(av(ax))})},function(aw){if(ap){return}ap=true;ar.resolve(av(aw))})});return ar.promise}ad.spread=h;function h(aq,ao,ap){return P(aq,function(ar){return ao.apply(void 0,ar)},ap)}ad.async=V;function V(ao){return function(){function aq(ax,av){var au;try{au=ar[ax](av)}catch(aw){if(z(aw)){return aw.value}else{return G(aw)}}return P(au,at,ap)}var ar=ao.apply(this,arguments);var at=aq.bind(aq,"send");var ap=aq.bind(aq,"throw");return at()}}ad["return"]=o;function o(ao){throw new M(ao)}ad.sender=m;ad.Method=m;function m(ao){return function(aq){var ap=af(arguments,1);return K.apply(void 0,[aq,ao].concat(ap))}}ad.send=K;function K(aq,ar){var ao=n();var ap=af(arguments,2);aq=E(aq);aj(function(){aq.promiseSend.apply(aq,[ar,ao.resolve].concat(ap))});return ao.promise}ad.dispatch=ab;function ab(aq,ar,ap){var ao=n();aq=E(aq);aj(function(){aq.promiseSend.apply(aq,[ar,ao.resolve].concat(ap))});return ao.promise}ad.dispatcher=I;function I(ao){return function(aq){var ap=af(arguments,1);return ab(aq,ao,ap)}}ad.get=I("get");ad.put=I("put");ad["delete"]=ad.del=I("del");var B=ad.post=I("post");ad.invoke=function(aq,ap){var ao=af(arguments,2);return B(aq,ap,ao)};var ak=ad.apply=I("apply");var N=ad.fapply=I("fapply");ad.call=b;function b(aq,ap){var ao=af(arguments,2);return ak(aq,ap,ao)}ad["try"]=k;ad.fcall=k;function k(ap){var ao=af(arguments,1);return N(ap,ao)}ad.bind=l;function l(ar,ap){var ao=af(arguments,2);return function aq(){var at=ao.concat(af(arguments));return ak(ar,ap,at)}}ad.fbind=r;function r(aq){var ao=af(arguments,1);return function ap(){var ar=ao.concat(af(arguments));return N(aq,ar)}}ad.keys=I("keys");ad.all=C;function C(ao){return P(ao,function(ar){var aq=ar.length;if(aq===0){return E(ar)}var ap=n();f(ar,function(av,au,at){P(au,function(aw){ar[at]=aw;if(--aq===0){ap.resolve(ar)}}).fail(ap.reject)},void 0);return ap.promise})}ad.allResolved=g;function g(ao){return P(ao,function(ap){return P(C(c(ap,function(aq){return P(aq,ah,ah)})),function(){return c(ap,E)})})}ad["catch"]=ad.fail=s;function s(ap,ao){return P(ap,void 0,ao)}ad["finally"]=ad.fin=aa;function aa(ao,ap){return P(ao,function(aq){return P(ap(),function(){return aq})},function(aq){return P(ap(),function(){return G(aq)})})}ad.end=A;function A(ao){P(ao,void 0,function(ap){aj(function(){if(Error.captureStackTrace){var aq=d(ap);var ar=d(ao);var at=aq.concat("From previous event:",ar);ap.stack=x(ap,at)}throw ap})})}ad.timeout=ae;function ae(aq,ap){var ao=n();P(aq,ao.resolve,ao.reject);setTimeout(function(){ao.reject(new Error("Timed out after "+ap+"ms"))},ap);return ao.promise}ad.delay=O;function O(aq,ap){if(ap===void 0){ap=aq;aq=void 0}var ao=n();setTimeout(function(){ao.resolve(aq)},ap);return ao.promise}ad.napply=U;function U(aq,ap,ao){return a(aq,ap).apply(void 0,ao)}ad.ncall=ai;function ai(aq,ap){var ao=af(arguments,2);return U(aq,ap,ao)}ad.nbind=a;function a(ar){if(arguments.length>1){var ap=arguments[1];var ao=af(arguments,2);var aq=ar;ar=function(){var at=ao.concat(af(arguments));return aq.apply(ap,at)}}return function(){var at=n();var au=af(arguments);au.push(at.makeNodeResolver());N(ar,au).fail(at.reject);return at.promise}}ad.npost=u;function u(aq,ap,ao){return U(aq[ap],ap,ao)}ad.ninvoke=al;function al(aq,ap){var ao=af(arguments,2);return U(aq[ap],ap,ao)}q(ad)});