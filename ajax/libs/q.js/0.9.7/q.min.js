/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
(function(a){if(typeof bootstrap==="function"){bootstrap("promise",a)}else{if(typeof exports==="object"){module.exports=a()}else{if(typeof define==="function"&&define.amd){define(a)}else{if(typeof ses!=="undefined"){if(!ses.ok()){return}else{ses.makeQ=a}}else{Q=a()}}}}})(function(){var H=false;try{throw new Error()}catch(al){H=!!al.stack}var x=aa();var k;var ah=function(){};var am=(function(){var au={task:void 0,next:null};var at=au;var aw=false;var ap=void 0;var ar=false;function e(){while(au.next){au=au.next;var ax=au.task;au.task=void 0;var ay=au.domain;if(ay){au.domain=void 0;ay.enter()}try{ax()}catch(az){if(ar){if(ay){ay.exit()}setTimeout(e,0);if(ay){ay.enter()}throw az}else{setTimeout(function(){throw az},0)}}if(ay){ay.exit()}}aw=false}am=function(ax){at=at.next={task:ax,domain:ar&&process.domain,next:null};if(!aw){aw=true;ap()}};if(typeof process!=="undefined"&&process.nextTick){ar=true;ap=function(){process.nextTick(e)}}else{if(typeof setImmediate==="function"){if(typeof window!=="undefined"){ap=setImmediate.bind(window,e)}else{ap=function(){setImmediate(e)}}}else{if(typeof MessageChannel!=="undefined"){var av=new MessageChannel();av.port1.onmessage=function(){ap=aq;av.port1.onmessage=e;e()};var aq=function(){av.port2.postMessage(0)};ap=function(){setTimeout(e,0);aq()}}else{ap=function(){setTimeout(e,0)}}}}return am})();var a=Function.call;function s(e){return function(){return a.apply(e,arguments)}}var af=s(Array.prototype.slice);var d=s(Array.prototype.reduce||function(ar,aq){var e=0,ap=this.length;if(arguments.length===1){do{if(e in this){aq=this[e++];break}if(++e>=ap){throw new TypeError()}}while(1)}for(;e<ap;e++){if(e in this){aq=ar(aq,this[e],e)}}return aq});var V=s(Array.prototype.indexOf||function(ap){for(var e=0;e<this.length;e++){if(this[e]===ap){return e}}return -1});var b=s(Array.prototype.map||function(ar,ap){var e=this;var aq=[];d(e,function(av,au,at){aq.push(ar.call(ap,au,at,e))},void 0);return aq});var K=Object.create||function(ap){function e(){}e.prototype=ap;return new e()};var D=s(Object.prototype.hasOwnProperty);var J=Object.keys||function(e){var aq=[];for(var ap in e){if(D(e,ap)){aq.push(ap)}}return aq};var ao=s(Object.prototype.toString);function Z(e){return e===Object(e)}function z(e){return(ao(e)==="[object StopIteration]"||e instanceof L)}var L;if(typeof ReturnValue!=="undefined"){L=ReturnValue}else{L=function(e){this.value=e}}var c;try{new Function("(function* (){ yield 1; })");c=true}catch(al){c=false}var ac="From previous event:";function n(e,at){if(H&&at.stack&&typeof e==="object"&&e!==null&&e.stack&&e.stack.indexOf(ac)===-1){var aq=[];for(var ar=at;!!ar;ar=ar.source){if(ar.stack){aq.unshift(ar.stack)}}aq.unshift(e.stack);var ap=aq.join("\n"+ac+"\n");e.stack=N(ap)}}function N(ar){var ap=ar.split("\n");var at=[];for(var aq=0;aq<ap.length;++aq){var e=ap[aq];if(!h(e)&&!ad(e)&&e){at.push(e)}}return at.join("\n")}function ad(e){return e.indexOf("(module.js:")!==-1||e.indexOf("(node.js:")!==-1}function aj(e){var ar=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(e);if(ar){return[ar[1],Number(ar[2])]}var aq=/at ([^ ]+):(\d+):(?:\d+)$/.exec(e);if(aq){return[aq[1],Number(aq[2])]}var ap=/.*@(.+):(\d+)$/.exec(e);if(ap){return[ap[1],Number(ap[2])]}}function h(ap){var aq=aj(ap);if(!aq){return false}var ar=aq[0];var e=aq[1];return ar===k&&e>=x&&e<=v}function aa(){if(!H){return}try{throw new Error()}catch(at){var ap=at.stack.split("\n");var aq=ap[0].indexOf("@")>0?ap[1]:ap[2];var ar=aj(aq);if(!ar){return}k=ar[0];return ar[1]}}function F(aq,e,ap){return function(){if(typeof console!=="undefined"&&typeof console.warn==="function"){console.warn(e+" is deprecated, use "+ap+" instead.",new Error("").stack)}return aq.apply(aq,arguments)}}function m(e){if(B(e)){return e}if(P(e)){return O(e)}else{return C(e)}}m.resolve=m;m.nextTick=am;m.longStackSupport=false;m.defer=i;function i(){var ar=[],au=[],at;var ap=K(i.prototype);var aw=K(R.prototype);aw.promiseDispatch=function(ay,az,ax){var e=af(arguments);if(ar){ar.push(e);if(az==="when"&&ax[1]){au.push(ax[1])}}else{am(function(){at.promiseDispatch.apply(at,e)})}};aw.valueOf=F(function(){if(ar){return aw}var e=M(at);if(B(e)){at=e}return e},"valueOf","inspect");aw.inspect=function(){if(!at){return{state:"pending"}}return at.inspect()};if(m.longStackSupport&&H){try{throw new Error()}catch(av){aw.stack=av.stack.substring(av.stack.indexOf("\n")+1)}}function aq(e){at=e;aw.source=e;d(ar,function(ay,ax){am(function(){e.promiseDispatch.apply(e,ax)})},void 0);ar=void 0;au=void 0}ap.promise=aw;ap.resolve=function(e){if(at){return}aq(m(e))};ap.fulfill=function(e){if(at){return}aq(C(e))};ap.reject=function(e){if(at){return}aq(G(e))};ap.notify=function(e){if(at){return}d(au,function(ay,ax){am(function(){ax(e)})},void 0)};return ap}i.prototype.makeNodeResolver=function(){var e=this;return function(ap,aq){if(ap){e.reject(ap)}else{if(arguments.length>2){e.resolve(af(arguments,1))}else{e.resolve(aq)}}}};m.promise=X;function X(aq){if(typeof aq!=="function"){throw new TypeError("resolver must be a function.")}var e=i();try{aq(e.resolve,e.reject,e.notify)}catch(ap){e.reject(ap)}return e.promise}m.passByCopy=function(e){return e};R.prototype.passByCopy=function(){return this};m.join=function(e,ap){return m(e).join(ap)};R.prototype.join=function(e){return m([this,e]).spread(function(ap,aq){if(ap===aq){return ap}else{throw new Error("Can't join: not the same: "+ap+" "+aq)}})};m.race=q;function q(e){return X(function(at,ar){for(var aq=0,ap=e.length;aq<ap;aq++){m(e[aq]).then(at,ar)}})}R.prototype.race=function(){return this.then(m.race)};m.makePromise=R;function R(ap,at,ar){if(at===void 0){at=function(au){return G(new Error("Promise does not support operation: "+au))}}if(ar===void 0){ar=function(){return{state:"unknown"}}}var aq=K(R.prototype);aq.promiseDispatch=function(ax,ay,av){var au;try{if(ap[ay]){au=ap[ay].apply(aq,av)}else{au=at.call(aq,ay,av)}}catch(aw){au=G(aw)}if(ax){ax(au)}};aq.inspect=ar;if(ar){var e=ar();if(e.state==="rejected"){aq.exception=e.reason}aq.valueOf=F(function(){var au=ar();if(au.state==="pending"||au.state==="rejected"){return aq}return au.value})}return aq}R.prototype.toString=function(){return"[object Promise]"};R.prototype.then=function(at,au,ap){var av=this;var aw=i();var aq=false;function ar(az){try{return typeof at==="function"?at(az):az}catch(ay){return G(ay)}}function ax(ay){if(typeof au==="function"){n(ay,av);try{return au(ay)}catch(az){return G(az)}}return G(ay)}function e(ay){return typeof ap==="function"?ap(ay):ay}am(function(){av.promiseDispatch(function(ay){if(aq){return}aq=true;aw.resolve(ar(ay))},"when",[function(ay){if(aq){return}aq=true;aw.resolve(ax(ay))}])});av.promiseDispatch(void 0,"when",[void 0,function(ay){var aA;var aB=false;try{aA=e(ay)}catch(az){aB=true;if(m.onerror){m.onerror(az)}else{throw az}}if(!aB){aw.notify(aA)}}]);return aw.promise};m.when=T;function T(aq,e,ap,ar){return m(aq).then(e,ap,ar)}R.prototype.thenResolve=function(e){return this.then(function(){return e})};m.thenResolve=function(ap,e){return m(ap).thenResolve(e)};R.prototype.thenReject=function(e){return this.then(function(){throw e})};m.thenReject=function(ap,e){return m(ap).thenReject(e)};m.nearer=M;function M(ap){if(B(ap)){var e=ap.inspect();if(e.state==="fulfilled"){return e.value}}return ap}m.isPromise=B;function B(e){return Z(e)&&typeof e.promiseDispatch==="function"&&typeof e.inspect==="function"}m.isPromiseAlike=P;function P(e){return Z(e)&&typeof e.then==="function"}m.isPending=ag;function ag(e){return B(e)&&e.inspect().state==="pending"}R.prototype.isPending=function(){return this.inspect().state==="pending"};m.isFulfilled=U;function U(e){return !B(e)||e.inspect().state==="fulfilled"}R.prototype.isFulfilled=function(){return this.inspect().state==="fulfilled"};m.isRejected=Y;function Y(e){return B(e)&&e.inspect().state==="rejected"}R.prototype.isRejected=function(){return this.inspect().state==="rejected"};var ae=[];var an=[];var o=false;var r=true;function S(){if(!o&&typeof window!=="undefined"&&!window.Touch&&window.console){console.warn("[Q] Unhandled rejection reasons (should be empty):",ae)}o=true}function p(){for(var e=0;e<ae.length;e++){var ap=ae[e];console.warn("Unhandled rejection reason:",ap)}}function ak(){ae.length=0;an.length=0;o=false;if(!r){r=true;if(typeof process!=="undefined"&&process.on){process.on("exit",p)}}}function E(ap,e){if(!r){return}an.push(ap);if(e&&typeof e.stack!=="undefined"){ae.push(e.stack)}else{ae.push("(no stack) "+e)}S()}function l(ap){if(!r){return}var e=V(an,ap);if(e!==-1){an.splice(e,1);ae.splice(e,1)}}m.resetUnhandledRejections=ak;m.getUnhandledReasons=function(){return ae.slice()};m.stopUnhandledRejectionTracking=function(){ak();if(typeof process!=="undefined"&&process.on){process.removeListener("exit",p)}r=false};ak();m.reject=G;function G(ap){var e=R({when:function(at){if(at){l(this)}return at?at(ap):this}},function ar(){return this},function aq(){return{state:"rejected",reason:ap}});E(e,ap);return e}m.fulfill=C;function C(e){return R({when:function(){return e},get:function(aq){return e[aq]},set:function(aq,ar){e[aq]=ar},"delete":function(aq){delete e[aq]},post:function(ar,aq){if(ar===null||ar===void 0){return e.apply(void 0,aq)}else{return e[ar].apply(e,aq)}},apply:function(ar,aq){return e.apply(ar,aq)},keys:function(){return J(e)}},void 0,function ap(){return{state:"fulfilled",value:e}})}function O(ap){var e=i();am(function(){try{ap.then(e.resolve,e.reject,e.notify)}catch(aq){e.reject(aq)}});return e.promise}m.master=y;function y(e){return R({isDef:function(){}},function ap(ar,aq){return ab(e,ar,aq)},function(){return m(e).inspect()})}m.spread=g;function g(aq,e,ap){return m(aq).spread(e,ap)}R.prototype.spread=function(e,ap){return this.all().then(function(aq){return e.apply(void 0,aq)},ap)};m.async=W;function W(e){return function(){function aq(ax,av){var au;if(c){try{au=ar[ax](av)}catch(aw){return G(aw)}if(au.done){return au.value}else{return T(au.value,at,ap)}}else{try{au=ar[ax](av)}catch(aw){if(z(aw)){return aw.value}else{return G(aw)}}return T(au,at,ap)}}var ar=e.apply(this,arguments);var at=aq.bind(aq,"next");var ap=aq.bind(aq,"throw");return at()}}m.spawn=u;function u(e){m.done(m.async(e)())}m["return"]=j;function j(e){throw new L(e)}m.promised=t;function t(e){return function(){return g([this,A(arguments)],function(ap,aq){return e.apply(ap,aq)})}}m.dispatch=ab;function ab(ap,aq,e){return m(ap).dispatch(aq,e)}R.prototype.dispatch=function(ar,aq){var ap=this;var e=i();am(function(){ap.promiseDispatch(e.resolve,ar,aq)});return e.promise};m.get=function(e,ap){return m(e).dispatch("get",[ap])};R.prototype.get=function(e){return this.dispatch("get",[e])};m.set=function(e,ap,aq){return m(e).dispatch("set",[ap,aq])};R.prototype.set=function(e,ap){return this.dispatch("set",[e,ap])};m.del=m["delete"]=function(e,ap){return m(e).dispatch("delete",[ap])};R.prototype.del=R.prototype["delete"]=function(e){return this.dispatch("delete",[e])};m.mapply=m.post=function(aq,ap,e){return m(aq).dispatch("post",[ap,e])};R.prototype.mapply=R.prototype.post=function(ap,e){return this.dispatch("post",[ap,e])};m.send=m.mcall=m.invoke=function(ap,e){return m(ap).dispatch("post",[e,af(arguments,2)])};R.prototype.send=R.prototype.mcall=R.prototype.invoke=function(e){return this.dispatch("post",[e,af(arguments,1)])};m.fapply=function(ap,e){return m(ap).dispatch("apply",[void 0,e])};R.prototype.fapply=function(e){return this.dispatch("apply",[void 0,e])};m["try"]=m.fcall=function(e){return m(e).dispatch("apply",[void 0,af(arguments,1)])};R.prototype.fcall=function(){return this.dispatch("apply",[void 0,af(arguments)])};m.fbind=function(ap){var ar=m(ap);var e=af(arguments,1);return function aq(){return ar.dispatch("apply",[this,e.concat(af(arguments))])}};R.prototype.fbind=function(){var aq=this;var e=af(arguments);return function ap(){return aq.dispatch("apply",[this,e.concat(af(arguments))])}};m.keys=function(e){return m(e).dispatch("keys",[])};R.prototype.keys=function(){return this.dispatch("keys",[])};m.all=A;function A(e){return T(e,function(ar){var aq=0;var ap=i();d(ar,function(aw,av,au){var at;if(B(av)&&(at=av.inspect()).state==="fulfilled"){ar[au]=at.value}else{++aq;T(av,function(ax){ar[au]=ax;if(--aq===0){ap.resolve(ar)}},ap.reject,function(ax){ap.notify({index:au,value:ax})})}},void 0);if(aq===0){ap.resolve(ar)}return ap.promise})}R.prototype.all=function(){return A(this)};m.allResolved=F(f,"allResolved","allSettled");function f(e){return T(e,function(ap){ap=b(ap,m);return T(A(b(ap,function(aq){return T(aq,ah,ah)})),function(){return ap})})}R.prototype.allResolved=function(){return f(this)};m.allSettled=w;function w(e){return m(e).allSettled()}R.prototype.allSettled=function(){return this.then(function(e){return A(b(e,function(aq){aq=m(aq);function ap(){return aq.inspect()}return aq.then(ap,ap)}))})};m.fail=m["catch"]=function(e,ap){return m(e).then(void 0,ap)};R.prototype.fail=R.prototype["catch"]=function(e){return this.then(void 0,e)};m.progress=I;function I(e,ap){return m(e).then(void 0,void 0,ap)}R.prototype.progress=function(e){return this.then(void 0,void 0,e)};m.fin=m["finally"]=function(e,ap){return m(e)["finally"](ap)};R.prototype.fin=R.prototype["finally"]=function(e){e=m(e);return this.then(function(ap){return e.fcall().then(function(){return ap})},function(ap){return e.fcall().then(function(){throw ap})})};m.done=function(aq,e,ar,ap){return m(aq).done(e,ar,ap)};R.prototype.done=function(e,ar,aq){var ap=function(au){am(function(){n(au,at);if(m.onerror){m.onerror(au)}else{throw au}})};var at=e||ar||aq?this.then(e,ar,aq):this;if(typeof process==="object"&&process&&process.domain){ap=process.domain.bind(ap)}at.then(void 0,ap)};m.timeout=function(ap,e,aq){return m(ap).timeout(e,aq)};R.prototype.timeout=function(ap,aq){var e=i();var ar=setTimeout(function(){e.reject(new Error(aq||"Timed out after "+ap+" ms"))},ap);this.then(function(at){clearTimeout(ar);e.resolve(at)},function(at){clearTimeout(ar);e.reject(at)},e.notify);return e.promise};m.delay=function(e,ap){if(ap===void 0){ap=e;e=void 0}return m(e).delay(ap)};R.prototype.delay=function(e){return this.then(function(aq){var ap=i();setTimeout(function(){ap.resolve(aq)},e);return ap.promise})};m.nfapply=function(ap,e){return m(ap).nfapply(e)};R.prototype.nfapply=function(ap){var e=i();var aq=af(ap);aq.push(e.makeNodeResolver());this.fapply(aq).fail(e.reject);return e.promise};m.nfcall=function(ap){var e=af(arguments,1);return m(ap).nfapply(e)};R.prototype.nfcall=function(){var ap=af(arguments);var e=i();ap.push(e.makeNodeResolver());this.fapply(ap).fail(e.reject);return e.promise};m.nfbind=m.denodeify=function(ap){var e=af(arguments,1);return function(){var ar=e.concat(af(arguments));var aq=i();ar.push(aq.makeNodeResolver());m(ap).fapply(ar).fail(aq.reject);return aq.promise}};R.prototype.nfbind=R.prototype.denodeify=function(){var e=af(arguments);e.unshift(this);return m.denodeify.apply(void 0,e)};m.nbind=function(aq,e){var ap=af(arguments,2);return function(){var au=ap.concat(af(arguments));var ar=i();au.push(ar.makeNodeResolver());function at(){return aq.apply(e,arguments)}m(at).fapply(au).fail(ar.reject);return ar.promise}};R.prototype.nbind=function(){var e=af(arguments,0);e.unshift(this);return m.nbind.apply(void 0,e)};m.nmapply=m.npost=function(aq,ap,e){return m(aq).npost(ap,e)};R.prototype.nmapply=R.prototype.npost=function(aq,ap){var ar=af(ap||[]);var e=i();ar.push(e.makeNodeResolver());this.dispatch("post",[aq,ar]).fail(e.reject);return e.promise};m.nsend=m.nmcall=m.ninvoke=function(aq,ap){var ar=af(arguments,2);var e=i();ar.push(e.makeNodeResolver());m(aq).dispatch("post",[ap,ar]).fail(e.reject);return e.promise};R.prototype.nsend=R.prototype.nmcall=R.prototype.ninvoke=function(ap){var aq=af(arguments,1);var e=i();aq.push(e.makeNodeResolver());this.dispatch("post",[ap,aq]).fail(e.reject);return e.promise};m.nodeify=ai;function ai(ap,e){return m(ap).nodeify(e)}R.prototype.nodeify=function(e){if(e){this.then(function(ap){am(function(){e(null,ap)})},function(ap){am(function(){e(ap)})})}else{return this}};var v=aa();return m});