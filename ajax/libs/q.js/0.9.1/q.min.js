/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
(function(a){if(typeof bootstrap==="function"){bootstrap("promise",a)}else{if(typeof exports==="object"){module.exports=a()}else{if(typeof define==="function"&&define.amd){define(a)}else{if(typeof ses!=="undefined"){if(!ses.ok()){return}else{ses.makeQ=a}}else{Q=a()}}}}})(function(){var u=aa();var j;var am=function(){};var ao;if(typeof process!=="undefined"){ao=process.nextTick}else{if(typeof setImmediate==="function"){if(typeof window!=="undefined"){ao=setImmediate.bind(window)}else{ao=setImmediate}}else{(function(){var ay={task:void 0,next:null},ax=ay,aA=2,au=0,az=0,aB=0,av;function at(){--au;if(++aB>=aA){aB=0;aA*=4;var aC=az&&Math.min(az-1,aA);while(au<aC){++au;av()}}while(az){--az;ay=ay.next;var aD=ay.task;ay.task=void 0;aD()}aB=0}ao=function(aC){ax=ax.next={task:aC,next:null};if(au<++az&&au<aA){++au;av()}};if(typeof MessageChannel!=="undefined"){var aw=new MessageChannel();aw.port1.onmessage=at;av=function(){aw.port2.postMessage(0)}}else{av=function(){setTimeout(at,0)}}})()}}function p(au){var at=Function.call;return function(){return at.apply(au,arguments)}}var ai=p(Array.prototype.slice);var c=p(Array.prototype.reduce||function(aw,av){var at=0,au=this.length;if(arguments.length===1){do{if(at in this){av=this[at++];break}if(++at>=au){throw new TypeError()}}while(1)}for(;at<au;at++){if(at in this){av=aw(av,this[at],at)}}return av});var U=p(Array.prototype.indexOf||function(au){for(var at=0;at<this.length;at++){if(this[at]===au){return at}}return -1});var b=p(Array.prototype.map||function(aw,au){var at=this;var av=[];c(at,function(az,ay,ax){av.push(aw.call(au,ay,ax,at))},void 0);return av});var L=Object.create||function(au){function at(){}at.prototype=au;return new at()};var B=p(Object.prototype.hasOwnProperty);var J=Object.keys||function(at){var av=[];for(var au in at){if(B(at,au)){av.push(au)}}return av};var ar=p(Object.prototype.toString);function w(at){return(ar(at)==="[object StopIteration]"||at instanceof M)}var M;if(typeof ReturnValue!=="undefined"){M=ReturnValue}else{M=function(at){this.value=at}}k.longStackJumpLimit=1;var ad="From previous event:";function l(at,au){if(au.stack&&typeof at==="object"&&at!==null&&at.stack&&at.stack.indexOf(ad)===-1){at.stack=O(at.stack)+"\n"+ad+"\n"+O(au.stack)}}function O(aw){var au=aw.split("\n");var ax=[];for(var av=0;av<au.length;++av){var at=au[av];if(!f(at)&&!ae(at)){ax.push(at)}}return ax.join("\n")}function ae(at){return at.indexOf("(module.js:")!==-1||at.indexOf("(node.js:")!==-1}function f(au){var av=/at .+ \((.*):(\d+):\d+\)/.exec(au);if(!av){return false}var aw=av[1];var at=av[2];return aw===j&&at>=u&&at<=s}function aa(){if(Error.captureStackTrace){var av,at;var au=Error.prepareStackTrace;Error.prepareStackTrace=function(aw,ax){av=ax[1].getFileName();at=ax[1].getLineNumber()};new Error().stack;Error.prepareStackTrace=au;j=av;return at}}function F(av,at,au){return function(){if(typeof console!=="undefined"&&typeof console.warn==="function"){console.warn(at+" is deprecated, use "+au+" instead.",new Error("").stack)}return av.apply(av,arguments)}}function k(at){return C(at)}k.nextTick=ao;k.defer=h;function h(){var ay=[],aw=[],av;var at=L(h.prototype);var ax=L(al.prototype);ax.promiseDispatch=function(aB,aC,aA){var az=ai(arguments);if(ay){ay.push(az);if(aC==="when"&&aA[1]){aw.push(aA[1])}}else{ao(function(){av.promiseDispatch.apply(av,az)})}};ax.valueOf=function(){if(ay){return ax}var az=t(av);if(z(az)){av=az}return az};if(Error.captureStackTrace&&k.longStackJumpLimit>0){Error.captureStackTrace(ax,h);ax.stack=ax.stack.substring(ax.stack.indexOf("\n")+1)}function au(az){if(!ay){return}av=C(az);c(ay,function(aB,aA){ao(function(){av.promiseDispatch.apply(av,aA)})},void 0);ay=void 0;aw=void 0}at.promise=ax;at.resolve=au;at.fulfill=function(az){au(A(az))};at.reject=function(az){au(G(az))};at.notify=function(az){if(ay){c(aw,function(aB,aA){ao(function(){aA(az)})},void 0)}};return at}h.prototype.makeNodeResolver=function(){var at=this;return function(au,av){if(au){at.reject(au)}else{if(arguments.length>2){at.resolve(ai(arguments,1))}else{at.resolve(av)}}}};k.promise=X;function X(au){var at=h();g(au,at.resolve,at.reject,at.notify).fail(at.reject);return at.promise}k.makePromise=al;function al(aw,ay,at,au,av){if(ay===void 0){ay=function(az){return G(new Error("Promise does not support operation: "+az))}}var ax=L(al.prototype);ax.promiseDispatch=function(aC,aD,aA){var az;try{if(aw[aD]){az=aw[aD].apply(ax,aA)}else{az=ay.call(ax,aD,aA)}}catch(aB){az=G(aB)}if(aC){aC(az)}};if(at){ax.valueOf=at}if(av){ax.exception=au}return ax}al.prototype.then=function(at,au,av){return T(this,at,au,av)};al.prototype.thenResolve=function(at){return T(this,function(){return at})};al.prototype.thenReject=function(at){return T(this,function(){throw at})};c(["isFulfilled","isRejected","isPending","dispatch","when","spread","get","put","set","del","delete","post","send","invoke","keys","fapply","fcall","fbind","all","allResolved","timeout","delay","catch","finally","fail","fin","progress","done","nfcall","nfapply","nfbind","denodeify","nbind","ncall","napply","nbind","npost","nsend","ninvoke","nodeify"],function(au,at){al.prototype[at]=function(){return k[at].apply(k,[this].concat(ai(arguments)))}},void 0);al.prototype.toSource=function(){return this.toString()};al.prototype.toString=function(){return"[object Promise]"};k.nearer=t;function t(at){if(z(at)){return at.valueOf()}return at}k.isPromise=z;function z(at){return at&&typeof at.promiseDispatch==="function"}k.isPromiseAlike=R;function R(at){return at&&typeof at.then==="function"}k.isPending=aj;function aj(at){return !V(at)&&!Z(at)}k.isFulfilled=V;function V(at){return !R(t(at))}k.isRejected=Z;function Z(at){at=t(at);return z(at)&&"exception" in at}var Y=[];var E=[];var af;function aq(){if(!af&&typeof window!=="undefined"&&!window.Touch&&window.console){console.log("Should be empty:",E)}af=true}if(typeof process!=="undefined"&&process.on){process.on("exit",function(){for(var au=0;au<E.length;au++){var at=E[au];if(at&&typeof at.stack!=="undefined"){console.warn("Unhandled rejected promise:",at.stack)}else{console.warn("Unhandled rejected promise (no stack):",at)}}})}k.reject=G;function G(av){var au=al({when:function(ay){if(ay){var ax=U(Y,this);if(ax!==-1){E.splice(ax,1);Y.splice(ax,1)}}return ay?ay(av):this}},function aw(){return G(av)},function at(){return this},av,true);aq();Y.push(au);E.push(av);return au}k.fulfill=A;function A(au){return al({when:function(){return au},get:function(av){return au[av]},set:function(av,aw){au[av]=aw},"delete":function(av){delete au[av]},post:function(aw,av){if(aw==null){return au.apply(void 0,av)}else{return au[aw].apply(au,av)}},apply:function(aw,av){return au.apply(aw,av)},keys:function(){return J(au)}},void 0,function at(){return au})}k.resolve=C;function C(at){if(z(at)){return at}at=t(at);if(R(at)){return P(at)}else{return A(at)}}function P(au){var at=h();ao(function(){try{au.then(at.resolve,at.reject,at.notify)}catch(av){at.reject(av)}});return at.promise}k.master=v;function v(at){return al({isDef:function(){}},function au(aw,av){return ac(at,aw,av)},function(){return t(at)})}k.when=T;function T(az,ay,aA,av){var aB=h();var aw=false;function ax(aE){try{return typeof ay==="function"?ay(aE):aE}catch(aD){return G(aD)}}function aC(aD){if(typeof aA==="function"){l(aD,at);try{return aA(aD)}catch(aE){return G(aE)}}return G(aD)}function au(aD){return typeof av==="function"?av(aD):aD}var at=C(az);ao(function(){at.promiseDispatch(function(aD){if(aw){return}aw=true;aB.resolve(ax(aD))},"when",[function(aD){if(aw){return}aw=true;aB.resolve(aC(aD))}])});at.promiseDispatch(void 0,"when",[void 0,function(aD){var aF;var aG=false;try{aF=au(aD)}catch(aE){aG=true;if(k.onerror){k.onerror(aE)}else{throw aE}}if(!aG){aB.notify(aF)}}]);return aB.promise}k.spread=e;function e(av,at,au){return T(av,function(aw){return y(aw).then(function(ax){return at.apply(void 0,ax)},au)},au)}k.async=W;function W(at){return function(){function av(aB,az){var ay;try{ay=aw[aB](az)}catch(aA){if(w(aA)){return aA.value}else{return G(aA)}}return T(ay,ax,au)}var aw=at.apply(this,arguments);var ax=av.bind(av,"send");var au=av.bind(av,"throw");return ax()}}k["return"]=i;function i(at){throw new M(at)}k.promised=r;function r(at){return function(){return e([this,y(arguments)],function(au,av){return at.apply(au,av)})}}k.dispatch=ac;function ac(av,aw,au){var at=h();ao(function(){C(av).promiseDispatch(at.resolve,aw,au)});return at.promise}k.dispatcher=I;function I(at){return function(av){var au=ai(arguments,1);return ac(av,at,au)}}k.get=I("get");k.set=I("set");k["delete"]=k.del=I("delete");var x=k.post=I("post");k.send=K;k.invoke=K;function K(av,au){var at=ai(arguments,2);return x(av,au,at)}k.fapply=N;function N(au,at){return ac(au,"apply",[void 0,at])}k["try"]=g;k.fcall=g;function g(au){var at=ai(arguments,1);return N(au,at)}k.fbind=m;function m(av){var at=ai(arguments,1);return function au(){var aw=at.concat(ai(arguments));return ac(av,"apply",[this,aw])}}k.keys=I("keys");k.all=y;function y(at){return T(at,function(aw){var av=0;var au=h();c(aw,function(az,ay,ax){if(V(ay)){aw[ax]=t(ay)}else{++av;T(ay,function(aA){aw[ax]=aA;if(--av===0){au.resolve(aw)}},au.reject)}},void 0);if(av===0){au.resolve(aw)}return au.promise})}k.allResolved=d;function d(at){return T(at,function(au){au=b(au,C);return T(y(b(au,function(av){return T(av,am,am)})),function(){return au})})}k["catch"]=k.fail=o;function o(au,at){return T(au,void 0,at)}k.progress=H;function H(at,au){return T(at,void 0,void 0,au)}k["finally"]=k.fin=ab;function ab(at,au){return T(at,function(av){return T(au(),function(){return av})},function(av){return T(au(),function(){return G(av)})})}k.done=n;function n(ay,at,ax,aw){var au=function(az){ao(function(){l(az,ay);if(k.onerror){k.onerror(az)}else{throw az}})};var av=at||ax||aw?T(ay,at,ax,aw):ay;if(typeof process==="object"&&process&&process.domain){au=process.domain.bind(au)}o(av,au)}k.timeout=ah;function ah(aw,au){var at=h();var av=setTimeout(function(){at.reject(new Error("Timed out after "+au+" ms"))},au);T(aw,function(ax){clearTimeout(av);at.resolve(ax)},function(ax){clearTimeout(av);at.reject(ax)});return at.promise}k.delay=S;function S(av,au){if(au===void 0){au=av;av=void 0}var at=h();setTimeout(function(){at.resolve(av)},au);return at.promise}k.nfapply=ag;function ag(aw,au){var av=ai(au);var at=h();av.push(at.makeNodeResolver());N(aw,av).fail(at.reject);return at.promise}k.nfcall=ak;function ak(av){var au=ai(arguments,1);var at=h();au.push(at.makeNodeResolver());N(av,au).fail(at.reject);return at.promise}k.nfbind=ap;k.denodeify=k.nfbind;function ap(au){var at=ai(arguments,1);return function(){var aw=at.concat(ai(arguments));var av=h();aw.push(av.makeNodeResolver());N(au,aw).fail(av.reject);return av.promise}}k.nbind=a;function a(au){var at=ai(arguments,1);return function(){var ay=at.concat(ai(arguments));var aw=h();ay.push(aw.makeNodeResolver());var av=this;function ax(){return au.apply(av,arguments)}N(ax,ay).fail(aw.reject);return aw.promise}}k.npost=q;function q(aw,av,au){var ax=ai(au||[]);var at=h();ax.push(at.makeNodeResolver());x(aw,av,ax).fail(at.reject);return at.promise}k.nsend=D;k.ninvoke=k.nsend;function D(av,au){var aw=ai(arguments,2);var at=h();aw.push(at.makeNodeResolver());x(av,au,aw).fail(at.reject);return at.promise}k.nodeify=an;function an(au,at){if(at){au.then(function(av){ao(function(){at(null,av)})},function(av){ao(function(){at(av)})})}else{return au}}var s=aa();return k});