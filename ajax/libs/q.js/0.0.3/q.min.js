(function(f,d){var b;if(typeof setTimeout==="function"){b=function(k){setTimeout(k,0)}}else{b=require("./event-loop").enqueue}f.enqueue=b;f.defer=a;function a(){var n=[],l;var m=Object.create(i.prototype);m.emit=function(){var o=Array.prototype.slice.call(arguments);if(n){n.push(o)}else{g.apply(d,[l].concat(o))}};var k=function(o){var q,r,p;if(!n){return}l=c(o);for(q=0,r=n.length;q<r;++q){g.apply(d,[l].concat(n[q]))}n=d};return{promise:m,resolve:k,reject:function(o){k(j(o))}}}f.Promise=i;function i(k,m){if(m===d){m=function(n){return j("Promise does not support operation: "+n)}}var l=Object.create(i.prototype);l.emit=function(q,o){var p=Array.prototype.slice.call(arguments,2);var n;if(k[q]){n=k[q].apply(k,p)}else{n=m.apply(k,arguments)}if(o){return o(n)}return n};return l}i.prototype.toSource=function(){return this.toString()};i.prototype.toString=function(){return"[object Promise]"};i.prototype.valueOf=function(){return this.emit("valueOf")};f.isPromise=h;function h(k){return k instanceof i}f.reject=j;function j(k){return i({when:function(m){return m?m(k):j(k)}},function l(o,n){var m=j(k);return n?n(m):m})}f.ref=c;function c(k){if(h(k)){return k}return i({when:function(l){return k},get:function(l){return k[l]},put:function(l,m){k[l]=m},"delete":function(l){delete k[l]},post:function(m,l){return k[m].apply(k,l)},valueOf:function(){return k}})}f.Method=e;function e(k){return function(n){var l=a();var m=Array.prototype.slice.call(arguments,1);g.apply(d,[c(n),k,l.resolve].concat(m));return l.promise}}f.when=function(o,l,n){var m=a();var k=false;g(c(o),"when",function(p){if(k){return}k=true;m.resolve(c(p).emit("when",l,n))},function(p){if(k){return}k=true;m.resolve(n?n(p):j(p))});return m.promise};f.asap=function(p,l,o){var n=a();var k=false;var m;c(p).emit("when",function(q){if(k){return}k=true;n.resolve(c(q).emit("when",l,o));m=q},function(q){if(k){return}k=true;n.resolve(o?o(q):j(q));m=n.promise});return k?m:n.promise};f.get=e("get");f.put=e("put");f.del=e("del");f.post=e("post");f.defined=function(k){return f.when(k,function(l){if(l===d||l===null){return j("Resolved undefined value: "+l)}return l})};function g(l){var k=Array.prototype.slice.call(arguments,1);b(function(){l.emit.apply(l,k)})}})(typeof exports!=="undefined"?exports:Q={});