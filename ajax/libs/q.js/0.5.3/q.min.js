/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 */
(function(a,b){if(typeof define==="function"){define(function(d,c){a(d,c)})}else{if(typeof exports==="object"){a(require,exports)}else{a(b,Q={})}}})(function(E,G,l){var y;try{y=E("event-queue").enqueue}catch(F){if(typeof MessageChannel!=="undefined"){var I=new MessageChannel();y=function(e){I.port1.onmessage=e;I.port2.postMessage()}}else{y=function(e){setTimeout(e,0)}}}function H(e){return e}var b=Object.freeze||H;var s=Object.create||function s(J){var e=function(){};e.prototype=J;return new e()};var v=Object.keys||function(e){var K=[];for(var J in e){K.push(J)}return K};var t=Array.prototype.reduce||function(L,K){for(var e=0,J=this.length;e<J;e++){K=L(K,this[e],e)}return K};var g=typeof console==="undefined"?H:function(e){console.log(e)};G.enqueue=y;G.defer=d;function d(){var L=[],J;var K=s(f.prototype);K.promiseSend=function(){var M=Array.prototype.slice.call(arguments);if(L){L.push(M)}else{r.apply(l,[J].concat(M))}};K.valueOf=function(){if(L){return K}return p(J)};var e=function(M){var O,P,N;if(!L){return}J=k(M);for(O=0,P=L.length;O<P;++O){r.apply(l,[J].concat(L[O]))}L=l;return J};return{promise:b(K),resolve:e,reject:function(M){return e(j(M))}}}G.makePromise=f;function f(J,L,e){if(L===l){L=function(M){return j("Promise does not support operation: "+M)}}var K=s(f.prototype);K.promiseSend=function(P,N){var O=Array.prototype.slice.call(arguments,2);var M;if(J[P]){M=J[P].apply(J,O)}else{M=L.apply(J,[P].concat(O))}N=N||H;return N(M)};if(e){K.valueOf=e}return b(K)}f.prototype.then=function(e,J){return n(this,e,J)};t.call(["get","put","del","post","invoke","keys","apply","call","wait","join","fail","fin","spy","report","end"],function(J,e){f.prototype[e]=function(){return G[e].apply(G,[this].concat(Array.prototype.slice.call(arguments)))}},l);f.prototype.toSource=function(){return this.toString()};f.prototype.toString=function(){return"[object Promise]"};b(f.prototype);G.isPromise=w;function w(e){return e&&typeof e.promiseSend==="function"}G.isResolved=q;function q(e){return !w(p(e.valueOf()))}G.isFulfilled=A;function A(e){return !w(p(e))&&!x(e)}G.isRejected=x;function x(e){e=p(e);if(e===l||e===null){return false}return !!e.promiseRejected}G.reject=j;function j(J){return f({when:function(L){return L?L(J):j(J)}},function K(L){return j(J)},function e(){var L=s(j.prototype);L.promiseRejected=true;L.reason=J;return L})}j.prototype=s(f.prototype,{constructor:{value:j}});G.ref=k;function k(J){if(w(J)){return J}if(J&&typeof J.then==="function"){return f({},function K(N,M){if(N!=="when"){return n(J,function(O){return k(O).promiseSend.apply(null,arguments)})}else{var L=d();J.then(L.resolve,L.reject);return L.promise}})}return f({when:function(L){return J},get:function(L){if(J===l||J===null){return j("Cannot access property "+L+" of "+J)}return J[L]},put:function(L,M){if(J===l||J===null){return j("Cannot set property "+L+" of "+J+" to "+M)}return J[L]=M},del:function(L){if(J===l||J===null){return j("Cannot delete property "+L+" of "+J)}return delete J[L]},post:function(L,M){if(J===l||J===null){return j(""+J+" has no methods")}var N=J[L];if(!N){return j("No such method "+L+" on object "+J)}if(!N.apply){return j("Property "+L+" on object "+J+" is not a method")}return J[L].apply(J,M)},apply:function(L,M){if(!J||typeof J.apply!=="function"){return j(""+J+" is not a function")}return J.apply(L,M)},keys:function(){return v(J)}},l,function e(){return J})}G.master=G.def=u;function u(J){return f({isDef:function(){}},function K(M){var L=Array.prototype.slice.call(arguments);return o.apply(l,[J].concat(L))},function e(){return J.valueOf()})}G.when=n;function n(N,K,M){var L=d();var J=false;function e(R){try{return K?K(R):R}catch(P){return j(P)}}function O(R){try{return M?M(R):j(R)}catch(P){return j(P)}}r(k(N),"when",function(P){if(J){return}J=true;L.resolve(k(P).promiseSend("when",e,O))},function(P){if(J){return}J=true;L.resolve(O(P))});return L.promise}G.asap=function(K,e,J){e=e||H;if(A(K)){return p(e(p(K)))}else{if(x(K)){var L=K.valueOf().reason;if(J){return J(L)}else{throw L}}else{return n(K,e,J)}}};var p=function(e){if(e===l||e===null){return e}else{return e.valueOf()}};G.Method=a;function a(e){return function(K){var J=Array.prototype.slice.call(arguments,1);return o.apply(l,[K,e].concat(J))}}G.send=o;function o(K,L){var e=d();var J=Array.prototype.slice.call(arguments,2);r.apply(l,[k(K),L,e.resolve].concat(J));return e.promise}G.get=a("get");G.put=a("put");G.del=a("del");var C=G.post=a("post");G.invoke=function(K,J){var e=Array.prototype.slice.call(arguments,2);return C(K,J,e)};var z=G.apply=a("apply");G.call=function(K,J){var e=Array.prototype.slice.call(arguments,2);return z(K,J,e)};G.keys=a("keys");G.all=c;function c(L){var K=L.length;var J=[];if(K===0){return k(J)}var e=d();t.call(L,function(O,N,M){n(N,function(P){J[M]=P;if(--K===0){e.resolve(J)}},e.reject)},l);return e.promise}G.wait=function(e){return c(arguments).get(0)};G.join=function(){var e=Array.prototype.slice.call(arguments);var J=e.pop();return c(e).then(function(K){return J.apply(l,K)})};G.fail=m;function m(J,e){return n(J,l,e)}G.fin=D;function D(e,J){return n(e,function(K){return J(K,l)},function(K){return J(l,K)})}G.spy=h;function h(e,J){return n(e,function(K){return n(J(K,l),function(){return K})},function(K){return n(J(l,K),function(){return j(K)})})}G.report=B;function B(K,J){var e=new Error(J||"REPORT");return h(K,function(L,M){g(e&&e.stack||e);if(M){g(M&&M.stack||M)}else{g(L)}})}G.end=i;function i(e){n(e,l,function(J){y(function(){throw J})})}function r(J){var e=Array.prototype.slice.call(arguments,1);y(function(){J.promiseSend.apply(J,e)})}});