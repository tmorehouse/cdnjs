/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * With formatStackTrace and formatSourcePosition functions
 * Copyright 2006-2008 the V8 project authors. All rights reserved.
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *     * Neither the name of Google Inc. nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
(function(a){if(typeof define==="function"){define(a)}else{if(typeof exports==="object"){a(void 0,exports)}else{if(typeof ses!=="undefined"){if(!ses.ok()){return}else{ses.makeQ=function(){var b={};return a(void 0,b)}}}else{a(void 0,Q={})}}}})(function(j,ai){ae(new Error());var am=function(){};var r=Object.freeze||am;if(typeof cajaVM!=="undefined"){r=cajaVM.def}var ao;if(typeof process!=="undefined"){ao=process.nextTick}else{if(typeof msSetImmediate==="function"){ao=msSetImmediate.bind(window)}else{if(typeof setImmediate==="function"){ao=setImmediate}else{if(typeof MessageChannel!=="undefined"){var V=new MessageChannel();var y={},ar=y;V.port1.onmessage=function(){y=y.next;var au=y.task;delete y.task;au()};ao=function(au){ar=ar.next={task:au};V.port2.postMessage(0)}}else{ao=function(au){setTimeout(au,0)}}}}}var u;if(Function.prototype.bind){var L=Function.prototype.bind;u=L.bind(L.call)}else{u=function(au){return function(av){return au.call.apply(au,arguments)}}}var ak=u(Array.prototype.slice);var f=u(Array.prototype.reduce||function(ax,aw){var au=0,av=this.length;if(arguments.length===1){do{if(au in this){aw=this[au++];break}if(++au>=av){throw new TypeError()}}while(1)}for(;au<av;au++){if(au in this){aw=ax(aw,this[au],au)}}return aw});var W=u(Array.prototype.indexOf||function(av){for(var au=0;au<this.length;au++){if(this[au]===av){return au}}return -1});var c=u(Array.prototype.map||function(ax,av){var au=this;var aw=[];f(au,function(aA,az,ay){aw.push(ax.call(av,az,ay,au))},void 0);return aw});var P=Object.create||function(av){function au(){}au.prototype=av;return new au()};var N=Object.keys||function(au){var aw=[];for(var av in au){aw.push(av)}return aw};var at=Object.prototype.toString;function C(au){return(at(au)==="[object StopIteration]"||au instanceof R)}var R;if(typeof ReturnValue!=="undefined"){R=ReturnValue}else{R=function(au){this.value=au}}function A(ax,aB){var aw=[];try{aw.push(ax.toString())}catch(az){try{aw.push("<error: "+az+">")}catch(av){aw.push("<error>")}}for(var ay=0;ay<aB.length;ay++){var aA=aB[ay];var au;if(typeof aA==="string"){aw.push(aA)}else{try{au=aa(aA)}catch(az){try{au="<error: "+az+">"}catch(av){au="<error>"}}aw.push("    at "+au)}}return aw.join("\n")}function aa(av){var az="";if(av.isNative()){az="native"}else{if(av.isEval()){az="eval at "+av.getEvalOrigin()}else{var ax=av.getFileName();if(ax){az+=ax;var aw=av.getLineNumber();if(aw!==null){az+=":"+aw;var au=av.getColumnNumber();if(au){az+=":"+au}}}}}if(!az){az="unknown source"}var aE="";var aA=av.getFunction().name;var aD=true;var aC=av.isConstructor();var ay=!(av.isToplevel()||aC);if(ay){var aB=av.getMethodName();aE+=av.getTypeName()+".";if(aA){aE+=aA;if(aB&&(aB!==aA)){aE+=" [as "+aB+"]"}}else{aE+=aB||"<anonymous>"}}else{if(aC){aE+="new "+(aA||"<anonymous>")}else{if(aA){aE+=aA}else{aE+=az;aD=false}}}if(aD){aE+=" ("+az+")"}return aE}function i(aw,av){if(aw!==q){return false}var au=av.getLineNumber();return au>=z&&au<=w}function d(aw){var av=Error.prepareStackTrace;Error.prepareStackTrace=function(ax,ay){return ay.filter(function(az){var aA=az.getFileName();return(aA!=="module.js"&&aA!=="node.js"&&!i(aA,az))})};var au=aw.stack;Error.prepareStackTrace=av;return au}var q,z,w;function ae(aw){if(Error.captureStackTrace){var ax,au;var av=Error.prepareStackTrace;Error.prepareStackTrace=function(ay,az){ax=az[0].getFileName();au=az[0].getLineNumber()};aw.stack;Error.prepareStackTrace=av;q=ax;if(z){w=au}else{z=au}}}function J(aw,au,av){return function(){if(typeof console!=="undefined"&&typeof console.warn==="function"){console.warn(au+" is deprecated, use "+av+" instead.")}return aw.apply(aw,arguments)}}ai.nextTick=ao;ai.defer=o;function o(){var ay=[],aw;var au=P(o.prototype);var ax=P(al.prototype);ax.promiseSend=function(){var az=ak(arguments);if(ay){ay.push(az)}else{ao(function(){aw.promiseSend.apply(aw,az)})}};ax.valueOf=function(){if(ay){return ax}return aw.valueOf()};if(Error.captureStackTrace){Error.captureStackTrace(ax,o)}function av(az){if(!ay){return}aw=H(az);f(ay,function(aB,aA){ao(function(){aw.promiseSend.apply(aw,aA)})},void 0);ay=void 0;return aw}r(ax);au.promise=ax;au.resolve=av;au.reject=function(az){return av(K(az))};return au}o.prototype.makeNodeResolver=function(){var au=this;return function(av,aw){if(av){au.reject(av)}else{if(arguments.length>2){au.resolve(ak(arguments,1))}else{au.resolve(aw)}}}};o.prototype.node=J(o.prototype.makeNodeResolver,"node","makeNodeResolver");ai.promise=ab;function ab(av){var au=o();b(av,void 0,au.resolve,au.reject).fail(au.reject);return au.promise}ai.makePromise=al;function al(aw,ay,au,av){if(ay===void 0){ay=function(az){return K(new Error("Promise does not support operation: "+az))}}var ax=P(al.prototype);ax.promiseSend=function(aD,aA){var aB=ak(arguments,2);var az;try{if(aw[aD]){az=aw[aD].apply(ax,aB)}else{az=ay.apply(ax,[aD].concat(aB))}}catch(aC){az=K(aC)}aA(az)};if(au){ax.valueOf=au}if(av){ax.exception=av}r(ax);return ax}al.prototype.then=function(au,av){return U(this,au,av)};f(["isResolved","isFulfilled","isRejected","when","spread","send","get","put","del","post","invoke","keys","apply","call","bind","fapply","fcall","fbind","all","allResolved","view","viewInfo","timeout","delay","catch","finally","fail","fin","end"],function(av,au){al.prototype[au]=function(){return ai[au].apply(ai,[this].concat(ak(arguments)))}},void 0);al.prototype.toSource=function(){return this.toString()};al.prototype.toString=function(){return"[object Promise]"};r(al.prototype);ai.nearer=x;function x(au){if(Object(au)!==au){return au}else{return au.valueOf()}}ai.isPromise=G;function G(au){return au&&typeof au.promiseSend==="function"}ai.isResolved=k;function k(au){return X(au)||ad(au)}ai.isFulfilled=X;function X(au){return !G(x(au))}ai.isRejected=ad;function ad(au){au=x(au);return G(au)&&"exception" in au}var ac=[];var I=[];if(typeof window!=="undefined"&&window.console){console.log("Should be empty:",I)}ai.reject=K;function K(aw){aw=aw||new Error();var av=al({when:function(az){if(az){var ay=W(ac,this);if(ay!==-1){I.splice(ay,1);ac.splice(ay,1)}}return az?az(aw):K(aw)}},function ax(ay){return K(aw)},function au(){return this},aw);ac.push(av);I.push(aw);return av}ai.begin=H;ai.resolve=H;ai.ref=J(H,"ref","resolve");function H(aw){if(G(aw)){return aw}if(aw&&typeof aw.then==="function"){var av=o();aw.then(av.resolve,av.reject);return av.promise}return al({when:function(ax){return aw},get:function(ax){return aw[ax]},put:function(ax,ay){return aw[ax]=ay},del:function(ax){return delete aw[ax]},post:function(ax,ay){return aw[ax].apply(aw,ay)},apply:function(ax,ay){return aw.apply(ax,ay)},fapply:function(ax){return aw.apply(void 0,ax)},viewInfo:function(){var ax=aw;var ay={};function az(aA){if(!ay[aA]){ay[aA]=typeof ax[aA]}}while(ax){Object.getOwnPropertyNames(ax).forEach(az);ax=Object.getPrototypeOf(ax)}return{type:typeof aw,properties:ay}},keys:function(){return N(aw)}},void 0,function au(){return aw})}ai.master=B;function B(au){return al({isDef:function(){}},function av(ax){var aw=ak(arguments);return O.apply(void 0,[au].concat(aw))},function(){return x(au)})}ai.viewInfo=ah;function ah(au,av){au=H(au);if(av){return al({viewInfo:function(){return av}},function aw(ay){var ax=ak(arguments);return O.apply(void 0,[au].concat(ax))},function(){return x(au)})}else{return O(au,"viewInfo")}}ai.view=e;function e(au){return ah(au).when(function(ax){var av;if(ax.type==="function"){av=function(){return ap(au,void 0,arguments)}}else{av={}}var aw=ax.properties||{};N(aw).forEach(function(ay){if(aw[ay]==="function"){av[ay]=function(){return E(au,ay,arguments)}}});return H(av)})}ai.when=U;function U(az,aw,ay){var ax=o();var av=false;function au(aC){try{return aw?aw(aC):aC}catch(aB){return K(aB)}}function aA(aB){try{return ay?ay(aB):K(aB)}catch(aC){return K(aC)}}ao(function(){H(az).promiseSend("when",function(aB){H(aB).promiseSend("when",function(aC){if(av){return}av=true;ax.resolve(au(aC))},function(aC){if(av){return}av=true;ax.resolve(aA(aC))})},function(aB){if(av){return}av=true;ax.resolve(aA(aB))})});return ax.promise}ai.spread=h;function h(aw,au,av){return U(aw,function(ax){return au.apply(void 0,ax)},av)}ai.async=Z;function Z(au){return function(){function aw(aC,aA){var az;try{az=ax[aC](aA)}catch(aB){if(C(aB)){return aB.value}else{return K(aB)}}return U(az,ay,av)}var ax=au.apply(this,arguments);var ay=aw.bind(aw,"send");var av=aw.bind(aw,"throw");return ay()}}ai["return"]=p;function p(au){throw new R(au)}ai.sender=J(n,"sender","dispatcher");ai.Method=J(n,"Method","dispatcher");function n(au){return function(aw){var av=ak(arguments,1);return O.apply(void 0,[aw,au].concat(av))}}ai.send=J(O,"send","dispatch");function O(aw,ax){var au=o();var av=ak(arguments,2);aw=H(aw);ao(function(){aw.promiseSend.apply(aw,[ax,au.resolve].concat(av))});return au.promise}ai.dispatch=ag;function ag(aw,ax,av){var au=o();aw=H(aw);ao(function(){aw.promiseSend.apply(aw,[ax,au.resolve].concat(av))});return au.promise}ai.dispatcher=M;function M(au){return function(aw){var av=ak(arguments,1);return ag(aw,au,av)}}ai.get=M("get");ai.put=M("put");ai["delete"]=ai.del=M("del");var E=ai.post=M("post");ai.invoke=function(aw,av){var au=ak(arguments,2);return E(aw,av,au)};var ap=ai.apply=J(M("apply"),"apply","fapply");var S=ai.fapply=M("fapply");ai.call=J(b,"call","fcall");function b(aw,av){var au=ak(arguments,2);return ap(aw,av,au)}ai["try"]=l;ai.fcall=l;function l(av){var au=ak(arguments,1);return S(av,au)}ai.bind=J(m,"bind","fbind");function m(ax,av){var au=ak(arguments,2);return function aw(){var ay=au.concat(ak(arguments));return ap(ax,av,ay)}}ai.fbind=s;function s(aw){var au=ak(arguments,1);return function av(){var ax=au.concat(ak(arguments));return S(aw,ax)}}ai.keys=M("keys");ai.all=F;function F(au){return U(au,function(ax){var aw=ax.length;if(aw===0){return H(ax)}var av=o();f(ax,function(aA,az,ay){if(X(az)){ax[ay]=x(az);if(--aw===0){av.resolve(ax)}}else{U(az,function(aB){ax[ay]=aB;if(--aw===0){av.resolve(ax)}}).fail(av.reject)}},void 0);return av.promise})}ai.allResolved=g;function g(au){return U(au,function(av){return U(F(c(av,function(aw){return U(aw,am,am)})),function(){return c(av,H)})})}ai["catch"]=ai.fail=t;function t(av,au){return U(av,void 0,au)}ai["finally"]=ai.fin=af;function af(au,av){return U(au,function(aw){return U(av(),function(){return aw})},function(aw){return U(av(),function(){return K(aw)})})}ai.end=D;function D(au){U(au,void 0,function(av){ao(function(){var aw;if(Error.captureStackTrace&&typeof av==="object"&&(aw=d(av))){var ax=d(au);var ay=aw.concat("From previous event:",ax);av.stack=A(av,ay)}throw av})})}ai.timeout=aj;function aj(ax,av){var au=o();var aw=setTimeout(function(){au.reject(new Error("Timed out after "+av+" ms"))},av);U(ax,function(ay){clearTimeout(aw);au.resolve(ay)},au.reject);return au.promise}ai.delay=T;function T(aw,av){if(av===void 0){av=aw;aw=void 0}var au=o();setTimeout(function(){au.resolve(aw)},av);return au.promise}ai.napply=Y;function Y(aw,av,au){return a(aw,av).apply(void 0,au)}ai.ncall=an;function an(aw,av){var au=ak(arguments,2);return Y(aw,av,au)}ai.nbind=a;function a(ax){if(arguments.length>1){var av=arguments[1];var au=ak(arguments,2);var aw=ax;ax=function(){var ay=au.concat(ak(arguments));return aw.apply(av,ay)}}return function(){var ay=o();var az=ak(arguments);az.push(ay.makeNodeResolver());S(ax,az).fail(ay.reject);return ay.promise}}ai.npost=v;function v(aw,av,au){return Y(aw[av],aw,au)}ai.ninvoke=aq;function aq(aw,av){var au=ak(arguments,2);return Y(aw[av],aw,au)}r(ai);ae(new Error())});