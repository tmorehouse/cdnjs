/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 */
(function(a,b){if(typeof define==="function"&&define.amd){define(function(d,c){a(d,c)})}else{if(typeof exports==="object"){a(require,exports)}else{a(b,Q={})}}})(function(w,y,h){var s;try{s=w("event-queue").enqueue}catch(x){s=function(e){setTimeout(e,0)}}function z(e){return e}var b=Object.freeze||z;var o=Object.create||function o(A){var e=function(){};e.prototype=A;return new e()};var f=typeof console==="undefined"?z:function(e){console.log(e)};y.enqueue=s;y.defer=c;function c(){var C=[],A;var B=o(d.prototype);B.promiseSend=function(){var D=Array.prototype.slice.call(arguments);if(C){C.push(D)}else{n.apply(h,[A].concat(D))}};B.valueOf=function(){if(C){return B}return l(A)};var e=function(D){var F,G,E;if(!C){return}A=i(D);for(F=0,G=C.length;F<G;++F){n.apply(h,[A].concat(C[F]))}C=h;return A};return{promise:b(B),resolve:e,reject:function(D){return e(g(D))}}}y.makePromise=d;function d(A,C,e){if(C===h){C=function(D){return g("Promise does not support operation: "+D)}}var B=o(d.prototype);B.promiseSend=function(G,E){var F=Array.prototype.slice.call(arguments,2);var D;if(A[G]){D=A[G].apply(A,F)}else{D=C.apply(A,[G].concat(F))}E=E||z;return E(D)};if(e){B.valueOf=e}return b(B)}d.prototype.then=function(e,A){return j(this,e,A)};d.prototype.end=function(){return j(this,h,t)};d.prototype.toSource=function(){return this.toString()};d.prototype.toString=function(){return"[object Promise]"};b(d.prototype);y.isPromise=q;function q(e){return e&&typeof e.promiseSend==="function"}y.isResolved=m;function m(e){return !q(l(e.valueOf()))}y.isFulfilled=u;function u(e){return !q(l(e))&&!r(e)}y.isRejected=r;function r(e){e=l(e);if(e===h||e===null){return false}return !!e.promiseRejected}y.reject=g;function g(A){return d({when:function(C){return C?C(A):g(A)}},function B(C){return g(A)},function e(){var C=o(g.prototype);C.promiseRejected=true;C.reason=A;return C})}g.prototype=o(d.prototype,{constructor:{value:g}});y.ref=i;function i(A){if(q(A)){return A}if(A&&typeof A.then==="function"){return d({},function B(E,D){if(E!=="when"){return Q.when(A,function(F){return Q.ref(F).promiseSend.apply(null,arguments)})}else{var C=c();A.then(C.resolve,C.reject);return C.promise}})}return d({when:function(C){return A},get:function(C){if(A===h||A===null){return g("Cannot access property "+C+" of "+A)}return A[C]},put:function(C,D){if(A===h||A===null){return g("Cannot set property "+C+" of "+A+" to "+D)}return A[C]=D},del:function(C){if(A===h||A===null){return g("Cannot delete property "+C+" of "+A)}return delete A[C]},post:function(C,D){if(A===h||A===null){return g(""+A+" has no methods")}var E=A[C];if(!E){return g("No such method "+C+" on object "+A)}if(!E.apply){return g("Property "+C+" on object "+A+" is not a method")}return A[C].apply(A,D)},keys:function(){return Object.keys(A)}},h,function e(){return A})}y.def=p;function p(A){return d({isDef:function(){}},function B(D){var C=Array.prototype.slice.call(arguments);return k.apply(h,[A].concat(C))},function e(){return A.valueOf()})}y.when=j;function j(E,B,D){var C=c();var A=false;function e(H){try{return B?B(H):H}catch(G){if(typeof process!=="undefined"){process.emit("uncaughtException",G)}else{f(G&&G.stack||G)}return g(G)}}function F(H){try{return D?D(H):g(H)}catch(G){f(G&&G.stack||G);return g(G)}}n(i(E),"when",function(G){if(A){return}A=true;C.resolve(i(G).promiseSend("when",e,F))},function(G){if(A){return}A=true;C.resolve(F(G))});return C.promise}y.asap=function(B,e,A){e=e||z;if(u(B)){return l(e(l(B)))}else{if(r(B)){var C=B.valueOf().reason;if(A){return A(C)}else{throw C}}else{return j(B,e,A)}}};var l=function(e){if(e===h||e===null){return e}else{return e.valueOf()}};y.Method=a;function a(e){return function(B){var A=Array.prototype.slice.call(arguments,1);return k.apply(h,[B,e].concat(A))}}y.send=k;function k(B,C){var e=c();var A=Array.prototype.slice.call(arguments,2);n.apply(h,[i(B),C,e.resolve].concat(A));return e.promise}y.get=a("get");y.put=a("put");y.del=a("del");var v=y.post=a("post");y.invoke=function(B,A){var e=Array.prototype.slice.call(arguments,2);return v(B,A,e)};y.keys=a("keys");y.error=t;function t(e){throw e}function n(A){var e=Array.prototype.slice.call(arguments,1);s(function(){A.promiseSend.apply(A,e)})}});