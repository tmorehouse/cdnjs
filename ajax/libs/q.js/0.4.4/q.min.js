/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 */
(function(a,b){if(typeof define==="function"){define(function(d,c){a(d,c)})}else{if(typeof exports==="object"){a(require,exports)}else{a(b,Q={})}}})(function(x,z,h){var s;try{s=x("event-queue").enqueue}catch(y){s=function(e){setTimeout(e,0)}}function A(e){return e}var b=Object.freeze||A;var o=Object.create||function o(B){var e=function(){};e.prototype=B;return new e()};var f=typeof console==="undefined"?A:function(e){console.log(e)};z.enqueue=s;z.defer=c;function c(){var D=[],B;var C=o(d.prototype);C.promiseSend=function(){var E=Array.prototype.slice.call(arguments);if(D){D.push(E)}else{n.apply(h,[B].concat(E))}};C.valueOf=function(){if(D){return C}return l(B)};var e=function(E){var G,H,F;if(!D){return}B=i(E);for(G=0,H=D.length;G<H;++G){n.apply(h,[B].concat(D[G]))}D=h;return B};return{promise:b(C),resolve:e,reject:function(E){return e(g(E))}}}z.makePromise=d;function d(B,D,e){if(D===h){D=function(E){return g("Promise does not support operation: "+E)}}var C=o(d.prototype);C.promiseSend=function(H,F){var G=Array.prototype.slice.call(arguments,2);var E;if(B[H]){E=B[H].apply(B,G)}else{E=D.apply(B,[H].concat(G))}F=F||A;return F(E)};if(e){C.valueOf=e}return b(C)}d.prototype.then=function(e,B){return j(this,e,B)};d.prototype.end=function(){j(this,h,t)};d.prototype.report=function(e){if(!e){e=new Error("REPORT")}else{if(!e.message){e=new Error(e||"REPORT")}}return j(this,h,function(B){v(e);v(B);return g(B)})};d.prototype.toSource=function(){return this.toString()};d.prototype.toString=function(){return"[object Promise]"};b(d.prototype);z.isPromise=q;function q(e){return e&&typeof e.promiseSend==="function"}z.isResolved=m;function m(e){return !q(l(e.valueOf()))}z.isFulfilled=u;function u(e){return !q(l(e))&&!r(e)}z.isRejected=r;function r(e){e=l(e);if(e===h||e===null){return false}return !!e.promiseRejected}z.reject=g;function g(B){return d({when:function(D){return D?D(B):g(B)}},function C(D){return g(B)},function e(){var D=o(g.prototype);D.promiseRejected=true;D.reason=B;return D})}g.prototype=o(d.prototype,{constructor:{value:g}});z.ref=i;function i(B){if(q(B)){return B}if(B&&typeof B.then==="function"){return d({},function C(F,E){if(F!=="when"){return Q.when(B,function(G){return Q.ref(G).promiseSend.apply(null,arguments)})}else{var D=c();B.then(D.resolve,D.reject);return D.promise}})}return d({when:function(D){return B},get:function(D){if(B===h||B===null){return g("Cannot access property "+D+" of "+B)}return B[D]},put:function(D,E){if(B===h||B===null){return g("Cannot set property "+D+" of "+B+" to "+E)}return B[D]=E},del:function(D){if(B===h||B===null){return g("Cannot delete property "+D+" of "+B)}return delete B[D]},post:function(D,E){if(B===h||B===null){return g(""+B+" has no methods")}var F=B[D];if(!F){return g("No such method "+D+" on object "+B)}if(!F.apply){return g("Property "+D+" on object "+B+" is not a method")}return B[D].apply(B,E)},keys:function(){return Object.keys(B)}},h,function e(){return B})}z.def=p;function p(B){return d({isDef:function(){}},function C(E){var D=Array.prototype.slice.call(arguments);return k.apply(h,[B].concat(D))},function e(){return B.valueOf()})}z.when=j;function j(F,C,E){var D=c();var B=false;function e(I){try{return C?C(I):I}catch(H){return g(H)}}function G(I){try{return E?E(I):g(I)}catch(H){return g(H)}}n(i(F),"when",function(H){if(B){return}B=true;D.resolve(i(H).promiseSend("when",e,G))},function(H){if(B){return}B=true;D.resolve(G(H))});return D.promise}z.asap=function(C,e,B){e=e||A;if(u(C)){return l(e(l(C)))}else{if(r(C)){var D=C.valueOf().reason;if(B){return B(D)}else{throw D}}else{return j(C,e,B)}}};var l=function(e){if(e===h||e===null){return e}else{return e.valueOf()}};z.Method=a;function a(e){return function(C){var B=Array.prototype.slice.call(arguments,1);return k.apply(h,[C,e].concat(B))}}z.send=k;function k(C,D){var e=c();var B=Array.prototype.slice.call(arguments,2);n.apply(h,[i(C),D,e.resolve].concat(B));return e.promise}z.get=a("get");z.put=a("put");z.del=a("del");var w=z.post=a("post");z.invoke=function(C,B){var e=Array.prototype.slice.call(arguments,2);return w(C,B,e)};z.keys=a("keys");z.error=t;function t(e){if(typeof process!=="undefined"){v(e);process.exit(e?e.exit||1:1)}else{v(e);throw e}}z.report=v;function v(e){f(e&&e.stack||e);return g(e)}function n(B){var e=Array.prototype.slice.call(arguments,1);s(function(){B.promiseSend.apply(B,e)})}});