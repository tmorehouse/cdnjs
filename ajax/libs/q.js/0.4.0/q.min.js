(function(w,h){var s;try{s=require("event-queue").enqueue}catch(v){s=function(e){setTimeout(e,0)}}function x(e){return e}var b=Object.freeze||x;var o=Object.create||function o(y){var e=function(){};e.prototype=y;return new e()};var f=typeof console==="undefined"?x:function(e){console.log(e)};w.enqueue=s;w.defer=c;function c(){var A=[],y;var z=o(d.prototype);z.promiseSend=function(){var B=Array.prototype.slice.call(arguments);if(A){A.push(B)}else{n.apply(h,[y].concat(B))}};z.valueOf=function(){if(A){return z}return l(y)};var e=function(B){var D,E,C;if(!A){return}y=i(B);for(D=0,E=A.length;D<E;++D){n.apply(h,[y].concat(A[D]))}A=h;return y};return{promise:b(z),resolve:e,reject:function(B){return e(g(B))}}}w.makePromise=d;function d(y,A,e){if(A===h){A=function(B){return g("Promise does not support operation: "+B)}}var z=o(d.prototype);z.promiseSend=function(E,C){var D=Array.prototype.slice.call(arguments,2);var B;if(y[E]){B=y[E].apply(y,D)}else{B=A.apply(y,[E].concat(D))}C=C||x;return C(B)};if(e){z.valueOf=e}return b(z)}d.prototype.then=function(e,y){return j(this,e,y)};d.prototype.toSource=function(){return this.toString()};d.prototype.toString=function(){return"[object Promise]"};b(d.prototype);w.isPromise=q;function q(e){return e&&typeof e.promiseSend==="function"}w.isResolved=m;function m(e){return !q(l(e.valueOf()))}w.isFulfilled=t;function t(e){return !q(l(e))&&!r(e)}w.isRejected=r;function r(e){e=l(e);if(e===h||e===null){return false}return !!e.promiseRejected}w.reject=g;function g(y){return d({when:function(A){return A?A(y):g(y)}},function z(A){return g(y)},function e(){var A=o(g.prototype);A.promiseRejected=true;A.reason=y;return A})}g.prototype=o(d.prototype,{constructor:{value:g}});w.ref=i;function i(y){if(q(y)){return y}if(y&&typeof y.then==="function"){return d({},function z(C,B){if(C!=="when"){return Q.when(y,function(D){return Q.ref(D).promiseSend.apply(null,arguments)})}else{var A=c();y.then(A.resolve,A.reject);return A.promise}})}return d({when:function(A){return y},get:function(A){if(y===h||y===null){return g("Cannot access property "+A+" of "+y)}return y[A]},put:function(A,B){if(y===h||y===null){return g("Cannot set property "+A+" of "+y+" to "+B)}return y[A]=B},del:function(A){if(y===h||y===null){return g("Cannot delete property "+A+" of "+y)}return delete y[A]},post:function(A,B){if(y===h||y===null){return g(""+y+" has no methods")}var C=y[A];if(!C){return g("No such method "+A+" on object "+y)}if(!C.apply){return g("Property "+A+" on object "+y+" is not a method")}return y[A].apply(y,B)},keys:function(){return Object.keys(y)}},h,function e(){return y})}w.def=p;function p(y){return d({isDef:function(){}},function z(B){var A=Array.prototype.slice.call(arguments);return k.apply(h,[y].concat(A))},function e(){return y.valueOf()})}w.when=j;function j(C,z,B){var A=c();var y=false;function e(F){try{return z?z(F):F}catch(E){if(typeof process!=="undefined"){process.emit("uncaughtException",E)}else{f(E&&E.stack||E)}return g(E)}}function D(F){try{return B?B(F):g(F)}catch(E){f(E&&E.stack||E);return g(E)}}n(i(C),"when",function(E){if(y){return}y=true;A.resolve(i(E).promiseSend("when",e,D))},function(E){if(y){return}y=true;A.resolve(D(E))});return A.promise}w.asap=function(z,e,y){e=e||x;if(t(z)){return l(e(l(z)))}else{if(r(z)){var A=z.valueOf().reason;if(y){return y(A)}else{throw A}}else{return j(z,e,y)}}};var l=function(e){if(e===h||e===null){return e}else{return e.valueOf()}};w.Method=a;function a(e){return function(z){var y=Array.prototype.slice.call(arguments,1);return k.apply(h,[z,e].concat(y))}}w.send=k;function k(z,A){var e=c();var y=Array.prototype.slice.call(arguments,2);n.apply(h,[i(z),A,e.resolve].concat(y));return e.promise}w.get=a("get");w.put=a("put");w.del=a("del");var u=w.post=a("post");w.invoke=function(z,y){var e=Array.prototype.slice.call(arguments,2);return u(z,y,e)};w.keys=a("keys");w.error=function(e){throw e};function n(y){var e=Array.prototype.slice.call(arguments,1);s(function(){y.promiseSend.apply(y,e)})}})(typeof exports!=="undefined"?exports:Q={});