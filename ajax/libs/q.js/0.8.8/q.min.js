/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 * With formatStackTrace and formatSourcePosition functions
 * Copyright 2006-2008 the V8 project authors. All rights reserved.
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are
 * met:
 *
 *     * Redistributions of source code must retain the above copyright
 *       notice, this list of conditions and the following disclaimer.
 *     * Redistributions in binary form must reproduce the above
 *       copyright notice, this list of conditions and the following
 *       disclaimer in the documentation and/or other materials provided
 *       with the distribution.
 *     * Neither the name of Google Inc. nor the names of its
 *       contributors may be used to endorse or promote products derived
 *       from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
 * "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
 * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
 * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
 * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
 * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT
 * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
 * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 */
(function(a){if(typeof bootstrap==="function"){bootstrap("promise",a)}else{if(typeof exports==="object"){a(void 0,exports)}else{if(typeof define==="function"){define(a)}else{if(typeof ses!=="undefined"){if(!ses.ok()){return}else{ses.makeQ=function(){var b={};return a(void 0,b)}}}else{a(void 0,Q={})}}}}})(function(aj,F){var R=g();var I;var ag=function(){};var X=Object.freeze||ag;if(typeof cajaVM!=="undefined"){X=cajaVM.def}var E;if(typeof process!=="undefined"){E=process.nextTick}else{if(typeof msSetImmediate==="function"){E=msSetImmediate.bind(window)}else{if(typeof setImmediate==="function"){E=setImmediate}else{if(typeof MessageChannel!=="undefined"){var ac=new MessageChannel();var r={},w=r;ac.port1.onmessage=function(){r=r.next;var ax=r.task;delete r.task;ax()};E=function(ax){w=w.next={task:ax};ac.port2.postMessage(0)}}else{E=function(ax){setTimeout(ax,0)}}}}}var q;if(Function.prototype.bind){var z=Function.prototype.bind;q=z.bind(z.call)}else{q=function(ax){return function(){return ax.call.apply(ax,arguments)}}}var ae=q(Array.prototype.slice);var L=q(Array.prototype.reduce||function(aA,az){var ax=0,ay=this.length;if(arguments.length===1){do{if(ax in this){az=this[ax++];break}if(++ax>=ay){throw new TypeError()}}while(1)}for(;ax<ay;ax++){if(ax in this){az=aA(az,this[ax],ax)}}return az});var ah=q(Array.prototype.indexOf||function(ay){for(var ax=0;ax<this.length;ax++){if(this[ax]===ay){return ax}}return -1});var u=q(Array.prototype.map||function(aA,ay){var ax=this;var az=[];L(ax,function(aD,aC,aB){az.push(aA.call(ay,aC,aB,ax))},void 0);return az});var v=Object.create||function(ay){function ax(){}ax.prototype=ay;return new ax()};var t=Object.keys||function(ax){var az=[];for(var ay in ax){az.push(ay)}return az};var au=Object.prototype.toString;function s(ax){return(au(ax)==="[object StopIteration]"||ax instanceof A)}var A;if(typeof ReturnValue!=="undefined"){A=ReturnValue}else{A=function(ax){this.value=ax}}function aa(aA,aE){var az=[];try{az.push(aA.toString())}catch(aC){try{az.push("<error: "+aC+">")}catch(ay){az.push("<error>")}}for(var aB=0;aB<aE.length;aB++){var aD=aE[aB];var ax;if(typeof aD==="string"){az.push(aD)}else{try{ax=N(aD)}catch(aC){try{ax="<error: "+aC+">"}catch(ay){ax="<error>"}}az.push("    at "+ax)}}return az.join("\n")}function N(ay){var aC="";if(ay.isNative()){aC="native"}else{if(ay.isEval()){aC="eval at "+ay.getEvalOrigin()}else{var aA=ay.getFileName();if(aA){aC+=aA;var az=ay.getLineNumber();if(az!==null){aC+=":"+az;var ax=ay.getColumnNumber();if(ax){aC+=":"+ax}}}}}if(!aC){aC="unknown source"}var aH="";var aD=ay.getFunction().name;var aG=true;var aF=ay.isConstructor();var aB=!(ay.isToplevel()||aF);if(aB){var aE=ay.getMethodName();aH+=ay.getTypeName()+".";if(aD){aH+=aD;if(aE&&(aE!==aD)){aH+=" [as "+aE+"]"}}else{aH+=aE||"<anonymous>"}}else{if(aF){aH+="new "+(aD||"<anonymous>")}else{if(aD){aH+=aD}else{aH+=aC;aG=false}}}if(aG){aH+=" ("+aC+")"}return aH}function ak(az,ay){if(az!==I){return false}var ax=ay.getLineNumber();return ax>=R&&ax<=U}function P(az){var ay=Error.prepareStackTrace;Error.prepareStackTrace=function(aA,aB){return aB.filter(function(aC){var aD=aC.getFileName();return(aD!=="module.js"&&aD!=="node.js"&&!ak(aD,aC))})};var ax=az.stack;Error.prepareStackTrace=ay;return ax}function g(){if(Error.captureStackTrace){var az,ax;var ay=Error.prepareStackTrace;Error.prepareStackTrace=function(aA,aB){az=aB[1].getFileName();ax=aB[1].getLineNumber()};new Error().stack;Error.prepareStackTrace=ay;I=az;return ax}}function at(az,ax,ay){return function(){if(typeof console!=="undefined"&&typeof console.warn==="function"){console.warn(ax+" is deprecated, use "+ay+" instead.",new Error("").stack)}return az.apply(az,arguments)}}F.nextTick=E;F.defer=S;function S(){var aB=[],az;var ax=v(S.prototype);var aA=v(M.prototype);aA.promiseSend=function(){var aC=ae(arguments);if(aB){aB.push(aC)}else{E(function(){az.promiseSend.apply(az,aC)})}};aA.valueOf=function(){if(aB){return aA}return az.valueOf()};if(Error.captureStackTrace){Error.captureStackTrace(aA,S)}function ay(aC){if(!aB){return}az=O(aC);L(aB,function(aE,aD){E(function(){az.promiseSend.apply(az,aD)})},void 0);aB=void 0;return az}X(aA);ax.promise=aA;ax.resolve=ay;ax.reject=function(aC){return ay(Z(aC))};return ax}S.prototype.makeNodeResolver=function(){var ax=this;return function(ay,az){if(ay){ax.reject(ay)}else{if(arguments.length>2){ax.resolve(ae(arguments,1))}else{ax.resolve(az)}}}};S.prototype.node=at(S.prototype.makeNodeResolver,"node","makeNodeResolver");F.promise=p;function p(ay){var ax=S();o(ay,ax.resolve,ax.reject).fail(ax.reject);return ax.promise}F.makePromise=M;function M(az,aB,ax,ay){if(aB===void 0){aB=function(aC){return Z(new Error("Promise does not support operation: "+aC))}}var aA=v(M.prototype);aA.promiseSend=function(aG,aD){var aE=ae(arguments,2);var aC;try{if(az[aG]){aC=az[aG].apply(aA,aE)}else{aC=aB.apply(aA,[aG].concat(aE))}}catch(aF){aC=Z(aF)}aD(aC)};if(ax){aA.valueOf=ax}if(ay){aA.exception=ay}X(aA);return aA}M.prototype.then=function(ax,ay){return an(this,ax,ay)};L(["isResolved","isFulfilled","isRejected","when","spread","send","get","put","del","post","invoke","keys","apply","call","bind","fapply","fcall","fbind","all","allResolved","view","viewInfo","timeout","delay","catch","finally","fail","fin","end"],function(ay,ax){M.prototype[ax]=function(){return F[ax].apply(F,[this].concat(ae(arguments)))}},void 0);M.prototype.toSource=function(){return this.toString()};M.prototype.toString=function(){return"[object Promise]"};X(M.prototype);F.nearer=n;function n(ax){if(Object(ax)!==ax){return ax}else{return ax.valueOf()}}F.isPromise=ai;function ai(ax){return ax&&typeof ax.promiseSend==="function"}F.isResolved=ap;function ap(ax){return c(ax)||l(ax)}F.isFulfilled=c;function c(ax){return !ai(n(ax))}F.isRejected=l;function l(ax){ax=n(ax);return ai(ax)&&"exception" in ax}var H=[];var T=[];var m;function h(){if(!m&&typeof window!=="undefined"&&!window.Touch&&window.console){console.log("Should be empty:",T)}m=true}F.reject=Z;function Z(az){az=az||new Error();var ay=M({when:function(aC){if(aC){var aB=ah(H,this);if(aB!==-1){T.splice(aB,1);H.splice(aB,1)}}return aC?aC(az):Z(az)}},function aA(){return Z(az)},function ax(){return this},az);h();H.push(ay);T.push(az);return ay}F.begin=O;F.resolve=O;F.ref=at(O,"ref","resolve");function O(az){if(ai(az)){return az}if(az&&typeof az.then==="function"){var ay=S();az.then(ay.resolve,ay.reject);return ay.promise}return M({when:function(){return az},get:function(aA){return az[aA]},put:function(aA,aB){return az[aA]=aB},del:function(aA){return delete az[aA]},post:function(aA,aB){return az[aA].apply(az,aB)},apply:function(aA,aB){return az.apply(aA,aB)},fapply:function(aA){return az.apply(void 0,aA)},viewInfo:function(){var aA=az;var aB={};function aC(aD){if(!aB[aD]){aB[aD]=typeof aA[aD]}}while(aA){Object.getOwnPropertyNames(aA).forEach(aC);aA=Object.getPrototypeOf(aA)}return{type:typeof az,properties:aB}},keys:function(){return t(az)}},void 0,function ax(){return az})}F.master=d;function d(ax){return M({isDef:function(){}},function ay(){var az=ae(arguments);return G.apply(void 0,[ax].concat(az))},function(){return n(ax)})}F.viewInfo=av;function av(ax,ay){ax=O(ax);if(ay){return M({viewInfo:function(){return ay}},function az(){var aA=ae(arguments);return G.apply(void 0,[ax].concat(aA))},function(){return n(ax)})}else{return G(ax,"viewInfo")}}F.view=af;function af(ax){return av(ax).when(function(aA){var ay;if(aA.type==="function"){ay=function(){return ar(ax,void 0,arguments)}}else{ay={}}var az=aA.properties||{};t(az).forEach(function(aB){if(az[aB]==="function"){ay[aB]=function(){return j(ax,aB,arguments)}}});return O(ay)})}F.when=an;function an(aC,az,aB){var aA=S();var ay=false;function ax(aF){try{return az?az(aF):aF}catch(aE){return Z(aE)}}function aD(aE){try{return aB?aB(aE):Z(aE)}catch(aF){return Z(aF)}}E(function(){O(aC).promiseSend("when",function(aE){if(ay){return}ay=true;aA.resolve(ax(aE))},function(aE){if(ay){return}ay=true;aA.resolve(aD(aE))})});return aA.promise}F.spread=y;function y(az,ax,ay){return an(az,function(aA){return al(aA).then(function(aB){return ax.apply(void 0,aB)})},ay)}F.async=K;function K(ax){return function(){function az(aF,aD){var aC;try{aC=aA[aF](aD)}catch(aE){if(s(aE)){return aE.value}else{return Z(aE)}}return an(aC,aB,ay)}var aA=ax.apply(this,arguments);var aB=az.bind(az,"send");var ay=az.bind(az,"throw");return aB()}}F["return"]=e;function e(ax){throw new A(ax)}F.promised=aq;function aq(ax){return function(){return al([this,al(arguments)]).spread(function(ay,az){return ax.apply(ay,az)})}}F.sender=at(V,"sender","dispatcher");F.Method=at(V,"Method","dispatcher");function V(ax){return function(az){var ay=ae(arguments,1);return G.apply(void 0,[az,ax].concat(ay))}}F.send=at(G,"send","dispatch");function G(az,aA){var ax=S();var ay=ae(arguments,2);az=O(az);E(function(){az.promiseSend.apply(az,[aA,ax.resolve].concat(ay))});return ax.promise}F.dispatch=aw;function aw(az,aA,ay){var ax=S();az=O(az);E(function(){az.promiseSend.apply(az,[aA,ax.resolve].concat(ay))});return ax.promise}F.dispatcher=x;function x(ax){return function(az){var ay=ae(arguments,1);return aw(az,ax,ay)}}F.get=x("get");F.put=x("put");F["delete"]=F.del=x("del");var j=F.post=x("post");F.invoke=function(az,ay){var ax=ae(arguments,2);return j(az,ay,ax)};var ar=F.apply=at(x("apply"),"apply","fapply");var am=F.fapply=x("fapply");F.call=at(D,"call","fcall");function D(az,ay){var ax=ae(arguments,2);return ar(az,ay,ax)}F["try"]=o;F.fcall=o;function o(ay){var ax=ae(arguments,1);return am(ay,ax)}F.bind=at(ao,"bind","fbind");function ao(aA,ay){var ax=ae(arguments,2);return function az(){var aB=ax.concat(ae(arguments));return ar(aA,ay,aB)}}F.fbind=W;function W(az){var ax=ae(arguments,1);return function ay(){var aA=ax.concat(ae(arguments));return am(az,aA)}}F.keys=x("keys");F.all=al;function al(ax){return an(ax,function(aA){var az=aA.length;if(az===0){return O(aA)}var ay=S();L(aA,function(aD,aC,aB){if(c(aC)){aA[aB]=n(aC);if(--az===0){ay.resolve(aA)}}else{an(aC,function(aE){aA[aB]=aE;if(--az===0){ay.resolve(aA)}}).fail(ay.reject)}},void 0);return ay.promise})}F.allResolved=J;function J(ax){return an(ax,function(ay){return an(al(u(ay,function(az){return an(az,ag,ag)})),function(){return u(ay,O)})})}F["catch"]=F.fail=a;function a(ay,ax){return an(ay,void 0,ax)}F["finally"]=F.fin=k;function k(ax,ay){return an(ax,function(az){return an(ay(),function(){return az})},function(az){return an(ay(),function(){return Z(az)})})}F.end=C;function C(ax){an(ax,void 0,function(ay){E(function(){var az;if(Error.captureStackTrace&&typeof ay==="object"&&(az=P(ay))){var aA=P(ax);var aB=az.concat("From previous event:",aA);ay.stack=aa(ay,aB)}throw ay})})}F.timeout=Y;function Y(aA,ay){var ax=S();var az=setTimeout(function(){ax.reject(new Error("Timed out after "+ay+" ms"))},ay);an(aA,function(aB){clearTimeout(az);ax.resolve(aB)},ax.reject);return ax.promise}F.delay=b;function b(az,ay){if(ay===void 0){ay=az;az=void 0}var ax=S();setTimeout(function(){ax.resolve(az)},ay);return ax.promise}F.napply=f;function f(az,ay,ax){return i(az,ay).apply(void 0,ax)}F.ncall=ab;function ab(az,ay){var ax=ae(arguments,2);return f(az,ay,ax)}F.nbind=i;function i(aA){if(arguments.length>1){var ay=arguments[1];var ax=ae(arguments,2);var az=aA;aA=function(){var aB=ax.concat(ae(arguments));return az.apply(ay,aB)}}return function(){var aB=S();var aC=ae(arguments);aC.push(aB.makeNodeResolver());am(aA,aC).fail(aB.reject);return aB.promise}}F.npost=B;function B(az,ay,ax){return f(az[ay],az,ax)}F.ninvoke=ad;function ad(az,ay){var ax=ae(arguments,2);return f(az[ay],az,ax)}X(F);var U=g()});