/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 */
(function(a,b){if(typeof define==="function"){define(function(d,c,e){a(d,c,e)})}else{if(typeof exports==="object"){a(require,exports,module)}else{Q=a(b,{},{})}}})(function(i,H,a,h){var d;try{d=i("event-queue").enqueue}catch(K){if(typeof MessageChannel!=="undefined"){var A=new MessageChannel();d=function(e){A.port1.onmessage=e;A.port2.postMessage()}}else{d=function(e){setTimeout(e,0)}}}function G(e){return e}var n=Object.freeze||G;var f=Object.create||function f(M){var e=function(){};e.prototype=M;return new e()};var v=Object.keys||function(e){var N=[];for(var M in e){N.push(M)}return N};var m=Array.prototype.reduce||function(O,N){for(var e=0,M=this.length;e<M;e++){N=O(N,this[e],e)}return N};var l=function(e){return Object.prototype.toString.call(e)==="[object StopIteration]"};var I=typeof console==="undefined"?G:function(e){console.log(e)};H.enqueue=d;H.defer=c;function c(){var O=[],M;var N=f(x.prototype);N.promiseSend=function(){var P=Array.prototype.slice.call(arguments);if(O){O.push(P)}else{z.apply(h,[M].concat(P))}};N.valueOf=function(){if(O){return N}return k(M)};var e=function(P){var S,T,R;if(!O){return}M=F(P);for(S=0,T=O.length;S<T;++S){z.apply(h,[M].concat(O[S]))}O=h;return M};return{promise:n(N),resolve:e,reject:function(P){return e(u(P))}}}H.makePromise=x;function x(M,O,e){if(O===h){O=function(P){return u("Promise does not support operation: "+P)}}var N=f(x.prototype);N.promiseSend=function(T,R){var S=Array.prototype.slice.call(arguments,2);var P;if(M[T]){P=M[T].apply(M,S)}else{P=O.apply(M,[T].concat(S))}R=R||G;return R(P)};if(e){N.valueOf=e}return n(N)}x.prototype.then=function(e,M){return y(this,e,M)};m.call(["when","get","put","del","post","invoke","keys","apply","call","all","wait","join","fail","fin","spy","report","end"],function(M,e){x.prototype[e]=function(){return H[e].apply(H,[this].concat(Array.prototype.slice.call(arguments)))}},h);x.prototype.toSource=function(){return this.toString()};x.prototype.toString=function(){return"[object Promise]"};n(x.prototype);H.isPromise=q;function q(e){return e&&typeof e.promiseSend==="function"}H.isResolved=b;function b(e){return !q(k(e.valueOf()))}H.isFulfilled=B;function B(e){return !q(k(e))&&!D(e)}H.isRejected=D;function D(e){e=k(e);if(e===h||e===null){return false}return !!e.promiseRejected}H.reject=u;function u(M){return x({when:function(O){return O?O(M):u(M)}},function N(O){return u(M)},function e(){var O=f(u.prototype);O.promiseRejected=true;O.reason=M;return O})}u.prototype=f(x.prototype,{constructor:{value:u}});H.ref=F;function F(M){if(q(M)){return M}if(M&&typeof M.then==="function"){return x({},function N(R,P){if(R!=="when"){return y(M,function(S){return F(S).promiseSend.apply(null,arguments)})}else{var O=c();M.then(O.resolve,O.reject);return O.promise}})}return x({when:function(O){return M},get:function(O){if(M===h||M===null){return u("Cannot access property "+O+" of "+M)}return M[O]},put:function(O,P){if(M===h||M===null){return u("Cannot set property "+O+" of "+M+" to "+P)}return M[O]=P},del:function(O){if(M===h||M===null){return u("Cannot delete property "+O+" of "+M)}return delete M[O]},post:function(O,P){if(M===h||M===null){return u(""+M+" has no methods")}var R=M[O];if(!R){return u("No such method "+O+" on object "+M)}if(!R.apply){return u("Property "+O+" on object "+M+" is not a method")}return M[O].apply(M,P)},apply:function(O,P){if(!M||typeof M.apply!=="function"){return u(""+M+" is not a function")}return M.apply(O,P)},keys:function(){return v(M)}},h,function e(){return M})}H.master=H.def=r;function r(M){return x({isDef:function(){}},function N(P){var O=Array.prototype.slice.call(arguments);return w.apply(h,[M].concat(O))},function e(){return M.valueOf()})}H.when=y;function y(R,N,P){var O=c();var M=false;function e(U){try{return N?N(U):U}catch(T){return u(T)}}function S(U){try{return P?P(U):u(U)}catch(T){return u(T)}}z(F(R),"when",function(T){if(M){return}M=true;O.resolve(F(T).promiseSend("when",e,S))},function(T){if(M){return}M=true;O.resolve(S(T))});return O.promise}H.asap=function(N,e,M){e=e||G;if(B(N)){return k(e(k(N)))}else{if(D(N)){var O=N.valueOf().reason;if(M){return M(O)}else{throw O}}else{return y(N,e,M)}}};var k=function(e){if(e===h||e===null){return e}else{return e.valueOf()}};H.async=C;function C(e){return function(){var N=function(U,S){var R;try{R=O[U](S)}catch(T){if(l(T)){return T.value}else{return u(T)}}return y(R,P,M)};var O=e.apply(this,arguments);var P=N.bind(N,"send");var M=N.bind(N,"throw");return P()}}H.Method=t;function t(e){return function(N){var M=Array.prototype.slice.call(arguments,1);return w.apply(h,[N,e].concat(M))}}H.send=w;function w(N,O){var e=c();var M=Array.prototype.slice.call(arguments,2);z.apply(h,[F(N),O,e.resolve].concat(M));return e.promise}H.get=t("get");H.put=t("put");H.del=t("del");var p=H.post=t("post");H.invoke=function(N,M){var e=Array.prototype.slice.call(arguments,2);return p(N,M,e)};var L=H.apply=t("apply");H.call=function(N,M){var e=Array.prototype.slice.call(arguments,2);return L(N,M,e)};H.keys=t("keys");H.all=s;function s(e){return y(e,function(P){var O=P.length;var N=[];if(O===0){return F(N)}var M=c();m.call(P,function(T,S,R){y(S,function(U){N[R]=U;if(--O===0){M.resolve(N)}},M.reject)},h);return M.promise})}H.wait=function(e){return s(arguments).get(0)};H.join=function(){var e=Array.prototype.slice.call(arguments);var M=e.pop();return s(e).then(function(N){return M.apply(h,N)})};H.fail=g;function g(M,e){return y(M,h,e)}H.spy=H.fin=E;function E(e,M){return y(e,function(N){return y(M(h,N),function(){return N})},function(N){return y(M(N),function(){return u(N)})})}H.report=J;function J(N,M){var e=new Error(M||"REPORT");return spy(N,function(O,P){I(e&&e.stack||e);if(P){I(P&&P.stack||P)}else{I(O)}})}H.end=o;function o(e){y(e,h,function(M){d(function(){throw M})})}function z(M){var e=Array.prototype.slice.call(arguments,1);d(function(){M.promiseSend.apply(M,e)})}for(var j in H){F[j]=H[j]}a.exports=F;return F});