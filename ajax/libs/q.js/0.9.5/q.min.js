/*!
 *
 * Copyright 2009-2012 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 * With parts by Tyler Close
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * With parts by Mark Miller
 * Copyright (C) 2011 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *
 */
(function(a){if(typeof bootstrap==="function"){bootstrap("promise",a)}else{if(typeof exports==="object"){module.exports=a()}else{if(typeof define==="function"&&define.amd){define(a)}else{if(typeof ses!=="undefined"){if(!ses.ok()){return}else{ses.makeQ=a}}else{Q=a()}}}}})(function(){var f=false;try{throw new Error()}catch(O){f=!!O.stack}var ac=k();var P;var ao=function(){};var M;if(typeof setImmediate==="function"){if(typeof window!=="undefined"){M=setImmediate.bind(window)}else{M=setImmediate}}else{if(typeof process!=="undefined"&&process.nextTick){M=process.nextTick}else{(function(){var aK={task:void 0,next:null};var aJ=aK;var aM=2;var aG=0;var aL=0;var aN=0;var aH=void 0;function e(){--aG;if(++aN>=aM){aN=0;aM*=4;var aO=aL&&Math.min(aL-1,aM);while(aG<aO){++aG;aH()}}while(aL){--aL;aK=aK.next;var aP=aK.task;aK.task=void 0;aP()}aN=0}M=function(aO){aJ=aJ.next={task:aO,next:null};if(aG<++aL&&aG<aM){++aG;aH()}};if(typeof MessageChannel!=="undefined"){var aI=new MessageChannel();aI.port1.onmessage=e;aH=function(){aI.port2.postMessage(0)}}else{aH=function(){setTimeout(e,0)}}})()}}function v(aG){var e=Function.call;return function(){return e.apply(aG,arguments)}}var an=v(Array.prototype.slice);var X=v(Array.prototype.reduce||function(aI,aH){var e=0,aG=this.length;if(arguments.length===1){do{if(e in this){aH=this[e++];break}if(++e>=aG){throw new TypeError()}}while(1)}for(;e<aG;e++){if(e in this){aH=aI(aH,this[e],e)}}return aH});var aq=v(Array.prototype.indexOf||function(aG){for(var e=0;e<this.length;e++){if(this[e]===aG){return e}}return -1});var C=v(Array.prototype.map||function(aI,aG){var e=this;var aH=[];X(e,function(aL,aK,aJ){aH.push(aI.call(aG,aK,aJ,e))},void 0);return aH});var E=Object.create||function(aG){function e(){}e.prototype=aG;return new e()};var ay=v(Object.prototype.hasOwnProperty);var B=Object.keys||function(e){var aH=[];for(var aG in e){if(ay(e,aG)){aH.push(aG)}}return aH};var aC=v(Object.prototype.toString);function x(e){return e===Object(e)}function z(e){return(aC(e)==="[object StopIteration]"||e instanceof K)}var K;if(typeof ReturnValue!=="undefined"){K=ReturnValue}else{K=function(e){this.value=e}}var am;try{new Function("(function* (){ yield 1; })");am=true}catch(O){am=false}var ae="From previous event:";function r(e,aJ){if(f&&aJ.stack&&typeof e==="object"&&e!==null&&e.stack&&e.stack.indexOf(ae)===-1){var aH=[];for(var aI=aJ;!!aI;aI=aI.source){if(aI.stack){aH.unshift(aI.stack)}}aH.unshift(e.stack);var aG=aH.join("\n"+ae+"\n");e.stack=D(aG)}}function D(aI){var aG=aI.split("\n");var aJ=[];for(var aH=0;aH<aG.length;++aH){var e=aG[aH];if(!at(e)&&!i(e)&&e){aJ.push(e)}}return aJ.join("\n")}function i(e){return e.indexOf("(module.js:")!==-1||e.indexOf("(node.js:")!==-1}function al(e){var aI=/at .+ \((.+):(\d+):(?:\d+)\)$/.exec(e);if(aI){return[aI[1],Number(aI[2])]}var aH=/at ([^ ]+):(\d+):(?:\d+)$/.exec(e);if(aH){return[aH[1],Number(aH[2])]}var aG=/.*@(.+):(\d+)$/.exec(e);if(aG){return[aG[1],Number(aG[2])]}}function at(aG){var aH=al(aG);if(!aH){return false}var aI=aH[0];var e=aH[1];return aI===P&&e>=ac&&e<=af}function k(){if(!f){return}try{throw new Error()}catch(aJ){var aG=aJ.stack.split("\n");var aH=aG[0].indexOf("@")>0?aG[1]:aG[2];var aI=al(aH);if(!aI){return}P=aI[0];return aI[1]}}function aA(aH,e,aG){return function(){if(typeof console!=="undefined"&&typeof console.warn==="function"){console.warn(e+" is deprecated, use "+aG+" instead.",new Error("").stack)}return aH.apply(aH,arguments)}}function ab(e){return aa(e)}ab.nextTick=M;ab.longStackSupport=false;ab.defer=ad;function ad(){var aI=[],aK=[],aJ;var aG=E(ad.prototype);var aM=E(Y.prototype);aM.promiseDispatch=function(aO,aP,aN){var e=an(arguments);if(aI){aI.push(e);if(aP==="when"&&aN[1]){aK.push(aN[1])}}else{M(function(){aJ.promiseDispatch.apply(aJ,e)})}};aM.valueOf=aA(function(){if(aI){return aM}var e=g(aJ);if(ar(e)){aJ=e}return e},"valueOf","inspect");aM.inspect=function(){if(!aJ){return{state:"pending"}}return aJ.inspect()};if(ab.longStackSupport&&f){try{throw new Error()}catch(aL){aM.stack=aL.stack.substring(aL.stack.indexOf("\n")+1)}}function aH(e){aJ=e;aM.source=e;X(aI,function(aO,aN){M(function(){e.promiseDispatch.apply(e,aN)})},void 0);aI=void 0;aK=void 0}aG.promise=aM;aG.resolve=function(e){if(aJ){return}aH(aa(e))};aG.fulfill=function(e){if(aJ){return}aH(aD(e))};aG.reject=function(e){if(aJ){return}aH(ai(e))};aG.notify=function(e){if(aJ){return}X(aK,function(aO,aN){M(function(){aN(e)})},void 0)};return aG}ad.prototype.makeNodeResolver=function(){var e=this;return function(aG,aH){if(aG){e.reject(aG)}else{if(arguments.length>2){e.resolve(an(arguments,1))}else{e.resolve(aH)}}}};ab.promise=u;function u(aG){if(typeof aG!=="function"){throw new TypeError("resolver must be a function.")}var e=ad();t(aG,e.resolve,e.reject,e.notify).fail(e.reject);return e.promise}ab.makePromise=Y;function Y(aG,aJ,aI){if(aJ===void 0){aJ=function(aK){return ai(new Error("Promise does not support operation: "+aK))}}var aH=E(Y.prototype);aH.promiseDispatch=function(aN,aO,aL){var aK;try{if(aG[aO]){aK=aG[aO].apply(aH,aL)}else{aK=aJ.call(aH,aO,aL)}}catch(aM){aK=ai(aM)}if(aN){aN(aK)}};aH.inspect=aI;if(aI){var e=aI();if(e.state==="rejected"){aH.exception=e.reason}aH.valueOf=aA(function(){var aK=aI();if(aK.state==="pending"||aK.state==="rejected"){return aH}return aK.value})}return aH}Y.prototype.then=function(e,aG,aH){return ax(this,e,aG,aH)};Y.prototype.thenResolve=function(e){return ax(this,function(){return e})};Y.prototype.thenReject=function(e){return ax(this,function(){throw e})};X(["isFulfilled","isRejected","isPending","dispatch","when","spread","get","set","del","delete","post","send","mapply","invoke","mcall","keys","fapply","fcall","fbind","all","allResolved","timeout","delay","catch","finally","fail","fin","progress","done","nfcall","nfapply","nfbind","denodeify","nbind","npost","nsend","nmapply","ninvoke","nmcall","nodeify"],function(aG,e){Y.prototype[e]=function(){return ab[e].apply(ab,[this].concat(an(arguments)))}},void 0);Y.prototype.toSource=function(){return this.toString()};Y.prototype.toString=function(){return"[object Promise]"};ab.nearer=g;function g(aG){if(ar(aG)){var e=aG.inspect();if(e.state==="fulfilled"){return e.value}}return aG}ab.isPromise=ar;function ar(e){return x(e)&&typeof e.promiseDispatch==="function"}ab.isPromiseAlike=R;function R(e){return x(e)&&typeof e.then==="function"}ab.isPending=U;function U(e){return ar(e)&&e.inspect().state==="pending"}ab.isFulfilled=d;function d(e){return !ar(e)||e.inspect().state==="fulfilled"}ab.isRejected=q;function q(e){return ar(e)&&e.inspect().state==="rejected"}var s=[];var S=[];var aE=false;var A=true;function W(){if(!aE&&typeof window!=="undefined"&&!window.Touch&&window.console){console.warn("[Q] Unhandled rejection reasons (should be empty):",s)}aE=true}function Z(){for(var e=0;e<s.length;e++){var aG=s[e];if(aG&&typeof aG.stack!=="undefined"){console.warn("Unhandled rejection reason:",aG.stack)}else{console.warn("Unhandled rejection reason (no stack):",aG)}}}function au(){s.length=0;S.length=0;aE=false;if(!A){A=true;if(typeof process!=="undefined"&&process.on){process.on("exit",Z)}}}function H(aG,e){if(!A){return}S.push(aG);s.push(e);W()}function m(aG){if(!A){return}var e=aq(S,aG);if(e!==-1){S.splice(e,1);s.splice(e,1)}}ab.resetUnhandledRejections=au;ab.getUnhandledReasons=function(){return s.slice()};ab.stopUnhandledRejectionTracking=function(){au();if(typeof process!=="undefined"&&process.on){process.removeListener("exit",Z)}A=false};au();ab.reject=ai;function ai(aG){var e=Y({when:function(aJ){if(aJ){m(this)}return aJ?aJ(aG):this}},function aI(){return this},function aH(){return{state:"rejected",reason:aG}});H(e,aG);return e}ab.fulfill=aD;function aD(e){return Y({when:function(){return e},get:function(aH){return e[aH]},set:function(aH,aI){e[aH]=aI},"delete":function(aH){delete e[aH]},post:function(aI,aH){if(aI===null||aI===void 0){return e.apply(void 0,aH)}else{return e[aI].apply(e,aH)}},apply:function(aI,aH){return e.apply(aI,aH)},keys:function(){return B(e)}},void 0,function aG(){return{state:"fulfilled",value:e}})}ab.resolve=aa;function aa(e){if(ar(e)){return e}if(R(e)){return aB(e)}else{return aD(e)}}function aB(aG){var e=ad();M(function(){try{aG.then(e.resolve,e.reject,e.notify)}catch(aH){e.reject(aH)}});return e.promise}ab.master=h;function h(e){return Y({isDef:function(){}},function aG(aI,aH){return aF(e,aI,aH)},function(){return aa(e).inspect()})}ab.when=ax;function ax(aL,aK,aM,aH){var aN=ad();var aI=false;function aJ(aQ){try{return typeof aK==="function"?aK(aQ):aQ}catch(aP){return ai(aP)}}function aO(aP){if(typeof aM==="function"){r(aP,e);try{return aM(aP)}catch(aQ){return ai(aQ)}}return ai(aP)}function aG(aP){return typeof aH==="function"?aH(aP):aP}var e=aa(aL);M(function(){e.promiseDispatch(function(aP){if(aI){return}aI=true;aN.resolve(aJ(aP))},"when",[function(aP){if(aI){return}aI=true;aN.resolve(aO(aP))}])});e.promiseDispatch(void 0,"when",[void 0,function(aP){var aR;var aS=false;try{aR=aG(aP)}catch(aQ){aS=true;if(ab.onerror){ab.onerror(aQ)}else{throw aQ}}if(!aS){aN.notify(aR)}}]);return aN.promise}ab.spread=I;function I(aH,e,aG){return ax(aH,function(aI){return av(aI).then(function(aJ){return e.apply(void 0,aJ)},aG)},aG)}ab.async=V;function V(e){return function(){function aH(aN,aL){var aK;if(am){try{aK=aI[aN](aL)}catch(aM){return ai(aM)}if(aK.done){return aK.value}else{return ax(aK.value,aJ,aG)}}else{try{aK=aI[aN](aL)}catch(aM){if(z(aM)){return aM.value}else{return ai(aM)}}return ax(aK,aJ,aG)}}var aI=e.apply(this,arguments);var aJ=aH.bind(aH,"send");var aG=aH.bind(aH,"throw");return aJ()}}ab.spawn=y;function y(e){ab.done(ab.async(e)())}ab["return"]=j;function j(e){throw new K(e)}ab.promised=az;function az(e){return function(){return I([this,av(arguments)],function(aG,aH){return e.apply(aG,aH)})}}ab.dispatch=aF;function aF(aH,aI,aG){var e=ad();M(function(){aa(aH).promiseDispatch(e.resolve,aI,aG)});return e.promise}ab.dispatcher=G;function G(e){return function(aH){var aG=an(arguments,1);return aF(aH,e,aG)}}ab.get=G("get");ab.set=G("set");ab["delete"]=ab.del=G("delete");var o=ab.post=G("post");ab.mapply=o;ab.send=N;ab.invoke=N;ab.mcall=N;function N(aH,aG){var e=an(arguments,2);return o(aH,aG,e)}ab.fapply=aw;function aw(aG,e){return aF(aG,"apply",[void 0,e])}ab["try"]=t;ab.fcall=t;function t(aG){var e=an(arguments,1);return aw(aG,e)}ab.fbind=ag;function ag(aH){var e=an(arguments,1);return function aG(){var aI=e.concat(an(arguments));return aF(aH,"apply",[this,aI])}}ab.keys=G("keys");ab.all=av;function av(e){return ax(e,function(aI){var aH=0;var aG=ad();X(aI,function(aM,aL,aK){var aJ;if(ar(aL)&&(aJ=aL.inspect()).state==="fulfilled"){aI[aK]=aJ.value}else{++aH;ax(aL,function(aN){aI[aK]=aN;if(--aH===0){aG.resolve(aI)}},aG.reject)}},void 0);if(aH===0){aG.resolve(aI)}return aG.promise})}ab.allResolved=aA(T,"allResolved","allSettled");function T(e){return ax(e,function(aG){aG=C(aG,aa);return ax(av(C(aG,function(aH){return ax(aH,ao,ao)})),function(){return aG})})}ab.allSettled=l;function l(e){return ax(e,function(aG){return av(C(aG,function(aI,aH){return ax(aI,function(aJ){aG[aH]={state:"fulfilled",value:aJ};return aG[aH]},function(aJ){aG[aH]={state:"rejected",reason:aJ};return aG[aH]})})).thenResolve(aG)})}ab["catch"]=ab.fail=a;function a(aG,e){return ax(aG,void 0,e)}ab.progress=F;function F(e,aG){return ax(e,void 0,void 0,aG)}ab["finally"]=ab.fin=p;function p(e,aG){return ax(e,function(aH){return ax(aG(),function(){return aH})},function(aH){return ax(aG(),function(){return ai(aH)})})}ab.done=ak;function ak(aK,e,aJ,aI){var aG=function(aL){M(function(){r(aL,aK);if(ab.onerror){ab.onerror(aL)}else{throw aL}})};var aH=e||aJ||aI?ax(aK,e,aJ,aI):aK;if(typeof process==="object"&&process&&process.domain){aG=process.domain.bind(aG)}a(aH,aG)}ab.timeout=ah;function ah(aJ,aG,aI){var e=ad();var aH=setTimeout(function(){e.reject(new Error(aI||"Timed out after "+aG+" ms"))},aG);ax(aJ,function(aK){clearTimeout(aH);e.resolve(aK)},function(aK){clearTimeout(aH);e.reject(aK)},e.notify);return e.promise}ab.delay=b;function b(aH,aG){if(aG===void 0){aG=aH;aH=void 0}var e=ad();ax(aH,undefined,undefined,e.notify);setTimeout(function(){e.resolve(aH)},aG);return e.promise}ab.nfapply=w;function w(aI,aG){var aH=an(aG);var e=ad();aH.push(e.makeNodeResolver());aw(aI,aH).fail(e.reject);return e.promise}ab.nfcall=J;function J(aH){var aG=an(arguments,1);var e=ad();aG.push(e.makeNodeResolver());aw(aH,aG).fail(e.reject);return e.promise}ab.nfbind=ap;ab.denodeify=ab.nfbind;function ap(aG){var e=an(arguments,1);return function(){var aI=e.concat(an(arguments));var aH=ad();aI.push(aH.makeNodeResolver());aw(aG,aI).fail(aH.reject);return aH.promise}}ab.nbind=n;function n(aH,e){var aG=an(arguments,2);return function(){var aK=aG.concat(an(arguments));var aI=ad();aK.push(aI.makeNodeResolver());function aJ(){return aH.apply(e,arguments)}aw(aJ,aK).fail(aI.reject);return aI.promise}}ab.npost=L;ab.nmapply=L;function L(aI,aH,aG){var aJ=an(aG||[]);var e=ad();aJ.push(e.makeNodeResolver());o(aI,aH,aJ).fail(e.reject);return e.promise}ab.nsend=aj;ab.ninvoke=ab.nsend;ab.nmcall=ab.nsend;function aj(aH,aG){var aI=an(arguments,2);var e=ad();aI.push(e.makeNodeResolver());o(aH,aG,aI).fail(e.reject);return e.promise}ab.nodeify=c;function c(aG,e){if(e){aG.then(function(aH){M(function(){e(null,aH)})},function(aH){M(function(){e(aH)})})}else{return aG}}var af=k();return ab});