/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 */
(function(a,b){if(typeof define==="function"){define(function(d,c){a(d,c)})}else{if(typeof exports==="object"){a(require,exports)}else{a(b,Q={})}}})(function(x,z,j){var u;try{u=x("event-queue").enqueue}catch(y){u=function(e){setTimeout(e,0)}}function A(e){return e}var b=Object.freeze||A;var p=Object.create||function p(B){var e=function(){};e.prototype=B;return new e()};var q=Array.prototype.reduce||function(D,C){for(var e=0,B=this.length;e<B;e++){C=D(C,this[e],e)}return C};var f=typeof console==="undefined"?A:function(e){console.log(e)};z.enqueue=u;z.defer=c;function c(){var D=[],B;var C=p(d.prototype);C.promiseSend=function(){var E=Array.prototype.slice.call(arguments);if(D){D.push(E)}else{o.apply(j,[B].concat(E))}};C.valueOf=function(){if(D){return C}return m(B)};var e=function(E){var G,H,F;if(!D){return}B=i(E);for(G=0,H=D.length;G<H;++G){o.apply(j,[B].concat(D[G]))}D=j;return B};return{promise:b(C),resolve:e,reject:function(E){return e(h(E))}}}z.makePromise=d;function d(B,D,e){if(D===j){D=function(E){return h("Promise does not support operation: "+E)}}var C=p(d.prototype);C.promiseSend=function(H,F){var G=Array.prototype.slice.call(arguments,2);var E;if(B[H]){E=B[H].apply(B,G)}else{E=D.apply(B,[H].concat(G))}F=F||A;return F(E)};if(e){C.valueOf=e}return b(C)}d.prototype.then=function(e,B){return k(this,e,B)};d.prototype.wait=function(){return q.call(arguments,function(e,B){return k(B,function(){return e})},this)};d.prototype.join=function(){var e=Array.prototype.slice.call(arguments);e.unshift(this);var B=e.pop();return q.call(e,function(C,E,D){return k(E,function(F){return k(C,function(){e[D]=F})})},j).then(function(){return B.apply(j,e)})};d.prototype.end=function(){g(this)};d.prototype.report=function(e){if(!e){e=new Error("REPORT")}else{if(!e.message){e=new Error(e||"REPORT")}}return k(this,j,function(B){f(e&&e.stack||e);f(B&&B.stack||B);return h(B)})};d.prototype.toSource=function(){return this.toString()};d.prototype.toString=function(){return"[object Promise]"};b(d.prototype);z.isPromise=s;function s(e){return e&&typeof e.promiseSend==="function"}z.isResolved=n;function n(e){return !s(m(e.valueOf()))}z.isFulfilled=v;function v(e){return !s(m(e))&&!t(e)}z.isRejected=t;function t(e){e=m(e);if(e===j||e===null){return false}return !!e.promiseRejected}z.reject=h;function h(B){return d({when:function(D){return D?D(B):h(B)}},function C(D){return h(B)},function e(){var D=p(h.prototype);D.promiseRejected=true;D.reason=B;return D})}h.prototype=p(d.prototype,{constructor:{value:h}});z.ref=i;function i(B){if(s(B)){return B}if(B&&typeof B.then==="function"){return d({},function C(F,E){if(F!=="when"){return k(B,function(G){return i(G).promiseSend.apply(null,arguments)})}else{var D=c();B.then(D.resolve,D.reject);return D.promise}})}return d({when:function(D){return B},get:function(D){if(B===j||B===null){return h("Cannot access property "+D+" of "+B)}return B[D]},put:function(D,E){if(B===j||B===null){return h("Cannot set property "+D+" of "+B+" to "+E)}return B[D]=E},del:function(D){if(B===j||B===null){return h("Cannot delete property "+D+" of "+B)}return delete B[D]},post:function(D,E){if(B===j||B===null){return h(""+B+" has no methods")}var F=B[D];if(!F){return h("No such method "+D+" on object "+B)}if(!F.apply){return h("Property "+D+" on object "+B+" is not a method")}return B[D].apply(B,E)},keys:function(){return Object.keys(B)}},j,function e(){return B})}z.def=r;function r(B){return d({isDef:function(){}},function C(E){var D=Array.prototype.slice.call(arguments);return l.apply(j,[B].concat(D))},function e(){return B.valueOf()})}z.when=k;function k(F,C,E){var D=c();var B=false;function e(I){try{return C?C(I):I}catch(H){return h(H)}}function G(I){try{return E?E(I):h(I)}catch(H){return h(H)}}o(i(F),"when",function(H){if(B){return}B=true;D.resolve(i(H).promiseSend("when",e,G))},function(H){if(B){return}B=true;D.resolve(G(H))});return D.promise}z.asap=function(C,e,B){e=e||A;if(v(C)){return m(e(m(C)))}else{if(t(C)){var D=C.valueOf().reason;if(B){return B(D)}else{throw D}}else{return k(C,e,B)}}};var m=function(e){if(e===j||e===null){return e}else{return e.valueOf()}};z.Method=a;function a(e){return function(C){var B=Array.prototype.slice.call(arguments,1);return l.apply(j,[C,e].concat(B))}}z.send=l;function l(C,D){var e=c();var B=Array.prototype.slice.call(arguments,2);o.apply(j,[i(C),D,e.resolve].concat(B));return e.promise}z.get=a("get");z.put=a("put");z.del=a("del");var w=z.post=a("post");z.invoke=function(C,B){var e=Array.prototype.slice.call(arguments,2);return w(C,B,e)};z.keys=a("keys");z.end=g;function g(e){k(e,j,function(B){u(function(){throw B})})}function o(B){var e=Array.prototype.slice.call(arguments,1);u(function(){B.promiseSend.apply(B,e)})}});