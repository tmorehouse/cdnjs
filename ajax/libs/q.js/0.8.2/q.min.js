/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 */
(function(a){if(typeof define==="function"){define(a)}else{if(typeof exports==="object"){a(require,exports)}else{a(void 0,Q={})}}})(function(i,L){var P;try{P=i("event-queue").enqueue}catch(O){if(typeof MessageChannel!=="undefined"){var D=new MessageChannel();var k={},S=k;D.port1.onmessage=function(){var T=k.next;var e=T.task;k=T;e()};P=function(e){S=S.next={task:e};D.port2.postMessage(0)}}else{P=function(e){setTimeout(e,0)}}}function J(e){return e}var H=function(T,e,U){if(!T[e]){T[e]=U}return T[e]};var p=H(Object,"freeze",J);var g=H(Object,"create",function(T){var e=function(){};e.prototype=T;return new e()});var x=H(Object,"keys",function(e){var U=[];for(var T in e){U.push(T)}return U});var m=Array.prototype.reduce||function(V,U){var e=0,T=this.length;if(arguments.length==1){do{if(e in this){U=this[e++];break}if(++e>=T){throw new TypeError()}}while(1)}for(;e<T;e++){if(e in this){U=V(U,this[e],e)}}return U};var l=function(e){return Object.prototype.toString.call(e)==="[object StopIteration]"};var o=Array.prototype.slice;var j=function(e){if(e===void 0||e===null){return e}else{return e.valueOf()}};L.nextTick=P;L.defer=f;function f(){var W=[],U;var e=g(f.prototype);var V=g(A.prototype);V.promiseSend=function(){var X=o.call(arguments);if(W){W.push(X)}else{P(function(){U.promiseSend.apply(U,X)})}};V.valueOf=function(){if(W){return V}return U.valueOf()};var T=function(X){var Z,aa,Y;if(!W){return}U=v(X);m.call(W,function(ac,ab){P(function(){U.promiseSend.apply(U,ab)})},void 0);W=void 0;return U};e.promise=p(V);e.resolve=T;e.reject=function(X){return T(w(X))};return e}f.prototype.node=function(){var e=this;return function(T,U){if(T){e.reject(T)}else{if(arguments.length>2){e.resolve(Array.prototype.slice.call(arguments,1))}else{e.resolve(U)}}}};L.makePromise=A;function A(T,V,e){if(V===void 0){V=function(W){return w("Promise does not support operation: "+W)}}var U=g(A.prototype);U.promiseSend=function(aa,X){var Y=o.call(arguments,2);var W;try{if(T[aa]){W=T[aa].apply(T,Y)}else{W=V.apply(T,[aa].concat(Y))}}catch(Z){W=w(Z)}return(X||J)(W)};if(e){U.valueOf=e}return p(U)}A.prototype.then=function(e,T){return C(this,e,T)};m.call(["when","spread","send","get","put","del","post","invoke","keys","apply","call","all","wait","join","fail","fin","view","viewInfo","timeout","delay","end"],function(T,e){A.prototype[e]=function(){return L[e].apply(L,[this].concat(o.call(arguments)))}},void 0);A.prototype.toSource=function(){return this.toString()};A.prototype.toString=function(){return"[object Promise]"};p(A.prototype);L.isPromise=t;function t(e){return e&&typeof e.promiseSend==="function"}L.isResolved=d;function d(e){return !t(j(e))}L.isFulfilled=E;function E(e){return !t(j(e))&&!G(e)}L.isRejected=G;function G(e){e=j(e);if(e===void 0||e===null){return false}return !!e.promiseRejected}L.reject=w;function w(T){return A({when:function(V){return V?V(T):w(T)}},function U(V){return w(T)},function e(){var V=g(w.prototype);V.promiseRejected=true;V.reason=T;return V})}w.prototype=g(A.prototype,{constructor:{value:w}});L.resolve=v;L.ref=v;function v(U){if(t(U)){return U}if(U&&typeof U.then==="function"){var T=f();U.then(T.resolve,T.reject);return T.promise}return A({when:function(V){return U},get:function(V){return U[V]},put:function(V,W){return U[V]=W},del:function(V){return delete U[V]},post:function(V,W){return U[V].apply(U,W)},apply:function(V,W){return U.apply(V,W)},viewInfo:function(){var V=U;var W={};while(V){Object.getOwnPropertyNames(V).forEach(function(X){if(!W[X]){W[X]=typeof V[X]}});V=Object.getPrototypeOf(V)}return{type:typeof U,properties:W}},keys:function(){return x(U)}},void 0,function e(){return U})}L.master=n;function n(e){return A({isDef:function(){}},function T(V){var U=o.call(arguments);return y.apply(void 0,[e].concat(U))},function(){return j(e)})}L.viewInfo=K;function K(e,T){e=v(e);if(T){return A({viewInfo:function(){return T}},function U(W){var V=o.call(arguments);return y.apply(void 0,[e].concat(V))},function(){return j(e)})}else{return y(e,"viewInfo")}}L.view=b;function b(e){return K(e).when(function(V){var T;if(V.type==="function"){T=function(){return R(e,void 0,arguments)}}else{T={}}var U=V.properties||{};Object.keys(U).forEach(function(W){if(U[W]==="function"){T[W]=function(){return r(e,W,arguments)}}});return v(T)})}L.when=C;function C(X,U,W){var V=f();var T=false;function e(aa){try{return U?U(aa):aa}catch(Z){return w(Z)}}function Y(aa){try{return W?W(aa):w(aa)}catch(Z){return w(Z)}}P(function(){v(X).promiseSend("when",function(Z){if(T){return}T=true;V.resolve(v(Z).promiseSend("when",e,Y))},function(Z){if(T){return}T=true;V.resolve(Y(Z))})});return V.promise}L.spread=c;function c(U,e,T){return C(U,function(V){return e.apply(void 0,V)},T)}L.async=F;function F(e){return function(){var U=function(aa,Y){var X;try{X=V[aa](Y)}catch(Z){if(l(Z)){return Z.value}else{return w(Z)}}return C(X,W,T)};var V=e.apply(this,arguments);var W=U.bind(U,"send");var T=U.bind(U,"throw");return W()}}L.Method=u;function u(e){return function(U){var T=o.call(arguments,1);return y.apply(void 0,[U,e].concat(T))}}L.send=y;function y(U,V){var e=f();var T=o.call(arguments,2);U=v(U);P(function(){U.promiseSend.apply(U,[V,e.resolve].concat(T))});return e.promise}L.get=u("get");L.put=u("put");L.del=u("del");var r=L.post=u("post");L.invoke=function(U,T){var e=o.call(arguments,2);return r(U,T,e)};var R=L.apply=u("apply");var a=L.call=function(U,T){var e=o.call(arguments,2);return R(U,T,e)};L.keys=u("keys");L.all=s;function s(e){return C(e,function(V){var U=V.length;if(U===0){return v(V)}var T=f();m.call(V,function(Y,X,W){C(X,function(Z){V[W]=Z;if(--U===0){T.resolve(V)}}).fail(T.reject)},void 0);return T.promise})}L.fail=h;function h(T,e){return C(T,void 0,e)}L.fin=I;function I(e,T){return C(e,function(U){return C(T(),function(){return U})},function(U){return C(T(),function(){return w(U)})})}L.end=q;function q(e){C(e,void 0,function(T){P(function(){throw T})})}L.timeout=M;function M(U,T){var e=f();C(U,e.resolve,e.reject);setTimeout(function(){e.reject("Timed out")},T);return e.promise}L.delay=B;function B(U,T){if(T===void 0){T=U;U=void 0}var e=f();setTimeout(function(){e.resolve(U)},T);return e.promise}L.node=z;function z(T){if(arguments.length>1){var e=Array.prototype.slice.call(arguments,1);T=T.bind.apply(T,e)}return function(){var U=f();var V=o.call(arguments);V.push(U.node());R(T,this,V).fail(U.reject);return U.promise}}L.ncall=N;function N(U,T){var e=o.call(arguments,2);return z(U).apply(T,e)}});