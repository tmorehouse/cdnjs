/*!
 *
 * Copyright 2007-2009 Tyler Close under the terms of the MIT X license found
 * at http://www.opensource.org/licenses/mit-license.html
 * Forked at ref_send.js version: 2009-05-11
 *
 * Copyright 2009-2011 Kris Kowal under the terms of the MIT
 * license found at http://github.com/kriskowal/q/raw/master/LICENSE
 *
 */
(function(a){if(typeof define==="function"){define(["exports"],a)}else{if(typeof exports==="object"){a(exports)}else{a(Q={})}}})(function(N){var S;if(typeof process!=="undefined"){S=process.nextTick}else{if(typeof msSetImmediate==="function"){S=msSetImmediate}else{if(typeof setImmediate==="function"){S=setImmediate}else{if(typeof MessageChannel!=="undefined"){var D=new MessageChannel();var m={},U=m;D.port1.onmessage=function(){m=m.next;var V=m.task;m.task=null;V()};S=function(V){U=U.next={task:V};D.port2.postMessage(0)}}else{S=function(V){setTimeout(V,0)}}}}}function L(V){return V}function J(X,W,V){if(!X[W]){X[W]=V}return X[W]}var r=J(Object,"freeze",L);var j=J(Object,"create",function(W){function V(){}V.prototype=W;return new V()});var z=J(Object,"keys",function(V){var X=[];for(var W in V){X.push(W)}return X});var o=Array.prototype.reduce||function(Y,X){var V=0,W=this.length;if(arguments.length===1){do{if(V in this){X=this[V++];break}if(++V>=W){throw new TypeError()}}while(1)}for(;V<W;V++){if(V in this){X=Y(X,this[V],V)}}return X};function n(V){return Object.prototype.toString.call(V)==="[object StopIteration]"}var q=Array.prototype.slice;function l(V){if(Object(V)!==V){return V}else{return V.valueOf()}}N.nextTick=S;N.defer=h;function h(){var Z=[],X;var V=j(h.prototype);var Y=j(P.prototype);Y.promiseSend=function(){var aa=q.call(arguments);if(Z){Z.push(aa)}else{S(function(){X.promiseSend.apply(X,aa)})}};Y.valueOf=function(){if(Z){return Y}return X.valueOf()};function W(aa){if(!Z){return}X=w(aa);o.call(Z,function(ac,ab){S(function(){X.promiseSend.apply(X,ab)})},void 0);Z=void 0;return X}V.promise=r(Y);V.resolve=W;V.reject=function(aa){return W(y(aa))};return V}h.prototype.node=function(){var V=this;return function(W,X){if(W){V.reject(W)}else{if(arguments.length>2){V.resolve(Array.prototype.slice.call(arguments,1))}else{V.resolve(X)}}}};N.makePromise=P;function P(X,Z,V,W){if(Z===void 0){Z=function(aa){return y("Promise does not support operation: "+aa)}}var Y=j(P.prototype);Y.promiseSend=function(ae,ab){var ac=q.call(arguments,2);var aa;try{if(X[ae]){aa=X[ae].apply(Y,ac)}else{aa=Z.apply(Y,[ae].concat(ac))}}catch(ad){aa=y(ad)}return(ab||L)(aa)};if(V){Y.valueOf=V}if(W){Y.promiseRejected=true}return r(Y)}P.prototype.then=function(V,W){return C(this,V,W)};o.call(["isResolved","isFulfilled","isRejected","when","spread","send","get","put","del","post","invoke","keys","apply","call","bind","all","allResolved","view","viewInfo","timeout","delay","catch","finally","fail","fin","end"],function(W,V){P.prototype[V]=function(){return N[V].apply(N,[this].concat(q.call(arguments)))}},void 0);P.prototype.toSource=function(){return this.toString()};P.prototype.toString=function(){return"[object Promise]"};r(P.prototype);N.isPromise=v;function v(V){return V&&typeof V.promiseSend==="function"}N.isResolved=f;function f(V){return E(V)||I(V)}N.isFulfilled=E;function E(V){return !v(l(V))}N.isRejected=I;function I(V){V=l(V);return V&&!!V.promiseRejected}var H=[];var x=[];if(typeof window!=="undefined"){console.log("Should be empty:",x)}N.reject=y;function y(X){var W=P({when:function(aa){if(aa){var Z=H.indexOf(this);if(Z!==-1){x.splice(Z,1);H.splice(Z,1)}}return aa?aa(X):y(X)}},function Y(Z){return y(X)},function V(){return y(X)},true);H.push(W);x.push(X);return W}N.resolve=w;N.ref=w;function w(X){if(v(X)){return X}if(X&&typeof X.then==="function"){var W=h();X.then(W.resolve,W.reject);return W.promise}return P({when:function(Y){return X},get:function(Y){return X[Y]},put:function(Y,Z){return X[Y]=Z},del:function(Y){return delete X[Y]},post:function(Y,Z){return X[Y].apply(X,Z)},apply:function(Y,Z){return X.apply(Y,Z)},viewInfo:function(){var Y=X;var Z={};function aa(ab){if(!Z[ab]){Z[ab]=typeof Y[ab]}}while(Y){Object.getOwnPropertyNames(Y).forEach(aa);Y=Object.getPrototypeOf(Y)}return{type:typeof X,properties:Z}},keys:function(){return z(X)}},void 0,function V(){return X})}N.master=p;function p(V){return P({isDef:function(){}},function W(Y){var X=q.call(arguments);return A.apply(void 0,[V].concat(X))},function(){return l(V)})}N.viewInfo=M;function M(V,W){V=w(V);if(W){return P({viewInfo:function(){return W}},function X(Z){var Y=q.call(arguments);return A.apply(void 0,[V].concat(Y))},function(){return l(V)})}else{return A(V,"viewInfo")}}N.view=c;function c(V){return M(V).when(function(Y){var W;if(Y.type==="function"){W=function(){return T(V,void 0,arguments)}}else{W={}}var X=Y.properties||{};Object.keys(X).forEach(function(Z){if(X[Z]==="function"){W[Z]=function(){return t(V,Z,arguments)}}});return w(W)})}N.when=C;function C(aa,X,Z){var Y=h();var W=false;function V(ad){try{return X?X(ad):ad}catch(ac){return y(ac)}}function ab(ad){try{return Z?Z(ad):y(ad)}catch(ac){return y(ac)}}S(function(){w(aa).promiseSend("when",function(ac){if(W){return}W=true;Y.resolve(w(ac).promiseSend("when",V,ab))},function(ac){if(W){return}W=true;Y.resolve(ab(ac))})});return Y.promise}N.spread=e;function e(X,V,W){return C(X,function(Y){return V.apply(void 0,Y)},W)}N.async=G;function G(V){return function(){function X(ad,ab){var aa;try{aa=Y[ad](ab)}catch(ac){if(n(ac)){return ac.value}else{return y(ac)}}return C(aa,Z,W)}var Y=V.apply(this,arguments);var Z=X.bind(X,"send");var W=X.bind(X,"throw");return Z()}}N.sender=i;N.Method=i;function i(V){return function(X){var W=q.call(arguments,1);return A.apply(void 0,[X,V].concat(W))}}N.send=A;function A(X,Y){var V=h();var W=q.call(arguments,2);X=w(X);S(function(){X.promiseSend.apply(X,[Y,V.resolve].concat(W))});return V.promise}N.get=i("get");N.put=i("put");N.del=N["delete"]=i("del");var t=N.post=i("post");N.invoke=function(X,W){var V=q.call(arguments,2);return t(X,W,V)};var T=N.apply=i("apply");N.call=N["try"]=b;function b(X,W){var V=q.call(arguments,2);return T(X,W,V)}N.bind=g;function g(Y,W){var V=q.call(arguments,2);return function X(){var ab=V.concat(q.call(arguments));if(this instanceof X){var ac=function(){};ac.prototype=Y.prototype;var aa=new ac();var Z=T(Y,aa,ab);return Z.then(function(ad){if(Object(ad)===ad){return ad}return aa})}else{return T(Y,W,ab)}}}N.keys=i("keys");N.all=u;function u(V){return C(V,function(Y){var X=Y.length;if(X===0){return w(Y)}var W=h();o.call(Y,function(ab,aa,Z){C(aa,function(ac){Y[Z]=ac;if(--X===0){W.resolve(Y)}}).fail(W.reject)},void 0);return W.promise})}N.allResolved=d;function d(V){return C(V,function(W){return C(u(W.map(function(X){return C(X,L,L)})),function(){return W.map(w)})})}N["catch"]=N.fail=k;function k(W,V){return C(W,void 0,V)}N["finally"]=N.fin=K;function K(V,W){return C(V,function(X){return C(W(),function(){return X})},function(X){return C(W(),function(){return y(X)})})}N.end=s;function s(V){C(V,void 0,function(W){S(function(){throw W})})}N.timeout=O;function O(X,W){var V=h();C(X,V.resolve,V.reject);setTimeout(function(){V.reject("Timed out")},W);return V.promise}N.delay=B;function B(X,W){if(W===void 0){W=X;X=void 0}var V=h();setTimeout(function(){V.resolve(X)},W);return V.promise}N.nbind=a;N.node=a;function a(W){if(arguments.length>1){var V=Array.prototype.slice.call(arguments,1);W=W.bind.apply(W,V)}return function(){var X=h();var Y=q.call(arguments);Y.push(X.node());T(W,this,Y).fail(X.reject);return X.promise}}N.napply=F;function F(X,W,V){return a(X).apply(W,V)}N.ncall=R;function R(X,W){var V=q.call(arguments,2);return F(X,W,V)}});