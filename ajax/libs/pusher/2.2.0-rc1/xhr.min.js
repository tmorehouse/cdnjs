/*!
 * Pusher JavaScript Library v2.2.0-rc1
 * http://pusherapp.com/
 *
 * Copyright 2013, Pusher
 * Released under the MIT licence.
 */

(function(){function c(b,a,c){Pusher.EventsDispatcher.call(this);this.hooks=b;this.method=a;this.url=c}var a=c.prototype;Pusher.Util.extend(a,Pusher.EventsDispatcher.prototype);a.start=function(a){var e=this;e.position=0;e.xhr=e.hooks.getRequest(e);e.unloader=function(){e.close()};Pusher.Util.addWindowListener("unload",e.unloader);e.xhr.open(e.method,e.url,!0);e.xhr.send(a)};a.close=function(){if(this.unloader)Pusher.Util.removeWindowListener("unload",this.unloader),this.unloader=null;if(this.xhr)this.hooks.abortRequest(this.xhr),
this.xhr=null};a.onChunk=function(a,e){for(;;){var c=this.advanceBuffer(e);if(c)this.emit("chunk",{status:a,data:c});else break}this.isBufferTooLong(e)&&this.emit("buffer_too_long")};a.advanceBuffer=function(a){var a=a.slice(this.position),e=a.indexOf("\n");return e!==-1?(this.position+=e+1,a.slice(0,e)):null};a.isBufferTooLong=function(a){return this.position===a.length&&a.length>262144};Pusher.HTTP.Request=c}).call(this);
(function(){var c={getRequest:function(a){var b=new window.XMLHttpRequest;b.onreadystatechange=b.onprogress=function(){switch(b.readyState){case 3:if(b.responseText&&b.responseText.length>0)a.onChunk(b.status,b.responseText);break;case 4:if(b.responseText&&b.responseText.length>0)a.onChunk(b.status,b.responseText);a.emit("finished",b.status);a.close()}};return b},abortRequest:function(a){a.onreadystatechange=null;a.abort()}};Pusher.HTTP.getXHR=function(a,b){return new Pusher.HTTP.Request(c,a,b)}}).call(this);
(function(){function c(d,a){this.hooks=d;var b=Math.floor(Math.random()*1E3)+"/",c;c=[];for(var f=0;f<8;f++)c.push(Math.floor(Math.random()*32).toString(32));c=c.join("");this.session=b+c;b=/([^\?]*)\/*(\??.*)/.exec(a);this.location={base:b[1],queryString:b[2]};this.readyState=e;this.openStream()}function a(d){var a=d.indexOf("?")===-1?"?":"&";return d+a+"t="+ +new Date+"&n="+g++}function b(d,a){if(Pusher.Util.isXHRSupported())return Pusher.HTTP.getXHR(d,a);else if(Pusher.Util.isXDRSupported(a.indexOf("https:")===
0))return Pusher.HTTP.getXDR(d,a);else throw new "Cross-origin HTTP requests are not supported";}var e=0,g=1,f=c.prototype;f.send=function(d){return this.sendRaw(JSON.stringify([d]))};f.close=function(d,a){this.onClose(d,a,!0)};f.sendRaw=function(d){if(this.readyState===1)try{return b("POST",a(this.location.base+"/"+this.session+"/xhr_send")).start(d),!0}catch(c){return!1}else return!1};f.reconnect=function(){this.closeStream();this.openStream()};f.onClose=function(a,b,c){this.stopActivityCheck();
this.closeStream();this.readyState=3;if(this.onclose)this.onclose({code:a,reason:b,wasClean:c})};f.onChunk=function(a){if(a.status===200)switch(this.readyState===1&&this.resetActivityCheck(),a.data.slice(0,1)){case "o":a=JSON.parse(a.data.slice(1)||"{}");this.onOpen(a);break;case "a":for(var a=JSON.parse(a.data.slice(1)||"[]"),b=0;b<a.length;b++)this.onEvent(a[b]);break;case "m":a=JSON.parse(a.data.slice(1)||"null");this.onEvent(a);break;case "h":this.hooks.onHeartbeat(this);break;case "c":a=JSON.parse(a.data.slice(1)||
"[]"),this.onClose(a[0],a[1],!0)}};f.onOpen=function(a){if(this.readyState===e){if(a&&a.hostname){var b=this.location,a=a.hostname,c=/(https?:\/\/)([^\/:]+)((\/|:)?.*)/.exec(this.location.base);b.base=c[1]+a+c[3]}this.resetActivityCheck();this.readyState=1;if(this.onopen)this.onopen()}else this.onClose(1006,"Server lost session",!0)};f.onEvent=function(a){if(this.readyState===1&&this.onmessage)this.onmessage({data:a})};f.onError=function(a){if(this.onerror)this.onerror(a)};f.openStream=function(){var d=
this;d.stream=b("POST",a(d.hooks.getReceiveURL(d.location,d.session)));d.stream.bind("chunk",function(a){d.onChunk(a)});d.stream.bind("finished",function(a){d.hooks.onFinished(d,a)});d.stream.bind("buffer_too_long",function(){d.reconnect()});try{d.stream.start()}catch(c){Pusher.Util.defer(function(){d.onError(c);d.onClose(1006,"Could not start streaming",!1)})}};f.closeStream=function(){if(this.stream)this.stream.unbind_all(),this.stream.close(),this.stream=null};f.resetActivityCheck=function(){var a=
this;a.stopActivityCheck();a.activityTimer=new Pusher.Timer(3E4,function(){a.hooks.sendHeartbeat(a);a.activityTimer=new Pusher.Timer(15E3,function(){a.onClose(1006,"Did not receive a heartbeat response",!1)})})};f.stopActivityCheck=function(){if(this.activityTimer)this.activityTimer.ensureAborted(),this.activityTimer=null};Pusher.HTTP.Socket=c}).call(this);
(function(){var c={getReceiveURL:function(a,b){return a.base+"/"+b+"/xhr_streaming"+a.queryString},onHeartbeat:function(a){a.sendRaw("[]")},sendHeartbeat:function(a){a.sendRaw("h")},onFinished:function(a,b){a.onClose(1006,"Connection interrupted ("+b+")",!1)}};Pusher.HTTP.getStreamingSocket=function(a){return new Pusher.HTTP.Socket(c,a)}}).call(this);
(function(){var c={getReceiveURL:function(a,b){return a.base+"/"+b+"/xhr"+a.queryString},onHeartbeat:function(){},sendHeartbeat:function(a){a.sendRaw("h")},onFinished:function(a,b){if(b===200)a.reconnect();else a.onClose(1006,"Connection interrupted ("+b+")",!1)}};Pusher.HTTP.getPollingSocket=function(a){return new Pusher.HTTP.Socket(c,a)}}).call(this);
