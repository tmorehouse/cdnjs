(function(d){var a=false;if(typeof process!=="undefined"){a=true;var c=require("request")}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(h,g){if(g===null){g=0}else{if(g<0){g=Math.max(0,this.length+g)}}for(var f=g,e=this.length;f<e;f++){if(this[f]===h){return f}}return -1}}var b=function(e){if(!this||!(this instanceof b)){return new b(e)}if(typeof(e)==="string"){e={key:e}}this.callback=e.callback;this.wanted=e.wanted||[];this.key=e.key;this.simpleSheet=!!e.simpleSheet;this.parseNumbers=!!e.parseNumbers;this.wait=!!e.wait;this.postProcess=e.postProcess;this.debug=!!e.debug;this.query=e.query||"";this.endpoint=e.endpoint||"https://spreadsheets.google.com";this.singleton=!!e.singleton;this.simple_url=!!e.simple_url;this.callbackContext=e.callbackContext;if(typeof(e.proxy)!=="undefined"){this.endpoint=e.proxy;this.simple_url=true;this.singleton=true}this.parameterize=e.parameterize||false;if(this.singleton){if(typeof(b.singleton)!=="undefined"){this.log("WARNING! Tabletop singleton already defined")}b.singleton=this}if(/key=/.test(this.key)){this.log("You passed a key as a URL! Attempting to parse.");this.key=this.key.match("key=(.*?)&")[1]}if(!this.key){this.log("You need to pass Tabletop a key!");return}this.log("Initializing with key "+this.key);this.models={};this.model_names=[];this.base_json_path="/feeds/worksheets/"+this.key+"/public/basic?alt=";if(a){this.base_json_path+="json"}else{this.base_json_path+="json-in-script"}if(!this.wait){this.fetch()}};b.callbacks={};b.init=function(e){return new b(e)};b.sheets=function(){this.log("Times have changed! You'll want to use var tabletop = Tabletop.init(...); tabletop.sheets(...); instead of Tabletop.sheets(...)")};b.prototype={fetch:function(e){if(typeof(e)!=="undefined"){this.callback=e}this.requestData(this.base_json_path,this.loadSheets)},requestData:function(e,f){if(a){this.serverSideFetch(e,f)}else{this.injectScript(e,f)}},injectScript:function(i,j){var f=document.createElement("script");var h;if(this.singleton){if(j===this.loadSheets){h="Tabletop.singleton.loadSheets"}else{if(j===this.loadSheet){h="Tabletop.singleton.loadSheet"}}}else{var e=this;h="tt"+(+new Date())+(Math.floor(Math.random()*100000));b.callbacks[h]=function(){var k=Array.prototype.slice.call(arguments,0);j.apply(e,k);f.parentNode.removeChild(f);delete b.callbacks[h]};h="Tabletop.callbacks."+h}var g=i+"&callback="+h;if(this.simple_url){if(i.indexOf("/list/")!==-1){f.src=this.endpoint+"/"+this.key+"-"+i.split("/")[4]}else{f.src=this.endpoint+"/"+this.key}}else{f.src=this.endpoint+g}if(this.parameterize){f.src=this.parameterize+encodeURIComponent(f.src)}document.getElementsByTagName("script")[0].parentNode.appendChild(f)},serverSideFetch:function(f,g){var e=this;c({url:this.endpoint+f,json:true},function(i,j,h){if(i){return console.error(i)}g.call(e,h)})},isWanted:function(e){if(this.wanted.length===0){return true}else{return this.wanted.indexOf(e)!==-1}},data:function(){if(this.model_names.length===0){return undefined}if(this.simpleSheet){if(this.model_names.length>1&&this.debug){this.log("WARNING You have more than one sheet but are using simple sheet mode! Don't blame me when something goes wrong.")}return this.models[this.model_names[0]].all()}else{return this.models}},addWanted:function(e){if(this.wanted.indexOf(e)===-1){this.wanted.push(e)}},loadSheets:function(j){var f,e;var h=[];this.foundSheetNames=[];for(f=0,e=j.feed.entry.length;f<e;f++){this.foundSheetNames.push(j.feed.entry[f].title.$t);if(this.isWanted(j.feed.entry[f].content.$t)){var g=j.feed.entry[f].link[3].href.substr(j.feed.entry[f].link[3].href.length-3,3);var k="/feeds/list/"+this.key+"/"+g+"/public/values?sq="+this.query+"&alt=";if(a){k+="json"}else{k+="json-in-script"}h.push(k)}}this.sheetsToLoad=h.length;for(f=0,e=h.length;f<e;f++){this.requestData(h[f],this.loadSheet)}},sheets:function(e){if(typeof e==="undefined"){return this.models}else{if(typeof(this.models[e])==="undefined"){return}else{return this.models[e]}}},loadSheet:function(f){var e=new b.Model({data:f,parseNumbers:this.parseNumbers,postProcess:this.postProcess,tabletop:this});this.models[e.name]=e;if(this.model_names.indexOf(e.name)===-1){this.model_names.push(e.name)}this.sheetsToLoad--;if(this.sheetsToLoad===0){this.doCallback()}},doCallback:function(){if(this.sheetsToLoad===0){this.callback.apply(this.callbackContext||this,[this.data(),this])}},log:function(e){if(this.debug){if(typeof console!=="undefined"&&typeof console.log!=="undefined"){Function.prototype.apply.apply(console.log,[console,arguments])}}}};b.Model=function(o){var h,g,f,n;this.column_names=[];this.name=o.data.feed.title.$t;this.elements=[];this.raw=o.data;if(typeof(o.data.feed.entry)==="undefined"){o.tabletop.log("Missing data for "+this.name+", make sure you didn't forget column headers");this.elements=[];return}for(var m in o.data.feed.entry[0]){if(/^gsx/.test(m)){this.column_names.push(m.replace("gsx$",""))}}for(h=0,f=o.data.feed.entry.length;h<f;h++){var e=o.data.feed.entry[h];var k={};for(var g=0,n=this.column_names.length;g<n;g++){var l=e["gsx$"+this.column_names[g]];if(typeof(l)!=="undefined"){if(o.parseNumbers&&l.$t!==""&&!isNaN(l.$t)){k[this.column_names[g]]=+l.$t}else{k[this.column_names[g]]=l.$t}}else{k[this.column_names[g]]=""}}if(k.rowNumber===undefined){k.rowNumber=h+1}if(o.postProcess){o.postProcess(k)}this.elements.push(k)}};b.Model.prototype={all:function(){return this.elements},toArray:function(){var l=[],h,f,g,e;for(h=0,g=this.elements.length;h<g;h++){var k=[];for(f=0,e=this.column_names.length;f<e;f++){k.push(this.elements[h][this.column_names[f]])}l.push(k)}return l}};if(a){module.exports=b}else{d.Tabletop=b}})(this);