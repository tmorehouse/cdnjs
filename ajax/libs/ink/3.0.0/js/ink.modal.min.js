Ink.createModule("Ink.UI.Modal","1",["Ink.UI.Common_1","Ink.Dom.Event_1","Ink.Dom.Css_1","Ink.Dom.Element_1","Ink.Dom.Selector_1","Ink.Util.Array_1"],function(t,e,i,s,o,n){"use strict";function h(t){var e=t.match(/^./)[0];return e.toUpperCase()+t.replace(/^./,"")}function a(t){return"max"+h(t)}var l=function(t){return t.style.opacity="invalid","invalid"!==t.style.opacity}(s.create("div",{style:"opacity: 1"})),d=[],r=function(n,h){if(this._element=n?t.elOrSelector(n,"Ink.UI.Modal markup"):null,this._options={width:void 0,height:void 0,shadeClass:void 0,modalClass:void 0,trigger:void 0,triggerEvent:"click",autoDisplay:!0,markup:void 0,onShow:void 0,onDismiss:void 0,closeOnClick:!1,closeOnEscape:!0,responsive:!0,disableScroll:!0},this._handlers={click:Ink.bindEvent(this._onShadeClick,this),keyDown:Ink.bindEvent(this._onKeyDown,this),resize:Ink.bindEvent(this._onResize,this)},this._wasDismissed=!1,this._markupMode=this._element?i.hasClassName(this._element,"ink-modal"):!1,this._markupMode){if(this._modalDiv=this._element,this._modalDivStyle=this._modalDiv.style,this._modalShadow=this._modalDiv.parentNode,this._modalShadowStyle=this._modalShadow.style,this._contentContainer=o.select(".modal-body",this._modalDiv)[0],!this._contentContainer)throw new Error('Ink.UI.Modal: Missing div with class "modal-body"');this._options.markup=this._contentContainer.innerHTML,this._options=Ink.extendObj(this._options,s.data(this._element))}else this._modalShadow=document.createElement("div"),this._modalShadowStyle=this._modalShadow.style,this._modalDiv=document.createElement("div"),this._modalDivStyle=this._modalDiv.style,this._element&&(this._options.markup=this._element.innerHTML),i.addClassName(this._modalShadow,"ink-shade"),i.addClassName(this._modalDiv,"ink-modal ink-space"),this._modalShadow.appendChild(this._modalDiv),document.body.appendChild(this._modalShadow);if(this._options=Ink.extendObj(this._options,h||{}),this._markupMode||this.setContentMarkup(this._options.markup),"string"==typeof this._options.shadeClass&&i.addClassName(this._modalShadow,this._options.shadeClass),"string"==typeof this._options.modalClass&&i.addClassName(this._modalDiv,this._options.modalClass),"trigger"in this._options&&"undefined"!=typeof this._options.trigger){var a;"string"==typeof this._options.trigger&&(a=o.select(this._options.trigger),e.observeMulti(a,this._options.triggerEvent,Ink.bindEvent(this.open,this)))}else"true"===this._options.autoDisplay.toString()&&this.open()};return r.prototype={_reposition:function(){this._modalDivStyle.marginTop=-s.elementHeight(this._modalDiv)/2+"px",this._modalDivStyle.marginLeft=-s.elementWidth(this._modalDiv)/2+"px"},_onResize:function(t){"boolean"==typeof t?this._timeoutResizeFunction.call(this):!this._resizeTimeout&&t&&"object"==typeof t&&(this._resizeTimeout=setTimeout(Ink.bind(this._timeoutResizeFunction,this),250))},_timeoutResizeFunction:function(){var t={width:-1!==(""+this._options.width).indexOf("%"),height:-1!==(""+this._options.height).indexOf("%")},e={height:s.viewportHeight(),width:s.viewportWidth()};n.forEach(["height","width"],Ink.bind(function(i){t[i]||(this._modalDivStyle[i]=e[i]>this.originalStatus[i]?this._modalDivStyle[a(i)]:Math.round(.9*e[i])+"px")},this)),this._resizeContainer(),this._reposition(),this._resizeTimeout=void 0},_onShadeClick:function(t){var n=e.element(t);if(i.hasClassName(n,"ink-close")||i.hasClassName(n,"ink-dismiss")||s.findUpwardsBySelector(n,".ink-close,.ink-dismiss")||this._options.closeOnClick&&(!s.descendantOf(this._shadeElement,n)||n===this._shadeElement)){for(var h=o.select(".ink-alert",this._shadeElement),a=h.length,l=0;a>l;l++)if(s.descendantOf(h[l],n))return;this.dismiss(),this._wasDismissed&&e.stop(t)}},_onKeyDown:function(t){27!==t.keyCode||this._wasDismissed||"true"===this._options.closeOnEscape.toString()&&d[d.length-1]===this&&(this.dismiss(),this._wasDismissed&&e.stop(t))},_resizeContainer:function(){this._contentElement.style.overflow=this._contentElement.style.overflowX=this._contentElement.style.overflowY="hidden";var t=s.elementHeight(this._modalDiv);this._modalHeader=o.select(".modal-header",this._modalDiv)[0],this._modalHeader&&(t-=s.elementHeight(this._modalHeader)),this._modalFooter=o.select(".modal-footer",this._modalDiv)[0],this._modalFooter&&(t-=s.elementHeight(this._modalFooter)),this._contentContainer.style.height=t+"px",t!==s.elementHeight(this._contentContainer)&&(this._contentContainer.style.height=~~(t-(s.elementHeight(this._contentContainer)-t))+"px"),this._markupMode||(this._contentContainer.style.overflow=this._contentContainer.style.overflowX="hidden",this._contentContainer.style.overflowY="auto",this._contentElement.style.overflow=this._contentElement.style.overflowX=this._contentElement.style.overflowY="visible")},_disableScroll:function(){var t=document.documentElement;this._oldHtmlOverflows=[t.style.overflowX,t.style.overflowY],t.style.overflowX=t.style.overflowY="hidden"},open:function(o){o&&e.stop(o);var l="CSS1Compat"===document.compatMode?document.documentElement:document.body;this._resizeTimeout=null,i.addClassName(this._modalShadow,"ink-shade"),this._modalShadowStyle.display=this._modalDivStyle.display="block",setTimeout(Ink.bind(function(){i.addClassName(this._modalShadow,"visible"),i.addClassName(this._modalDiv,"visible")},this),100),this._contentElement=this._modalDiv,this._shadeElement=this._modalShadow,this._markupMode||this.setContentMarkup(this._options.markup);var r={width:-1!==(""+this._options.width).indexOf("%"),height:-1!==(""+this._options.height).indexOf("%")};n.forEach(["width","height"],Ink.bind(function(t){void 0!==this._options[t]?(this._modalDivStyle[t]=this._options[t],r[t]||(this._modalDivStyle[a(t)]=s["element"+h(t)](this._modalDiv)+"px")):this._modalDivStyle[a(t)]=s["element"+h(t)](this._modalDiv)+"px",r[t]&&parseInt(l["client"+a(t)],10)<=parseInt(this._modalDivStyle[t],10)&&(this._modalDivStyle[t]=Math.round(.9*parseInt(l["client"+a(t)],10))+"px")},this)),this.originalStatus={viewportHeight:s.elementHeight(l),viewportWidth:s.elementWidth(l),height:s.elementHeight(this._modalDiv),width:s.elementWidth(this._modalDiv)},"true"===this._options.responsive.toString()?(this._onResize(!0),e.observe(window,"resize",this._handlers.resize)):(this._resizeContainer(),this._reposition()),this._options.onShow&&this._options.onShow(this),"true"===this._options.disableScroll.toString()&&this._disableScroll(),e.observe(this._shadeElement,"click",this._handlers.click),"true"===this._options.closeOnEscape.toString()&&e.observe(document,"keydown",this._handlers.keyDown),t.registerInstance(this,this._shadeElement,"modal"),this._wasDismissed=!1,d.push(this),i.addClassName(document.documentElement,"ink-modal-is-open")},dismiss:function(){if(!this._wasDismissed){if(this._options.onDismiss){var t=this._options.onDismiss(this);if(t===!1)return}if(this._wasDismissed=!0,this._options.responsive&&e.stopObserving(window,"resize",this._handlers.resize),this._markupMode?(i.removeClassName(this._modalDiv,"visible"),i.removeClassName(this._modalShadow,"visible"),this._waitForFade(this._modalShadow,Ink.bind(function(){this._modalShadowStyle.display="none"},this))):(this._modalShadow.parentNode.removeChild(this._modalShadow),this.destroy()),d=n.remove(d,n.keyValue(this,d),1),0===d.length){var s=document.documentElement;this._options.disableScroll&&(s.style.overflowX=this._oldHtmlOverflows[0],s.style.overflowY=this._oldHtmlOverflows[1]),i.removeClassName(s,"ink-modal-is-open")}}},_waitForFade:function(t,s){if(!l)return s();for(var o,n,h=["transitionEnd","oTransitionEnd","webkitTransitionEnd"],a=0,d=h.length;d>a;a++)if(n=h[a],o="on"+n.toLowerCase(),o in t)return void e.observeOnce(t,n,s);var r=function(){+i.getStyle(t,"opacity")>0?setTimeout(r,250):s()};setTimeout(r,500)},destroy:function(){t.unregisterInstance(this._instanceId)},getContentElement:function(){return this._contentContainer},setContentMarkup:function(t){if(this._markupMode)this._contentContainer.innerHTML=t;else{if(this._modalDiv.innerHTML=[t].join(""),this._contentContainer=o.select(".modal-body",this._modalDiv),!this._contentContainer.length){var e=o.select(".modal-header",this._modalDiv),h=o.select(".modal-footer",this._modalDiv);n.each(e,s.remove),n.each(h,s.remove);var a=document.createElement("div");i.addClassName(a,"modal-body"),a.innerHTML=this._modalDiv.innerHTML,this._modalDiv.innerHTML="";var l=e.concat([a]).concat(h);n.each(l,Ink.bindMethod(this._modalDiv,"appendChild")),this._contentContainer=o.select(".modal-body",this._modalDiv)}this._contentContainer=this._contentContainer[0]}this._contentElement=this._modalDiv,this._resizeContainer()}},r});