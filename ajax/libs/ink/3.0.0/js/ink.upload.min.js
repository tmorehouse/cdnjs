Ink.createModule("Ink.UI.Upload","1",["Ink.Dom.Event_1","Ink.Dom.Element_1","Ink.Dom.Browser_1","Ink.UI.Common_1"],function(t,e,i,n){"use strict";var s=function(t){this.init(t)};s.prototype={init:function(t){this.options=Ink.extendObj({entry:void 0,maxDepth:10},t||{});try{this._read()}catch(e){Ink.error(e)}},_read:function(){if(!this.options.entry)throw"The entry specify you must";try{this._readDirectories()}catch(t){Ink.error(t)}},_readDirectories:function(){var t=[],e=!1,i=0,n=Ink.bind(function(s){var o=s.createReader();e=!0,o.readEntries(Ink.bind(function(s){if(s.length>0){for(var o=0,r=s.length;r>o;o++)t.push(s[o]),s[o].isDirectory&&(i=this.clearArray(s[o].fullPath.split("/")),i.shift(),i=i.length,i<=this.options.maxDepth&&n(s[o]));this._stopActivityTimeout&&clearTimeout(this._stopActivityTimeout),this._stopActivityTimeout=setTimeout(function(){e=!1},250)}s.length||(e=!1)},this),Ink.bind(function(t){this.options.readError(t,s)},this))},this);n(this.options.entry);var s,o=function(){return e?!1:(clearInterval(s),this.options.readComplete&&"function"==typeof this.options.readComplete&&this.options.readComplete(t),!0)};s=setInterval(Ink.bind(o,this),250)},clearArray:function(t){for(var e=t.length-1;e>=0;e--)("undefined"==typeof t[e]||null===t[e]||""===t[e])&&t.splice(e,1);return t}};var o={lists:[],items:[],create:function(t){var e;return t=String(t),this.lists.push({name:t}),e=this.lists.length-1},getItems:function(t){if(!t)return this.items;for(var e=[],i=0,n=this.items.length;n>i;i++)this.items[i].parentId===t&&e.push(this.items[i]);return e},purge:function(t,e){if("number"!=typeof t||isNaN(Number(t)))return!1;try{for(var i=this.items.length;i>=0;i--)this.items[i]&&t===this.items[i].parentId&&this.remove(this.items[i].parentId,this.items[i].pid);return e||this.lists.splice(t,1),!0}catch(n){return Ink.error("Purge: invalid id"),!1}},add:function(t,e,i){if(!this.lists[t])return!1;"object"!=typeof e&&(e=String(e));var n=parseInt(Math.round(1e5*Math.random())+""+Math.round(1e5*Math.random()),10);return i=i||0,this.items.push({parentId:t,item:e,priority:i||0,pid:n}),n},view:function(t,e){var i=this._searchByPid(t,e);return i===!1?!1:this.items[i]},remove:function(t,e){try{var i=this._searchByPid(t,e);return i===!1?!1:(this.items.splice(i,1),!0)}catch(n){return Ink.error("Remove: invalid id"),!1}},_searchByPid:function(t,e){if(!t&&"boolean"==typeof t||!e)return!1;if(t=parseInt(t,10),e=parseInt(e,10),isNaN(t)||isNaN(e))return!1;for(var i=0,n=this.items.length;n>i;i++)if(this.items[i].parentId===t&&this.items[i].pid===e)return i;return!1}},r=function(t){this.Upload=t,this.init()};r.prototype={init:function(){this._fileButton=this.Upload.options.fileButton,this._dropzone=this.Upload.options.dropzone,this._setDropEvent(),this._setFileButton()},_setDropEvent:function(){for(var t=this._dropzone,e=0,i=t.length;i>e;e++)t[e].ondrop=Ink.bindEvent(this.Upload._dropEventHandler,this.Upload),t[e].ondragleave=Ink.bindEvent(this._onDragLeave,this),t[e].ondragend=Ink.bindEvent(this._onDragEndEventHandler,this),t[e].ondragenter=Ink.bindEvent(this._onDragEnterHandler,this),t[e].ondragover=Ink.bindEvent(this._onDragOverHandler,this)},_onDragEnterHandler:function(t){return t&&t.stopPropagation&&t.stopPropagation(),t&&t.preventDefault&&t.preventDefault(),t&&(t.returnValue=!1),this.Upload.publish("DragEnter",t),!1},_onDragOverHandler:function(t){return t?(t.preventDefault(),t.stopPropagation(),t.returnValue=!1,!0):!1},_onDragLeave:function(t){return this.Upload.publish("DragLeave",t)},_onDragEndEventHandler:function(t){return this.Upload.publish("DragEnd",t)},_setFileButton:function(){var e=this._fileButton;t.observeMulti(e,"change",Ink.bindEvent(this._fileChangeHandler,this))},_fileChangeHandler:function(i){var n=t.element(i),s=n.files,o=e.findUpwardsByTag(n,"form");return s&&window.FormData&&"withCredentials"in new XMLHttpRequest?(this.Upload._addFilesToQueue(s),void(n.value="")):(o.parentNode.submit(),!1)}};var a=function(t){this.Queue=o,this.init(t),this._events={}};return a.prototype={init:function(t){if("string"==typeof t&&(t=e.data(n.elOrSelector(t,"1st argument"))),this.options=Ink.extendObj({extraData:{},fileFormName:"Ink_Filelist",dropzone:void 0,fileButton:void 0,endpoint:"",endpointChunk:"",endpointChunkCommit:"",maxFilesize:300<<20,chunkSize:4194304,minSizeToUseChunks:20971520,INVALID_FILE_NAME:void 0,foldersEnabled:!0,useChunks:!0,directoryMaxDepth:10},t||{}),this._queueId=o.create("Ink_UPLOAD"),this._queueRunning=!1,this._folders={},this.options.dropzone&&n.elOrSelector(this.options.dropzone,"Upload - dropzone"),this.options.fileButton&&n.elOrSelector(this.options.fileButton,"Upload - fileButton"),!this.options.dropzone&&!this.options.fileButton)throw new TypeError("A file button or dropzone, specify you must, my young padawan");this.options.dropzone=Ink.ss(this.options.dropzone),this.options.fileButton=Ink.ss(this.options.fileButton),new r(this)},_supportChunks:function(t){return this.options.useChunks&&"Blob"in window&&(new Blob).slice&&t>this.options.minSizeToUseChunks},_dropEventHandler:function(t){t&&t.stopPropagation&&t.stopPropagation(),t&&t.preventDefault&&t.preventDefault(),t&&(t.returnValue=!1),this.publish("DropComplete",t.dataTransfer);var e=t.dataTransfer;if(!e||!e.files||!e.files.length)return!1;if(this._files=e.files,this._files=Array.prototype.slice.call(this._files||[],0),e.items&&e.items[0]&&e.items[0].webkitGetAsEntry){if(!this.options.foldersEnabled)return setTimeout(Ink.bind(this._addFilesToQueue,this,this._files),0);for(var i,n=[],s=t.dataTransfer.items.length-1;s>=0;s--)i=t.dataTransfer.items[s].webkitGetAsEntry(),i&&i.isDirectory&&(n.push(i),this._files[s].isDirectory=!0,this._files.splice(s,1));this._addFolderToQueue(n,Ink.bind(function(){setTimeout(Ink.bind(this._addFilesToQueue,this,this._files),0)},this))}else setTimeout(Ink.bind(this._addFilesToQueue,this,this._files),0);return!0},_addFolderToQueue:function(t,e){var i=[],n={};if(!t||!t.length)return e(),i;var o=function(t){for(var e=[],i=0,n=t.length;n>i;i++)t[i].isFile&&e.push(t[i]);return e},r=function(t,e){var n;return e=e||0,this._files[e]?"fileentry"!==this._files[e].constructor.name.toLowerCase()?r.apply(this,[t,++e]):void this._files[e].file(Ink.bind(function(i){n=this._files[e].fullPath,this._files[e]=i,this._files[e].hasParent=!0,this._files[e].fullPath||(this._files[e].fullPath=n),r.apply(this,[t,++e])},this),Ink.bind(function(){this._files.splice(e,1),r.apply(this,[t,e])},this)):(t(),i)},a=Ink.bind(function(h){return t[h]?void new s({entry:t[h],maxDepth:this.options.directoryMaxDepth,readComplete:Ink.bind(function(e){if(i=i.concat(o(e)),t[h]&&!(t[h].fullPath in this._folders)){this._folders[t[h].fullPath]={items:e,files:i,length:e.length,created:!1,root:!0};for(var s=0,r=e.length;r>s;s++)e[s].isFile||(e[s].fullPath in n?delete n[e[s].fullPath]:this._folders[e[s].fullPath]={created:!1,root:!1});a(++h)}},this),readError:Ink.bind(function(t,e){n[e.fullPath]={},n[e.fullPath].error=t},this)}):(this._files=this._files.concat(i),r.call(this,e),!1)},this);return a(0),i},_addFilesToQueue:function(t){for(var e,n,s,r=0,a=t.length;a>r;r++)e=t[r],e.isDirectory||null!==e&&(e.type||e.size%4096!==0||i.CHROME&&this.options.foldersEnabled)?e.size>this.options.maxFilesize?this.publish("MaxSizeFailure",e,this.options.maxFilesize):(n=parseInt(Math.round(1e5*Math.random())+""+Math.round(1e5*Math.random()),10),s={id:r,data:e,fileID:n,directory:e.isDirectory},o.add(this._queueId,s),this.publish("FileAddedToQueue",s)):this.publish("InvalidFile",e,"size");this._processQueue(!0),this._files=[]},_processQueue:function(t){if(this._queueRunning)return!1;this.running=0;var e,i=1,n=0,s=o.items.length;this._queueRunning=!0,this.interval=setInterval(Ink.bind(function(){if(o.items.length===n&&0===this.running&&(o.purge(this._queueId,!0),this._queueRunning=!1,clearInterval(this.interval),this.publish("QueueEnd",this._queueId,s)),e=o.getItems(this._queueId),this.running<i&&e[n]){if(e[n].canceled)for(var a=n;e[a]&&e[a].canceled;)n++,a++;else r.call(this,e[n].pid,e[n].item.data,e[n].item.fileID,e[n].item.directory,t),this.running++,n++;return!0}return!1},this),100);var r=function(t,e,i,n,s){var o={file:e,fileID:i,cb:Ink.bind(function(){this.running--},this)};s&&(n?o.cb():this._upload(o))};return!0},_upload:function(t){var e=t.file,i=new XMLHttpRequest,n=t.fileID;this.publish("BeforeUpload",e,this.options.extraData,n,i,this._supportChunks(e.size));var s=function(s){t.cb&&t.cb(),this.publish("OnProgress",{length:e.size,lengthComputable:!0,loaded:e.size,total:e.size},e,n),this.publish("EndUpload",e,n,s?{error:!0}:!0),this.publish("InvalidFile",e,"name"),i.abort()};if(this.options.INVALID_FILE_NAME&&this.options.INVALID_FILE_NAME instanceof RegExp&&this.options.INVALID_FILE_NAME.test(t.file.name))return void s.call(this);if(!e.lastModifiedDate&&!Ink.Dom.Browser.OPERA)return void s.call(this,!0);i.upload.onprogress=Ink.bind(this.publish,this,"OnProgress",e,n);var o,r;this._supportChunks(e.size)?e.size<=e.chunk_offset?(o=this.options.endpointChunkCommit,r="POST"):(o=this.options.endpointChunk,e.chunk_upload_id&&(o+="?upload_id="+e.chunk_upload_id),e.chunk_offset&&(o+="&offset="+e.chunk_offset),r="PUT"):(o=this.options.endpoint,r="POST"),i.open(r,o,!0),i.withCredentials=!0,i.setRequestHeader("x-requested-with","XMLHttpRequest"),this._supportChunks(e.size)&&i.setRequestHeader("Content-type","application/x-www-form-urlencoded");var a,h=new FormData;if("Blob"in window&&"function"==typeof Blob?(a=new Blob([e],{type:e.type}),this._supportChunks(e.size)?(e.chunk_offset=e.chunk_offset||0,a=a.slice(e.chunk_offset,e.chunk_offset+this.options.chunkSize)):h.append(this.options.fileFormName,a,e.name)):h.append(this.options.fileFormName,e),this._supportChunks(e.size))h.append("upload_id",e.chunk_upload_id),h.append("path",e.upload_path);else for(var u in this.options.extraData)this.options.extraData.hasOwnProperty(u)&&h.append(u,this.options.extraData[u]);e.hasParent?this.publish("cbCreateFolder",e.parentID,e.fullPath,this.options.extraData,this._folders,e.rootPath,Ink.bind(function(){i.send(this._supportChunks(e.size)?e.size<=e.chunk_offset?"upload_id="+e.chunk_upload_id+"&path="+e.upload_path+"/"+e.name:a:h)},this)):i.send(this._supportChunks(e.size)?e.size<=e.chunk_offset?"upload_id="+e.chunk_upload_id+"&path="+e.upload_path+"/"+e.name:a:h),i.onload=Ink.bindEvent(function(){if(this._supportChunks(e.size)&&e.size>e.chunk_offset){if(i.response){var s=JSON.parse(i.response),o=e.chunk_offset&&s.offset!==e.chunk_offset+this.options.chunkSize&&e.size!==s.offset;o?(t.cb&&t.cb(),this.publish("ErrorUpload",e,n)):(e.chunk_upload_id=s.upload_id,e.chunk_offset=s.offset,e.chunk_expires=s.expires,this._upload(t))}else t.cb&&t.cb(),this.publish("ErrorUpload",e,n);return i=null}return t.cb&&t.cb(),i.responseText&&i.status<400?this.publish("EndUpload",e,n,i.responseText):this.publish("ErrorUpload",e,n),i=null},this),i.onerror=Ink.bindEvent(function(){t.cb&&t.cb(),this.publish("ErrorUpload",e,n)},this),i.onabort=Ink.bindEvent(function(){t.cb&&t.cb(),this.publish("AbortUpload",e,n,{abortAll:Ink.bind(this.abortAll,this),abortOne:Ink.bind(this.abortOne,this)})},this)},abortAll:function(){return this._queueRunning?(clearInterval(this.interval),this._queueRunning=!1,o.purge(this._queueId,!0),!0):!1},abortOne:function(t,e){for(var i,n=o.getItems(0),s=0,r=n.length;r>s;s++)if(n[s].item.fileID===t)return i={id:n[s].item.fileID,name:n[s].item.data.name,size:n[s].item.data.size,hasParent:n[s].item.data.hasParent},o.remove(0,n[s].pid),e&&e(i),!0;return!1},subscribe:function(t,e){return this._events[t]||(this._events[t]=[]),this._events[t].push(e),this._events[t]},publish:function(t){var e=this._events[t],i=Array.prototype.slice.call(arguments||[],0);if(e)for(var n=0,s=e.length;s>n;n++)try{e[n].apply(this,i.splice(1,i.length))}catch(o){Ink.error(t+": "+o)}}},a});