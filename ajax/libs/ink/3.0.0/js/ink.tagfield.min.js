Ink.createModule("Ink.UI.TagField","1",["Ink.Dom.Element_1","Ink.Dom.Event_1","Ink.Dom.Css_1","Ink.Dom.Browser_1","Ink.UI.Droppable_1","Ink.Util.Array_1","Ink.Dom.Selector_1","Ink.UI.Common_1"],function(t,e,i,n,s,a,o,r){"use strict";function h(t,e){this.init(t,e)}var l=13,u=8,_=function(t){return!!t};return h.prototype={init:function(n,s){n=this._element=r.elOrSelector(n,"Ink.UI.TagField");var o=this._options=r.options("Ink.UI.TagField",{tags:["String",[]],tagQuery:["Object",null],tagQueryAsync:["Object",null],allowRepeated:["Boolean",!1],maxTags:["Integer",-1],outSeparator:["String",","],separator:["String",/[,; ]+/g],autoSplit:["Boolean",!0]},s||{},this._element);"string"==typeof o.separator&&(o.separator=new RegExp(o.separator,"g")),"string"==typeof o.tags&&(o.tags=this._readInput(o.tags)),i.addClassName(this._element,"hide-all"),this._viewElm=t.create("div",{className:"ink-tagfield",insertAfter:this._element}),this._input=t.create("input",{type:"text",className:"new-tag-input",insertBottom:this._viewElm});var h=[].concat(o.tags,this._tagsFromMarkup(this._element));this._tags=[],a.each(h,Ink.bindMethod(this,"_addTag")),e.observe(this._input,"keyup",Ink.bindEvent(this._onKeyUp,this)),e.observe(this._input,"change",Ink.bindEvent(this._onKeyUp,this)),e.observe(this._input,"keydown",Ink.bindEvent(this._onKeyDown,this)),e.observe(this._input,"blur",Ink.bindEvent(this._onBlur,this)),e.observe(this._viewElm,"click",Ink.bindEvent(this._refocus,this))},destroy:function(){t.remove(this._viewElm),i.removeClassName(this._element,"hide-all")},_tagsFromMarkup:function(e){var i=e.tagName.toLowerCase();if("input"===i)return this._readInput(e.value);if("select"===i)return a.map(e.getElementsByTagName("option"),function(e){return t.textContent(e)});throw new Error("Cannot read tags from a "+i+" tag. Unknown tag")},_tagsToMarkup:function(e,i){var n=i.tagName.toLowerCase();if("input"===n)this._options.separator&&(i.value=e.join(this._options.outSeparator));else{if("select"!==n)throw new Error("TagField: Cannot read tags from a "+n+" tag. Unknown tag");i.innerHTML="",a.each(e,function(e){var n=t.create("option",{selected:"selected"});t.setTextContent(n,e),i.appendChild(n)})}},_addTag:function(i){if(!(-1!==this._options.maxTags&&this._tags.length>=this._options.maxTags)){if(!this._options.allowRepeated&&a.inArray(i,this._tags,i)||!i)return!1;var n=t.create("span",{className:"ink-tag",setTextContent:i+" "}),s=t.create("span",{className:"remove fa fa-times",insertBottom:n});e.observe(s,"click",Ink.bindEvent(this._removeTag,this,null));var o=document.createTextNode(" ");this._tags.push(i),this._viewElm.insertBefore(n,this._input),this._viewElm.insertBefore(o,this._input),this._tagsToMarkup(this._tags,this._element)}},_readInput:function(t){return this._options.separator?a.filter(t.split(this._options.separator),_):[t]},_onKeyUp:function(){if(this._options.autoSplit){var t=this._input.value.split(this._options.separator);if(!(t.length<=1)){var e=t[t.length-1];t=t.splice(0,t.length-1),t=a.filter(t,_),a.each(t,Ink.bind(this._addTag,this)),this._input.value=e}}},_onKeyDown:function(t){return t.which===l?this._onEnterKeyDown(t):t.which===u?this._onBackspaceKeyDown():void(this._removeConfirm&&this._unsetRemovingVisual(this._tags.length-1))},_onBackspaceKeyDown:function(){this._input.value||(this._removeConfirm?(this._unsetRemovingVisual(this._tags.length-1),this._removeTag(this._tags.length-1),this._removeConfirm=null):this._setRemovingVisual(this._tags.length-1))},_onEnterKeyDown:function(t){var i=this._input.value;i&&(this._addTag(i),this._input.value=""),e.stopDefault(t)},_onBlur:function(){this._addTag(this._input.value),this._input.value=""},_setRemovingVisual:function(t){var n=this._viewElm.children[t];i.addClassName(n,"tag-deleting"),this._removeRemovingVisualTimeout=setTimeout(Ink.bindMethod(this,"_unsetRemovingVisual",t),4e3),e.observe(this._input,"blur",Ink.bindMethod(this,"_unsetRemovingVisual",t)),this._removeConfirm=!0},_unsetRemovingVisual:function(t){var e=this._viewElm.children[t];e&&(i.removeClassName(e,"tag-deleting"),clearTimeout(this._removeRemovingVisualTimeout)),this._removeConfirm=null},_removeTag:function(i){var n;if("object"==typeof i){var s=e.element(i).parentNode;n=t.parentIndexOf(this._viewElm,s)}else"number"==typeof i&&(n=i);this._tags=a.remove(this._tags,n,1),t.remove(this._viewElm.children[n]),this._tagsToMarkup(this._tags,this._element)},_refocus:function(t){return this._input.focus(),e.stop(t),!1}},h});