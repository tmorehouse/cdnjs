Ink.createModule("Ink.UI.DatePicker","1",["Ink.UI.Common_1","Ink.Dom.Event_1","Ink.Dom.Css_1","Ink.Dom.Element_1","Ink.Dom.Selector_1","Ink.Util.Array_1","Ink.Util.Date_1","Ink.Dom.Browser_1"],function(t,e,n,i,a,s,o){"use strict";function r(t,e){for(var n="",i=0;t>i;i++)n+=e;return n}function h(t,e,n){return t>n&&(t=n),e>t&&(t=e),t}function l(t){var e=t.split("-");return _(+e[0],+e[1]-1,+e[2])}function _(t,e,n){return{_year:t,_month:e,_day:n}}function c(t){return{_year:t.getFullYear(),_month:t.getMonth(),_day:t.getDate()}}var d=function(e,n){if(this._element=e&&t.elOrSelector(e,"[Ink.UI.DatePicker_1]: selector argument"),this._options=t.options("Ink.UI.DatePicker_1",{autoOpen:["Boolean",!1],cleanText:["String","Clear"],closeText:["String","Close"],containerElement:["Element",null],cssClass:["String","ink-calendar bottom"],dateRange:["String",null],displayInSelect:["Boolean",!1],dayField:["Element",null],monthField:["Element",null],yearField:["Element",null],format:["String","yyyy-mm-dd"],instance:["String","scdp_"+Math.round(99999*Math.random())],nextLinkText:["String","»"],ofText:["String"," de "],onFocus:["Boolean",!0],onMonthSelected:["Function",null],onSetDate:["Function",null],onYearSelected:["Function",null],position:["String","right"],prevLinkText:["String","«"],showClean:["Boolean",!0],showClose:["Boolean",!0],shy:["Boolean",!0],startDate:["String",null],startWeekDay:["Number",1],validDayFn:["Function",null],validMonthFn:["Function",null],validYearFn:["Function",null],nextValidDateFn:["Function",null],prevValidDateFn:["Function",null],yearRange:["String",null],month:["Object",{1:"January",2:"February",3:"March",4:"April",5:"May",6:"June",7:"July",8:"August",9:"September",10:"October",11:"November",12:"December"}],wDay:["Object",{0:"Sunday",1:"Monday",2:"Tuesday",3:"Wednesday",4:"Thursday",5:"Friday",6:"Saturday"}]},n||{},this._element),this._options.format=this._dateParsers[this._options.format]||this._options.format,this._hoverPicker=!1,this._picker=this._options.pickerField&&t.elOrSelector(this._options.pickerField,"pickerField"),this._setMinMax(this._options.dateRange||this._options.yearRange),this._options.startDate)this.setDate(this._options.startDate);else if(this._element&&this._element.value)this.setDate(this._element.value);else{var i=new Date;this._day=i.getDate(),this._month=i.getMonth(),this._year=i.getFullYear()}if((this._options.startWeekDay<0||this._options.startWeekDay>6)&&(Ink.warn('Ink.UI.DatePicker_1: option "startWeekDay" must be between 0 (sunday) and 6 (saturday)'),this._options.startWeekDay=h(this._options.startWeekDay,0,6)),this._options.displayInSelect&&!(this._options.dayField&&this._options.monthField&&this._options.yearField))throw new Error("Ink.UI.DatePicker: displayInSelect option enabled.Please specify dayField, monthField and yearField selectors.");this._init()};return d.prototype={version:"0.1",_init:function(){Ink.extendObj(this._options,this._lang||{}),this._render(),this._listenToContainerObjectEvents(),t.registerInstance(this,this._containerObject,"datePicker")},_render:function(){this._containerObject=document.createElement("div"),this._containerObject.id=this._options.instance,this._containerObject.className=this._options.cssClass+" ink-datepicker-calendar hide-all",this._renderSuperTopBar();var e=document.createElement("div");e.className="ink-calendar-top",this._monthDescContainer=document.createElement("div"),this._monthDescContainer.className="ink-calendar-month_desc",this._monthPrev=document.createElement("div"),this._monthPrev.className="ink-calendar-prev",this._monthPrev.innerHTML='<a href="#prev" class="change_month_prev">'+this._options.prevLinkText+"</a>",this._monthNext=document.createElement("div"),this._monthNext.className="ink-calendar-next",this._monthNext.innerHTML='<a href="#next" class="change_month_next">'+this._options.nextLinkText+"</a>",e.appendChild(this._monthPrev),e.appendChild(this._monthDescContainer),e.appendChild(this._monthNext),this._monthContainer=document.createElement("div"),this._monthContainer.className="ink-calendar-month",this._containerObject.appendChild(e),this._containerObject.appendChild(this._monthContainer),this._monthSelector=this._renderMonthSelector(),this._containerObject.appendChild(this._monthSelector),this._yearSelector=document.createElement("ul"),this._yearSelector.className="ink-calendar-year-selector",this._containerObject.appendChild(this._yearSelector),(!this._options.onFocus||this._options.displayInSelect)&&(this._options.pickerField?this._picker=t.elOrSelector(this._options.pickerField,"pickerField"):(this._picker=document.createElement("a"),this._picker.href="#open_cal",this._picker.innerHTML="open",this._element.parentNode.appendChild(this._picker),this._picker.className="ink-datepicker-picker-field")),this._appendDatePickerToDom(),this._renderMonth(),this._monthChanger=document.createElement("a"),this._monthChanger.href="#monthchanger",this._monthChanger.className="ink-calendar-link-month",this._monthChanger.innerHTML=this._options.month[this._month+1],this._ofText=document.createElement("span"),this._ofText.innerHTML=this._options.ofText,this._yearChanger=document.createElement("a"),this._yearChanger.href="#yearchanger",this._yearChanger.className="ink-calendar-link-year",this._yearChanger.innerHTML=this._year,this._monthDescContainer.innerHTML="",this._monthDescContainer.appendChild(this._monthChanger),this._monthDescContainer.appendChild(this._ofText),this._monthDescContainer.appendChild(this._yearChanger),this._options.inline?this.show():this._addOpenCloseEvents(),this._addDateChangeHandlersToInputs()},_addDateChangeHandlersToInputs:function(){var t=this._element;this._options.displayInSelect&&(t=[this._options.dayField,this._options.monthField,this._options.yearField]),e.observeMulti(t,"change",Ink.bindEvent(function(){this._updateDate(),this._showDefaultView(),this.setDate(),this._inline||this._hoverPicker||this._hide(!0)},this))},show:function(){this._updateDate(),this._renderMonth(),n.removeClassName(this._containerObject,"hide-all")},_addOpenCloseEvents:function(){var t=this._picker||this._element;e.observe(t,"click",Ink.bindEvent(function(t){e.stop(t),this.show()},this)),this._options.autoOpen&&this.show(),this._options.displayInSelect||e.observe(t,"blur",Ink.bindEvent(function(){this._hoverPicker||this._hide(!0)},this)),this._options.shy&&e.observe(document,"click",Ink.bindEvent(function(t){for(var n=e.element(t),a=[this._options.dayField,this._options.monthField,this._options.yearField,this._picker,this._element],s=0,o=a.length;o>s;s++)if(a[s]&&i.descendantOf(a[s],n))return;this._hide(!0)},this))},_renderMonthSelector:function(){var t=document.createElement("ul");t.className="ink-calendar-month-selector";for(var e=document.createElement("ul"),n=1;12>=n;n++)e.appendChild(this._renderMonthButton(n)),n%4===0&&(t.appendChild(e),e=document.createElement("ul"));return t},_renderMonthButton:function(t){var e=document.createElement("li"),n=document.createElement("a");return n.setAttribute("data-cal-month",t),n.innerHTML=this._options.month[t].substring(0,3),e.appendChild(n),e},_appendDatePickerToDom:function(){if(this._options.containerElement){var e=Ink.i(this._options.containerElement)||t.elOrSelector(this._options.containerElement);e.appendChild(this._containerObject)}i.findUpwardsBySelector(this._element,".ink-form .control-group .control")===this._element.parentNode?(this._wrapper=this._element.parentNode,this._wrapperIsControl=!0):(this._wrapper=i.create("div",{className:"ink-datepicker-wrapper"}),i.wrap(this._element,this._wrapper)),i.insertAfter(this._containerObject,this._element)},_renderSuperTopBar:function(){this._options.showClose&&this._options.showClean&&(this._superTopBar=document.createElement("div"),this._superTopBar.className="ink-calendar-top-options",this._options.showClean&&this._superTopBar.appendChild(i.create("a",{className:"clean",setHTML:this._options.cleanText})),this._options.showClose&&this._superTopBar.appendChild(i.create("a",{className:"close",setHTML:this._options.closeText})),this._containerObject.appendChild(this._superTopBar))},_listenToContainerObjectEvents:function(){e.observe(this._containerObject,"mouseover",Ink.bindEvent(function(t){e.stop(t),this._hoverPicker=!0},this)),e.observe(this._containerObject,"mouseout",Ink.bindEvent(function(t){e.stop(t),this._hoverPicker=!1},this)),e.observe(this._containerObject,"click",Ink.bindEvent(this._onClick,this))},_onClick:function(t){var i=e.element(t);return n.hasClassName(i,"ink-calendar-off")?(e.stopDefault(t),null):(e.stop(t),this._onRelativeChangerClick(i),this._onAbsoluteChangerClick(i),n.hasClassName(i,"ink-calendar-link-month")?this._showMonthSelector():n.hasClassName(i,"ink-calendar-link-year")?this._showYearSelector():n.hasClassName(i,"clean")?this._clean():n.hasClassName(i,"close")&&this._hide(!1),void this._updateDescription())},_onRelativeChangerClick:function(t){var e={change_year_next:1,change_year_prev:-1},n={change_month_next:1,change_month_prev:-1};t.className in n?this._updateCal(n[t.className]):t.className in e&&this._showYearSelector(e[t.className])},_onAbsoluteChangerClick:function(t){var e=i.data(t);Number(e.calDay)?(this.setDate([this._year,this._month+1,e.calDay].join("-")),this._hide()):Number(e.calMonth)?(this._month=Number(e.calMonth)-1,this._showDefaultView(),this._updateCal()):Number(e.calYear)&&this._changeYear(Number(e.calYear))},_changeYear:function(t){t=+t,t&&(this._year=t,"function"==typeof this._options.onYearSelected&&this._options.onYearSelected(this,{year:this._year}),this._showMonthSelector())},_clean:function(){this._options.displayInSelect?(this._options.yearField.selectedIndex=0,this._options.monthField.selectedIndex=0,this._options.dayField.selectedIndex=0):this._element.value=""},_hide:function(t){t=void 0===t?!0:t,(t===!1||t&&this._options.shy)&&n.addClassName(this._containerObject,"hide-all")},_setMinMax:function(t){function e(){n._min=i,n._max=a}var n=this,i={_year:-Number.MAX_VALUE,_month:0,_day:1},a={_year:Number.MAX_VALUE,_month:11,_day:31};if(!t)return e();var o=t.split(":"),r=/^(\d{4})((\-)(\d{1,2})((\-)(\d{1,2}))?)?$/;s.each([{name:"_min",date:o[0],noLim:i},{name:"_max",date:o[1],noLim:a}],Ink.bind(function(t){var e=t.noLim;if("NOW"===t.date.toUpperCase()){var n=new Date;e=c(n)}else"EVER"===t.date.toUpperCase()?e=t.noLim:r.test(t.date)&&(e=l(t.date),e._month=h(e._month,0,11),e._day=h(e._day,1,this._daysInMonth(e._year,e._month+1)));this[t.name]=e},this));var _=-1!==this._dateCmp(this._max,this._min);_||e()},_fitDateToRange:function(t){return this._isValidDate(t)||(t=c(new Date)),-1===this._dateCmp(t,this._min)?Ink.extendObj({},this._min):1===this._dateCmp(t,this._max)?Ink.extendObj({},this._max):Ink.extendObj({},t)},_dateWithinRange:function(t){return arguments.length||(t=this),!this._dateAboveMax(t)&&!this._dateBelowMin(t)},_dateAboveMax:function(t){return 1===this._dateCmp(t,this._max)},_dateBelowMin:function(t){return-1===this._dateCmp(t,this._min)},_dateCmp:function(t,e){return this._dateCmpUntil(t,e,"_day")},_dateCmpUntil:function(t,e,n){var i=["_year","_month","_day"],a=-1;do{if(a++,t[i[a]]>e[i[a]])return 1;if(t[i[a]]<e[i[a]])return-1}while(i[a]!==n&&void 0!==t[i[a+1]]&&void 0!==e[i[a+1]]);return 0},_showDefaultView:function(){this._yearSelector.style.display="none",this._monthSelector.style.display="none",this._monthPrev.childNodes[0].className="change_month_prev",this._monthNext.childNodes[0].className="change_month_next",this._getPrevMonth()||(this._monthPrev.childNodes[0].className="action_inactive"),this._getNextMonth()||(this._monthNext.childNodes[0].className="action_inactive"),this._monthContainer.style.display="block"},_updateDate:function(){var t;!this._options.displayInSelect&&this._element.value?t=this._parseDate(this._element.value):this._options.displayInSelect&&(t={_year:this._options.yearField[this._options.yearField.selectedIndex].value,_month:this._options.monthField[this._options.monthField.selectedIndex].value-1,_day:this._options.dayField[this._options.dayField.selectedIndex].value}),t&&(t=this._fitDateToRange(t),this._year=t._year,this._month=t._month,this._day=t._day),this.setDate(),this._updateDescription(),this._renderMonth()},_updateDescription:function(){this._monthChanger.innerHTML=this._options.month[this._month+1],this._ofText.innerHTML=this._options.ofText,this._yearChanger.innerHTML=this._year},_showYearSelector:function(t){this._incrementViewingYear(t);var e=this._year-this._year%10,n=e-1,i="<li><ul>";i+=n>this._min._year?'<li><a href="#year_prev" class="change_year_prev">'+this._options.prevLinkText+"</a></li>":"<li>&nbsp;</li>";for(var a=1;11>a;a++)a%4===0&&(i+="</ul><ul>"),n=e+a-1,i+=this._getYearButtonHtml(n);i+=n<this._max._year?'<li><a href="#year_next" class="change_year_next">'+this._options.nextLinkText+"</a></li>":"<li>&nbsp;</li>",i+="</ul></li>",this._yearSelector.innerHTML=i,this._monthPrev.childNodes[0].className="action_inactive",this._monthNext.childNodes[0].className="action_inactive",this._monthSelector.style.display="none",this._monthContainer.style.display="none",this._yearSelector.style.display="block"},_incrementViewingYear:function(t){if(t){var e=+this._year+10*t;e-=e%10,e>this._max._year||e+9<this._min._year||(this._year=+this._year+10*t)}},_getYearButtonHtml:function(t){if(this._acceptableYear({_year:t})){var e=t===this._year?' class="ink-calendar-on"':"";return'<li><a href="#" data-cal-year="'+t+'"'+e+">"+t+"</a></li>"}return'<li><a href="#" class="ink-calendar-off">'+t+"</a></li>"},_showMonthSelector:function(){this._yearSelector.style.display="none",this._monthContainer.style.display="none",this._monthPrev.childNodes[0].className="action_inactive",this._monthNext.childNodes[0].className="action_inactive",this._addMonthClassNames(),this._monthSelector.style.display="block"},_parseDate:function(t){var e=o.set(this._options.format,t);return e?c(e):null},_isValidDate:function(t){var e=/^\d{4}$/,n=/^\d{1,2}$/;return e.test(t._year)&&n.test(t._month)&&n.test(t._day)&&+t._month+1>=1&&+t._month+1<=12&&+t._day>=1&&+t._day<=this._daysInMonth(t._year,t._month+1)},_isDate:function(t,e){try{if("undefined"==typeof t)return!1;var n=o.set(t,e);if(n&&this._isValidDate(c(n)))return!0}catch(i){}return!1},_acceptableDay:function(t){return this._acceptableDateComponent(t,"validDayFn")},_acceptableMonth:function(t){return this._acceptableDateComponent(t,"validMonthFn")},_acceptableYear:function(t){return this._acceptableDateComponent(t,"validYearFn")},_acceptableDateComponent:function(t,e){return this._options[e]?this._callUserCallbackBool(this._options[e],t):this._dateWithinRange(t)},_writeDateInFormat:function(){return o.get(this._options.format,this.getDate())},setDate:function(t){if(/\d{4}-\d{1,2}-\d{1,2}/.test(t)){var e=t.split("-");this._year=+e[0],this._month=+e[1]-1,this._day=+e[2]}this._setDate()},getDate:function(){if(!this._day)throw"Ink.UI.DatePicker: Still picking a date. Cannot getDate now!";return new Date(this._year,this._month,this._day)},_setDate:function(t){if(t){var e=i.data(t);this._day=+e.calDay||this._day}var n=this._fitDateToRange(this);this._year=n._year,this._month=n._month,this._day=n._day,this._options.displayInSelect?(this._options.dayField.value=this._day,this._options.monthField.value=this._month+1,this._options.yearField.value=this._year):this._element.value=this._writeDateInFormat(),this._options.onSetDate&&this._options.onSetDate(this,{date:this.getDate()})},_updateCal:function(t){"function"==typeof this._options.onMonthSelected&&this._options.onMonthSelected(this,{year:this._year,month:this._month}),t&&null===this._updateMonth(t)||this._renderMonth()},_daysInMonth:function(t,e){var n={2:t%400===0||t%4===0&&t%100!==0?29:28,4:30,6:30,9:30,11:30};return n[e]||31},_updateMonth:function(t){var e;return t>0?e=this._getNextMonth():0>t&&(e=this._getPrevMonth()),e?(this._year=e._year,this._month=e._month,void(this._day=e._day)):null},_getNextMonth:function(t){return this._tryLeap(t,"Month","next",function(t){return t._month+=1,t._month>11&&(t._month=0,t._year+=1),t})},_getPrevMonth:function(t){return this._tryLeap(t,"Month","prev",function(t){return t._month-=1,t._month<0&&(t._month=11,t._year-=1),t})},_getPrevYear:function(t){return this._tryLeap(t,"Year","prev",function(t){return t._year-=1,t})},_getNextYear:function(t){return this._tryLeap(t,"Year","next",function(t){return t._year+=1,t})},_tryLeap:function(t,e,n,i){t=t||{_year:this._year,_month:this._month,_day:this._day};var a="prev"===n?"_min":"_max",s=this[a];if(0===this._dateCmpUntil(t,s,e))return null;var o=this._options[n+"ValidDateFn"];return o?this._callUserCallbackDate(o,t):(t=i(t),t=this._fitDateToRange(t),this["_acceptable"+e](t)?t:null)},_getNextDecade:function(t){t=t||{_year:this._year,_month:this._month,_day:this._day};var e=this._getCurrentDecade(t);return e+10>this._max._year?null:e+10},_getPrevDecade:function(t){t=t||{_year:this._year,_month:this._month,_day:this._day};var e=this._getCurrentDecade(t);return e-10<this._min._year?null:e-10},_getCurrentDecade:function(t){return t=t?t._year||t:this._year,10*Math.floor(t/10)},_callUserCallbackBase:function(t,e){return t.call(this,e._year,e._month+1,e._day)},_callUserCallbackBool:function(t,e){return!!this._callUserCallbackBase(t,e)},_callUserCallbackDate:function(t,e){var n=this._callUserCallbackBase(t,e);return n?c(n):null},_dateParsers:{"yyyy-mm-dd":"Y-m-d","yyyy/mm/dd":"Y/m/d","yy-mm-dd":"y-m-d","yy/mm/dd":"y/m/d","dd-mm-yyyy":"d-m-Y","dd/mm/yyyy":"d/m/Y","dd-mm-yy":"d-m-y","dd/mm/yy":"d/m/y","mm/dd/yyyy":"m/d/Y","mm-dd-yyyy":"m-d-Y"},_renderMonth:function(){var t=this._month,e=this._year;this._showDefaultView();var n="";n+=this._getMonthCalendarHeaderHtml(this._options.startWeekDay);var i=0;n+="<ul>";var a='<li class="ink-calendar-empty">&nbsp;</li>',s=this._getFirstDayIndex(e,t);s>0&&(i+=s,n+=r(s,a)),n+=this._getDayButtonsHtml(e,t),n+="</ul>",this._monthContainer.innerHTML=n},_getFirstDayIndex:function(t,e){var n=new Date(t,e,1).getDay(),i=this._options.startWeekDay||0,a=n-i;return a%=7,0>a&&(a+=6),a},_getDayButtonsHtml:function(t,e){for(var n=this._getFirstDayIndex(t,e),i=this._daysInMonth(t,e+1),a="",s=1;i>=s;s++)7===n&&(n=0,a+="<ul>"),a+=this._getDayButtonHtml(t,e,s),n++,7===n&&(a+="</ul>");return a},_getDayButtonHtml:function(t,e,n){var i=" ",a=_(t,e,n);return i+=this._acceptableDay(a)?'data-cal-day="'+n+'"':'class="ink-calendar-off"',this._day&&0===this._dateCmp(a,this)&&(i+='class="ink-calendar-on" data-cal-day="'+n+'"'),'<li><a href="#" '+i+">"+n+"</a></li>"},_getMonthCalendarHeaderHtml:function(t){for(var e,n='<ul class="ink-calendar-header">',i=0;7>i;i++)e=(t+i)%7,n+="<li>"+this._options.wDay[e].substring(0,1)+"</li>";return n+"</ul>"},_addMonthClassNames:function(t){s.forEach((t||this._monthSelector).getElementsByTagName("a"),Ink.bindMethod(this,"_addMonthButtonClassNames"))},_addMonthButtonClassNames:function(t){var e=i.data(t);if(!e.calMonth)throw"not a calendar month button!";var a=+e.calMonth-1;if(a===this._month)n.addClassName(t,"ink-calendar-on"),n.removeClassName(t,"ink-calendar-off");else{n.removeClassName(t,"ink-calendar-on");var s=!this._acceptableMonth({_year:this._year,_month:a});n.addRemoveClassName(t,"ink-calendar-off",s)}},lang:function(t){this._lang=t},showMonth:function(){this._renderMonth()},isMonthRendered:function(){var t=a.select(".ink-calendar-header",this._containerObject)[0];return"none"!==n.getStyle(t.parentNode,"display")&&"none"!==n.getStyle(t.parentNode.parentNode,"display")},destroy:function(){i.unwrap(this._element),i.remove(this._wrapper),i.remove(this._containerObject),t.unregisterInstance.call(this)}},d});