Ink.createModule("Ink.UI.Table","1",["Ink.Util.Url_1","Ink.UI.Pagination_1","Ink.Net.Ajax_1","Ink.UI.Common_1","Ink.Dom.Event_1","Ink.Dom.Css_1","Ink.Dom.Element_1","Ink.Dom.Selector_1","Ink.Util.Array_1","Ink.Util.String_1","Ink.Util.Json_1"],function(t,e,i,s,n,o,r,a,l,h,d){"use strict";function _(t){return!isNaN(t)&&g.test(t)?parseInt(t,10):isNaN(t)?t:parseFloat(t)}function c(t,e){return t===e?0:t>e?1:-1}function p(t,e){var i=_(r.textContent(t)),s=_(r.textContent(e));return c(i,s)}function u(t){if("undefined"!=typeof Object.keys)return Object.keys(t);var e=[];for(var i in t)t.hasOwnProperty(i)&&e.push(i);return e}function f(t){return t}var g=/\d/g,m=function(t,e){if(this._rootElement=s.elOrSelector(t,"Ink.UI.Table :"),"table"!==this._rootElement.nodeName.toLowerCase())throw new Error("[Ink.UI.Table] :: The element is not a table");this._options=s.options({pageSize:["Integer",null],caretUpClass:["String","fa fa-caret-up"],caretDownClass:["String","fa fa-caret-down"],endpoint:["String",null],createEndpointUrl:["Function",null],getDataFromEndPoint:["Function",null],processJSONRows:["Function",f],processJSONRow:["Function",f],processJSONField:["Function",f],processJSONHeaders:["Function",function(t){return t.fields}],processJSONTotalRows:["Function",function(t){return t.length||t.totalRows}],getSortKey:["Function",null],pagination:["Element",null],allowResetSorting:["Boolean",!1],visibleFields:["String",null],tdClassNames:["Object",{}],paginationOptions:["Object",null]},e||{},this._rootElement),this._markupMode=!this._options.endpoint,this._options.visibleFields&&(this._options.visibleFields=this._options.visibleFields.toString().split(/[, ]+/g)),this._thead=this._rootElement.tHead||this._rootElement.createTHead(),this._headers=a.select("th",this._thead),this._handlers={thClick:null},this._originalFields=[],this._sortableFields={},this._originalData=this._data=[],this._pagination=null,this._totalRows=0,this._handlers.thClick=n.observeDelegated(this._rootElement,"click",'thead th[data-sortable="true"]',Ink.bindMethod(this,"_onThClick")),this._init()};return m.prototype={_init:function(){this._markupMode?(this._resetSortOrder(),this._addHeadersClasses(),this._data=a.select("tbody tr",this._rootElement),this._originalData=this._data.slice(0),this._totalRows=this._data.length,this._setPagination()):this._getData()},_addHeadersClasses:function(){for(var t,e,i=0,s=this._headers.length;s>i;i++)t=r.textContent(this._headers[i]),e=this._options.tdClassNames[t],e&&o.addClassName(this._headers[i],e)},_onThClick:function(t){var e=n.element(t),i=void 0!==this._options.pageSize;n.stop(t);var o=l.keyValue(e,this._headers,!0),r=o!==!1&&void 0!==this._sortableFields[o];if(r)if(!this._markupMode&&i)this._invertSortOrder(o,!1);else{"desc"===this._sortableFields[o]&&this._options.allowResetSorting?(this._setSortOrderOfColumn(o,null),this._data=this._originalData.slice(0)):this._invertSortOrder(o,!0);var h=a.select("tbody",this._rootElement)[0];s.cleanChildren(h),l.each(this._data,Ink.bindMethod(h,"appendChild")),this._pagination&&(this._pagination.setCurrent(0),this._paginate(1))}},_invertSortOrder:function(t,e){for(var i="asc"===this._sortableFields[t],s=0,n=this._headers.length;n>s;s++)this._setSortOrderOfColumn(s,null);e&&(this._sort(t),i&&this._data.reverse()),this._setSortOrderOfColumn(t,!i)},_setSortOrderOfColumn:function(t,e){var i=this._headers[t],s=[""],n="none";e===!0?(s=['<i class="',this._options.caretUpClass,'"></i>'],n="asc"):e===!1&&(s=['<i class="',this._options.caretDownClass,'"></i>'],n="desc"),this._sortableFields[t]=n,i.innerHTML=r.textContent(i)+s.join("")},_paginate:function(t){if(this._pagination){var e=this._options.pageSize,i=(t-1)*e,s=i+e;l.each(this._data,function(t,e){e>=i&&s>e?o.removeClassName(t,"hide-all"):o.addClassName(t,"hide-all")})}},_registerFieldNames:function(t){this._originalFields=[],l.forEach(t,Ink.bind(function(t){this._fieldIsVisible(t)&&this._originalFields.push(t)},this))},_fieldIsVisible:function(t){return!this._options.visibleFields||-1!==this._options.visibleFields.indexOf(t)},_sort:function(t){function e(e){return s.call(n,{columnIndex:t,columnName:i,data:r.textContent(e),element:e})}var i=r.textContent(this._headers[t]),s=this._options.getSortKey;s&&(s="function"==typeof s[i]?s[i]:"function"==typeof s?s:null);var n=this;this._data.sort(function(i,n){var o=Ink.ss("td",i)[t],r=Ink.ss("td",n)[t];return s?c(e(o),e(r)):p(o,r,t)})},_createHeadersFromJson:function(t){if(this._registerFieldNames(u(t)),!this._thead.children.length)for(var e,i=this._thead.insertRow(0),s=0,n=t.length;n>s;s++)this._fieldIsVisible(t[s])&&(e=r.create("th"),e=this._createSingleHeaderFromJson(t[s],e),i.appendChild(e),this._headers.push(e))},_createSingleHeaderFromJson:function(t,e){return t.sortable&&e.setAttribute("data-sortable","true"),t.label&&r.setTextContent(e,t.label),e},_resetSortOrder:function(){for(var t=0,e=this._headers.length;e>t;t++){var i=r.data(this._headers[t]);i.sortable&&"true"===i.sortable.toString()&&(this._sortableFields[t]="none")}},_createRowsFromJSON:function(t){var e=a.select("tbody",this._rootElement)[0];e?r.setHTML(e,""):(e=document.createElement("tbody"),this._rootElement.appendChild(e)),this._data=[];var i;for(var s in t)t.hasOwnProperty(s)&&(i=this._options.processJSONRow(t[s]),this._createSingleRowFromJson(e,i,s));this._originalData=this._data.slice(0)},_createSingleRowFromJson:function(t,e,i){var s=document.createElement("tr");t.appendChild(s);for(var n in e)e.hasOwnProperty(n)&&this._createFieldFromJson(s,e[n],n,i);this._data.push(s)},_createFieldFromJson:function(t,e,i,s){if(this._fieldIsVisible(i)){var n,r=this._options.processJSONField[i]||this._options.processJSONField;n="function"==typeof r?r(e,i,s):e;var a=this._elOrFieldData(n),l=this._options.tdClassNames[i];l&&o.addClassName(a,l),t.appendChild(a)}},_elOrFieldData:function(t){if(s.isDOMElement(t))return t;var e="string"==typeof t,i="number"==typeof t,n=r.create("td");if(e&&/^\s*?</.test(t))r.setHTML(n,t);else{if(!e&&!i)throw new Error("Ink.UI.Table Unknown result from processJSONField: "+t);r.setTextContent(n,t)}return n},setEndpoint:function(t,e){this._markupMode||(this._options.endpoint=t,this._pagination&&this._pagination.setCurrent(e?parseInt(e,10):0))},_setPagination:function(){if(null!=this._options.pageSize){var t=this._options.pagination;if(t instanceof e)return void(this._pagination=t);t||(t=r.create("nav",{className:"ink-navigation",insertAfter:this._rootElement}),r.create("ul",{className:"pagination",insertBottom:t}));var i=Ink.extendObj({totalItemCount:this._totalRows,itemsPerPage:this._options.pageSize,onChange:Ink.bind(function(t,e){this._paginate(e+1)},this)},this._options.paginationOptions||{});this._pagination=new e(t,i),this._paginate(1)}},_getData:function(){var t=this._getSortOrder()||null,e=null;this._pagination&&(e={size:this._options.pageSize,page:this._pagination.getCurrent()+1}),this._getDataViaAjax(this._getUrl(t,e))},_getSortOrder:function(){var t;for(t in this._sortableFields)if(this._sortableFields.hasOwnProperty(t)&&"none"!==this._sortableFields[t])break;return t?{field:this._originalFields[t],order:this._sortableFields[t]}:null},_getUrl:function(e,i){var s=this._options.createEndpointUrl||function(e,i,s){return e=t.parseUrl(e),e.query=e.query||{},i&&(e.query.sortOrder=i.order,e.query.sortField=i.field),s&&(e.query.rows_per_page=s.size,e.query.page=s.page),t.format(e)},n=s(this._options.endpoint,e,i);if("string"!=typeof n)throw new TypeError("Ink.UI.Table_1: createEndpointUrl did not return a string!");return n},_getDataViaAjax:function(t){var e=Ink.bind(function(t){this._onAjaxSuccess(t)},this);this._options.getDataFromEndpoint?this._options.getDataFromEndpoint(t,e):new i(t,{method:"GET",contentType:"application/json",sanitizeJSON:!0,onSuccess:Ink.bind(function(t){200===t.status&&e(d.parse(t.responseText))},this)})},_onAjaxSuccess:function(t){var e=null!=this._options.pageSize,i=this._options.processJSONRows(t);if(this._headers=a.select("th",this._thead),0===this._headers.length){var s=this._options.processJSONHeaders(t);if(!s||!s.length||!s[0])throw new Error("Ink.UI.Table: processJSONHeaders option must return an array of objects!");this._createHeadersFromJson(s),this._resetSortOrder(),this._addHeadersClasses()}this._createRowsFromJSON(i),this._totalRows=this._rowLength=i.length,e&&(this._totalRows=this._options.processJSONTotalRows(t),this._setPagination())}},m});